<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Project Ideas: PMod AMP2</title>
  <meta name="description" content="Fig 1.  Digilent's PMod AMP2">

  <link rel="shortcut icon" type="image/x-icon" href="/img/GT.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://zipcpu.com/blog/2019/04/24/pl-pmodamp2.html">
  <link rel="alternate" type="application/rss+xml" title="The ZipCPU by Gisselquist Technology" href="https://zipcpu.com/feed.xml">
</head>


  <body>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102570964-1', 'auto');
  ga('send', 'pageview');

</script>

    <header class="site-header">
  <div id="banner">
  <a href="/"><picture>
    <img height=120 id="site-logo" src="/img/fullgqtech.png" alt="Gisselquist Technology, LLC">
  </picture></A>
  </div>

  <div class="site-nav">
<ul>

<li><a HREF="/">Main/Blog</a>


<li><a HREF="/about/">About Us</a>


<li><a HREF="/fpga-hell.html">FPGA Hell</a>


<li><a HREF="/tutorial/">Tutorial</a>
<li><a HREF="/tutorial/formal.html">Formal training</a>


<li><a HREF="/quiz/quizzes.html">Quizzes</a>


<li><a HREF="/projects.html">Projects</a>


<li><a HREF="/topics.html">Site Index</a>

<HR>

<li><a href="https://twitter.com/zipcpu"><span class="icon--twitter"><svg viewBox="0 0 400 400"><path fill="#1da1f2" d="M153.62,301.59c94.34,0,145.94-78.16,145.94-145.94,0-2.22,0-4.43-.15-6.63A104.36,104.36,0,0,0,325,122.47a102.38,102.38,0,0,1-29.46,8.07,51.47,51.47,0,0,0,22.55-28.37,102.79,102.79,0,0,1-32.57,12.45,51.34,51.34,0,0,0-87.41,46.78A145.62,145.62,0,0,1,92.4,107.81a51.33,51.33,0,0,0,15.88,68.47A50.91,50.91,0,0,1,85,169.86c0,.21,0,.43,0,.65a51.31,51.31,0,0,0,41.15,50.28,51.21,51.21,0,0,1-23.16.88,51.35,51.35,0,0,0,47.92,35.62,102.92,102.92,0,0,1-63.7,22A104.41,104.41,0,0,1,75,278.55a145.21,145.21,0,0,0,78.62,23"/></svg>
</span><span class="username">@zipcpu</span></a>

<li><a href="https://www.reddit.com/r/ZipCPU"><span class="username">Reddit</a>
<li><a HREF="https://www.patreon.com/ZipCPU"><IMG SRC="/img/patreon_logomark_color_on_white.png" WIDTH="25"> Support</a>
</ul>
</div>


</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="https://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Project Ideas: PMod AMP2</h1>
    <p class="post-meta"><time datetime="2019-04-24T00:00:00-04:00" itemprop="datePublished">Apr 24, 2019</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <table align="center" style="float: right"><caption>Fig 1.  Digilent's PMod AMP2</caption><tr><td><a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/"><img src="/img/pmod-amp2.png" alt="" width="300" /></a></td></tr></table>

<p>Someone recently contacted me to ask how to build a design for their <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod
AMP2</a>.
My response to him was to provide a list of projects, from very simple to
complex, of things he could do with his <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod
AMP2</a>.
Indeed, I thought this list was so valuable and useful as a set of beginner
projects, that I thought I might share it here.</p>

<p>Before starting, however, if you haven’t yet gone through <a href="/tutorial">my
tutorial</a> to learn how to use buttons and
serial ports, and likewise how to
<a href="/blog/2018/08/22/what-is-simulation.html">simulate</a> and use
<a href="/blog/2017/10/19/formal-intro.html">formal methods</a>, you
should do that first.  You’ll need that background in a moment to keep things
from going wrong.</p>

<h2 id="preliminary-steps">0. Preliminary Steps</h2>

<p>Before starting any project with an
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>, or
any other digital electronics project for that matter, there’s always a
first step: gather the information you need.  I usually create a project
directory, and a subdirectory of that directory that contains these reference
files.  Specific files you will want to gather include:</p>

<ol>
  <li>
    <p>The schematic for your board(s).  This includes not only the schematic for
your
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
base or development board, but also the schematic for any
peripheral boards you might wish to use.</p>

    <p>In this case, you would want a copy of the <a href="https://reference.digilentinc.com/_media/reference/pmod/pmodamp2/pmodamp2_sch.pdf">schematic for the PMod
AMP2</a>.</p>
  </li>
  <li>
    <p>The data sheets for all of the parts on the board.</p>

    <p>For this, you can usually work your way through the schematic to find the
part IDs.  On a good schematic, these will be listed–often next to the
the various chips on the schematic.  You can usually take the cryptic
number and google it to get the data sheet.</p>

    <p>In the case of the <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod
AMP2</a>, there’s only
one IC on the board.  This IC is marked with “IC1” (integrated circuit chip
number one) and “SSM2377”.  A <a href="https://www.google.com/search?q=ssm2377">quick google search for SSM2377</a> yields <a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ssm2377.pdf">this
data sheet for the Analog Devices Filterless, High Efficiency, Mono 2.5W
class D audio amplifier</a>.</p>
  </li>
  <li>
    <p>Any other documentation for your board(s): user guides, reference manuals
and so forth.</p>

    <p>Over time, I have found <a href="https://store.digilentinc.com">Digilent</a> to be
really good with their documentation.  Every device I have purchased from
them has had a reference page, and the <a href="https://reference.digilentinc.com/reference/pmod/pmodamp2/start">PMod AMP2 is no
different</a>.
The page often has links to tutorials and example project code as well.
There’s even a <a href="https://reference.digilentinc.com/reference/pmod/pmodamp2/reference-manual">reference sheet</a>,
that you’ll want to print (to a file) for your records as well.</p>
  </li>
</ol>

<p>You’ll need these items during your subsequent design, and once your board gets
old enough they’ll become hard to find.  Projects vanish, links move, etc.
Worse, if your board eventually gets replaced with another board, you may
grab the reference material for the new board and not notice the difference.
By grabbing this information first, before anything else, and by keeping a copy
with your project, you’ll keep yourself from having this problem.</p>

<h2 id="pin-discovery">1. Pin Discovery</h2>

<p>If you know your
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>,
or if you are an old hand at digital circuitry, you may be able to breeze
through this step.  For me, I’m always struggling to figure out which I/O pin
on my board connects to which pin on an external
peripheral.  Mapping these together can be tedious, but it needs to be
done carefully and done right to avoid any potential short circuits.</p>

<p>Often, a board will come with a master constraint file.  (You did copy this
in the first step when you bought your
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>,
board, right?)  This will work for all of the on-board peripherals–except
things with bidirectional names.  For example, which
direction does the “TX” wire go between your
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
and another chip, such as an <a href="https://www.ftdichip.com/Support/Documents/DataSheets/ICs/DS_FT2232H.pdf">FTDI USB-UART</a> chip?  Does it “transmit” from the
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
to the <a href="https://www.ftdichip.com/Support/Documents/DataSheets/ICs/DS_FT2232H.pdf">FTDI</a>, or is it the “transmit” pin from the <a href="https://www.ftdichip.com/Support/Documents/DataSheets/ICs/DS_FT2232H.pdf">FTDI
USB-UART</a>
chip to the <a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>?</p>

<p>This problem can be compounded by the Pmod you are working with, if the pins
on the PMod aren’t well labeled.</p>

<p>Often, you can find a particular pin with a square pad.  This is pin one,
and it should help you figure out which schematic pin names map to which
physical <a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
I/O pad.</p>

<p>From this, create/adjust your master constraint file.  (Don’t forget to keep
a copy of the original!)</p>

<p>You can do this the hard way too.  Set a pin to be an output, and then drive
the pin high.  Use your voltmeter to then figure out which pin (or pins) is
at the right voltage.  You can then set the pin low and see which pin changes.</p>

<p>Or, you can do what <a href="https://twitter.com/oe1cxw">one person</a> did: Force each
pin to be a <a href="/formal/2019/02/21/txuart.html">serial port
transmitter</a>
with a different message, and then take another board and read off the pin
mapping from there.</p>

<h2 id="your-first-design-a-voltage-controller-with-no-audio">2. Your first design: a voltage controller with no audio</h2>

<p>We’ve <a href="/dsp/2017/09/04/pwm-reinvention.html">discussed the PModAMP2
before</a>.  Perhaps you
might remember that this was the design I <a href="/dsp/2017/09/16/pwm-demo.html">demonstrated my “improved” PWM
approach with</a>.  The board
itself offers an analog lowpass filter, followed by an amplifier.  The basic
approach to sending “audio” to the board involves sending a high
<a href="https://en.wikipedia.org/wiki/Frequency">frequency</a>
signal whose proportion of 1’s to 0’s roughly matches the value of the audio
sample you are trying to send.</p>

<p>For your very first design, skip the <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod
AMP2</a>, and just
send your (would be) audio to the audio input pin of (what would be) the
<a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod AMP2</a>s audio
input port.</p>

<p>For example, you could set this port based upon a counter and a threshold.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">parameter</span> <span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="p">(</span><span class="n">some</span> <span class="n">value</span><span class="p">)</span><span class="o">;</span>
	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">counter</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

	<span class="k">assign</span> <span class="n">o_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">THRESHOLD</span><span class="p">)</span><span class="o">;</span></code></pre></figure>

<p>Set the threshold to 0, and then use your voltmeter.  You should be able to
read zero volts.  You can often find a suitable ground for your voltmeter
from the shield on the USB port.  Sometimes the screws for any standoffs are
connected to board ground.  If all else fails, there’s a ground pin on the
PMod connector itself–just don’t accidentally fumble finger your probe and
cross-connect that pin with the power pin right that’s next to it.  I’ve often
found that sticking a wire (or wires) inside the PMod port itself gives me
better access to the pins when making measurements like these.</p>

<p>Now try setting the threshold to <code class="highlighter-rouge">8'hff</code>.  You should be able to read something
close to 3.3V.  Now try <code class="highlighter-rouge">8'h80</code>, <code class="highlighter-rouge">8'h20</code>, and <code class="highlighter-rouge">8'hc0</code>.</p>

<h2 id="an-adjustable-controller-but-still-no-audio-yet">3. An adjustable controller, but still no audio yet</h2>

<p>Before trying this next step, make certain you have a solid understanding of
<a href="/blog/2017/08/04/debouncing.html">debouncing</a> and <a href="/blog/2017/08/02/debounce-teaser.html">why
it’s necessary</a>.
I’m going to assume you have four switches to your board, and that their
outputs have been suitably
<a href="/blog/2017/08/04/debouncing.html">debounced</a>
and <a href="/blog/2017/10/20/cdc.html">synchronized</a>
to your system clock.  Buttons would work as well, if you have enough fingers
to push them and hold your voltmeter.</p>

<p>If you have enough switches/buttons, why not adjust your design so that the
threshold from the last step is now variable?  We’ll test the design using
the voltmeter here again.</p>

<p>For example, your design might now contain something that looks like:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="n">posedgde</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">casez</span><span class="p">(</span><span class="n">i_sw</span><span class="p">)</span>
	<span class="mb">4'b1???</span><span class="o">:</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mh">8'h44</span><span class="o">;</span>
	<span class="mb">4'b01??</span><span class="o">:</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mh">8'h88</span><span class="o">;</span>
	<span class="mb">4'b001?</span><span class="o">:</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mh">8'hcc</span><span class="o">;</span>
	<span class="mb">4'b0001</span><span class="o">:</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mh">8'hff</span><span class="o">;</span>
	<span class="nl">default:</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">endcase</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">o_audio</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">;</span></code></pre></figure>

<p>Notice that, to do the last comparison right, <code class="highlighter-rouge">o_audio</code> must be declared as
an <code class="highlighter-rouge">output reg o_audio</code> instead of <code class="highlighter-rouge">output wire o_audio</code>.</p>

<h2 id="your-first-sound">4. Your first sound</h2>

<p>If you’ve gotten this far, then it’s time to try a sound to see if it works.</p>

<p>Are you ready to plug in your board?  Don’t forget to hold the <code class="highlighter-rouge">SHUTDOWN</code> pin
high (inactive).  You might want to leave the gain low initially, or even
control it from a button.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">assign</span>	<span class="n">o_shutdown_n</span> <span class="o">=</span> <span class="mb">1'b1</span><span class="o">;</span>
	<span class="k">assign</span>	<span class="n">o_gain</span> <span class="o">=</span> <span class="n">debounced_button</span><span class="o">;</span></code></pre></figure>

<p>Let’s send <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">a
tone</a> to
this board.  It won’t be a nice tone, it won’t be a pretty tone, but it will at
least let you know that your <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod
AMP2</a>
works and that you have the PMod pins wired correctly.</p>

<p>To do this, we’ll go back to the counter, and adjust its step size based upon
your board’s <code class="highlighter-rouge">CLOCK_FREQUENCY_HZ</code> and your desired <code class="highlighter-rouge">TONE_FREQUENCY_HZ</code>.
(You’ll need to look these up and set them appropriately yourself.)</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">parameter</span>	<span class="n">COUNTER_WIDTH</span> <span class="o">=</span> <span class="mi">32</span><span class="o">;</span>
	<span class="k">localparam</span>	<span class="n">MSB</span> <span class="o">=</span> <span class="n">COUNTER_WIDTH</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span>
	<span class="k">parameter</span> <span class="n">STEP_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">COUNTER_WIDTH</span><span class="p">))</span>
				<span class="o">*</span> <span class="n">TONE_FREQUENCY_HZ</span> <span class="o">/</span> <span class="n">CLOCK_FREQUENCY_HZ</span><span class="o">;</span>

	<span class="kt">reg</span>	<span class="p">[</span><span class="n">COUNTER_WIDTH</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">phase</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">phase</span> <span class="o">&lt;=</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">STEP_SIZE</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
		<span class="n">o_audio</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">MSB</span><span class="p">]</span><span class="o">;</span></code></pre></figure>

<p>But what <code class="highlighter-rouge">TONE_FREQUENCY_HZ</code> to start with?  <a href="https://en.wikipedia.org/wiki/A440_(pitch_standard)">How about <code class="highlighter-rouge">440.0Hz</code>?  This is the
frequency of the basic tuning <code class="highlighter-rouge">A</code> in the first octave above middle C that
many instrumentalists will use to tune their instruments
with</a>.  Want to go up an
<a href="https://en.wikipedia.org/wiki/Octave">octave</a>?
Double the <code class="highlighter-rouge">TONE_FREQUENCY_HZ</code>.  Want to go down an
<a href="https://en.wikipedia.org/wiki/Octave">octave</a>?
Halve it.</p>

<p>If you haven’t been
<a href="/blog/2018/08/22/what-is-simulation.html">simulating</a>
your designs, now is a good time to start.
The problem you’ll have is that you might struggle to “see” the output waveform.
Not a problem, take a <a href="/dsp/2017/10/16/boxcar.html">box car
filter</a> and filter your
signal until it <a href="/dsp/2017/07/24/dsp-debugging.html">looks reasonable in
GTKWave</a>.  You may
need to filter it several times over.</p>

<h2 id="a-prettier-sound">5. A prettier sound</h2>

<p>The problem is that a square wave just doesn’t sound all that pretty on the
ear.  Can we do any better?</p>

<p>Sure we can!  Let’s use a <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">table lookup based sine
wave</a>.
A basic 8-pt table shouldn’t be too difficult.  You can find a discussion
about <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">how to build one of these
here</a>,
and an <a href="https://github.com/ZipCPU/cordic">example program that does this and more
here</a>.  Once you have the table, your
audio logic will now look something like:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="kt">wire</span>	<span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">sample</span><span class="o">;</span>

	<span class="n">sintable</span> <span class="n">tbl</span><span class="p">(</span><span class="n">i_clk</span><span class="o">,</span> <span class="n">phase</span><span class="p">[</span><span class="n">MSB</span><span class="o">:</span><span class="n">MSB</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">,</span> <span class="n">sample</span><span class="p">)</span><span class="o">;</span></code></pre></figure>

<p>To get a nice quality 8-bit sample output, lets run it through the <a href="/dsp/2017/09/04/pwm-reinvention.html">“improved
PWM” method we’ve already
discussed</a>.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="kt">wire</span>	<span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">offset_sample</span><span class="o">;</span>
	<span class="k">assign</span> <span class="n">offset_sample</span> <span class="o">=</span> <span class="o">{</span> <span class="o">!</span><span class="n">sample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">6</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">};</span>

	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">pwmcounter</span><span class="o">;</span>
	<span class="kt">wire</span>	<span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">brevcounter</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">pwmcounter</span> <span class="o">&lt;=</span> <span class="n">pwmcounter</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

	<span class="kt">integer</span> <span class="n">k</span><span class="o">;</span>
	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
	<span class="k">begin</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">;</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">brevcounter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwmcounter</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">k</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span>

	<span class="k">assign</span>	<span class="n">o_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">brevcounter</span> <span class="o">&lt;</span> <span class="n">offset_sample</span><span class="p">)</span><span class="o">;</span></code></pre></figure>

<p>You should now have a nice quality sounding tone coming out of your device.</p>

<p>You may find it to be obnoxiously loud, however, and this design gives you
no control of the <a href="https://en.wikipedia.org/wiki/Amplitude">amplitude (volume)</a>.
So, let’s adjust the <a href="https://en.wikipedia.org/wiki/Amplitude">amplitude</a>.</p>

<h2 id="adjustable-volume">5. Adjustable Volume</h2>

<p>If you have hardware that will support multiplies (Xilinx, Intel, ECP5, some
ice40s, etc), then <a href="https://en.wikipedia.org/wiki/Amplitude">volume</a>
adjustment is easy.  Simply multiply by the chosen volume, and shift right.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">parameter</span> <span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">VOLUME</span> <span class="o">=</span> <span class="mh">3'h1f</span><span class="o">;</span>
	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">15</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">sample</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">sample</span> <span class="o">=</span> <span class="n">sinesample</span> <span class="o">*</span> <span class="n">VOLUME</span><span class="o">;</span></code></pre></figure>

<p>You can even use the buttons / switches as before to adjust the volume, just
as we did when adjusting the voltage earlier.</p>

<p>But what if you have an iCE40 hx8k, or 1k
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
with no internal hardware multiplies?  How will you then adjust the
<a href="https://en.wikipedia.org/wiki/Amplitude">volume</a>?</p>

<p>In this case, the easy way is to shift your sample by some power of two.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">volume</span><span class="o">;</span>
	<span class="c1">// Set your volume register somehow ...
</span>	<span class="c1">// Then,
</span>	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
	<span class="mb">3'b000</span><span class="o">:</span> <span class="n">sample</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="mb">3'b010</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b010</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b011</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b100</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b101</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b110</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="o">{</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">{</span><span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">,</span> <span class="n">sinesample</span><span class="p">[</span><span class="mi">7</span><span class="o">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">3'b111</span><span class="o">:</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="n">sinesample</span><span class="o">;</span>
	<span class="k">endcase</span></code></pre></figure>

<p>Voila, coarse grained <a href="https://en.wikipedia.org/wiki/Amplitude">volume</a> control!</p>

<h2 id="swept-tone">5. Swept Tone</h2>

<p>Did you know that if you adjust the phase step on every sample, the tone will
sweep up or down?</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">initial</span>	<span class="n">phase_step</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">phase_step</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="n">phase</span> <span class="o">&lt;=</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">phase_step</span><span class="o">;</span></code></pre></figure>

<p>The curious thing about this design is that the
<a href="https://en.wikipedia.org/wiki/Frequency">frequency</a>
will sweep up, much like you expect, but then it will start
<em>sweeping back down</em>!</p>

<p>Try it!  Can you explain why?</p>

<h2 id="adjustable-frequency">6. Adjustable Frequency</h2>

<table align="center" style="float: right"><caption>Fig 2. An Octave on the Piano</caption><tr><td><img src="/img/piano-octave.png" alt="" width="233" /></td></tr></table>

<p>With a little bit of work, and some table lookups, we can adjust the
output <a href="https://en.wikipedia.org/wiki/Frequency">frequency</a> as well.</p>

<p>For example, there are eight notes in a scale.  If you check <a href="https://en.wikipedia.org/wiki/Piano_key_frequencies">Wikipedia’s
piano key frequency</a>
page, you’ll discover the <a href="https://en.wikipedia.org/wiki/Frequency">frequencies</a>
of a scale in the key of C are: <code class="highlighter-rouge">261.6</code>,
<code class="highlighter-rouge">293.6</code>, <code class="highlighter-rouge">329.6</code>, <code class="highlighter-rouge">349.2</code>, <code class="highlighter-rouge">391.9</code>, <code class="highlighter-rouge">440.0</code>, <code class="highlighter-rouge">493.9</code>, and <code class="highlighter-rouge">523.25</code>.  Why not
create a design that steps through these output frequencies at two per second?</p>

<p>You’d need a <a href="/blog/2017/06/02/generating-timing.html">half second
timer</a>.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">parameter</span> <span class="n">HALF_SECOND_STEP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">33</span><span class="p">)</span> <span class="o">/</span> <span class="n">CLOCK_FREQUENCY_HZ</span><span class="o">;</span>

	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">half_second_timer</span><span class="o">;</span>
	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="o">{</span> <span class="n">half_second_stb</span><span class="o">,</span> <span class="n">half_second_timer</span> <span class="o">}</span>
			<span class="o">&lt;=</span> <span class="n">half_second_timer</span> <span class="o">+</span> <span class="n">HALF_SECOND_STEP</span><span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span></code></pre></figure>

<p>You’ll also need a state machine, running from <code class="highlighter-rouge">0</code> to <code class="highlighter-rouge">8</code> and back again to
capture the pitch number of interest:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">half_second_stb</span><span class="p">)</span>
	<span class="k">begin</span>
		<span class="n">fsm</span> <span class="o">&lt;=</span> <span class="n">fsm</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsm</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">fsm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">end</span></code></pre></figure>

<p>You’ll then need a table lookup, to get the values you want:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">parameter</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">STEP_C</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">COUNTER_WIDTH</span><span class="p">))</span>
				<span class="o">*</span> <span class="mf">261.6</span> <span class="o">/</span> <span class="n">CLOCK_FREQUENCY_HZ</span><span class="o">;</span>
	<span class="k">parameter</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">STEP_D</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">COUNTER_WIDTH</span><span class="p">))</span>
				<span class="o">*</span> <span class="mf">293.6</span> <span class="o">/</span> <span class="n">CLOCK_FREQUENCY_HZ</span><span class="o">;</span>
	<span class="c1">// ...
</span>	<span class="k">parameter</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">STEP_OCTAVE</span> <span class="o">=</span> <span class="n">STEP_C</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">casez</span><span class="p">(</span><span class="n">fsm</span><span class="p">)</span>
	<span class="mh">4'h0</span><span class="o">:</span>	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">STEP_C</span><span class="o">;</span>
	<span class="mh">4'h1</span><span class="o">:</span>	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">STEP_D</span><span class="o">;</span>
	<span class="mh">4'h2</span><span class="o">:</span>	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">STEP_E</span><span class="o">;</span>
	<span class="c1">//
</span>	<span class="mh">4'h7</span><span class="o">:</span>	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">STEP_B</span><span class="o">;</span>
	<span class="mh">4'h8</span><span class="o">:</span>	<span class="n">phase_step</span> <span class="o">&lt;=</span> <span class="n">STEP_OCTAVE</span><span class="o">;</span>
	<span class="nl">default:</span> <span class="n">phase_step</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">endcase</span>

	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="n">phase</span> <span class="o">&lt;=</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">phase_step</span><span class="o">;</span></code></pre></figure>

<p>Now that you have various states, it’s a good time to make certain you are
both
<a href="/blog/2017/10/19/formal-intro.html">formally verifying</a>
and
<a href="/blog/2018/08/22/what-is-simulation.html">simulating</a>
your design before it goes onto your board.  Your ears will thank you.</p>

<h2 id="playing-a-simple-song">7. Playing a simple song</h2>

<p>We now know all of the parts necessary to play a simple song: You can play
notes, coarsely adjust their
<a href="https://en.wikipedia.org/wiki/Amplitude">volume</a>, adjust their
<a href="https://en.wikipedia.org/wiki/Frequency">frequency</a>,
and more.  Why not turn this into a song?</p>

<p>You can, if you use a
<a href="/zipcpu/2018/07/13/memories.html">block RAM memory</a>.
Remember using <a href="/zipcpu/2018/07/13/memories.html">memories</a>
from our <a href="/tutorial">tutorial</a>?
Let’s create a <a href="/zipcpu/2018/07/13/memories.html">block RAM
memory</a> describing the
<a href="https://en.wikipedia.org/wiki/Amplitude">volume</a> and
<a href="https://en.wikipedia.org/wiki/Pitch_(music)">pitch</a>
of every point in this song.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">initial</span>	<span class="n">rd_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">half_second_stb</span><span class="p">)</span>
		<span class="n">rd_addr</span> <span class="o">&lt;=</span> <span class="n">rd_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

	<span class="k">initial</span> <span class="p">$</span><span class="nb">readmemh</span><span class="p">(</span><span class="s">"song.hex"</span><span class="o">,</span> <span class="n">songmem</span><span class="p">)</span><span class="o">;</span>
	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
		<span class="o">{</span> <span class="n">volume</span><span class="o">,</span> <span class="n">frequency_step</span> <span class="o">}</span> <span class="o">&lt;=</span> <span class="n">songmem</span><span class="p">[</span><span class="n">rd_addr</span><span class="p">]</span><span class="o">;</span></code></pre></figure>

<p>At this point, I’m sure you will find anything and everything going wrong as
you try to create your <code class="highlighter-rouge">songmem</code> memory.  You are testing everything in
<a href="/blog/2018/08/22/what-is-simulation.html">simulation</a> first,
right?  You should be able to generate an audio file and “listen” to your
song before you place it on your board–or you might never figure out why your
board is or isn’t working.  If you aren’t familiar with
<a href="https://sox.sourceforge.net">SoX</a>
it could easily be your good friend during this process.</p>

<h2 id="playing-some-harmony">8. Playing some harmony</h2>

<p>Now that you can play one audio file, why not two?  Why not two, three, or even
<a href="https://en.wikipedia.org/wiki/Four-part_harmony">four-part harmony</a>?
To create <a href="https://en.wikipedia.org/wiki/Four-part_harmony">four-part harmony</a>,
you’ll need four phase
counters, and varying step sizes according to the frequency of each.  (Be
careful not to place two notes at the same frequency!  You might not hear one
or the other.)</p>

<p>Each of these phase counters will then go into the <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">sine wave lookup
table</a>,
just like before.</p>

<p>The next big difference is that we’ll take the outputs of the <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">sine wave
lookup</a>
and create our final sample from their sum.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">begin</span>
		<span class="n">uppers</span> <span class="o">&lt;=</span> <span class="n">soprano</span> <span class="o">+</span> <span class="n">alto</span><span class="o">;</span>
		<span class="n">lowers</span> <span class="o">&lt;=</span> <span class="n">tenor</span> <span class="o">+</span> <span class="n">bass</span><span class="o">;</span>

		<span class="n">sample</span> <span class="o">&lt;=</span> <span class="n">uppers</span> <span class="o">+</span> <span class="n">lowers</span><span class="o">;</span>
	<span class="k">end</span></code></pre></figure>

<p>The problem with the above approach is <a href="/dsp/2017/07/21/bit-growth.html">bit
accumulation</a>.  The sum of
two 8-bit numbers requires 9-bits, and the sum of two 9-bit numbers requires
10 bits.  You’ll want to make certain that you don’t “clip”, or distort
your sound, as you add these voices together.  Of course, this might also
adjust your audio when only one voice is output, so that’s another thing
to adjust.</p>

<h2 id="playing-a-sampled-audio-file">9. Playing a sampled audio file</h2>

<p>All of the above is great if you want to play sounds that come across like
computerized beeps, squeeks, chirps, and mary had a little lamb, but somehow
our <a href="https://en.wikipedia.org/wiki/Four-part_harmony">four-part harmony</a>,
just didn’t quite sound right.</p>

<p>What went wrong?</p>

<p>The list is numerous.  Human voices don’t hold constant
<a href="https://en.wikipedia.org/wiki/Pitch_(music)">pitches</a>, they
vibrate in <a href="https://en.wikipedia.org/wiki/Frequency">frequency</a>
near the right one.  When they move from one
<a href="https://en.wikipedia.org/wiki/Frequency">frequency</a> to another, they do so
gradually.  <a href="https://en.wikipedia.org/wiki/Amplitude">Volume</a> comes in many
shades, crescendos and decrescendos are gradual, and I could go on.</p>

<p>You might try <a href="/dsp/2017/07/29/series-linear-interpolation.html">interpolating</a>
between <a href="https://en.wikipedia.org/wiki/Frequency">frequencies</a> and
<a href="https://en.wikipedia.org/wiki/Amplitude">volumes</a>.
How about <a href="/dsp/2018/03/30/quadratic.html">quadratic</a>?
You might find that <a href="/dsp/2017/07/29/series-linear-interpolation.html">interpolation</a>
helps, but you might also want to do so at a faster step size than 2Hz.</p>

<p>While I would challenge and encourage anyone to continue this thread,
I’d also like to offer some other ideas.</p>

<table align="center" style="float: right"><tr><td><img src="/img/homer-doh.png" alt="" width="408" /></td></tr></table>

<p><a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>s
often have on-board block RAM, such as the iCE40 hx8k which has 8kB
of RAM.  If we filled that RAM with 8-bit sampled audio values, we could
move from one sample to the next at 8kHz and play about a second of any sound.</p>

<p>That’s enough for some recognizable doorbell’s, and perhaps even for
Homer to shout, Doh!</p>

<p>How about using the <a href="/blog/2018/08/16/spiflash.html">flash device found on most
FPGAs</a> to hold your audio
samples?  We discussed <a href="/blog/2018/08/16/spiflash.html">how to build a basic controller for a flash
device</a> some time
ago.  If you chose to write audio samples to that device, reading those samples
from that device later should allow you to play any sound you want.  Even
better, since your typical flash device holds about 16MB, that should be enough
to hold a <em>half an hour</em> of sampled audio.</p>

<p>The only thing is … once you get this far, the project becomes a big enough
challenge that I can’t tell you how to do all of the pieces in the few lines
we have left below.</p>

<h2 id="cpu-audio">10. CPU audio</h2>

<p>If you have any interest at all in using a
<a href="https://en.wikipedia.org/wiki/Soft_microprocessor">soft-core CPU</a> on your
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>,
this may be the time to try it.  There’s many ways to do
<a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>
based audio, but I’ll warn you: It’s not as easy as it looks.</p>

<p>You’ll need to build an audio device with a
<a href="/zipcpu/2017/11/07/wb-formal.html">bus interface</a>.
You can control each sample, by having the
<a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>
write a sample value to this device.  You may also wish to place a
<a href="/blog/2017/07/29/fifo.html">FIFO</a> in your audio device
as well.</p>

<p>Here are some of the approaches you can try:</p>

<ol>
  <li>
    <p>Have the <a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>
<a href="https://en.wikipedia.org/wiki/Polling_(computer_science)">poll</a> the audio
device.  Wait in a tight loop, reading from the audio device’s control
register(s), until you read from the audio device’s control register a
value telling you it needs a new sample, and then feed it one.
Repeat while you have samples left, then set the device to zero.</p>
  </li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/Interrupt">Interrupt</a> driven audio.  By this
I’m referring to something very similar to the
<a href="https://en.wikipedia.org/wiki/Polling_(computer_science)">polled approach</a>
above, only this time don’t wait in the tight loop.  Either put the
<a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>
to sleep waiting on an <a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a>,
or go on and do something else.  Then when an
<a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a> occurs, reset the
<a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a> line and feed the
audio device a new sample.</p>
  </li>
  <li>
    <p>There is <em>so</em> much to be learned in this exercise.  For example,
<a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a> driven audio at
8kHz while doing something else might require more cycles than your
<a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a> has.  One way
to deal with this is to place a
<a href="/blog/2017/07/29/fifo.html">FIFO</a> into your audio
driver, and only <a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a> when
the <a href="/blog/2017/07/29/fifo.html">FIFO</a> is half empty.
You can then send a
half-<a href="/blog/2017/07/29/fifo.html">FIFO</a>s
worth of information to the audio driver and go back to what you were doing.</p>
  </li>
  <li>
    <p>You may find that <a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a>
driven audio is still too slow for what you need to do.  In that case, why
not use a <a href="https://github.com/ZipCPU/zipcpu/blob/master/rtl/peripherals/wbdmac.v">DMA
engine</a>,
and teach the
<a href="https://github.com/ZipCPU/zipcpu/blob/master/rtl/peripherals/wbdmac.v">DMA</a>
engine to fill the audio driver with samples every time the
<a href="/blog/2017/07/29/fifo.html">FIFO</a>
gets below some watermark?</p>
  </li>
</ol>

<p>One of my earlier <a href="https://github.com/ZipCPU/s6soc">ZipCPU projects</a> involved
“ringing a doorbell” from the
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>,
by having it play a <a href="https://github.com/ZipCPU/s6soc/blob/master/sw/dev/samples.c">sampled</a> doorbell audio sound through the
<a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier/">PMod AMP2</a>.
In my case, the <a href="/about/zipcpu.html">CPU</a>
was <a href="/zipcpu/2018/03/21/dblfetch.html">running from flash</a>,
and really struggled to keep up with
<a href="https://en.wikipedia.org/wiki/Interrupt">interrupt</a> driven sample by sample
audio.  I learned a lot by learning how to place some of my software in flash,
other parts in block RAM, and then how to create a basic <a href="https://github.com/ZipCPU/s6soc/blob/master/sw/zipos/syspipe.c">software
“pipe”</a>
so the audio “program” didn’t need to perpetually fill the (software) FIFO.</p>

<p>It was a fun exercise for me, and a <a href="/blog/2017/06/12/minimizing-luts.html">challenge for a Spartan 6
LX4</a> of all devices.</p>

<h2 id="conclusion">Conclusion</h2>

<p>If you’ve never worked with an audio peripheral before, there’s a lot you can
learn about by doing so.  I/O connectivity, <a href="/dsp/2017/09/04/pwm-reinvention.html">Pulse-Width
Modulation</a>, <a href="/dsp/2017/07/11/simplest-sinewave-generator.html">sinewave
table lookups</a>,
<a href="https://en.wikipedia.org/wiki/Frequency">frequency</a>,
<a href="https://en.wikipedia.org/wiki/Amplitude">volume</a>,
<a href="https://en.wikipedia.org/wiki/Harmony">harmony</a>,
<a href="/dsp/2018/01/16/interpolation-is-convolution.html">interpolation</a>, and more–the list
just goes on.  There’s lots of stuff to learn here, and the example projects
suggested above are just the bare beginnings of what you might do.</p>

<p>I’ll admit, this article doesn’t follow my usual style.  Usually, I like to
write articles about how to perform some task, or build some element.  I
describe the task, walk through an outline of it, then through the code
and
<a href="/formal/formal.html">formal properties</a>.  While I’ve
tackled some fairly complex problems in this fashion on the
<a href="">ZipCPU blog</a>, it often leaves beginners wondering
where to start to try things myself.  So, I thought a list of baby steps from
nothing to something significant, like the steps above, might be useful.</p>

<p>Let me know what you think.  (I also recommend <a href="https://www.fpga4fun.com">fpga4fun.com</a> for picking up fun/sample projects.)</p>

<p>The one big thing missing from the discussion above is the
<a href="/blog/2017/06/16/dbg-bus-forest.html">debugging bus</a>.
I personally struggle to build designs at all without some form of
<a href="/blog/2017/06/16/dbg-bus-forest.html">debugging bus</a>
allowing me access into the registers within a given design.  This is how
I go about programming Flash devices, loading programs into the
<a href="/about/zipcpu.html">CPU</a>,
and more.  It’s also how I <a href="/blog/2017/07/08/getting-started-with-wbscope.html">normally go about
debugging</a>
any <a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>,
projects I’m working on that pass <a href="/blog/2017/10/19/formal-intro.html">formal
verification</a> and
<a href="/blog/2018/08/22/what-is-simulation.html">simulation</a>,
but still don’t quite do what I want.</p>

<p>I skipped the
<a href="/blog/2017/06/16/dbg-bus-forest.html">debugging bus</a>,
however, since the individual who originally asked the question of me had a
<a href="https://nandland.com/goboard/introduction.html">GO board</a>.  The
<a href="https://nandland.com/goboard/introduction.html">GO board</a>
only has a rough 1k LUTs, and you may find it a challenge to place a
<a href="/blog/2017/06/16/dbg-bus-forest.html">debugging bus</a>
into 1k LUTs.  It’s not impossible, but it’s not going to be easy either.</p>

<p>I look forward to hearing from you: would you like more of these project
lists, going from scratch to a simple capability with a particular piece of
hardware?</p>

  </div>


<div class "verse">
<HR align="center;" width="25%">
<P><em>Also I heard the voice of the Lord, saying, Whom shall I send, and who will go for us? Then said I, Here am I; send me. (Is 6:8)</em>


</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The ZipCPU by Gisselquist Technology</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <!-- <li></li> -->
          <li><a href="mailto:zipcpu@gmail.com">zipcpu@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="soc-medlist">
          
          <li>
            <a href="https://github.com/ZipCPU"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ZipCPU</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/zipcpu"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">@zipcpu</span></a>

          </li>
          
          
          <li><A href="https://www.patreon.com/ZipCPU"><img src="/img/become_a_patron_button.png"></a></li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstream FPGA design courses such as how to debug an FPGA design.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
