<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Logic usage and decoding return results with cascaded multiplexers</title>
  <meta name="description" content="About a week ago or so, I was working on aWishbonecross-bar interconnect.It seemed like a fun project to toy around with.  However, at one point in mydesign,...">

  <link rel="shortcut icon" type="image/x-icon" href="/img/GT.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://zipcpu.com/zipcpu/2019/03/28/return-decoding.html">
  <link rel="alternate" type="application/rss+xml" title="The ZipCPU by Gisselquist Technology" href="https://zipcpu.com/feed.xml">
</head>


  <body>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102570964-1', 'auto');
  ga('send', 'pageview');

</script>

    <header class="site-header">
  <div id="banner">
  <a href="/"><picture>
    <img height=120 id="site-logo" src="/img/fullgqtech.png" alt="Gisselquist Technology, LLC">
  </picture></A>
  </div>

  <div class="site-nav">
<ul>

<li><a HREF="/">Main/Blog</a>


<li><a HREF="/about/">About Us</a>


<li><a HREF="/fpga-hell.html">FPGA Hell</a>


<li><a HREF="/tutorial/">Tutorial</a>


<li><a HREF="/projects.html">Projects</a>


<li><a HREF="/topics.html">Site Index</a>


<li><a href="https://twitter.com/zipcpu"><span class="icon--twitter"><svg viewBox="0 0 400 400"><path fill="#1da1f2" d="M153.62,301.59c94.34,0,145.94-78.16,145.94-145.94,0-2.22,0-4.43-.15-6.63A104.36,104.36,0,0,0,325,122.47a102.38,102.38,0,0,1-29.46,8.07,51.47,51.47,0,0,0,22.55-28.37,102.79,102.79,0,0,1-32.57,12.45,51.34,51.34,0,0,0-87.41,46.78A145.62,145.62,0,0,1,92.4,107.81a51.33,51.33,0,0,0,15.88,68.47A50.91,50.91,0,0,1,85,169.86c0,.21,0,.43,0,.65a51.31,51.31,0,0,0,41.15,50.28,51.21,51.21,0,0,1-23.16.88,51.35,51.35,0,0,0,47.92,35.62,102.92,102.92,0,0,1-63.7,22A104.41,104.41,0,0,1,75,278.55a145.21,145.21,0,0,0,78.62,23"/></svg>
</span><span class="username">@zipcpu</span></a>

<li><a HREF="https://www.patreon.com/ZipCPU"><IMG SRC="/img/patreon_logomark_color_on_white.png" WIDTH="25"> Support</a>
</ul>
</div>


</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="https://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Logic usage and decoding return results with cascaded multiplexers</h1>
    <p class="post-meta"><time datetime="2019-03-28T00:00:00-04:00" itemprop="datePublished">Mar 28, 2019</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>About a week ago or so, I was working on a
<a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a>
<a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/wbxbar.v">cross-bar interconnect</a>.
It seemed like a fun project to toy around with.  However, at one point in my
design, things just weren’t working.  Personally, I was convinced
<a href="http://www.clifford.at/yosys">yosys</a> was at fault, but I couldn’t figure out
what the fault was.</p>

<p>So I set out about the task of creating a
<a href="http://www.clifford.at/yosys">yosys</a>
<a href="https://github.com/YosysHQ/yosys/issues">issue</a>.</p>

<p>The problem with creating a <a href="http://www.clifford.at/yosys">yosys</a>
<a href="https://github.com/YosysHQ/yosys/issues">issue</a>
is that most
<a href="https://github.com/YosysHQ/yosys/issues">issues</a>
are ignored unless you can provide a <a href="https://stackoverflow.com/help/mcve">minimal, complete, verifiable
example</a>
of the error.  For me, this is usually about 60-90 lines of code.  However,
usually when I turn in this 60-90 lines, <a href="https://twitter.com/oe1cxw">Clifford</a>
tends to school me: either pointing out how the fault was my own, or
otherwise he reduces my “minimal” example to 15 lines of code.</p>

<p>This time I was determined to create a better example of this bug myself first.
Who knows, perhaps I might have even been able to find the bug?</p>

<p>So I set up all of the configurable parameters just the way I wanted, and
ran <a href="http://www.clifford.at/yosys">yosys</a>.  At the prompt, I typed:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ yosys -ql log.txt
yosys&gt; read -sv wbxbar.v
yosys&gt; dump
yosys&gt; exit</code></pre></figure>

<p>Sure enough, if I squinted my eyes just right at the output in <code class="highlighter-rouge">log.txt</code>,
I felt like I could understand what was going on.</p>

<p>For example, I found things like:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  attribute \src "../../rtl/wbxbar.v:227"
  cell $mux $ternary$../../rtl/wbxbar.v:227$1146
    parameter \WIDTH 1
    connect \Y $ternary$../../rtl/wbxbar.v:227$1146_Y
    connect \S \r_stb [0]
    connect \B \r_we [0]
    connect \A \i_mwe [0]
  end</code></pre></figure>

<p>This appeared to describe a
<a href="https://en.wikipedia.org/wiki/Multiplexer">multiplexer</a>, where the output,
<code class="highlighter-rouge">\Y</code>, would be set to <code class="highlighter-rouge">\A</code> is <code class="highlighter-rouge">\S</code> was false, and to <code class="highlighter-rouge">\B</code> otherwise.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">)</span>
		<span class="n">Y</span> <span class="o">=</span> <span class="n">B</span><span class="o">;</span>
	<span class="k">else</span>
		<span class="n">Y</span> <span class="o">=</span> <span class="n">A</span><span class="o">;</span></code></pre></figure>

<p>If I looked at line 227 within <a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/wbxbar.v">my source file</a>, sure
enough, I could recognize some of the variables within my design: <code class="highlighter-rouge">r_stb[0]</code>,
<code class="highlighter-rouge">r_we[0]</code>, and even <code class="highlighter-rouge">i_mwe[0]</code>.  The <code class="highlighter-rouge">$ternary$../../rtl/wbxbar.v:227$1146_Y</code>
value really didn’t make much sense to me, but if I searched on this string
within the <code class="highlighter-rouge">log.txt</code> file, I could often find where that was an input to
another block, meaning that it was an intermediate piece of logic.</p>

<p>Then, as I started trying to back out what was going on in this giant file of
logic, I found a chain of several
<a href="https://en.wikipedia.org/wiki/Multiplexer">muxes</a> all in a row.  Sure, I
had to do some scratching through the output to try to put it back together.
No, it wasn’t easy, but I was convinced I was going to do this! If you adjust
the output format to make it easier to read, you can then see (roughly) what
I found:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  cell $mux ...
    connect \Y $one$
    connect \S av
    connect \B bdata
    connect \A adata
  end

  cell $mux ...
    connect \Y $two$
    connect \S cv
    connect \B cdata
    connect \A $one$
  end

  cell $mux ...
    connect \Y myoutput
    connect \S dv
    connect \B ddata
    connect \A $two$
  end</code></pre></figure>

<p>This is really simplified, but what I found was certainly a <em>long</em> chain of
these multiplexers, perhaps as many as sixteen in a row.</p>

<p>This new knowledge left me wondering, was I writing my logic properly?</p>

<h2 id="whats-wrong-with-cascaded-ifs">What’s wrong with cascaded if’s</h2>

<p>Okay, I’ll admit that I use cascaded if’s in my code all the time.  A classic
example of when I might use such a cascaded if is when decoding a
<a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a>
return within an
<a href="/blog/2017/06/22/simple-wb-interconnect.html">interconnect</a>.</p>

<p>The basic logic is something like,</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
<span class="k">begin</span>
	<span class="n">o_ack</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="n">o_data</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_slaves</span><span class="o">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">begin</span>
  		<span class="k">if</span> <span class="p">(</span><span class="n">slave_ack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">begin</span>
    			<span class="n">o_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    			<span class="n">o_data</span> <span class="o">=</span> <span class="n">slave_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">;</span>
		<span class="k">end</span>
	<span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>While <a href="/blog/2017/09/18/clocks-for-sw-engineers.html">I don’t normally use a for
loop</a>
for this logic, like I did in my
<a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/wbxbar.v">crossbar code</a>,
the <a href="https://github.com/ZipCPU/xulalx25soc/blob/79553b81c687f27ec8737be16179ea19186cb9e4/rtl/busmaster.v#L390-L395">result would roughly be the same</a>.</p>

<p>Now, consider what this look like once it was turned into
logic.  It would become something similar to,</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">begin</span>
	<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="n">tmp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave_ack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="k">begin</span>
  		<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  		<span class="n">tmp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">slave_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">begin</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave_ack</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="k">begin</span>
  		<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  		<span class="n">tmp_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">slave_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
  		<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_ack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  		<span class="n">tmp_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">begin</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave_ack</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">begin</span>
  		<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  		<span class="n">tmp_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">slave_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
  		<span class="n">tmp_ack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_ack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">;</span>
  		<span class="n">tmp_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">;</span>
	<span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>And so on …. as this would continue through processing eight separate slaves.</p>

<p>Immediately I was concerned: long chains of logic like this <a href="/blog/2017/09/18/clocks-for-sw-engineers.html">will impact the
clock rate this logic can run
at</a>!  In
general, as part of design, you want to minimize your longest path in
order to achieve high speed.  This logic, however was anything but minimum!</p>

<p>But could it be improved?</p>

<table align="center" style="float: right"><caption>Fig 1: A series of unbalanced multiplexers</caption><tr><td><img src="/img/mux-lopsided.svg" width="240" alt="" /></td></tr></table>

<p>Looking over this logic tree, it was very much a one-sided tree, much like the
one shown in Fig. 1 at the right.</p>

<p>In this figure, the inputs are at the bottom left, and the intersections 
within the tree represent the
<a href="https://en.wikipedia.org/wiki/Multiplexer">multiplexers</a>
<a href="http://www.clifford.at/yosys">yosys</a> placed into my design.  At the top,
then is the result of this logic.</p>

<p>What if I could balance the tree?</p>

<table align="center" style="float: left; padding: 15px"><caption>Fig 2: A balanced multiplexer tree</caption><tr><td><img src="/img/mux-balanced.svg" width="240" alt="" /></td></tr></table>

<p>Were I able to balance the tree, I might then use fewer
<a href="https://en.wikipedia.org/wiki/Multiplexer">multiplexers</a>,
the decoding logic would get far simpler, and the longest path far shorter,
perhaps as short as Fig 2 on the left.</p>

<p>Was it doable?</p>

<p>In this example, I was issuing requests to one of several slaves, never to more
than one slave at a time, then listening for the requests in return.  So I got
to thinking, what if I also created an index to describe the one slave that
would respond?  In that fashion, the above code could be simplified to
something closer to:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
<span class="k">begin</span>
	<span class="n">o_ack</span>  <span class="o">=</span> <span class="n">slave_ack</span><span class="p">[</span><span class="n">slave_index</span><span class="p">]</span><span class="o">;</span>
	<span class="n">o_data</span> <span class="o">=</span> <span class="n">slave_data</span><span class="p">[</span><span class="n">slave_index</span><span class="p">]</span><span class="o">;</span>
<span class="k">end</span></code></pre></figure>

<p>Alternatively, I could’ve written this output in a case statement–had I
known how many slaves.  An example of such a case statement for four slaves
might look something like,</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
<span class="k">case</span><span class="p">(</span><span class="n">slave_index</span><span class="p">)</span>
	<span class="mb">2'b00</span><span class="o">:</span> <span class="o">{</span> <span class="n">o_ack</span><span class="o">,</span> <span class="n">o_data</span> <span class="o">}</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="n">slave_ack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span> <span class="n">slave_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">2'b01</span><span class="o">:</span> <span class="o">{</span> <span class="n">o_ack</span><span class="o">,</span> <span class="n">o_data</span> <span class="o">}</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="n">slave_ack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">,</span> <span class="n">slave_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">2'b10</span><span class="o">:</span> <span class="o">{</span> <span class="n">o_ack</span><span class="o">,</span> <span class="n">o_data</span> <span class="o">}</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="n">slave_ack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">,</span> <span class="n">slave_dat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">};</span>
	<span class="mb">2'b11</span><span class="o">:</span> <span class="o">{</span> <span class="n">o_ack</span><span class="o">,</span> <span class="n">o_data</span> <span class="o">}</span> <span class="o">&lt;=</span> <span class="o">{</span> <span class="n">slave_ack</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">,</span> <span class="n">slave_dat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">};</span>
<span class="k">endcase</span></code></pre></figure>

<p>Surely that would be better, right?</p>

<p>It was time to run some tests.</p>

<h2 id="the-basic-logic-test">The basic logic test</h2>

<p>Some time ago, I had the wonderful opportunity to meet
<a href="https://twitter.com/jangray">Jan Gray</a>.  While you may
know me for advertising a resource constrained 32-bit
<a href="https://en.wikipedia.org/wiki/Soft_microprocessor">CPU</a>
that I call the
<a href="/about/zipcpu.html">ZipCPU</a>,
<a href="https://twitter.com/jangray">Jan</a> has been known
for stuffing many, many
<a href="https://en.wikipedia.org/wiki/Soft_microprocessor">CPU</a>s
within an
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>.</p>

<p>Much as I hate to admit it, his
<a href="https://en.wikipedia.org/wiki/Soft_microprocessor">CPU</a>s
are often much smaller than mine.  So, I asked him, how do you get your
<a href="https://en.wikipedia.org/wiki/Soft_microprocessor">CPU</a>s
that small?  I found his answer very enlightening.</p>

<p>He said, and I’m paraphrasing here, to start with the clock rate you want to
achieve.  Then start piecing small bits of logic together here and there, and
just run these tiny pieces of logic through the synthesizer–never the whole
design.  Look at what the synthesizer does with these tiny pieces, the number
of <a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
they create, their timing performance, and then optimize these small
pieces at the low level.  In this way, you can gradually work your way up to
the whole.</p>

<p>No, that’s not a direct quote.  About a year and a half has passed since that
conversation, but his point remains: optimize your design piecemeal at the
very low level, and learn optimization there.  It will then be easier to create
a larger design from the lessons you’ve learned.</p>

<p>So, let’s do that here!</p>

<p>Imagine if you will that we have four sources of data, <code class="highlighter-rouge">a</code> through <code class="highlighter-rouge">d</code>.  Each
of these sources has a select line, <code class="highlighter-rouge">asel</code> through <code class="highlighter-rouge">dsel</code>, telling us when
their respective data words, <code class="highlighter-rouge">adata</code> through <code class="highlighter-rouge">ddata</code> are valid.  Our goal
will be to set our own output, <code class="highlighter-rouge">odata</code>, to contain the data from the one valid
input data word.</p>

<p>The code for this would look something like the one below.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">testa</span><span class="p">(</span><span class="n">asel</span><span class="o">,</span> <span class="n">adata</span><span class="o">,</span> <span class="n">bsel</span><span class="o">,</span> <span class="n">bdata</span><span class="o">,</span> <span class="n">csel</span><span class="o">,</span> <span class="n">cdata</span><span class="o">,</span> <span class="n">dsel</span><span class="o">,</span> <span class="n">ddata</span><span class="o">,</span> <span class="n">odata</span><span class="p">)</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>            <span class="n">asel</span><span class="o">,</span> <span class="n">bsel</span><span class="o">,</span> <span class="n">csel</span><span class="o">,</span> <span class="n">dsel</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>    <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">adata</span><span class="o">,</span> <span class="n">bdata</span><span class="o">,</span> <span class="n">cdata</span><span class="o">,</span> <span class="n">ddata</span><span class="o">;</span>
        <span class="kt">output</span>  <span class="kt">reg</span>     <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">odata</span><span class="o">;</span>

        <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">asel</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bsel</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">bdata</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csel</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">;</span>
        <span class="k">else</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">ddata</span><span class="o">;</span>

<span class="k">endmodule</span></code></pre></figure>

<p>Let’s run this through <a href="http://www.clifford.at/yosys">yosys</a> and see what we
can learn.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">% </span>yosys
<span class="gp">yosys&gt; </span><span class="nb">read</span> -sv test.v
<span class="c"># ... lots of stuff</span>
<span class="gp">yosys&gt; </span>synth_ice40 -top testa
<span class="c"># ... skipping even more stuff, then ...</span>
<span class="c">#</span>
2.42. Printing statistics.

<span class="o">===</span> testa <span class="o">===</span>

   Number of wires:                 73
   Number of wire bits:            228
   Number of public wires:           9
   Number of public wire bits:     164
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                 96
     SB_LUT4                        96

2.43. Executing CHECK pass <span class="o">(</span>checking <span class="k">for </span>obvious problems<span class="o">)</span>.
checking module testa..
found and reported 0 problems.

yosys&gt;</code></pre></figure>

<p>So we now know that this code would cost us 96
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s–essentially 3
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
for every outgoing data bit.</p>

<p>Can we do better?</p>

<p>Suppose we instead had an <code class="highlighter-rouge">index</code>, which could indicate for us which of the
four inputs we wanted to set our output to.  Such an example might look like
this one:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">testb</span><span class="p">(</span><span class="n">index</span><span class="o">,</span> <span class="n">adata</span><span class="o">,</span> <span class="n">bdata</span><span class="o">,</span> <span class="n">cdata</span><span class="o">,</span> <span class="n">ddata</span><span class="o">,</span> <span class="n">odata</span><span class="p">)</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>    <span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>   <span class="n">index</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>    <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">adata</span><span class="o">,</span> <span class="n">bdata</span><span class="o">,</span> <span class="n">cdata</span><span class="o">,</span> <span class="n">ddata</span><span class="o">;</span>   
        <span class="kt">output</span>  <span class="kt">reg</span>     <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">odata</span><span class="o">;</span>

        <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="k">case</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="mb">2'b00</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">;</span>
        <span class="mb">2'b01</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">bdata</span><span class="o">;</span>
        <span class="mb">2'b00</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">;</span>
        <span class="mb">2'b01</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">ddata</span><span class="o">;</span>
        <span class="k">endcase</span>
<span class="k">endmodule</span></code></pre></figure>

<p>This time, <a href="http://www.clifford.at/yosys">yosys</a> tells us that
we could calculate our outgoing data using only two
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
per output bit.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">2.42. Printing statistics.
=== testb ===

   Number of wires:                 38
   Number of wire bits:            194
   Number of public wires:           6
   Number of public wire bits:     162
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                 64
     SB_LUT4                        64</code></pre></figure>

<p>If you find yourself like me, scrounging for every
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>
you can in order to maintain your reputation as a log-logic designer, 32
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
is a <em>big</em> difference.  It might get even bigger if this sort of savings
could be replicated across the design.</p>

<h2 id="moving-to-the-cpu">Moving to the CPU</h2>

<table align="center" style="float: right"><caption>Fig 3: The ZipCPU has four basic data calculation units: ALU, memory, divide and the (not yet built) FPU</caption><tr><td><img src="/img/zipcpu.svg" width="360" alt="" /></td></tr></table>

<p>So I took a look within the <a href="/about/zipcpu.html">ZipCPU</a>.
As you may recall, the <a href="/about/zipcpu.html">ZipCPU</a>  has a
couple of functional units.  There’s the <a href="/zipcpu/2017/08/11/simple-alu.html">ALU, which can perform basic
arithmetic</a>,
the <a href="https://github.com/ZipCPU/zipcpu/blob/master/rtl/core/memops.v">memory unit, which can load values from memory and stores them back again</a>,
and the <a href="https://github.com/ZipCPU/zipcpu/blob/master/rtl/core/div.v">divide
unit</a>.  Not shown
in Fig. 3, is the fact that the <a href="/zipcpu/2017/08/25/hw-debugging.html">external debugging
port</a>
can also write values to the registers within the
<a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>.
I’ve also dreamed of creating a floating point unit, so let’s include that in
our discussion as well.</p>

<p>Now, each of these three units can return a <code class="highlighter-rouge">valid</code> signal, indicating that it
has an item to write to the register file, a <code class="highlighter-rouge">data</code> signal, containing the
data to be written, and similarly, many of the units can return an error signal.</p>

<p><a href="https://github.com/ZipCPU/zipcpu/blob/b3bee662b54a54d5b9ff27379e52d79b1e7f0a88/rtl/core/zipcpu.v#L1759-L1769">The logic, then, to determine when to write a value to a register looks
something like the following</a>:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">assign</span>	<span class="n">wr_reg_ce</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbgv</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">mem_valid</span><span class="p">)</span>
				<span class="o">||</span><span class="p">((</span><span class="o">!</span><span class="n">clear_pipeline</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="n">alu_illegal</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span><span class="p">(((</span><span class="n">alu_wR</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">alu_valid</span><span class="p">))</span>
						<span class="o">||</span><span class="p">((</span><span class="n">div_valid</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="n">div_error</span><span class="p">))</span>
						<span class="o">||</span><span class="p">((</span><span class="n">fpu_valid</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="n">fpu_error</span><span class="p">))))</span><span class="o">;</span></code></pre></figure>

<p>Does this look at all like the logic cascade we were dealing with above?</p>

<p>How about the <a href="https://github.com/ZipCPU/zipcpu/blob/b3bee662b54a54d5b9ff27379e52d79b1e7f0a88/rtl/core/zipcpu.v#L1793-L1799">logic to determine which of the various values needs to be
written to the register file</a>?
That looks like another logic cascade:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">assign</span>	<span class="n">wr_gpreg_vl</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem_valid</span><span class="p">)</span> <span class="o">?</span> <span class="n">mem_result</span>
				<span class="o">:</span><span class="p">((</span><span class="n">div_valid</span><span class="o">|</span><span class="n">fpu_valid</span><span class="p">))</span>
					<span class="o">?</span> <span class="p">((</span><span class="n">div_valid</span><span class="p">)</span> <span class="o">?</span> <span class="n">div_result</span><span class="o">:</span><span class="n">fpu_result</span><span class="p">)</span>
				<span class="o">:</span><span class="p">((</span><span class="n">dbgv</span><span class="p">)</span> <span class="o">?</span> <span class="n">dbg_val</span> <span class="o">:</span> <span class="n">alu_result</span><span class="p">))</span><span class="o">;</span></code></pre></figure>

<p>Well, actually, it’s worse.  If you look at the code I referenced above,
you’ll notice that I calculated the value twice, once for <code class="highlighter-rouge">wr_gpreg_vl</code> and
another time for <code class="highlighter-rouge">wr_spreg_vl</code>.  I had to do this just to keep any updates to
the <a href="https://en.wikipedia.org/wiki/Program_counter">program counter</a>
and the <a href="https://en.wikipedia.org/wiki/Status_register">status register</a>
off of the critical path.</p>

<p><a href="https://github.com/ZipCPU/zipcpu/blob/b3bee662b54a54d5b9ff27379e52d79b1e7f0a88/rtl/core/zipcpu.v#L1793-L1799">This logic</a>
doesn’t need to be so complex!</p>

<p>The <a href="/about/zipcpu.html">ZipCPU</a> is very much an in order
processor.  Sure, it is
<a href="/zipcpu/2017/08/23/cpu-pipeline.html">pipelined</a>,
but by the time you get to this stage in the
<a href="/zipcpu/2017/08/23/cpu-pipeline.html">pipeline</a>,
you already know what component will be producing a value.  Hence, I
could’ve  used an index instead.</p>

<p>So let’s instead create a simple test, just to estimate what the impact
of this change will be.  Let’s say that this is our current logic.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">testcpu</span><span class="p">(</span><span class="n">dbgv</span><span class="o">,</span> <span class="n">clear</span><span class="o">,</span> <span class="n">wb</span><span class="o">,</span> <span class="n">aluv</span><span class="o">,</span> <span class="n">memv</span><span class="o">,</span> <span class="n">divv</span><span class="o">,</span> <span class="n">fpuv</span><span class="o">,</span>
		<span class="n">dbgerr</span><span class="o">,</span> <span class="n">aluerr</span><span class="o">,</span> <span class="n">memerr</span><span class="o">,</span> <span class="n">diverr</span><span class="o">,</span> <span class="n">fpuerr</span><span class="o">,</span>
                <span class="n">dbgdata</span><span class="o">,</span> <span class="n">aludata</span><span class="o">,</span> <span class="n">memdata</span><span class="o">,</span> <span class="n">divdata</span><span class="o">,</span> <span class="n">fpudata</span><span class="o">,</span>
                <span class="n">ov</span><span class="o">,</span> <span class="n">odata</span><span class="p">)</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>            <span class="n">dbgv</span><span class="o">,</span> <span class="n">clear</span><span class="o">,</span> <span class="n">wb</span><span class="o">,</span> <span class="n">aluv</span><span class="o">,</span> <span class="n">memv</span><span class="o">,</span> <span class="n">divv</span><span class="o">,</span> <span class="n">fpuv</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>            <span class="n">dbgerr</span><span class="o">,</span> <span class="n">aluerr</span><span class="o">,</span> <span class="n">memerr</span><span class="o">,</span> <span class="n">diverr</span><span class="o">,</span> <span class="n">fpuerr</span><span class="o">;</span>
        <span class="kt">input</span>   <span class="kt">wire</span>    <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">dbgdata</span><span class="o">,</span> <span class="n">aludata</span><span class="o">,</span> <span class="n">memdata</span><span class="o">,</span> <span class="n">divdata</span><span class="o">,</span> <span class="n">fpudata</span><span class="o">;</span>
        <span class="kt">output</span>  <span class="kt">reg</span>             <span class="n">ov</span><span class="o">;</span>
        <span class="kt">output</span>  <span class="kt">reg</span>     <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>  <span class="n">odata</span><span class="o">;</span>

        <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbgv</span> <span class="o">|</span> <span class="n">memv</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="n">wb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
        	<span class="p">((</span><span class="n">aluv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aluerr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">memv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memerr</span><span class="p">)</span>
			<span class="o">||</span><span class="p">(</span><span class="n">divv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">diverr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fpuv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fpuerr</span><span class="p">))</span><span class="o">;</span>

        <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">memv</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">memdata</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">divv</span> <span class="o">|</span> <span class="n">fpuv</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="p">(</span><span class="n">divv</span> <span class="o">?</span> <span class="n">divdata</span> <span class="o">:</span> <span class="n">fpudata</span><span class="p">)</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dbgv</span><span class="p">)</span>
                <span class="n">odata</span> <span class="o">=</span> <span class="n">dbgdata</span><span class="o">;</span>
        <span class="k">else</span> <span class="c1">// if (aluv)
</span>                <span class="n">odata</span> <span class="o">=</span> <span class="n">aludata</span><span class="o">;</span>
<span class="k">endmodule</span></code></pre></figure>

<p>If you compare this to the <a href="https://github.com/ZipCPU/zipcpu/blob/b3bee662b54a54d5b9ff27379e52d79b1e7f0a88/rtl/core/zipcpu.v#L1793-L1799">actual logic above</a>,
you should see some strong similarities.</p>

<p>So let’s ask, how much logic does this use?  A quick run through
<a href="http://www.clifford.at/yosys">yosys</a> yields the following result:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">2.42. Printing statistics.

=== testcpu ===

   Number of wires:                117
   Number of wire bits:            303
   Number of public wires:          19
   Number of public wire bits:     205
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                131
     SB_LUT4                       131</code></pre></figure>

<p>Can we do better?</p>

<p>Sure we can!  Let’s add in just a little bit of precursor logic.  In this
case, imagine we know we will have to write to the
<a href="/zipcpu/2017/08/11/simple-alu.html">ALU</a>
on the clock after <code class="highlighter-rouge">prealu</code> is true, and likewise for the other values.
This means we’ll need to create an <code class="highlighter-rouge">index</code> first from these <code class="highlighter-rouge">pre*</code> values,
and so change our test case to:</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">testcpui</span><span class="p">(</span><span class="n">i_clk</span><span class="o">,</span> <span class="n">pred</span><span class="o">,</span> <span class="n">prealu</span><span class="o">,</span> <span class="n">premem</span><span class="o">,</span> <span class="n">prediv</span><span class="o">,</span> <span class="n">prefpu</span><span class="o">,</span>
		<span class="n">dbgv</span><span class="o">,</span> <span class="n">clear</span><span class="o">,</span> <span class="n">wb</span><span class="o">,</span> <span class="n">aluv</span><span class="o">,</span> <span class="n">memv</span><span class="o">,</span> <span class="n">divv</span><span class="o">,</span> <span class="n">fpuv</span><span class="o">,</span>
		<span class="n">dbgerr</span><span class="o">,</span> <span class="n">aluerr</span><span class="o">,</span> <span class="n">memerr</span><span class="o">,</span> <span class="n">diverr</span><span class="o">,</span> <span class="n">fpuerr</span><span class="o">,</span>
		<span class="n">dbgdata</span><span class="o">,</span> <span class="n">aludata</span><span class="o">,</span> <span class="n">memdata</span><span class="o">,</span> <span class="n">divdata</span><span class="o">,</span> <span class="n">fpudata</span><span class="o">,</span>
		<span class="n">ov</span><span class="o">,</span> <span class="n">odata</span><span class="p">)</span><span class="o">;</span>
	<span class="kt">input</span>	<span class="kt">wire</span>		<span class="n">i_clk</span><span class="o">;</span>
	<span class="kt">input</span>	<span class="kt">wire</span>		<span class="n">pred</span><span class="o">,</span> <span class="n">prealu</span><span class="o">,</span> <span class="n">premem</span><span class="o">,</span> <span class="n">prediv</span><span class="o">,</span> <span class="n">prefpu</span><span class="o">;</span>
	<span class="kt">input</span>	<span class="kt">wire</span>		<span class="n">dbgv</span><span class="o">,</span> <span class="n">clear</span><span class="o">,</span> <span class="n">wb</span><span class="o">,</span> <span class="n">aluv</span><span class="o">,</span> <span class="n">memv</span><span class="o">,</span> <span class="n">divv</span><span class="o">,</span> <span class="n">fpuv</span><span class="o">;</span>
	<span class="kt">input</span>	<span class="kt">wire</span>		<span class="n">dbgerr</span><span class="o">,</span> <span class="n">aluerr</span><span class="o">,</span> <span class="n">memerr</span><span class="o">,</span> <span class="n">diverr</span><span class="o">,</span> <span class="n">fpuerr</span><span class="o">;</span>
	<span class="kt">input</span>	<span class="kt">wire</span>	<span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">dbgdata</span><span class="o">,</span> <span class="n">aludata</span><span class="o">,</span> <span class="n">memdata</span><span class="o">,</span> <span class="n">divdata</span><span class="o">,</span> <span class="n">fpudata</span><span class="o">;</span>
	<span class="kt">output</span>	<span class="kt">reg</span>		<span class="n">ov</span><span class="o">;</span>
	<span class="kt">output</span>	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">odata</span><span class="o">;</span>

	<span class="kt">reg</span>	<span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span>	<span class="n">index</span><span class="o">;</span>

	<span class="k">initial</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">i_clk</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pred</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">3'h0</span><span class="o">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prealu</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">3'h1</span><span class="o">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">premem</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">3'h2</span><span class="o">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prediv</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">3'h3</span><span class="o">;</span>
	<span class="k">else</span> <span class="c1">// if (fpuv)
</span>		<span class="n">index</span> <span class="o">&lt;=</span> <span class="mh">3'h4</span><span class="o">;</span></code></pre></figure>

<p>Once we have this three bit index, we can now create logic based around a case
statement to decode our results.  As before <code class="highlighter-rouge">ov</code> will tell us when our output is
valid and hence when we need to write to the register file,</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
	<span class="mh">3'h0</span><span class="o">:</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbgv</span><span class="p">)</span><span class="o">;</span>
	<span class="mh">3'h1</span><span class="o">:</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aluv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aluerr</span><span class="p">)</span><span class="o">;</span>
	<span class="mh">3'h2</span><span class="o">:</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">memv</span><span class="p">)</span><span class="o">;</span>
	<span class="mh">3'h3</span><span class="o">:</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">divv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">diverr</span><span class="p">)</span><span class="o">;</span>
	<span class="mh">3'h4</span><span class="o">:</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpuv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fpuerr</span><span class="p">)</span><span class="o">;</span>
	<span class="nl">default:</span> <span class="n">ov</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">endcase</span></code></pre></figure>

<p>whereas <code class="highlighter-rouge">odata</code> will be the value we write to the register file.</p>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	<span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
	<span class="mh">3'h0</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">dbgdata</span><span class="o">;</span>
	<span class="mh">3'h1</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">aludata</span><span class="o">;</span>
	<span class="mh">3'h2</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">memdata</span><span class="o">;</span>
	<span class="mh">3'h3</span><span class="o">:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">divdata</span><span class="o">;</span>
	<span class="nl">default:</span> <span class="n">odata</span> <span class="o">=</span> <span class="n">fpudata</span><span class="o">;</span>
	<span class="k">endcase</span>

<span class="k">endmodule</span></code></pre></figure>

<p>What kind of logic usage might this garner?</p>

<p>Any guesses?</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">=== testcpui ===

   Number of wires:                103
   Number of wire bits:            291
   Number of public wires:          26
   Number of public wire bits:     214
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                113
     SB_DFFSR                        3
     SB_LUT4                       110</code></pre></figure>

<p>110 <a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s!
That’s a savings of nearly 20%!</p>

<p>What about that <code class="highlighter-rouge">SB_DFFSR</code> line?  That’s new.  Those three <code class="highlighter-rouge">SB_DFFSR</code>s
are the
<a href="https://en.wikipedia.org/wiki/Flip-flop_(electronics)">flip-flops</a>
holding the three bits of our index.  In most all of my designs, I’ve been
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>
starved, not
<a href="https://en.wikipedia.org/wiki/Flip-flop_(electronics)">flip-flops</a>
starved, so I’m not really worried about these.</p>

<h2 id="resource-measurement-is-not-just-for-ice40s">Resource measurement is not just for iCE40s</h2>

<p>Did you know you could measure resource usage for
<a href="http://www.xilinx.com">Xilinx</a> chips,
<a href="http://www.intel.com">Intel</a> chips, as well as
<a href="/blog/2017/10/13/fpga-v-asic.html">ASIC</a> gates
using this approach with <a href="http://www.clifford.at/yosys">yosys</a>?</p>

<p>If you wanted to do this for a <a href="http://www.xilinx.com">Xilinx</a>
design, for example, all you’d need to change is the
<a href="http://www.clifford.at/yosys/cmd_synth_ice40.html">synth_ice40</a> line to a
<a href="http://www.clifford.at/yosys/cmd_synth_xilinx.html">synth_xilinx</a> line.
Indeed, in my experience, you’ll also get a much faster result using
<a href="http://www.clifford.at/yosys">yosys</a> than using any of the
Vendor tools–<a href="https://www.xilinx.com/products/design-tools/vivado.html">Vivado</a>, <a href="https://www.xilinx.com/products/design-tools/ise-design-suite.html">ISE</a>,
or even <a href="https://www.intel.com/content/www/us/en/software/programmable/quartus-prime/download.html">Quartus</a>.
Feel free to check me out on this.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ yosys
yosys&gt; read -sv test.v
yosys&gt; synth_xilinx -top testcpu
# ... 
=== testcpu ===

   Number of wires:                116
   Number of wire bits:            302
   Number of public wires:          19
   Number of public wire bits:     205
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                130
     LUT3                           32
     LUT5                            1
     LUT6                           65
     MUXF7                          32</code></pre></figure>

<p>So our basic design would require 65 6-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s, one 5-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>, and 32 3-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s.  The 32 MUXF7s are
needed to combine 64 of those 6-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
together in order to make 32 7-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s.</p>

<p>If you now swap design approaches to use the index, the
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>
usage drops dramatically:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">=== testcpui ===

   Number of wires:                 67
   Number of wire bits:            257
   Number of public wires:          26
   Number of public wire bits:     214
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                 79
     FDRE                            3
     LUT2                            5
     LUT3                            1
     LUT4                            1
     LUT5                           16
     LUT6                           52
     MUXF7                           1</code></pre></figure>

<p>If you figure that the MUXF7s are really there for free, then we dropped
our logic needs from 98 6-input
<a href="https://en.wikipedia.org/wiki/Logic_block">LUT</a>s
down to 78–again this is about a 20% improvement or so.</p>

<p>Ever had to try to answer the question, “how complex is your design?” and the
questioner wants your answer in gates?  We can do that too!  In this case,
just run <a href="http://www.clifford.at/yosys/cmd_dump.html">synth</a>,
a generic synthesis routine, followed by
<a href="http://www.clifford.at/yosys/cmd_abc.html">abc -g cmos2</a>,
to map your design to traditional CMOS gates, and then
<a href="http://www.clifford.at/yosys/cmd_abc.html">stat</a>
to report the results.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ yosys
yosys&gt; read -sv test.v
yosys&gt; synth
yosys&gt; abc -g cmos2
yosys&gt; stat
=== testcpu ===

   Number of wires:                729
   Number of wire bits:            915
   Number of public wires:          19
   Number of public wire bits:     205
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                433
     $_NAND_                       293
     $_NOR_                         70
     $_NOT_                         70</code></pre></figure>

<p>That is, our pre-optimized design will require 293 NAND gates, 70 NOR gates,
and another 70 NOT gates.</p>

<p>Similarly, after our optimization, you’d get:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">=== testcpui ===

   Number of wires:                856
   Number of wire bits:           1046
   Number of public wires:          26
   Number of public wire bits:     214
   Number of memories:               0
   Number of memory bits:            0
   Number of processes:              0
   Number of cells:                396
     $_DFF_P_                        3
     $_NAND_                       238
     $_NOR_                         80
     $_NOT_                         75</code></pre></figure>

<p>If we don’t count the
<a href="https://en.wikipedia.org/wiki/Flip-flop_(electronics)">flip-flops</a>,
then you can see that we’ve dropped from 433 gates down to 393.  This time the
savings isn’t nearly as much, but 10% fewer gates translates to area in the
<a href="/blog/2017/10/13/fpga-v-asic.html">ASIC</a>
business, and lower area translates to lower cost.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Perhaps you’ve picked up on a couple of points from this discussion.  First,
if you are concerned about <a href="/blog/2017/06/12/minimizing-luts.html">minimum area and minimum
logic</a>,
then it’s important to know a bit about what’s happening under the hood.
Second, that <a href="http://www.clifford.at/yosys">yosys</a>
<a href="http://www.clifford.at/yosys/cmd_dump.html">dump</a>
command was what tipped me off to what was going on under the hood.
<a href="http://www.clifford.at/yosys">Yosys</a> also supports a 
<a href="http://www.clifford.at/yosys/cmd_show.html">show</a> command
for those who would rather view this information graphically.  Third,
you can compare various design techniques in seconds when using
<a href="http://www.clifford.at/yosys">yosys</a>.  It’s really quite a valuable lesson.</p>

<p>I’ve just rewritten how
<a href="/zipcpu/2017/10/05/autofpga-intro.html">AutoFPGA</a>
handles its address decoding as a result.  While I’m still working through some
of the pains of that rewrite, it turns out that it wasn’t all that hard to do.</p>

<p>Adjusting how the
<a href="/about/zipcpu.html">ZipCPU</a>
determines whether or not to write back, and which
value to write back to the register file is likely to be next.  Perhaps you
might want to consider at this point, what
<a href="/blog/2017/10/19/formal-intro.html">formal properties</a>
could be used in a switch like this, and how easy (or hard) would it be
to convince yourself that the updated code still worked as before?</p>

<p>I should also mention, there is another competing theory out there espoused by
the major vendors.  This theory is that you should build your design, count up
the gates you need, and buy your chip.  If your algorithm doesn’t fit in the
chip, then you need to buy a bigger chip and possibly even build a bigger board.
This also applies to much of the vendor supplied IP.  The major vendors have no 
incentive to build low-logic designs, if their low logic designs would keep you
from buying more of their product.</p>

<p>Think about it.</p>

<p>Oh, one more thing, remember that bug that sent me looking into the
<a href="http://www.clifford.at/yosys">yosys</a>
<a href="http://www.clifford.at/yosys/cmd_dump.html">dump</a> in the
first place?  Yeah, that one.  It was my own fault.  The problem was just
obscured by the for loop I was using, and the fact that <a href="/blog/2017/09/18/clocks-for-sw-engineers.html">for loops in Verilog
don’t work like they do in
C++</a>.</p>

  </div>


<div class "verse">
<HR align="center;" width="25%">
<P><em>It is naught, it is naught, saith the buyer: but when he is gone his way, then he boasteth. (Prov 20:14)</em>


</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The ZipCPU by Gisselquist Technology</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <!-- <li></li> -->
          <li><a href="mailto:zipcpu@gmail.com">zipcpu@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="soc-medlist">
          
          <li>
            <a href="https://github.com/ZipCPU"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ZipCPU</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/zipcpu"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">@zipcpu</span></a>

          </li>
          
          
          <li><A href="https://www.patreon.com/ZipCPU"><img src="/img/become_a_patron_button.png"></a></li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstream FPGA design courses such as how to debug an FPGA design.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
