<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Demonstrating the improved PWM waveform</title>
  <meta name="description" content="This post follows our prior post titledReinventing PWM.A reader has commented to me that I hadn’t posted any test bench or othermethod to prove that this mod...">

  <link rel="shortcut icon" type="image/x-icon" href="/img/GT.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://zipcpu.com/dsp/2017/09/16/pwm-demo.html">
  <link rel="alternate" type="application/rss+xml" title="The ZipCPU by Gisselquist Technology" href="https://zipcpu.com/feed.xml">
</head>


  <body>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZK7HKHSVW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4ZK7HKHSVW');
</script>

    <header class="site-header">
  <div id="banner">
  <a href="/"><picture>
    <img height=120 id="site-logo" src="/img/fullgqtech.png" alt="Gisselquist Technology, LLC">
  </picture></A>
  </div>

  <div class="site-nav">
<ul>

<li><a HREF="/">Main/Blog</a>


<li><a HREF="/about/">About Us</a>


<li><a HREF="/fpga-hell.html">FPGA Hell</a>


<li><a HREF="/tutorial/">Tutorial</a>
<li><a HREF="/tutorial/formal.html">Formal training</a>


<li><a HREF="/quiz/quizzes.html">Quizzes</a>


<li><a HREF="/projects.html">Projects</a>


<li><a HREF="/topics.html">Site Index</a>

<HR>

<li><a href="https://twitter.com/zipcpu"><span class="icon--twitter"><svg viewBox="0 0 400 400"><path fill="#1da1f2" d="M153.62,301.59c94.34,0,145.94-78.16,145.94-145.94,0-2.22,0-4.43-.15-6.63A104.36,104.36,0,0,0,325,122.47a102.38,102.38,0,0,1-29.46,8.07,51.47,51.47,0,0,0,22.55-28.37,102.79,102.79,0,0,1-32.57,12.45,51.34,51.34,0,0,0-87.41,46.78A145.62,145.62,0,0,1,92.4,107.81a51.33,51.33,0,0,0,15.88,68.47A50.91,50.91,0,0,1,85,169.86c0,.21,0,.43,0,.65a51.31,51.31,0,0,0,41.15,50.28,51.21,51.21,0,0,1-23.16.88,51.35,51.35,0,0,0,47.92,35.62,102.92,102.92,0,0,1-63.7,22A104.41,104.41,0,0,1,75,278.55a145.21,145.21,0,0,0,78.62,23"/></svg>
</span><span class="username">@zipcpu</span></a>

<li><a href="https://www.reddit.com/r/ZipCPU"><span class="username">Reddit</a>
<li><a HREF="https://www.patreon.com/ZipCPU"><IMG SRC="/img/patreon_logomark_color_on_white.png" WIDTH="25"> Support</a>
</ul>
</div>


</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="https://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Demonstrating the improved PWM waveform</h1>
    <p class="post-meta"><time datetime="2017-09-16T00:00:00-04:00" itemprop="datePublished">Sep 16, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This post follows our prior post titled
<a href="/dsp/2017/09/04/pwm-reinvention.html">Reinventing PWM</a>.
A reader has commented to me that I hadn’t posted any test bench or other
method to prove that this module works.  Since I also think that such a test
would be beneficial, I’ve created a <a href="https://github.com/ZipCPU/wbpwmaudio/tree/master/demo-rtl">test bench and
demonstration</a>
which we will examine below.</p>

<p>Most of the parts and pieces of our test code, and certainly the methodology,
could easily be applied to test just about any <a href="https://en.wikipedia.org/wiki/Digital_signal_processing">Digital Signal Processing
(DSP)</a>
system.  In short, we’ll put a test signal into the design, make some
predictions about how we think that test signal will behave, and then
measure the response to see how well it does and whether or not the
results match our predictions.</p>

<p>The classic test signals for any signal processing application are
<a href="https://en.wikipedia.org/wiki/Sine_wave">sine waves</a> and
<a href="https://en.wikipedia.org/wiki/Dirac_delta_function">impulses</a>.  For
our purposes today, we’ll focus on just the
<a href="https://en.wikipedia.org/wiki/Sine_wave">sine wave</a> input.
Specifically, let’s look at both a constant frequency and a swept frequency
<a href="https://en.wikipedia.org/wiki/Sine_wave">sine wave</a> input, and measure
the result the hardware provides.  We’ll also adjust our approach for both
sampling rates and volume variations.</p>

<p>To do this, we’ll build a test design of the form shown in Fig 1.</p>

<table style="float: none"><caption>Fig 1: Test Setup</caption><tr><td><img src="/img/pwm-demo/pwmtb-setup.svg" alt="Block diagram of a PDM vs PWM test" width="780" /></td></tr></table>

<p>The test-suite design will consist not only of <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/toplevel.v">Verilog based
logic</a>,
but also a C++ <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">test bench
driver</a>
that can be used to run the
<a href="https://www.veripool.org/wiki/verilator">Verilator</a> based simulation.  This
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">C++
portion</a>
will be used to <a href="https://en.wikipedia.org/wiki/Digital_filter">filter</a> and
<a href="https://en.wikipedia.org/wiki/Sample-rate_conversion">resample</a>
the 100MHz <a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
output pin values in order to create a file which can easily be ingested
and inspected within <a href="https://www.gnu.org/software/octave/">Octave</a>.</p>

<p>To control this design, we’ll have the sweep and frequency control selected
from a table at the top of each second over an 8-second repeating test
interval.  Over these 8-seconds, we’ll apply the following test cases to
demonstrate the <a href="/dsp/2017/09/04/pwm-reinvention.html">improved
PWM</a> generator:</p>

<table>
  <thead>
    <tr>
      <th>Second</th>
      <th>On/Off</th>
      <th>Test Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0-2</td>
      <td>ON</td>
      <td>Swept tone from 110Hz to 27.3kHz</td>
    </tr>
    <tr>
      <td>3</td>
      <td>off</td>
      <td> </td>
    </tr>
    <tr>
      <td>4-5</td>
      <td>ON</td>
      <td>440 Hz Tone</td>
    </tr>
    <tr>
      <td>6-7</td>
      <td>off</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>We’ll also run the sine wave initially at it’s full amplitude, just to
demonstrate that there are no problems with the internal comparisons as
a function of range.  We’ll later adjust to <code class="language-plaintext highlighter-rouge">1/256</code>th of that amount to
demonstrate that the method works reasonably for small amplitudes as well.</p>

<p>We’ll use a physical switch input to select between which of the two outputs
we send to a <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier">PMod
AMP2</a>
(should you happen to have one, and should you wish to try this in actual
hardware).</p>

<p>Finally, we’ll place all the code for this test
<a href="https://github.com/ZipCPU/wbpwmaudio/tree/master/demo-rtl">online</a>
within the
<a href="https://github.com/ZipCPU/wbpwmaudio">wbpwmaudio</a>
repository.  This will allow you to repeat the experiment, and verify the
results for yourself should you wish to do so.</p>

<h2 id="test-results">Test Results</h2>

<p>Let’s walk through both the test and the results.
In simulation, we’ll measure the results with a
<a href="https://en.wikipedia.org/wiki/Spectrogram">Spectrogram</a>.  (Wikipedia’s
article on the <a href="https://en.wikipedia.org/wiki/Periodogram">Periodogram</a> is
also applicable to the time slices of the
<a href="https://en.wikipedia.org/wiki/Spectrogram">Spectrogram</a>.)
A <a href="https://en.wikipedia.org/wiki/Spectrogram">Spectrogram</a>
is a two-dimensional image with the
two axes being time and frequency.  Time will go from left to right, and
frequency will go from zero at the top down to the maximum at the bottom.
Spectral energy comes out of the image in a third axis.
You can see the <a href="https://www.gnu.org/software/octave">Octave</a>
code for calculating the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/showspectrogram.m">spectrogram here</a>.</p>

<p>The scale on the z-axes, representing signal strength will be presented in
color ranging (in <a href="https://en.wikipedia.org/wiki/Decibel">decibels</a>)
from -80dB to 0dB relative to the maximum point in the image.
The maximum value will be held to zero dB and colored white.  We’ll
artificially cut the <a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>
off at -80dB below this maximum value, and color anything at or below this
level in black.  Hence we should expect our tone to be a brightly colored,
nearly white line, across a black (or nearly black) background.
All of this minor processing code is posted
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/showspectrogram.m">here</a>.
You can even find the code defining these false colormap
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/mymap.m">here</a>.</p>

<p>Given the tests described above, let’s think for a moment about what we
are going to expect to see from the
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a> of the
audio output.  First, one would expect a slanted line, representing the
initial swept tone, ranging from zero time and 110Hz frequency to three
seconds and just past 27.3kHz in frequency.  Further, once this swept tone
reaches the
<a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist frequency</a>
associated with the underlying sample rate, whether 4kHz or 16kHz (half the
sample rate), we should expect to see an “X” shape as the tone
<a href="https://en.wikipedia.org/wiki/Aliasing">aliases</a> back below the
<a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist limit</a>.  Second,
when displaying the result of the 440Hz tone, in an ideal system we would see
nothing more than a white horizontal line centered at 440Hz.
<a href="https://en.wikipedia.org/wiki/Aliasing">Aliasing</a> effects will appear at
440Hz plus or minus multiples of the sample rate.
Third, any sudden transition will spread its energy across frequency.
Hence, any transition or hiccup in the signal, such as when the transmitter
starts or stops, should appear on our
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a> as a (rough) vertical
line.</p>

<p>We’ll run our first test with a 32kHz sample rate, and the second test with an
8kHz sample rate.  The sample rate will also control the period of the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
waveform.  One would therefore expect silence, or near silence, to produce
a series of harmonic tones starting at this frequency when using
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>.  The
<a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">PDM</a> system
should have no such feature.  The third and final test will drop the sample
rate to <code class="language-plaintext highlighter-rouge">1/256</code>th of the original sample rate.  This should allow us to see
any spectral features created while the signal tries to output values near
“zero”.</p>

<p>These are the results that we will expect from a “perfect” system.</p>

<p>We’ll start by examining the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">traditional</a>
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a> result in Fig 2.
In this case, the sample rate was set to 32kHz–which will also drive the
period of the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">traditional</a>
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
waveform generator.</p>

<table align="center" style="float: none"><caption>Fig 2: Test Results for a PWM Generator</caption><tr><td><img src="/img/pwm-demo/pwm32k.png" alt="Test Results, PWM, 32kHz sample rate" width="780" /></td></tr></table>

<p>Because the sample interval is based about 32kHz, one would expect
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>
content above 16kHz to be a (rough) mirror image of the content below it, and
this is what we see in the
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a> figure.
Although this mirroring will continue on up to 32kHz, the image is cut off
at 22kHz–the <a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist
frequency</a>
of the resampler, and the <a href="https://en.wikipedia.org/wiki/Hearing_range">upper end of the human hearing frequency
range</a>.
If you’ve never seen this mirroring effect, it <a href="http://www.dtic.mil/dtic/tr/fulltext/u2/a423141.pdf">can be derived from first
principles</a> under no
other assumptions than the fact that the output is a sampled real valued
signal rather than a complex one.</p>

<p>I also expect the mirror images above the
<a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist frequency</a>
to decay slowly with a rough
<a href="https://en.wikipedia.org/wiki/Sinc_funtion">sinc shape</a>,
due to the underlying <a href="/dsp/2017/06/06/simple-interpolator.html">Nearest Neighbor
interpolation</a>
but I haven’t examined the results close enough to see if this is the case.</p>

<p>As a final item of note, the swept frequency portion of the test didn’t
produce just a single swept tone line in this
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>,
but rather a series of slanted lines.
The lines appear to converge with the swept tone test signal at zero
frequency and spread out from there.  Put simply, the swept tone
we desired to produce didn’t come out as a pure audio tone following the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>.
Instead, it producesd something still periodic but slightly different from a
sine wave.  These extra swept lines represent
<a href="https://en.wikipedia.org/wiki/Harmonic">harmonics</a> of the desired waveform,
running at roughly two, three, and four times the frequency of the swept tone.
(There’s even a fifth <a href="https://en.wikipedia.org/wiki/Harmonic">harmonic</a>
that you can see if you look close enough.)  These represent undesired and
unwanted distortions, caused by the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">generator</a>.</p>

<p>Now let’s compare that result with the
<a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">PDM</a> <a href="/dsp/2017/09/04/pwm-reinvention.html">improved
PWM</a>)
waveform in Fig 3.</p>

<table align="center" style="float: none"><caption>Fig 3: Test Results for the Improved Signal Generator</caption><tr><td><img src="/img/pwm-demo/pdm32k.png" alt="Test Results, PDM, 32kHz sample rate" width="780" /></td></tr></table>

<p>From here you can see that the
<a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">PDM</a>
waveform roughly matches what one would expect, while the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
waveform in Fig 2 has all kinds of
<a href="https://en.wikipedia.org/wiki/Harmonic">harmonic</a>
distortions.</p>

<table style="float: right"><caption>Fig 4: Resampler aliasing</caption><tr><td><img src="/img/pwm-demo/pdm32k-zoom.png" alt="Figure showing the resampler aliasing and falloff" width="240" /></td></tr></table>
<p>If you look closely at Fig 3, you can even start to see some additional
aliasing effects in the swept tone near the very bottom of the image (22kHz).
Fig 4 zooms in one one of these components, so you can see what I’m talking
about.  These show the transition band of the
<a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">anti-aliasing filter</a>
that was used within the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">C++ test
harness</a>.
They also show the utility of having such an
<a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">anti-aliasing filter</a>
in the design.  Without it, there would be further swept-tone “X”s within
the design, caused by the aliased components above 22kHz sweeping back into
band.  We’ll see these additional “X” components in the next test(s).</p>

<p>Let’s now repeat the above test using an 8kHz sample rate, but without
providing an
<a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">anti-aliasing filter</a>
for points above 4kHz.</p>

<p>Without this <a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">anti-aliasing
filter</a>, we should
expect to see <a href="https://en.wikipedia.org/wiki/Aliasing">aliasing</a> components
above 4kHz instead of above 32kHz.  (Remember the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">demo
software</a>
only applies
<a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">the anti-aliasing filter</a>
for frequencies above 22kHz.)  You’d expect these
<a href="https://en.wikipedia.org/wiki/Aliasing">aliasing</a>
products above 4kHz to create something where frequencies between 0-4kHz were
mirrored from 4kHz to 8kHz, and then the 0-8kHz range should be repeated
above 8kHz.  This is what we might expect.</p>

<p>The <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">traditional</a>
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
signal, however, might also be expected to have additional distortions since
the <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
interval is now within audio range.  These can be seen in Fig 5.  Of the
tests shown, the affect appears to be the most pronounced surrounding
the 440Hz tone.</p>

<table align="center" style="float: none"><caption>Fig 5: Test Results for a PWM Generator with an 8kHz based interval</caption><tr><td><img src="/img/pwm-demo/pwm8k.png" alt="Test Results, PWM, 8kHz interval rate" width="780" /></td></tr></table>

<p>What’s not shown is that this result is quite unpleasant upon the ears.</p>

<p>The corresponding
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/rtl/wbpwmaudio.v">improved</a>
<a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">PDM</a>
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>.
is shown in Fig 6.</p>

<table align="center" style="float: none"><caption>Fig 6: Test Results for the improved signal generator, with an 8kHz based interval</caption><tr><td><img src="/img/pwm-demo/pdm8k.png" alt="Test Results, PDM, 8kHz interval rate" width="780" /></td></tr></table>

<p>This <a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>
actually shows much of what you would expect: aliasing products from sampling
at a rate less than 40kHz with no
<a href="https://en.wikipedia.org/wiki/Anti-aliasing_filter">anti-aliasing filter</a>.
(The 40kHz number comes from twice the frequency at the top of the <a href="https://en.wikipedia.org/wiki/Hearing_range">human
hearing range</a>.)</p>

<p>When comparing Fig 5 with Fig 6, the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
output clearly has more distortion within it.  Not only does it have the same
<a href="https://en.wikipedia.org/wiki/Harmonic">harmonic</a>
distortions it had at the 32kHz sample rate, but there are
also many other distortions associated with the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a> waveform interval
at 8kHz.  This helps to demonstrate that the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/rtl/wbpwmaudio.v">improved PWM
generator</a>
solves many of the problems that <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">traditional
PWM</a>
signals struggle with.</p>

<p>You might be surprised in Fig 5 that the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">traditional</a>
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
generator did not produce an 8kHz tone during the silence period.  Such an
annoying tone during silence should be expected, should it not?  The reason
that there’s no annoying tone during this silence period is simply because
the design is considered to be controlling a
<a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier">PMod AMP2</a>.
The <a href="https://store.digilentinc.com/pmod-amp2-audio-amplifier">AMP2</a>
has both gain and shutdown controls, and so the simulator artificially turns
the output off during those regions based upon these control outputs.</p>

<p>Our last comparison, then, will be focused on examining how these two
waveform generators handle very weak signals.  Specifically, we’ll lower
the amplitude from full scale (or actually just nearly full scale) down to
<code class="language-plaintext highlighter-rouge">1/256</code>th of that amount and then repeat the 8kHz test.</p>

<p>The <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
output can be found in Fig 7.</p>

<table align="center" style="float: none"><caption>Fig 7: PWM Test Results, 8kHz sampling, 1/256 of full scale</caption><tr><td><img src="/img/pwm-demo/pwm8k-weak.png" alt="Figure: test results at 1/256th the amplitude for the PWM signal" width="780" /></td></tr></table>

<p>The <a href="/dsp/2017/09/04/pwm-reinvention.html">improved</a>
output can be found in Fig 8.</p>

<table align="center" style="float: none"><caption>Fig 8: PDM Test Results, 8kHz sampling, 1/256 of full scale</caption><tr><td><img src="/img/pwm-demo/pdm8k-weak.png" alt="Figure: test results at 1/256th the amplitude for the PDM signal" width="780" /></td></tr></table>

<p>Notice the difference in the background between the two images.  There you will
notice that Fig 8 has a blue background instead of a black background.  This
is an artifact of how we have chosen to plot the signal–showing the maximum
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a> value over the
course of the test as white, and the black being defined as 80dB below that.
In the case of Fig 7, you’ll notice that
the <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>’s output is
dominated, not by the swept tone or the 440Hz tone, but rather the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a> switching
signal at 8kHz.  This annoying signaling artifact sets the numeric value
associated with the 0dB color (white).  The
<a href="/dsp/2017/09/04/pwm-reinvention.html">improved signal</a>
has no such annoying tone setting its maximum value, and hence 80dB below its
maximum value is into the <a href="https://en.wikipedia.org/wiki/Quantization_(signal_processing)">quantization
noise</a>
of this system, which is showing up as a blue background.</p>

<p>Perhaps a time slice from the 440Hz tone region would help to explain this
better.  We’ll remove the arbitrary image scaling, so as to show this time
slice shown below in Fig 9.</p>

<table align="center" style="float: none"><caption>Fig 9: Comparing 440Hz tone generations</caption><tr><td><img src="/img/pwm-demo/pwm-v-pdm-weak.png" alt="Figure: comparing PWM vs PDM when producing a 440Hz tone" width="780" /></td></tr></table>

<p>In this figure, you can see the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
plotted in red, and the
<a href="/dsp/2017/09/04/pwm-reinvention.html">improved PWM signal</a>
shown in blue.</p>

<p>The first thing to notice is that the PWM signal has a tone in the center
of it that is 40+dB higher than the signal of interest.  Likewise, the
background values of both are nearly identical, although the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
implementation is showing some stronger artifacts.</p>

<h2 id="comparing-the-results-against-expectations">Comparing the results against expectations</h2>

<p>Now that you’ve seen the results, were they what you expected?  My answer
to that is <em>somewhat</em>.</p>

<p>I expected the <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
signal to have some problems, but I’ll admit I wasn’t expecting the strong
<a href="https://en.wikipedia.org/wiki/Harmonic">harmonic</a>
distortion.  While I might be tempted to believe this is caused by my test
setup, the
<a href="/dsp/2017/09/04/pwm-reinvention.html">improved approach</a>
didn’t have any such distortions.  Further, after
reviewing the traditional <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">PWM generation
code</a>
I can’t find anything that would cause this.</p>

<p>I was expecting the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">PWM generated</a>
tone in Fig 7, though.</p>

<p>Some of the comments I’ve received online have suggested that the
<a href="https://en.wikipedia.org/wiki/Two's_complement">two’s complement</a>
to <a href="https://en.wikipedia.org/wiki/Offset_binary">offset binary</a> conversion
discussed within the <a href="/dsp/2017/09/04/pwm-reinvention.html">improved
PWM</a>
article and used in the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/rtl/wbpwmaudio.v">demonstration waveform
generator</a>
was in error.  Had this been the case, the
<a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">PDM</a>
signal above would have had some seriously annoying harmonics of the desired
tone as well–particulary for full-range sample values.  That it does not
proves that the method, and the conversions, work as stated.</p>

<p>Does this prove that the
<a href="/dsp/2017/09/04/pwm-reinvention.html">improved PWM</a>
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/rtl/wbpwmaudio.v">generator</a>
is better?  I’ll leave that to your judgment.</p>

<h2 id="if-you-want-to-try-this-yourself">If you want to try this yourself</h2>

<p>In case you want to try this test and compare the waveforms yourself, you’ll
need to have both <a href="https://www.veripool.org/wiki/verilator">Verilator</a> and
<a href="https://www.gnu.org/software/octave/">Octave</a> installed.  On a
<a href="https://www.debian.org">Debian</a> based system, such as
<a href="https://www.ubuntu.com">Ubuntu</a>, you can install these packages via:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get <span class="nb">install </span>verilator octave</code></pre></figure>

<p>Once you have these two packages, you can download and build the
<a href="https://github.com/ZipCPU/wbpwmaudio/tree/master/demo-rtl">demo package</a>.
Start by cloning the <a href="https://github.com/ZipCPU/wbpwmaudio">wbpwmaudio</a>
repository.  Then change into the
<a href="https://github.com/ZipCPU/wbpwmaudio">demo-rtl</a> directory, and
then type “make”.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/ZipCPU/wbpwmaudio.git
<span class="nb">cd </span>wbpwmaudio/demo-rtl
make</code></pre></figure>

<p>On a Windows system, you may need to follow the
<a href="https://www.cygwin.com">Cygwin</a>
<a href="/blog/2017/07/28/cygwin-fpga.html">instructions found here</a>.
(I don’t use these often, so please tell me if you struggle with them at all.)</p>

<p>You can then run the test (for a given switch setting) by running <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">./pdmdemo</code></pre></figure>

<p>To view the results that
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>
creates, start up <a href="https://www.gnu.org/software/octave/">Octave</a>
and run the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/showspectrogram.m">script provided</a>
on the <code class="language-plaintext highlighter-rouge">wavfp.dbl</code> file that
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>
generates:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span> octave <span class="nt">-q</span> <span class="nt">--no-gui</span>
% showspectrogram<span class="o">(</span><span class="s1">'wavfp.dbl'</span><span class="o">)</span><span class="p">;</span></code></pre></figure>

<p>If you run this test in a separate window, while the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>
is still running, you should be able to see the program’s progress as it runs
through the demo.</p>

<p>If you want to repeat the test for the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/traditionalpwm.v">traditional</a>
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
generator, you’ll need
to edit the <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/pdmdemo.cpp">pdmdemo.cpp</a> C++ file and set the <code class="language-plaintext highlighter-rouge">traditiona_pwm</code> boolean value in the <code class="language-plaintext highlighter-rouge">main()</code>
function to <code class="language-plaintext highlighter-rouge">true</code>.  This will set the simulated hardware switch value to true.
Alternatively, you can try this design in hardware and just toggle the switch.</p>

<p>If you would like, you are also welcome to generate a
<a href="/blog/2017/07/31/vcd.html">VCD file</a> via the
<a href="https://www.veripool.org/wiki/verilator">Verilator</a>
based <a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">simulation</a>
as well.  Should you wish to do this, you’ll want to uncomment
the <code class="language-plaintext highlighter-rouge">tb-&gt;opentrace("pdmdemo.vcd");</code> line within
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo.cpp</a>.
Be aware if you do this, though, that the
<a href="/blog/2017/07/31/vcd.html">VCD file</a>
can grow to many GB very quickly.  While I’ve been successful using
<a href="/blog/2017/07/31/vcd.html">VCD file</a>,
of more than a GB, <a href="https://gtkwave.sourceforge.net">gtkwave</a> complains when
I do so.  As a result, I’ve generally tried to avoid using
<a href="/blog/2017/07/31/vcd.html">VCD file</a>,
greater than 10GB in in size.  A Control-C should stop the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>
program prior to completion if you choose to go this road.</p>

<h2 id="staring-closely">Staring Closely</h2>

<p>This is actually a fun opportunity to see if there’s anything to learn by
staring really closely at the data.</p>

<p>If you’ve never used a
<a href="https://en.wikipedia.org/wiki/Window_function">window function</a> before, the
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/showspectrogram.m">code</a>
creates its results using a
<a href="https://en.wikipedia.org/wiki/Hann_function">Hanning window</a>.
This window was responsible for the rough triangle shape of our signals
as shown in Fig 9 above.</p>

<p>Suppose we used a
<a href="/dsp/freq-teaser.html">better window</a>
instead?</p>

<p>Figure 10, below, shows the same chart as Fig 9 above, but this time with an
<a href="https://en.wikipedia.org/wiki/Fast_Fourier_transform">FFT</a>
<a href="https://en.wikipedia.org/wiki/Window_function">window</a>
having <a href="/dsp/freq-teaser.html">much better spectral
resolution</a> than the
<a href="https://en.wikipedia.org/wiki/Hann_function">Hanning window</a>.
used above.</p>

<table align="center" style="float: none"><caption>Fig 10: Comparing spectral resolution, 440Hz tone, 8kHz sampling, weak tone</caption><tr><td><img src="/img/pwm-demo/pwm-v-pdm-hires.png" alt="Image Showing High Resolution Spectral Estimation" width="780" /></td></tr></table>

<p>The biggest thing to notice is the difference in the resolution of the
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
generation found at 8kHz.  Indeed, Fig 10 shows that the interference
has very little spectral width to it.  This is as we would expect, although
not as Fig 9 above displayed.  This is also a common problem found in many
spectral estimation tools: the tool artificially distorts the results.</p>

<p>Let’s also look at the
<a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a>
of the <a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
tone, shown in Fig 7 above, but this time using the
<a href="/dsp/freq-teaser.html">high resolution frequency window</a>
and shown in Fig 11 below.</p>

<table align="center" style="float: none"><caption>Fig 11: High Resolution Spectrogram, PWM signal, 8kHz, weak amplitude</caption><tr><td><img src="/img/pwm-demo/pwm8k-weak-hires.png" alt="Image Showing High Resolution Spectral Estimation of the PWM 8kHz weak signal" width="780" /></td></tr></table>

<p>Here you might notice the difference in line thickness of the interfering
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">PWM</a>
tonal artifact.  In Fig 11, the artifact appears much sharper and
has better frequency resolution.  However, this difference only follows from
the individual cuts such as we showed above and its not nearly as pronounced
in this view.</p>

<p>We could also zoom in and examine the higher power swept tone, such as was
shown in the top left corner of Fig 3 above.  This comparison is now shown
below, with <a href="https://en.wikipedia.org/wiki/Hann_function">Hanning window</a> on
the left and the <a href="/dsp/freq-teaser.html">higher resolution
window</a> result on the right.</p>

<table align="center" style="float: none"><caption>Fig 12: Comparing Spectral Resolution</caption><tr><td><img src="/img/pwm-demo/pwm-spectro-hanning.png" alt="Spectrogram using Hanning Window" width="350" /></td><td><img src="/img/pwm-demo/pwm-spectro-sharp.png" alt="A better/sharper Spectrogram" width="350" /></td></tr><tr><td align="center">Hanning Window</td><td align="center">Higher Resolution Window</td></tr></table>

<p>Should you be interested in
<a href="/dsp/freq-teaser.html">high resolution frequency windowing</a>,
this is one of <a href="/about/gisselquist-technology.html">Gisselquist
Technology</a>’s
<a href="/projects.html">commercial products</a>.</p>

<h2 id="out-of-order">Out of Order</h2>

<p>Today’s test set demonstrates a lot of technology that we’ve haven’t yet had
the opportunity to work through within <a href="https://zipcpu.com/">this
blog</a>.  I hope to come back and
do so, and only apologize for presenting concepts out of order.
Missing background topics include:</p>

<ul>
  <li>
    <p>The <a href="/dsp/2017/10/02/cordic-tb.html">test-bench for the</a>
<a href="https://github.com/ZipCPU/cordic">CORDIC</a>
<a href="https://github.com/ZipCPU/cordic/tree/master/sw">core generator</a>
that we’ve built.</p>

    <p>The <a href="/dsp/2017/10/02/cordic-tb.html">trick to this test
bench</a>
is that the rounding and truncation taking place within the
<a href="https://github.com/ZipCPU/cordic">CORDIC</a> has consequences in the
output.  This creates some variability in the output, variability that is
a function of the parameters used when generating the
<a href="https://github.com/ZipCPU/cordic">CORDIC</a>.  <a href="/dsp/2017/10/02/cordic-tb.html">Predicting these
consequences</a>,
to know whether or not the
<a href="https://github.com/ZipCPU/cordic">CORDIC</a> is producing the correct output,
is <a href="/dsp/2017/10/02/cordic-tb.html">taking me some work</a>.
It’s also why I haven’t posted the <a href="https://github.com/ZipCPU/cordic">CORDIC</a>
<a href="/dsp/2017/10/02/cordic-tb.html">test bench</a> yet.</p>

    <p>Sadly, the result is that this
<a href="https://github.com/ZipCPU/cordic">CORDIC</a> <a href="/dsp/2017/10/02/cordic-tb.html">test bench
post</a>
is going to delve deeper into
<a href="https://en.wikipedia.org/wiki/Probability">probability</a> than
I would like to do on <a href="https://zipcpu.com/">this blog</a>.</p>
  </li>
  <li>
    <p>We haven’t really discussed how to create tone generators yet, nor have
we discussed swept tone generators.</p>

    <p>These really aren’t all that hard–especially once you have a working
<a href="/dsp/2017/08/30/cordic.html">CORDIC</a>.
They depend upon sending an incrementing
<a href="/dsp/2017/06/15/no-pi-for-you.html">phase angle</a>
into the <a href="/dsp/2017/08/30/cordic.html">CORDIC</a> module,
but we can come back and discuss the topic more as we have opportunity.</p>
  </li>
  <li>
    <p>We also haven’t discussed how to implement a
<a href="https://en.wikipedia.org/wiki/Sample-rate_conversion">downsampling filter</a>.</p>

    <p>This was a necessary part of the 100MHz to 44.1MHz <a href="https://en.wikipedia.org/wiki/Sample-rate_conversion">sample rate
converter</a>
within the
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">C++ portion</a>
of today’s
<a href="https://github.com/ZipCPU/wbpwmaudio/tree/master/demo-rtl">demonstration</a>.</p>
  </li>
  <li>
    <p>We haven’t discussed how to generate a good
<a href="https://en.wikipedia.org/wiki/Low-pass_filter">lowpass filter</a> for a very
small bandwidth signal.</p>

    <p>The <a href="https://en.wikipedia.org/wiki/Sample-rate_conversion">resampler</a> within
<a href="https://github.com/ZipCPU/wbpwmaudio/blob/master/demo-rtl/pdmdemo.cpp">pdmdemo</a>
doesn’t really have a “good”
<a href="https://en.wikipedia.org/wiki/Low-pass_filter">lowpass filter</a>
within it since it is far from optimized.  A better
<a href="https://en.wikipedia.org/wiki/Low-pass_filter">lowpass filter</a>
would have fewer taps and fewer operations.</p>
  </li>
</ul>

<p>These are all topics that we’ll need to come back and address again later on
<a href="https://zipcpu.com/">this blog</a> as time and opportunity are
available and provided the <a href="https://www.blueletterbible.org/kjv/jas/4/15/s_1150015">LORD is
willing</a>.</p>


  </div>


<div class "verse">
<HR align="center;" width="25%">
<P><em>Salt is good: but if the salt have lost his savour, wherewith shall it be seasoned?</em>


</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The ZipCPU by Gisselquist Technology</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <!-- <li></li> -->
          <li><a href="mailto:zipcpu@gmail.com">zipcpu@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="soc-medlist">
          
          <li>
            <a href="https://github.com/ZipCPU"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ZipCPU</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/zipcpu"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">@zipcpu</span></a>

          </li>
          
          
          <li><A href="https://www.patreon.com/ZipCPU"><img src="/img/become_a_patron_button.png"></a></li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstream FPGA design courses such as how to debug an FPGA design.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
