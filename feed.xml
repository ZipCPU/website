<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>The ZipCPU by Gisselquist Technology</title>
    <description>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstream FPGA design courses such as how to debug an FPGA design.
</description>
    <link>https://zipcpu.com/</link>
    <atom:link href="https://zipcpu.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 01 Nov 2022 15:01:27 -0400</pubDate>
    <lastBuildDate>Tue, 01 Nov 2022 15:01:27 -0400</lastBuildDate>
    <generator>Jekyll v4.2.0</generator>
    <image>
      <url>https://zipcpu.com/img/gt-rss.png</url>
      <title></title>
      <link></link>
    </image>
    
      <item>
        <title>Measuring the Steps to Design Checkoff</title>
        <description>&lt;p&gt;I’ve recently had the opportunity to rebuild a &lt;a href=&quot;https://www.arasan.com/products/nand-flash/&quot;&gt;NAND flash
controller&lt;/a&gt; for &lt;a href=&quot;https://www.arasan.com&quot;&gt;Arasan Chip
Systems, Inc&lt;/a&gt;.
The purpose of this redesign was to upgrade an existing flash controller
so that it can process flash requests and commands at even faster speeds than
ever before.  Indeed, this new controller is designed to handle flash chips
that operate at speeds of up to 1.6GB/s while being backwards compatible with
all previous speeds.  Those who know my typical design goals will already
know my personal goals for this design: &lt;em&gt;throughput, throughput, throughput!&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;What I wanted to discuss today, however, was a basic management problem I
came across while working on this project.  At one time, during development,
I was asked by &lt;a href=&quot;https://www.arasan.com&quot;&gt;Arasan&lt;/a&gt;’s management team where I
was at in the project, and how much longer the project would take to
accomplish.&lt;/p&gt;

&lt;p&gt;Gosh, where do you start?&lt;/p&gt;

&lt;p&gt;First, let’s face reality, despite how much an engineer would like to avoid
such questions, these are valid questions.  Customers have a right to know
how far along you are, and when you think you’ll have the project completed.
In other words, you might not like the question, but it is one that needs
answering.&lt;/p&gt;

&lt;p&gt;Perhaps the best and most truthful answer might be, “I’m working on it, and
it’ll get done when it gets done.”  While this might be true, it doesn’t
allow you the ability to express your progress at all.
Customers want to know your timeline, and they want to know that the timeline
you give them is well justified.
Put simply, you need to break projects down into tasks–tasks that need to take
place between now and project completion.  Each task then needs to be given
a time estimate, leading up to an ultimate completion date for each project.&lt;/p&gt;

&lt;p&gt;Here’s an example of what such a task list might look like.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig 1. Example task list table&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/checkoff/tasklist.svg&quot; alt=&quot;&quot; width=&quot;780&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;You might find it better to view something like this via a
&lt;a href=&quot;https://www.gantt.com/&quot;&gt;Gantt chart&lt;/a&gt; rather than as a list of independent
tasks, but let’s pull on this idea of a task list a bit more for discussion.
Why?  Because, once the interfaces to a module have been defined, then the
design of each module in a larger system can become an independent task
which can then be separated from the rest of the design. Of course, this
only goes so far: often when designing a module, you will often discover
changes that need to be made to the interface, and some tasks (like
simulation) cannot begin until other tasks complete, but this is still a
good place to start.&lt;/p&gt;

&lt;p&gt;One of the benefits of independent tasks is that they can be accomplished
in any order.  Over time, I’ve even found myself walking around in a large
project in a somewhat scatterbrained fashion and doing things out of order.
This leads to two clear problems.  The first is, how shall I know if an
individual task is complete or not?  The second one is like it.  For those
tasks that are not complete, how shall I measure how much of the task
remains?&lt;/p&gt;

&lt;p&gt;Answering these questions will be the topic of this article.&lt;/p&gt;

&lt;h2 id=&quot;measuring-design-progress&quot;&gt;Measuring design progress&lt;/h2&gt;

&lt;p&gt;The current solution that I came up with to measure design progress involves
building a list of design components (modules), and then discussing their
status in a sort of stop-light chart.  For example, Fig. 2 below shows five
components of a design together with their various states of development.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig 2. Module development stoplight chart&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/checkoff/componentlist.svg&quot; alt=&quot;&quot; width=&quot;780&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Many of the parts and pieces of this example design are already posted on
Github.  For example, you can find the &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axixbar.v&quot;&gt;AXI
Crossbar&lt;/a&gt; or the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.v&quot;&gt;AXI-lite instruction
fetch&lt;/a&gt; all
available on line.  You can even find &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;my AXI
DMA&lt;/a&gt; on
&lt;a href=&quot;https://github.com/ZipCPU&quot;&gt;github&lt;/a&gt;.  Other components, such as the “Custom
DMA”, the custom “Micro-Controller”, or the “Top Level Design” listed here,
were not yet built much less posted anywhere.  Each component is then given
a row in this chart, where each column contains a task to be accomplished
before the component is completed.  Each box is then filled in with a color
and a status to describe the reason for the color.&lt;/p&gt;

&lt;p&gt;In general, my color scheme follows:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Red: I color tasks red if either the task &lt;em&gt;not yet started&lt;/em&gt;, or if &lt;em&gt;known
problems exist&lt;/em&gt; with the task.  Perhaps a formal proof fails.  Perhaps the
component fails in simulation.  Either case would show up here in red.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Yellow: Yellow is for partial completion–a &lt;em&gt;work in progress&lt;/em&gt;.  To be
yellow, the design component must at least be written, but may not (yet)
pass any verification steps.  When it comes to formal proofs, a yellow box
would indicate that the design passed at one time, but for some reason the
proof needs to be re-run–perhaps because of some changes that have since
been made to the design, perhaps the interface requirements needed to be
updated, or perhaps because a new configuration now needs to be tested.
Whatever the reason, yellow shows progress without yet showing completion.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Green: A green box is &lt;em&gt;good to go&lt;/em&gt;.  The task is completed.  Both the design
portion is complete, and the given portion of testing has been completed as
well.  No more attention needs to be paid to a green task.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Gray: &lt;em&gt;Not applicable&lt;/em&gt;.  For example, I tend to only formally verify &lt;em&gt;leaf&lt;/em&gt;
components of my designs for complexity reasons.  The top level of a design
rarely sees the light of formal tools, and therefore needs to be tested
via simulation only.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now that we know the colors, let’s look at the columns.&lt;/p&gt;

&lt;p&gt;The first column simply provides an overview of the status of the component.
Is it in development?  If development hasn’t yet started, the component will
be colored in red.  Has the component been verified?  Is it being tested?  Has
it been signed off?  Once a component has received a formal sign off, and hence
is ready for integrated simulation, then I’ll color it green.  All of this is
captured by the first column.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 3. Four formal verification steps&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/checkoff/four-keys.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The next four columns follow from my discussion of the “&lt;a href=&quot;/formal/2020/06/12/four-keys.html&quot;&gt;Four Keys to getting
your design to work the first
time&lt;/a&gt;” article.  These
columns indicate whether or not the design component has passed an interface
check, a contract check, induction, or cover.  In summary:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;em&gt;interface check&lt;/em&gt; verifies the interfaces the component is supposed to
maintain.  If done well, a formal interface definition can define both
sides of the interface, and so assumptions made in one module can be verified
as assertions on the other side of any interface.&lt;/p&gt;

    &lt;p&gt;As an example from Fig. 2, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.v&quot;&gt;AXI-Lite
fetch&lt;/a&gt;
module maintains two interfaces: one with the &lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite
bus&lt;/a&gt;, and a second
between the fetch and the CPU.  Both interfaces need to be clearly defined,
and then the design will need to pass a formal property check against this
definition in order for the design to pass this box.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;em&gt;contract check&lt;/em&gt; is an internal check, designed to prove that the
design component does what it is supposed to do internally.&lt;/p&gt;

    &lt;p&gt;Continuing with the example of the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.v&quot;&gt;AXI-Lite
fetch&lt;/a&gt;,
the contract check would follow:&lt;/p&gt;

    &lt;ol&gt;
      &lt;li&gt;
        &lt;p&gt;First, pick an arbitrary memory address together with an arbitrary
32-bit value (the instruction) that you will assume be at that address.&lt;/p&gt;

        &lt;p&gt;I will also pick another arbitrary bit to decide whether or not reading
from this address will produce a bus error or not.&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;When the AXI-Lite bus returns an instruction associated with that
address, &lt;em&gt;assume&lt;/em&gt; the value returned matches the arbitrary instruction
selected above.  The extra bit will also determine whether or not this
return is OKAY or represents some form of bus error or not.&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;Now &lt;em&gt;prove&lt;/em&gt; (i.e. assert) that the instruction passed to the CPU that
is associated with this address matches the arbitrary instruction value
picked earlier.  Or, if the bus returned an error, then assert that the
illegal instruction flag is sent to the CPU with this instruction.&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 4. My master rule of formal verification&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/checkoff/fv-master-rule.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Note that the check above follows my “master rule” of formal verification:
  Assume inputs, such as the instruction returned by the bus, and then assert
  outputs–such as the instruction returned to the CPU.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;&lt;em&gt;induction&lt;/em&gt;&lt;/a&gt;
check will give you the confidence you need that your interface and contract
properties are not just held for the first twenty clock periods, but rather
for all time.&lt;/p&gt;

    &lt;p&gt;As an example here, it can be a challenge to formally verify that a component
is fully AXI compliant.  There’s just a &lt;em&gt;lot&lt;/em&gt; of assertions involved.  If
you only attempt 64-cycles of a bounded model check, then you’ll never know
whether or not your design would fail on the 65th cycle of a 256-beat burst,
or whether or not your design can handle two 32-beat bursts in a row.&lt;/p&gt;

    &lt;p&gt;If the component being tested were a cache component, the
&lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;&lt;em&gt;induction&lt;/em&gt;&lt;/a&gt;
check might help verify that nothing spoiled the cache between when the
instruction was first returned to the CPU, and when it may have been
returned some time later.  (How long?  Longer than the bound of the proof!)&lt;/p&gt;

    &lt;p&gt;For these questions, you will need to pass
&lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, the &lt;em&gt;cover&lt;/em&gt; check is left over to make certain that, in spite of
any assumptions you may have made, your design is still able to accomplish
whatever tasks were assigned to it.&lt;/p&gt;

    &lt;p&gt;Years ago, when visiting a helicopter squadron, I remember being introduced
to the test pilots of the squadron.  Why would a squadron need test pilots,
I asked?  The helicopters were decades old, and their performance well
established, what was the purpose of the test pilots or the test pilot
section they were members of?  The answer I was given surprised me:
After taking a helicopter apart to fix it, it’s important to shake
it around in a test flight just to make certain everything was properly put
back in place.  In digital design, we might call such a test a “regression”
test.&lt;/p&gt;

    &lt;p&gt;In a similar fashion, I use cover checks in a sanity checking role.  There’s
been more than once where I’ve convinced myself that a design passes a
formal verification check, only to discover later that I had erroneously
assumed the design would remain in reset the whole time.  A proper cover
check would’ve failed in this case, which would then lead me to the problem
in my proof.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Once all of the various components in a design pass their formal checks, I’ll
then turn to simulation so that I can demonstrate the functionality of the
design.  Note that, at this point, I’m no longer trying to &lt;em&gt;prove&lt;/em&gt; the design
works–that’s already been done via formal methods.  Instead, I’m now trying to
&lt;em&gt;demonstrate&lt;/em&gt; that the design works.  Frankly, there’s no way I could make any
simulation as thorough as the formal proofs preceding it, but there remain lots
of good reasons for using simulations and bugs that still get caught in this
final step.&lt;/p&gt;

&lt;p&gt;The simulation column might also be where I’d include code coverage statistics,
if the project required them.&lt;/p&gt;

&lt;p&gt;Some projects have an additional column that I haven’t listed in this chart.
This column would capture whether or not the design as a whole has been
hardware tested and proven.  This might mean that the design has been placed
onto an FPGA, and that it has been demonstrated to work on the FPGA.  It might
also mean that an ASIC has been built from the design.  The important part
here is that, while this is a very useful column, it’s not necessarily
an important check off criteria for all designs.&lt;/p&gt;

&lt;p&gt;With that as background, let’s go back and examine Fig. 2 a bit.&lt;/p&gt;

&lt;p&gt;As you can see from the list of components, my &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axixbar.v&quot;&gt;AXI
crossbar&lt;/a&gt; has
failed its
&lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;
check and changes have been made to it since it was last
formally verified.  This is evidence of work that needs to be accomplished.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.v&quot;&gt;AXI-lite instruction
fetch&lt;/a&gt;,
however, had only recently been built when I put this chart together.  At the
time, it was still a very new design.  Still, it has passed all of its
property checks, and was then being used in simulation testing.  (It’s now been
used quite successfully in several projects, but that’s another story
for another time.)&lt;/p&gt;

&lt;p&gt;The microcontroller in this example, however, had suffered from catastrophic
failures in simulation.  (I had tried to skip the formal checks after making
some minor changes and then to run directly to simulation.  Skipping steps often
feels like you are moving faster, when in this case it meant I had to go back
and do some rework.)  Since bugs had been found in the microcontroller, I
marked it in red so that I would remember to go back and update the formal
proof so these bugs never come back again.&lt;/p&gt;

&lt;p&gt;The custom DMA should be self-explanatory–it simply hadn’t (yet) been built,
so it’s line was red through and through.&lt;/p&gt;

&lt;p&gt;That brings us to the “Top Level Design” component.  This level will not be
formally verified, and so those boxes have been grayed out.  This is for two
reasons.  First, if everything beneath it was properly verified, then this
level shouldn’t need to be verified at all.  Second, formal verification
depends upon an exhaustive search over all potential states.  This search is
exponentially complex and can easily grow beyond what the designer’s (patience
and) computer power are able to handle.  Therefore, the top level design will
be the focus of a lot of simulation work, but that won’t be able to happen
until all the parts and pieces composing it have been built.&lt;/p&gt;

&lt;h2 id=&quot;other-uses&quot;&gt;Other uses&lt;/h2&gt;

&lt;p&gt;Since I started building charts like this one, I’ve found other uses for
building charts like this.  Three particular uses include scheduling, cost
estimation, and explaining design proposals in contract bids.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Scheduling&lt;/p&gt;

    &lt;p&gt;When scheduling, I’ll place the amount of time in each box that I expect
a task to take.  The sum of all the remaining times in a project should
then be the amount of work time remaining in a project.&lt;/p&gt;

    &lt;p&gt;Do I always get this right?  No.  A better question to ask might be whether
I ever get this estimate right at all.  The answer is probably not, but it’s
at least a good first order estimate.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Cost estimation&lt;/p&gt;

    &lt;p&gt;If you can figure out how much time a project will take, then cost
estimation becomes easier.  For most of my projects, the primary cost driver
is engineering time–my own personal time in particular.  Once a time
has been estimated for each of the tasks in the project, all that really
remains is to multiply that time by an hourly rate.&lt;/p&gt;

    &lt;p&gt;Tracking the time used in any particular task is also an important part of
estimating such acquisition measures as the &lt;a href=&quot;https://www.dau.edu/acquipedia/pages/ArticleContent.aspx?itemid=290&quot;&gt;Actual Cost of Work Performed
(ACWP)&lt;/a&gt;
or the &lt;a href=&quot;https://www.dau.edu/acquipedia/pages/ArticleContent.aspx?itemid=287&quot;&gt;Budgeted Cost of Work Performed
(BCWP)&lt;/a&gt;
for those customers that require these numbers.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Contract bids&lt;/p&gt;

    &lt;p&gt;Yes, I also use this approach when bidding for contracts as well.&lt;/p&gt;

    &lt;p&gt;However, when bidding for contracts, I’ll often list components instead of
components and tasks, and then rearrange those components into something
with more meaning.  Perhaps its a data flow diagram of some type.  Perhaps
its a system block diagram.  Either way, such a diagram then helps me to
illustrate for the customer that I understand the task at hand, while the
stop-light colors help to illustrate the status of the various &lt;a href=&quot;/blog/2020/01/13/reuse.html&quot;&gt;library
components&lt;/a&gt; I might bring to
the project.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In short, I’ve found this stop-light approach very valuable when communicating
with customers.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I’ve now used this component list progress chart for several projects and
purposes.  It has worked so well for me, that I intend to use it again
and again on future projects as the projects and needs allow.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;And ye shall hear of wars and rumours of wars: see that ye be not troubled: for all these things must come to pass, but the end is not yet.  For nation shall rise against nation, and kingdom against kingdom: and there shall be famines, and pestilences, and earthquakes, in divers places.  (Matt 24:6-7)&lt;/em&gt;</description>
        <pubDate>Tue, 01 Nov 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/formal/2022/11/01/design-checkoff.html</link>
        <guid isPermaLink="true">https://zipcpu.com/formal/2022/11/01/design-checkoff.html</guid>
        
        
        <category>formal</category>
        
      </item>
    
      <item>
        <title>Assignment delay's and Verilog's wait statement</title>
        <description>&lt;p&gt;I’ve now spent more time than I want to admit to debugging simulation issues
when using Verilog’s simulation semantics.  Let me therefore share some
problems I’ve come across, together with my proposed solution for them.&lt;/p&gt;

&lt;h2 id=&quot;the-problems&quot;&gt;The Problems&lt;/h2&gt;

&lt;p&gt;Today’s problem stems from logic like the following:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trigger_condition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;some_other_condition_determining_relevance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;state_variable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;complex_expression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// This then continues for another 50 lines or so&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;In general, this comes to me in “working” simulation code that’s been handed
down to me to maintain.  The simulations that use this logic often take hours
to run, and so debugging this sort of thing can be very time consuming.
(Costly too–my hourly rate isn’t cheap.)&lt;/p&gt;

&lt;p&gt;Let’s walk through this logic for a moment–before tearing it apart.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 1. Avoid assignment delays&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/phys-delays.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;In this example the first condition, the one I’ve called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trigger_condition&lt;/code&gt;
above, is simply some form of data change condition.  Sometimes its a
reference to a clock edge, sometimes its a reference to a particular piece of
data changing.  This isn’t the problem.&lt;/p&gt;

&lt;p&gt;The second condition, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;some_other_condition_determining_relevance&lt;/code&gt;, is used
to weed out all the times the always block might get triggered when you don’t
want it to be.  For example, it might be triggered during reset or when the
slave device being modeled is currently responsive to some other
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trigger_condition&lt;/code&gt;.  This is natural.  This is not (yet) a problem either.&lt;/p&gt;

&lt;p&gt;So what’s the problem with the logic above?  Well, let’s start with the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; assignment delay.  In this case, it’s not representing a true hardware
delay.  No, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; is there in order to &lt;em&gt;schedule&lt;/em&gt; Verilog simulation
statement execution.  Part of the reason why it’s there is because the rest
of the block uses &lt;em&gt;blocking&lt;/em&gt; logic (i.e. via the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;=&lt;/code&gt;).  Hence, if this block
was triggered off of a clock edge, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; allows us to reason about what
follows the clock edge but before the next edge.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 2. Recipe for trouble&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/always-disaster.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Now, let me ask, what happens five years from now when clock speeds get faster?
Some poor soul (like me) will be hired to maintain this logic, and that poor
soul will look at the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; and ask, why is this here?  Maybe it was a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1ns&lt;/code&gt;
delay, and they are now trying to run a clock at 500MHz instead of 100MHz.
That &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1ns&lt;/code&gt; delay will need to be understood, and replaced–&lt;em&gt;everywhere&lt;/em&gt;
it was used.  It doesn’t help that the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1ns&lt;/code&gt; doesn’t come with any explanations,
but that may be specific to the examples I’m debugging.&lt;/p&gt;

&lt;p&gt;Here’s a second problem, illustrated in Fig. 2: what happens when you use this
one nanosecond delay in multiple always blocks, similar to this one, all
depending on each other?  Which one will execute first?&lt;/p&gt;

&lt;p&gt;The third problem often follows this one, and it involves a wait statement
of some type.  To illustrate this, let me modify the example above a bit more.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trigger_condition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;some_other_condition_determining_relevance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;state_variable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;complex_expression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Continue for a while ...&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;negedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;output_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other_complex_expression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;In this case, the user wants to make certain his logic is constant across
the clock edge, and so he sets all his values on the negative edge of the
clock.  This leads to two problems: what happens when the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt;
delay conflicts with the clock edge?  And what happens when the output value
depends upon other inputs that are set on the negative clock edge?&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 3. Giant case statement dispatching tasks&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/buried-tasks.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Fig. 3 shows another problem, this time when using a case statement.  In this
case, it’s an attempt to implement a command structure within a modeled device.
The device can handle one of many commands, so depending on which one is
received you go and process that command.  The actual example this is drawn
from was worse, since it depended not only on commands but rather command
sequences, and the command sequences were found within case statements within
case statements.&lt;/p&gt;

&lt;p&gt;What’s wrong with this?  Well, what happens when the original trigger takes
place a second time, but the logic in the always block hasn’t finished
executing?  Perhaps this is erroneous.  Perhaps it finishes just barely on
the wrong side of the next clock edge.  In my case, I find the bug four hours
later–on a good day.  It doesn’t help that simulations tend to run rather slow.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 4. FSMs are often easier to debug than long-running tasks&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/appfsm.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;A better approach would’ve been to use a state machine rather than embedded
tasks.  Why is this better?  Well, if for no other reason, a case statement
would contain state variables which could be seen in the trace file.  That
means that you could then find and debug what would (or should) happen when/if
the new command trigger shows up before a prior command completes.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 5. Repeat LLC logic&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/appllc.svg&quot; alt=&quot;&quot; width=&quot;280&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;These problems are only compounded when this logic is copied.  For example,
imagine a device that can do tasks A, B, and C, but requires one of two IO
protocols to accomplish task A, B, or C.  Now, if that IO protocol logic is
copied and embedded into each of the protocol tasks, then all three will need
to be updated when the IO protocol is upgraded.  (I2C becomes I3C, SPI becomes
Quad SPI, etc.)&lt;/p&gt;

&lt;p&gt;While some of these problems are specific to hardware, many are not. 
&lt;a href=&quot;https://en.wikipedia.org/wiki/Magic_number_(programming)&quot;&gt;Magic numbers&lt;/a&gt;
are a bad idea in both RTL and software.  Design reuse and software
reuse are both very real things.  Even a carpenter will build a
&lt;a href=&quot;https://en.wikipedia.org/wiki/jig_(tool)&quot;&gt;custom jig of some type&lt;/a&gt; when he
has to make fifty copies of the same item.&lt;/p&gt;

&lt;p&gt;The good news is that better approaches exist.&lt;/p&gt;

&lt;h2 id=&quot;defining-terms&quot;&gt;Defining terms&lt;/h2&gt;

&lt;p&gt;Before diving into some better approaches, let me take just a couple of moments
to introduce the terms I will be using.  In general, a test bench has three
basic (types of) components, as illustrated in Fig. 6.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 6. Test bench components&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/gencomponents.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;The Device Under Test (DUT)&lt;/strong&gt;:  The is the hardware component that’s being
designed, and for which the test has been generated.&lt;/p&gt;

    &lt;p&gt;Since the DUT is intended to be synthesizable, Verilog delay statements are
inappropriate here.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;The Hardware Device Model, or just model&lt;/strong&gt;: Our hardware component is being
designed to interact with an external piece of hardware.  This component is
often off-chip, and so our “model” is a simulation component designed to
interact with our IP in the same way the actual hardware would.&lt;/p&gt;

    &lt;p&gt;Although I’ve called these “models” “emulators” in the past, these aren’t
truly “emulators”.  An “emulator” would imply a description of the actual
hardware existed, such as an RTL description, yielding an additional level
of realism in simulation.  Barring sufficient information from the external
device’s manufacturer to actually and truly “emulate” the device, the test
designer often settles for a “model” instead.&lt;/p&gt;

    &lt;p&gt;Hardware models may naturally require Verilog delays in order to model
the interfaces they are designed for.  For example, a signal may take some
time to transition from a known value to an unknown one following a clock
transition.  As another example, a hardware device may become busy following
a command of some kind.  The good news is that Verilog can model both of
these behaviors nicely.&lt;/p&gt;

    &lt;p&gt;How to handle these delays “properly” will become part of the discussion
below.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;The Test Script, or driver&lt;/strong&gt;: This is the component of the design that
interacts with the device under test, sequencing commands to given to it
to make sure all of the capabilities of the DUT are properly tested.&lt;/p&gt;

    &lt;p&gt;This component of the Verilog test script often reads more like it is
software than hardware.  Indeed, we’ve &lt;a href=&quot;/2021/07/23/cpusim.html&quot;&gt;already discussed the idea of
replacing the test script with a piece of software compiled for a soft-core
CPU existing in the test environment, and then emulating that CPU as part
of the simulation model&lt;/a&gt;.  The
benefit of this approach is that it can test and verify the software that
will be used to drive the hardware under test.  The downside is that
simulation’s are slow, and adding a CPU to the simulation environment can
only slow it down further.&lt;/p&gt;

    &lt;p&gt;For the purposes of our discussion today I’ll simply note that the test
script commonly interacts with the design in a &lt;em&gt;synchronous&lt;/em&gt; manner.
Any delays, therefore, need to be synchronized with the clock.&lt;/p&gt;

    &lt;p&gt;There is another problem with the driver that we won’t be discussing today.
This is the simple reality that there’s no way to test all possible
driver delays.  Will a test driver accurately test if your DUT can handle
back to back requests, requests separated by a single clock cycle, by two
clock cycles, by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;N&lt;/code&gt; clock cycles?  You can’t simulate all of these
possible delays, but you can catch them using formal methods.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Not shown in Fig. 6, but also relevant is the &lt;strong&gt;Simulation Environment&lt;/strong&gt;: 
While the DUT and model are both necessary components of any simulation
environment, the environment might also contains such additional components
as an &lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;AXI interconnect&lt;/a&gt;,
&lt;a href=&quot;/zipcpu/2018/01/01/zipcpu-isa.html&quot;&gt;CPU&lt;/a&gt;, DMA,
and/or &lt;a href=&quot;/zipcpu/2018/07/13/memories.html&quot;&gt;RAM&lt;/a&gt;,
all of which are neither the test script, DUT, or model.&lt;/p&gt;

    &lt;p&gt;Ideally these extra components will have been tested and verified in other
projects prior to the current one, although this isn’t always the case.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now that we’ve taken a moment to define our terms, we can now return to the
simulation modeling problem we began.&lt;/p&gt;

&lt;h2 id=&quot;better-practices&quot;&gt;Better practices&lt;/h2&gt;

&lt;p&gt;The good news is that Verilog was originally written as a language for
driving simulations.&lt;/p&gt;

&lt;p&gt;Even better, subsets of Verilog exist which can do a good job of modeling
synthesizable logic.  This applies to both asynchronous and synchronous logic.
The assignment delay problems that I’ve outlined above, however, arise from
trying to use Verilog to model a mix of logic and software when the goal was
to create a hardware device model.&lt;/p&gt;

&lt;p&gt;Here are some tips, therefore, for using delays in Verilog:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Write synthesizable simulation logic where possible.&lt;/p&gt;

    &lt;p&gt;This is really only an issue for test bench or modeling logic.  It’s not
really an issue for logic that was meant to be synthesizable in the first
place.&lt;/p&gt;

    &lt;p&gt;The good news about writing test bench logic in a synthesizable fashion
is that you might gain the ability to synthesize your model in hardware,
and then run tests on it just that much faster.  You could then
also get a second benefit by formally verifying your device model–it’d
save you that much time later when running integrated simulations.&lt;/p&gt;

    &lt;p&gt;As an example, compare the following two approaches for verifying a test
chip:&lt;/p&gt;

    &lt;p&gt;ASIC Test chip #1: Has an SPI port capable of driving internal registers.
This is actually a really good idea, since you can reduce the number of 
wires necessary to connect to such a test chip.  The problem, however, was
that the SPI driver came from encrypted vendor IP.  Why was this a problem?
It became a problem when the test team tried to connect to the device
once it had been realized in hardware.  They tried to connect their CPU to
this same SPI port to drive it–and then didn’t drive it according to
protocol properly.&lt;/p&gt;

    &lt;p&gt;The result of testing ASIC test chip #1?  I got a panic’d call from a
client, complaining that the SPI interface to the test chip wasn’t working
and asking if I could find the bugs in it.&lt;/p&gt;

    &lt;p&gt;ASIC Test chip #2: Also has a SPI port for reading and writing internal
registers.  In this chip, however, the SPI port was formally verified
as a composition of both the writer and the reader–much as Fig. 7 shows
below.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig 7. Sometimes, you'll have both RTL pieces available to you&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/excontrol.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I say “much as Fig. 7 shows” because the verification of this port wasn’t
   done with using the CPU as part of the test script.  However, because
   both the SPI master and SPI slave were verified together, and even better
   because they were &lt;em&gt;formally&lt;/em&gt; verified in an environment containing both
   components, the test team can begin it’s work with a verified RTL interface.&lt;/p&gt;

&lt;p&gt;You can even go one step farther by using a soft-core CPU to &lt;a href=&quot;/2021/07/23/cpusim.html&quot;&gt;verify the
   software driver&lt;/a&gt; at the same
   time.  This is the full extent of what’s shown in Fig. 7.  As I mentioned
   above, the formal verification for ASIC test chip #2 stopped at the AXI-lite
   control port for the SPI master.  When testing this chip as part of an
   integrated test, a test script was used to drive a Bus Functional Model
   (BFM), rather than actual CPU software.  However, if you just read the
   test script’s calls to the BFM, you would have the information necessary
   to build a verified software driver.&lt;/p&gt;

&lt;ol start=&quot;2&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(*)&lt;/code&gt; for combinatorial blocks, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(posedge clk)&lt;/code&gt;
(or negedge) or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(posedge clk or negedge reset_n)&lt;/code&gt; for synchronous
logic.&lt;/p&gt;

    &lt;p&gt;While I like using the positive edge of a clock for everything, the actual
edge you need to use will likely be determined by the device and protocol
you are modeling.  The same is true of the reset.&lt;/p&gt;

    &lt;p&gt;I would discourage the use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(trigger)&lt;/code&gt;, where &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trigger&lt;/code&gt; is some
combinatorial signal–lest you forget some required trigger component.  I
would also discourage the use of any &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(posedge trigger)&lt;/code&gt; blocks where
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trigger&lt;/code&gt; wasn’t a true clock–lest you create a race condition within your
logic.  I use the word &lt;em&gt;discourage&lt;/em&gt;, however, because some modeling contexts
require triggering on non-clocked logic.  If there’s no way around it,
then you do what you have to do to get the job done.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Synchronous (clocked) logic should use &lt;em&gt;non-blocking&lt;/em&gt; assignments (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;=&lt;/code&gt;),
and combinatorial logic should use &lt;em&gt;blocking&lt;/em&gt; assignments (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;=&lt;/code&gt;).&lt;/p&gt;

    &lt;p&gt;It seems like my debugging problems began when the prior designer used
a delay instead of proper blocking assignments.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;		&lt;span class=&quot;c1&quot;&gt;// SYNCHRONOUS block&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;			&lt;span class=&quot;c1&quot;&gt;// MAGIC NUMBER, doesn't model H/W, etc&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;expression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// BLOCKING LOGIC!&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Just … don’t do this.  When you start doing things like this, you’ll
   never know if (whatever) &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;expression&lt;/code&gt; had finished evaluating, or be able
   to keep track of when the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; delay needs to be updated.&lt;/p&gt;

&lt;ol start=&quot;4&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Device models aren’t test drivers.  Avoid consuming time within them–such
as with a wait statement of any type.  Let the time be driven elsewhere by
external events.&lt;/p&gt;

    &lt;p&gt;This applies to both delays and wait conditions within &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always&lt;/code&gt; blocks, as
well as any tasks that might be called from within them.  Non-blocking
assignment delays work well for this purpose.&lt;/p&gt;

    &lt;p&gt;Ideally, device models should use finite state machines, as in Fig. 4,
to model the passing of time if necessary, rather than consuming time
with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wait&lt;/code&gt; statements or ill defined assignment delays, as in Fig. 3.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When driving synchronous logic from a test script, &lt;em&gt;synchronize&lt;/em&gt; any
test driven signals using &lt;em&gt;non-blocking&lt;/em&gt; assignments.&lt;/p&gt;

    &lt;p&gt;I have now found the following simulation construct several times over:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ARESETN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// the problem continues on ...&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Sometimes the author uses the negative edge of the clock instead of the
positive edge here to try to “schedule” things away from the clock edge.
Indeed, I’ve been &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;somewhat guilty of this
myself&lt;/a&gt;.
Sadly, this causes no end of confusion when trying to analyze a resulting
trace file.&lt;/p&gt;

&lt;p&gt;A better approach would be to synchronize this logic with non-blocking
assignments.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;			&lt;span class=&quot;c1&quot;&gt;// Any initial value&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Other initial AR* values may be reset here as well&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;negedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ARESETN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

		&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// Set the rest of the AR* values&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ARREADY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;ARVALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Script continues further&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This will avoid any delta-time cycle issues that would otherwise be
   very difficult to find and debug.  Note that this also works because this
   block is the only block controlling &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ARVALID&lt;/code&gt; from within the test bench.
   Should you wish to control &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ARVALID&lt;/code&gt; from multiple test bench clocks, you
   may run into other concurrency problems.&lt;/p&gt;

&lt;p&gt;While you can still do this sort of thing with Verilator, I’ll reserve
   my solution for how to do it for another post.&lt;/p&gt;

&lt;ol start=&quot;6&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Pick a clock edge and use it.  Don’t transition on both edges–unless the
hardware protocol requires it.&lt;/p&gt;

    &lt;p&gt;As I alluded to above, I’ve seen a lot of AXI modeling that attempts to set
the various AXI signals on the &lt;em&gt;negative&lt;/em&gt; edge of the clock so that any and
all logic inputs will be stable later when the positive edge comes around.
This approach is all well and good until someone wants to do post–layout
timing analysis, or some other part of your design also wants to use the
negative edge, and then pain ensues.&lt;/p&gt;

    &lt;p&gt;Sadly, this means that the project may be turned in and then rest in a
“working” state for years before the problem reveals itself.&lt;/p&gt;

    &lt;p&gt;In a similar fashion, what happens when you have two always blocks, both
using a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#1&lt;/code&gt; delay as illustrated in Fig. 2 above?  Or, alternatively, what
happens when you want the tools to put real post place-and-route delays into
your design for a timing simulation?  You may find you’ve already lost your
timing slack due to a poor simulation test bench or model.  Need I say that
it would be embarrassing to have to own up to a timing failure in simulation,
due to your own simulation constructs?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There is a time for using multiple always blocks–particularly when modeling
DDR devices.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 8. Example DDR simulation logic&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/ddrsim.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;In today’s high speed devices, I’ve often found the need for multiple
   always blocks, triggered off of different conditions, to capture the
   various triggers and describe the behavior I want.  One, for example,
   might trigger off the positive edge, and another off the negative edge.
   This is all fine, well, and good for &lt;em&gt;simulation&lt;/em&gt; (i.e. &lt;em&gt;test bench&lt;/em&gt;)
   logic.  While this would never work in hardware, it can easily be used to 
   accurately model behavior in simulation.&lt;/p&gt;

&lt;ol start=&quot;8&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Use assignment delays to model &lt;em&gt;physical&lt;/em&gt; hardware delays &lt;em&gt;only&lt;/em&gt;.&lt;/p&gt;

    &lt;p&gt;For example, if some event will cause the ready line to go low for 50
microseconds, then you might write:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;parameter&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;tWAIT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;50_000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;event_and_not_reset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ready&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ready&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tWAIT&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Notice how I’ve carefully chosen not to consume any time within this
   always block, yet I’ve still managed to create something that will capture
   the passage of time.  In this case, I’ve used the Verilog &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;=&lt;/code&gt; together
   with a delay statement to schedule the transition of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ready&lt;/code&gt; from zero
   back to one by #tWAIT ns.&lt;/p&gt;

&lt;p&gt;I’ve now used this approach on high speed IO lines as well, with a lot
   of success.  For example, if the data will be valid &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tDVH&lt;/code&gt; after the
   clock goes high and remain valid for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tDV&lt;/code&gt; nanoseconds, then you might
   write:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chip_enable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;pre_output_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;some_expression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;output_valid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tDVH&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;output_valid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tDVH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tDV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;assign&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;output_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;output_valid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pre_output_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'bz&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;I’ve even gone so far in some cases to model the ‘x values in this fashion
   as well.  That way the output is properly ‘x while the voltage is swinging
   from one value to the next.&lt;/p&gt;

&lt;ol start=&quot;9&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;No &lt;a href=&quot;https://en.wikipedia.org/wiki/Magic_number_(programming)&quot;&gt;magic numbers&lt;/a&gt;!
Capture hardware delays in &lt;em&gt;named&lt;/em&gt; parameters, specparams, and registers,
rather than using numeric assignment delays.&lt;/p&gt;

    &lt;p&gt;For example, were I modeling a flash memory, I might do something like the
following to model an erase:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span class=&quot;cp&quot;&gt;`timestep&lt;/span&gt;	&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;parameter&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;real&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;tERASE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;500_000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// 500 microseconds&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// Decode the SPI interface.  We start by counting clocks&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//  from the negative edge of CSN&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SCK&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CSN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CSN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Count clock ticks&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Once clock_counts[5], we're past 32.  We&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// can keep counting, but the results will be&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// irrelevant for this example.&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// With each new clock tick, we capture one more bit&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// from the interface.&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SCK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;sreg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sreg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MOSI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// An erase command takes place after 32 SCK clock edges: the&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// first 8 contain the command, the next 24 contain the address&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// for the command.  Yes, this assumes 24-bit addressing.&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;erase_command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CSN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clock_counts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
				&lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sreg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CMD_ERASE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;erase_address&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sreg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;12'h0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// We only issue and act on the command once we get to the final&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// SCK clock edge of the command sequence--the 32nd clock edge after&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// CSn activates (lowers)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SCK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;erase_command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Set an internal busy bit.  We'll remain busy for&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// tERASE ns.&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tERASE&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Actually erase the memory in question&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BLOCK_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;erase_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;8'hff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Notice the use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tERASE&lt;/code&gt; rather than some arbitrary erase time buried among
the logic.  Placing all such device dependent times in one location (at the
top of the file) will then make it easier to upgrade this logic for a new
and faster device at a later time.&lt;/p&gt;

&lt;p&gt;We can also argue about when the actual erase should take place.  As long
as the user can’t interact with the device while it’s &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;busy&lt;/code&gt;, this probably
doesn’t make a difference.  Alternatively, we could register the erase
address and set a time for later when the erase should take place.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;erase_memory_flag&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SCK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;erase_command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tERASE&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;erase_memory_flag&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;r_erase_address&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;erase_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Render the memory in question unknown&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BLOCK_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;erase_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;negedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;busy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;erase_memory_flag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Actually erase the memory in question&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BLOCK_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r_erase_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;8'hff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Clear the flag&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;erase_memory_flag&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tCK&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Even this isn’t perfect, however, since we now have a transition taking place
on something other than a clock.  Given that the interface clock isn’t
continuous, this may still be the best option to create a reliable edge.&lt;/p&gt;

&lt;ol start=&quot;10&quot;&gt;
  &lt;li&gt;The &lt;a href=&quot;https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)&quot;&gt;rule of
   3&lt;/a&gt;
   applies to hardware as well as software: if you have to write the same
   logic more than twice, then you are doing something wrong.  Refactor it.
   Encapsulate it.  Make a module to describe it, and then reuse that module.&lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 9. If you have to build it more than twice, refactor it&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/better-appllc.svg&quot; alt=&quot;&quot; width=&quot;280&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Remember our example from Fig. 5 above?  Fig. 9 shows a better approach to
   handling three separate device tasks, each with two separate protocols that
   might be used to implement them.&lt;/p&gt;

&lt;p&gt;For protocols that separate themselves nicely between the link layer
   control (LLC) protocol and a media access control (MAC) layer, this works
   nicely to rearrange the logic so that each layer only needs to be written
   once, rather than duplicated within structures implementing both MAC and
   LLC layers together.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 10. The rule of Gold&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/vlog-wait/rule-of-gold.svg&quot; alt=&quot;&quot; width=&quot;280&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Remember: fully verified, well tested, well written logic is pure
&lt;a href=&quot;/blog/2020/01/13/reuse.html&quot;&gt;re-usable gold&lt;/a&gt; in this
business.  Do the job right the first time, and you’ll reap dividends for years
to come.&lt;/p&gt;

&lt;h2 id=&quot;todays-story&quot;&gt;Today’s story&lt;/h2&gt;

&lt;p&gt;A client recently called me to ask if I could modify an IP I had written
so that it would be responsive on an APB slave input with a different
clock frequency from the one the rest of the device model used.&lt;/p&gt;

&lt;p&gt;The update required inserting an APB cross clock domain bridge into the IP.
This wasn’t hard, since I’d built (and formally verified) such a bridge two
months prior–I just needed to connect the wires and do a bit of signal
renaming for the case when the bridge wasn’t required.&lt;/p&gt;

&lt;p&gt;That was the easy part.&lt;/p&gt;

&lt;p&gt;But, how shall this new capability be tested?  It would need an updated test
script and more.&lt;/p&gt;

&lt;p&gt;Thankfully, this was also easy.&lt;/p&gt;

&lt;p&gt;Because I had built the top level simulation construct using parameters, which
&lt;a href=&quot;/zipcpu/2022/07/04/zipsim.html&quot;&gt;could easily be overridden by the test
driver&lt;/a&gt;, the test suite
was easy to update: I just had to set an asynchronous clock parameter,
create a new parameter for the clock speed, adjust the clock speed itself,
and away I went.  Thankfully, I had already (over time) gotten rid of any
inappropriate delays, so the update went smoothly.&lt;/p&gt;

&lt;p&gt;Smoothly?  Indeed, the whole update took less than a half an hour.  (This
doesn’t include the time it took to originally build and verify a generic
APB cross-clock domain bridge.)&lt;/p&gt;

&lt;p&gt;… and that’s what you would hope for from well written logic.&lt;/p&gt;

&lt;p&gt;Well, okay, it’s not all roses–I still have to go back and update the user
guide, update the repository, increment the IP version, update the change log,
and then bill for the task.  Those tasks will take longer than the actual
update, but such is the business we are in.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Let’s face it, this article is a rant.  I know it.  Perhaps you’ll learn
something from it.  Perhaps I’ll learn something from any debate that will
ensue.  (Feel free to comment on &lt;a href=&quot;https://reddit.com/r/ZipCPU&quot;&gt;Reddit&lt;/a&gt; …)&lt;/p&gt;

&lt;p&gt;Yes, I charge by the hour.  Yes, messes like these will keep me gainfully
employed and my family well fed for years to come.  However, I’d rather charge
for doing the useful work of adding new capabilities to a design rather than
fixing up someone else’s mess.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;For the vision is yet for an appointed time, but at the end it shall speak, and not lie: though it tarry, wait for it; because it will surely come, it will not tarry. (Habakkuk 2:3)&lt;/em&gt;</description>
        <pubDate>Wed, 21 Sep 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/09/21/vlog-wait.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/09/21/vlog-wait.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>It's not my fault!  Your code is broken.</title>
        <description>&lt;p&gt;I’ve  always commented that the way to get an interface working is to lock
the engineers responsible for each side of the interface together in a room
until it works.  I like to say it in jest, but in many ways there’s a lot of
truth to it.&lt;/p&gt;

&lt;p&gt;One of the challenges of working with Open Source anything really is debugging.
To be successful, an open source engineer needs to commit their time to
supporting their design–no matter how it is used.  As an illustration, what
happens when one engineer uses an open source design, uses it inappropriately,
and then declares that it doesn’t work?  It can reflect poorly on the quality
of the design–even if the design was and remains fully functional.&lt;/p&gt;

&lt;p&gt;As an example, someone recently attempted to use &lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;my digital
PLL&lt;/a&gt;.  They commented
that &lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
worked great, as long as they didn’t attempt any frequency
tracking.  Was
&lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
broken?  Not at all.  Was the frequency tracking broken?
No, not that either.  In this case, the user wanted to track a 2kHz clock
using a 250MHz sample frequency.  The problem was twofold: first, they didn’t
adjust the gain coefficient appropriately.  As a result, the first time
&lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
noticed that the two clocks weren’t aligned, it attempted to adjust the
frequency by such a large extent that there was no way it would ever come into
alignment.  The second problem was that they didn’t give the design enough
phase bits to track such a low frequency.&lt;/p&gt;

&lt;p&gt;Finding these bugs required a test case from the user sufficient to trigger
the bug, and a couple of hours running simulations.   Thankfully, I knew where
to look since I’d worked with
&lt;a href=&quot;https://github.com/ZipCPU/dpll/master/blob/rtl/sdpll.v&quot;&gt;the design&lt;/a&gt;
before, and knew it was sensitive to how you set the tracking
coefficient–something anyone who had worked with PLLs before would know.&lt;/p&gt;

&lt;p&gt;In another example, I watched a user complain that Xilinx’s FFT wasn’t
working.  However, when he presented his logic it wasn’t too hard to
discover that his &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI stream logic was
broken&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Today’s story, however, regards the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;cheap-hardware-for-compressing-weather-data&quot;&gt;Cheap Hardware for Compressing Weather Data&lt;/h2&gt;

&lt;p&gt;Early on in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s
development, I met a kind gentleman who was interested in using cheap hardware
to compress massive amounts of weather data.  Let’s call him Pi, to allow him
to remain anonymous.  His goal, further, was to be able to accomplish this
compression on the cheapest commodity hardware he could find.  He was
interested in the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
back then specifically because the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
promised to be low logic and he wanted a CPU to help him do his work.&lt;/p&gt;

&lt;p&gt;We’ve since interacted with each other off and on for, well, I suppose it’s
been about five years.  He has been very supportive of my efforts, and has
always volunteered to help me test and verify any new distribution I put
together.&lt;/p&gt;

&lt;p&gt;Let’s come back to Pi again in a moment.  For now, let me share some of the
lessons I’ve since learned about verification from working with the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

&lt;!-- Need to lead up to the discussion of whether or not the memory is working
&quot;If memory is brok how does the lifting step work in catzip in hw and sim
produces same results as test-zipcore?  The pport rtl files from icozip dev
break pptest speechpp in hw.&quot;
--&gt;

&lt;h2 id=&quot;lessons-and-stories-from-zipcpu-verification&quot;&gt;Lessons and Stories from ZipCPU verification&lt;/h2&gt;

&lt;p&gt;When I first built the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;,
I needed some way of testing it.  So I built
a small assembly based test script to test each instruction.  While my goal
was to test each instruction in isolation, nothing ever really works out that
way.  In reality, every instruction under test required that two instruction
sequences needed to be tested.&lt;/p&gt;

&lt;p&gt;Well, let’s be honest, that first test was built in machine code.  A &lt;a href=&quot;https://github.com/ZipCPU/blob/master/sw/zasm/optest.cpp&quot;&gt;small C++
program&lt;/a&gt; helped me
generate this code, but the instructions were written in C++, not as an input
file.  I then &lt;a href=&quot;https://github.com/ZipCPU/blob/master/bench/asm/simtest.s&quot;&gt;converted the test to
assembly&lt;/a&gt;, and built
&lt;a href=&quot;https://github.com/ZipCPU/blob/master/sw/zasm.y&quot;&gt;my own assembler&lt;/a&gt; to turn it
into machine code.  Eventually, the test was compiled using
the GNU assembler from binutils, and then turned into a
&lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/cputest.c&quot;&gt;C program&lt;/a&gt; that
I now run on every updated design.&lt;/p&gt;

&lt;p&gt;Once I knew that every instruction worked, I then declared the CPU operational.&lt;/p&gt;

&lt;p&gt;Over the next several years, I was surprised to find further bugs in my
“operational” CPU.  The list below is just a small subset of some of those bugs.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was originally a
32-bit byte machine.  Back in the day, it couldn’t handle 8-bit bytes.
Neither could I compile the C-library for the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  So, it needed to change.&lt;/p&gt;

    &lt;p&gt;When I first converted the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
to using 8-bit bytes, I came across an ugly printf bug.  This was due to
the fact that the data structure used by the
&lt;a href=&quot;https://sourceware.org/newlib&quot;&gt;newlib&lt;/a&gt; stdio library is a packed structure.
My initial data tests only tested reading and writing 32-bit words–not
bytes within a greater structure.&lt;/p&gt;

    &lt;p&gt;The broken design failed to pass &lt;a href=&quot;https://en.wikipedia.org/wiki/&amp;quot;Hello_World!&amp;quot;_program&quot;&gt;&lt;em&gt;Hello
World&lt;/em&gt;&lt;/a&gt;, so
&lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/hello.c&quot;&gt;Hello World&lt;/a&gt; is
now one of my standard tests.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When it came time to give the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
an instruction cache, I built one I called
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/master/rtl/core/pfcache.v&quot;&gt;pfcache&lt;/a&gt;.
I built a test bench for it, and verified that it did everything right when
running the test bench.&lt;/p&gt;

    &lt;p&gt;I was then convinced the prefetch worked.  Indeed, &lt;em&gt;everything&lt;/em&gt; worked well:
the bench test, the CPU test, etc. until I first placed this design into
hardware.  Once I placed things into hardware, the &lt;a href=&quot;/zipcpu/2017/12/18/ugliest-bug.html&quot;&gt;CPU broke and I was
looking everywhere else but the instruction cache for the
bug&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I have continued using the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
for some time after that, and indeed still use it today.  However, when
it came time to learn formal verification, there was a time when it became
time to &lt;a href=&quot;/blog/2018/04/02/formal-cpu-bugs.html&quot;&gt;formally verify the
ZipCPU&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;At this point, again, it passed all my test benches.  It ran many programs
successfully.  I had used it in hardware successfully for many programs.
I “knew” it worked, and had a lot of confidence in it.  I just wanted to
formally verify it.&lt;/p&gt;

    &lt;p&gt;Much to my surprise, &lt;a href=&quot;/blog/2018/04/02/formal-cpu-bugs.html&quot;&gt;there were many bugs in the
CPU&lt;/a&gt; that none
of my simulation test benches ever caught.  Many of these depended on
specific instruction sequences that I didn’t have the vision to anticipate,
and which weren’t triggered by my &lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/cputest.c&quot;&gt;C test
program&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When I first added GCC support, I ran up against a difficult problem: the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; only had instruction space
to support eight conditions.  GCC wanted support for many more conditions.
How should the missing conditions be generated?&lt;/p&gt;

    &lt;p&gt;Specifically, I had an unsigned less than comparison, but no greater than
or equal unsigned comparison.  For example, to tell if the unsigned value
Rx was less than another unsigned value Ry, and then branch if it was, one
might write:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP Rx,Ry		# Is (unsigned)Rx &amp;lt; (unsigned)Ry?
     BC  target		# Branch to target if the carry bit is set&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;To handle greater than, I could reverse the comparison.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP Ry,Rx		# Is (Unsigned)Rx &amp;gt; (unsigned)Ry?
     BC  target		# Branch to target if the carry bit is set&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;But how should I check for less than or equal?&lt;/p&gt;

&lt;p&gt;My approach for this was to add one to the comparison, so that the
   comparison became,&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP -1+Rx,Ry	# Is (Unsigned)Rx-1 &amp;lt; (unsigned)Ry?&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Again, this passed all my tests.&lt;/p&gt;

&lt;p&gt;Look closely at this solution, though.  What would happen if Rx were
   zero?  If you subtracted one from Rx it would become the greatest possible
   unsigned integer.  If you then checked the comparison, it would fail.&lt;/p&gt;

&lt;p&gt;It wasn’t until some time after I had GCC support “working” that I came
   across this bug.  Sure enough, I didn’t expect to find it in my GCC
   back end.&lt;/p&gt;

&lt;p&gt;Eventually, I solved this problem by adjusting the instruction set
   so as to get rid of the greater than comparison and to replace it with a
   no-carry check.  The solution is only so good, and sometimes breaks down
   to the point where I need to issue two branch instructions to cover
   the desired condition–but that’s really a topic for another day.&lt;/p&gt;

&lt;p&gt;My point here is simply that, when debugging one part of my design, I found
   I needed to look somewhere else entirely to trace down this bug.&lt;/p&gt;

&lt;ol start=&quot;5&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;After using the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; for many 
projects, &lt;a href=&quot;/zipcpu/2019/02/04/debugging-that-cpu.html&quot;&gt;I ran into trouble in one that was using a GbE network
controller&lt;/a&gt;.
For some strange reason, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
appeared to be randomly hanging.  I struggled to figure out why.  I mean,
it worked in my test bench, no?&lt;/p&gt;

    &lt;p&gt;When I finally traced the problem down, it was due to a race condition
in the interrupt logic.  If an interrupt happened between two halves of a
compressed instruction, the CPU would lock up.&lt;/p&gt;

    &lt;p&gt;At the time, I didn’t have any good test scripts for triggering interrupts
on the CPU.  Unfortunately, I still don’t–although I now have more formal
properties to catch bugs like this.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;At one time, the HALT instruction wasn’t working.  Sure, it would issue,
but never actually halt.&lt;/p&gt;

    &lt;p&gt;The problem was another instruction sequence thing, combined with
handling the HALT instruction with a Verilator C++ test script.
In this bug, a particular instruction sequence might keep the CPU
from halting following a HALT instruction.&lt;/p&gt;

    &lt;p&gt;Does the test bench check the HALT instruction?  Well, yes, but … only
once.  (Fixing this is on my to-do list …)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The LOCK bug: Sometimes it’s just that you haven’t thought through all of
the complex interactions between your logic.  For example, how should the
CPU step through a user instruction sequence that attempts to perform an
atomic access instruction, and yet do this from supervisor mode?&lt;/p&gt;

    &lt;p&gt;In the case of this bug, the CPU faithfully allowed the supervisor to
step through each of the sub-instructions associated with a LOCK instruction
sequence:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;   LDI  atomic_value,Ra		# Get the address of a semaphore
   LOCK				# Acquire a bus lock
   LW     (Ra),Rd		# Load the semaphore
   SUB    1,Rd			# Attempt to decrement it by one
   SW.GE  Rd			# If the updated semaphore is &amp;gt;= 0, write it back
   # The bus lock is then released, after the store instruction is issued.&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The problem with doing this, though, is that stepping through a LOCK
   sequence destroys the LOCK operation on the bus.  All four instructions
   following the LOCK instruction must complete or fail together–you can’t
   step through them or interrupt them.&lt;/p&gt;

&lt;p&gt;Lesson learned.&lt;/p&gt;

&lt;p&gt;My point in going through this list is simple: in each case, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; passed all of its simulation
test cases.  In each case, I was convinced the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; worked before placing it into
either a larger simulation environment or hardware itself.  In each case,
debugging then became harder because the bug had escaped bench testing.&lt;/p&gt;

&lt;p&gt;Yes, I now have tests that will catch most or even all of these bugs should
they ever occur again.  Am I convinced that the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is now free of all bugs?
Convinced enough to use it.  Beyond that, only time will tell.&lt;/p&gt;

&lt;h2 id=&quot;sdram-problem&quot;&gt;SDRAM Problem&lt;/h2&gt;

&lt;p&gt;I bring all this up to begin another story.&lt;/p&gt;

&lt;p&gt;Let’s go back to the story of the kind gentleman I mentioned above, Pi.
Pi wanted to build a &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; design for
some hardware he had purchased.  I didn’t have a copy of his hardware, but
sure, go ahead, copy one of my designs and place it onto your hardware.  God
bless, and have an adventure!&lt;/p&gt;

&lt;p&gt;His hardware required an SDRAM controller.  I suggested &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;one of my
own&lt;/a&gt;,
but cautioned him: not all SDRAM chips and protocols are the same.  The
required timing can change from one chip to another.  Memory size can change,
etc.&lt;/p&gt;

&lt;p&gt;I’m not sure how he did it, but he did manage to get it to work.&lt;/p&gt;

&lt;p&gt;Later on, I made some updates to the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  These changes included bug
fixes, and so it was worth upgrading his design for the new
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  The problem was that, when
he upgraded his design, it stopped working.  Your CPU, he said, was the problem.&lt;/p&gt;

&lt;p&gt;Well, if the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; has a bug in
it, then I want to fix it.&lt;/p&gt;

&lt;p&gt;That said, this left me with a bit of a dilemma: this is a kind, retired,
gentleman.  He has no significant money to hire an engineer.  My time fixing
his bug would never be paid for, and I had demanding jobs on my plate at the
time.  On the other hand, a bug in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
would reflect poorly on my work, and I try to keep my github repositories
working and debugged.&lt;/p&gt;

&lt;p&gt;So, I invested a Saturday into debugging his problem.&lt;/p&gt;

&lt;p&gt;Sure enough, it wasn’t a bug in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  Yes, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; test case was
no longer running on his hardware, but the problem wasn’t in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  His problem was due to a
misconfiguration of the SDRAM controller he had copied, and then changed to
match his chip.  That was a copy and change done with little (if any)
understanding of how the SDRAM worked in the first place.&lt;/p&gt;

&lt;p&gt;This was voodoo engineering at its best:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Voodoo Engineering, Defn:&lt;/strong&gt; &lt;em&gt;To change what isn’t broken, in an attemp to fix
what is.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;To make matters worse, the &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;SDRAM
RTL&lt;/a&gt;
was modified one way, and the &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/sim/verilated/sdramsim.cpp&quot;&gt;SDRAM simulation
model&lt;/a&gt;
no longer matched.&lt;/p&gt;

&lt;p&gt;So, as a kind teacher, I tried to point out that he had no business trying to
run or debug his design on hardware if it didn’t work in simulation.&lt;/p&gt;

&lt;p&gt;Indeed, I went further: I pointed out that he had a bug in the SDRAM
portion of his design.&lt;/p&gt;

&lt;p&gt;However, this was no longer a controller I felt responsible for.  Yes, it was
originally my controller, but Pi had since changed and significantly modified
it.  Sure, I could debug it for him, but who would then pay for my time?  It
wasn’t a bug in &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;my SDRAM
controller&lt;/a&gt;,
nor in &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/sim/verilated/sdramsim.cpp&quot;&gt;my C++ SDRAM
model&lt;/a&gt;,
nor in the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  It was a bug in
Pi’s changes.&lt;/p&gt;

&lt;p&gt;Needless to say, Pi was quite frustrated.  To my knowledge, he remains stuck in
&lt;a href=&quot;/blog/2017/05/19/fpga-hell.html&quot;&gt;FPGA Hell&lt;/a&gt; to this day.
Worse, he seems to have given up on RTL design, and he has certainly stopped
trying to get the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; working on
his board.&lt;/p&gt;

&lt;p&gt;Was his problem that hard?  Not really, but you really have to know the basics,
to include how to properly debug a simulation and trace a problem down from
the bug (the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; CPU test not
working) through to the problem (the SDRAM mis-configured).  That’s a lot of
design that needs to be traced through to find a bug.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;What conclusions might we draw from these stories?  Hardware is hard?  Maybe,
but that’s not really the conclusion I am going to draw today.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Do not place a design into hardware if the design doesn’t first work
in simulation.&lt;/p&gt;

    &lt;p&gt;This should go without saying.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If you change the RTL controller, the simulation model should need to be
changed to match.&lt;/p&gt;

    &lt;p&gt;If not, then was your simulation model really good enough in the first
place?&lt;/p&gt;

    &lt;p&gt;In Pi’s case, I’m not sure he remembered that he had changed the simulation
model …&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;While I’d like to say that debugging hardware is hard, debugging a
simulation really isn’t any harder than debugging anything in software.
In fact, simulations &lt;em&gt;are&lt;/em&gt; (technically) software.  Unlike hardware, you
have every signal available to you to analyze when running a simulation!&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;Debug by printf works in simulation&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;When using VCD/trace files, you can get even more information about
what’s going on within a design than gdb will ever give you!&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Getting a single module working is easy–especially when it is one you’ve
written yourself.&lt;/p&gt;

    &lt;p&gt;Getting 5-6 modules to work together, and to interact with external hardware?
That’s harder.  Not only do you need to know enough of how those 5-6 modules
work, and how the external module is supposed to work, but you have to know
those parts and pieces well enough that you can debug them.  You have to know
them well enough that you can find the one condition within module 3 (or
whichever one it is) that was set improperly.  It doesn’t help if those
modules were written by someone else either–this just makes the task
of an integration engineer that much more challenging.&lt;/p&gt;

    &lt;p&gt;I’ve often found hardware debugging sessions to bounce around from place
to place, as I try to chase a bug from where it manifests to its cause.
The process is time consuming and painful.  It’s also why those whose work
involves jobs like this can demand big bucks.  (At least I think they’re
big …)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If the design is complicated enough, and a different engineer has written
each of the models that need to be made to work together, then it may be
time to force all of the various engineers into the same room to get the
design to work.&lt;/p&gt;

    &lt;p&gt;In business, where you have the $$ or control to make this happen, this is
generally the most successful approach to solving integration bugs.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The bug you are looking for is rarely in the place you are looking.&lt;/p&gt;

    &lt;p&gt;I seem to have written about this often enough that it seems to be a
recurring theme on this blog.  I’ve already linked to several examples of
this above.  Not only do I experience this problem within my own work, I also
come across it when participating in online forums.  This also took place
when I was working customer support for Yosys.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;Customer: Your design doesn’t work!&lt;/p&gt;

      &lt;p&gt;Me: Well, okay, let’s do some joint debugging …&lt;/p&gt;

      &lt;p&gt;(After a lot of work …)&lt;/p&gt;

      &lt;p&gt;Me: No, actually, it’s your own design that’s at fault.&lt;/p&gt;
    &lt;/blockquote&gt;

    &lt;p&gt;Of course, to get to this point, you have to have enough confidence in how
the customer’s design works (or doesn’t) to be able to state with confidence
that it is their problem.&lt;/p&gt;

    &lt;p&gt;As a professional engineer, this interaction tends to be rather frustrating:
who do I bill for this time?  Do I bill the project the complaint was lodged
against?  That project worked.  Realistically, the bill should be given to
the customer, but that’s just not how the open source world works.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Let me know if you want to help Pi out.  I’m sure he’d like some help getting
his design working again.&lt;/p&gt;

&lt;h2 id=&quot;one-final-gem&quot;&gt;One final gem&lt;/h2&gt;

&lt;p&gt;As one final gem: some of the most challenging problems I’ve had to deal with
have involved debugging memory.  The CPU might read a value from memory and
do something inappropriate with it.  When you then try to debug the CPU,
it can be very difficult to tell where the problematic value got written to
memory in the first place.&lt;/p&gt;

&lt;p&gt;If you ever find yourself stuck dealing with this problem, try the following.&lt;/p&gt;

&lt;p&gt;First, let’s assume for discussion purposes that your memory model logic
looks something like:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i_write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Here’s the trick: check for everytime the value at this memory location
changes, and print something out anytime it does.  In Verilog, this
check could easily look like:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;localparam&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ADDRESS_WIDTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Whatever ...;&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;reg&lt;/span&gt;	&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;assign&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mem[0x%08x] &amp;lt;= %08x at time %t&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;track_valu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Of course, this logic won’t &lt;em&gt;synthesize&lt;/em&gt;, so you’ll want to remove it as
soon as you are done debugging, but it should be enough to get you to the
next step.&lt;/p&gt;

&lt;p&gt;The next step is to look at the output of your simulation to find where in
the trace the wrong value got written to memory.  Now go look up that time
in the trace, and you’ll be able to continue your work backwards through the
logic until you can find the source of your bug.&lt;/p&gt;

&lt;p&gt;Oh, and yes, you can use this basic technique when using a Verilator C++ model
as well, it’s just that the code for it will look a bit different.
Indeed, this technique would’ve sent Pi directly to his problem.  Perhaps
he’ll even read this article and manage to find his bug, since he &lt;em&gt;is&lt;/em&gt; an avid
reader of this blog.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Many will say to me in that day, Lord, Lord, have we not prophesied in thy name? and in thy name have cast out devils? and in thy name done many wonderful works?  And then will I profess unto them, I never knew you: depart from me, ye that work iniquity. (Matt 7:22-23)&lt;/em&gt;</description>
        <pubDate>Tue, 30 Aug 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/zipcpu/2022/08/30/not-my-fault.html</link>
        <guid isPermaLink="true">https://zipcpu.com/zipcpu/2022/08/30/not-my-fault.html</guid>
        
        
        <category>zipcpu</category>
        
      </item>
    
      <item>
        <title>Protocol Design for Network Debugging</title>
        <description>&lt;p&gt;What do you do when you need
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;,
but don’t have it?&lt;/p&gt;

&lt;p&gt;Let me back up and set the stage a bit more.  I’m working with what will be
an underwater design, as shown in Fig. 1.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig 1. Controlling an Underwater FPGA&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/sysdesign.svg&quot; alt=&quot;&quot; width=&quot;780&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For those who haven’t figured it out, this will (eventually) form the basis of
a SONAR device.&lt;/p&gt;

&lt;p&gt;At first, this problem seems simple enough: there will be an FPGA device
controlled via a network port.  Easy, got it.  Better yet, what’s the easiest
network protocol to use?
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;.  Open
Source &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;,
software stacks aren’t all that hard to write, and I know there are several
open source stacks that are easy enough to use.  (No, I’ve never written one
myself …)&lt;/p&gt;

&lt;p&gt;But, let’s dig a little deeper: I want to be able to control and debug the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
via the same network port.  That means I’ll want to be able to &lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;stop the CPU,
read its registers, adjust the contents in RAM, and then restart it
again&lt;/a&gt; all
over the network.  Put another way, if the CPU software won’t be running at
all times, then I can’t implement
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;
in software and still debug the CPU using the same
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;
stack.  Worse, what if the FPGA firmware can’t be trusted?
Now things are getting a bit more challenging.  How shall a piece of broken
FPGA firmware be updated without using software on the FPGA board?&lt;/p&gt;

&lt;p&gt;This, then, is where this problem starts.&lt;/p&gt;

&lt;p&gt;At the most basic level, any FPGA design can be halted and updated via the JTAG
port.  Most vendor designs will allow for that.  However, in this design, that
JTAG port will be quite literally underwater.  The only way to access it will
be to bring the entire unit back out of the water, to dry off the chassis the
FPGA board sits within, and then to uncap the JTAG port and access it.  This
is the insurance policy for the project–guaranteeing that the chassis the
hardware sits within will not need to be opened except in extreme circumstances.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 2. Reconfiguring a running FPGA&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reconfig-plan.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;That’s not, however, going to be the normal mode of operation.  Normally, upon
application of power, this design will need to automatically start up and then
do something to allow itself to be updated.  This can be done via an
Internal Configuration and Access Port (ICAP) found within the FPGA itself.
If a second design configuration can be written to the
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;,
the ICAP port can then be told to tell the FPGA to reconfigure itself from
this second configuration location.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 3. Basic outline of a UART protocol to control a Wishbone Bus&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/wb-uart-ovw.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Normally, I handle this sort of problem within my designs using a &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial
port&lt;/a&gt;
together with what I call a “debugging bus”: a protocol, running over
that &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;,
that allows me to read from or write to any address on the bus within the FPGA.
&lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;We’ve discussed this protocol
before&lt;/a&gt;, and for
reference you can see the basic components of this protocol in Fig. 3 on the
left: Commands are grouped into words, decompressed, placed into a FIFO, and
then those commands are used to control the bus.  Bus returns then come back.
Reset acknowledgments and interrupts get added to the return stream, which is
then compressed and split back into bytes before being returned across the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;.
In general, this works great, and I’ve used this approach for years.
Even better, having full bus access makes it really easy to debug the FPGA–as
long as you can guarantee that neither the debugging bus protocol nor the bus
itself will fail on you.&lt;/p&gt;

&lt;p&gt;That’s great for a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; protocol,
where character’s aren’t (generally) lost and where messages don’t
accidentally get repeated.&lt;/p&gt;

&lt;p&gt;But what about a network protocol?&lt;/p&gt;

&lt;p&gt;Today’s discussion, then, will discuss a network protocol which can be used
to do this same thing, but with an interface simple enough that it can be
implemented in an FPGA.&lt;/p&gt;

&lt;h2 id=&quot;understanding-the-problem&quot;&gt;Understanding the Problem&lt;/h2&gt;

&lt;p&gt;Let’s back up, therefore, and take a moment to understand the goal and purpose
of this protocol together with some of what makes the networking environment
unique.  This will lead us to an understanding of some of the problems
involved that will need to be handled by this protocol.&lt;/p&gt;

&lt;h3 id=&quot;all-network-traffic-takes-place-in-packets&quot;&gt;All network traffic takes place in packets&lt;/h3&gt;

&lt;p&gt;The first rule of networks is that all communication takes place in packets.
Even better, since we’ll be using Ethernet, &lt;a href=&quot;https://en.wikipedia.org/wiki/Ethernet_frame&quot;&gt;every Ethernet
packet&lt;/a&gt;
ends in a four byte &lt;a href=&quot;https://en.wikipedia.org/wiki/Frame_check_sequence&quot;&gt;Frame Check
Sequence&lt;/a&gt;
based upon a &lt;a href=&quot;https://en.wikipedia.org/wiki/Cyclic_redundancy_check&quot;&gt;Cyclic Redundancy Check
(CRC)&lt;/a&gt;.  These four
bytes are produced by a function applied to the contents of the packet.  Then,
on reception, the receiving end can also calculate the same function.  If the
result matches the four-byte frame check sequence found in the packet, then
you can have some strong assurance that the packet was received across the
interface without error.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-be-lost&quot;&gt;Packets may be lost&lt;/h3&gt;

&lt;p&gt;Here’s our first problem: if something goes wrong on the network–perhaps
there’s too much congestion somewhere, perhaps the FPGA is still responding to
some other packet, then a packet may be dropped.  Indeed, &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;we discussed this
sort of idea&lt;/a&gt; quite
recently.  In network implementations, dropped packets are considered a
“normal” phenomena, and any protocol working across the network needs to be
able to recover from a lost packet.&lt;/p&gt;

&lt;p&gt;Think this through a bit, since this can be a real problem.  What happens if
the bus within the FPGA locks up because some peripheral isn’t responding?
In the worst case, all following packets will be lost–to include any
packets telling the FPGA to reset itself.  This is a real possibility that
we’ll need to consider as things go on.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-be-repeated&quot;&gt;Packets may be repeated&lt;/h3&gt;

&lt;p&gt;The next problem is that packets may be repeated.&lt;/p&gt;

&lt;p&gt;At first, I simply poo-pood this idea.  This would never happen in any of &lt;em&gt;my&lt;/em&gt;
implementations, I told myself, because nothing in the network stack will ever
repeat a packet.&lt;/p&gt;

&lt;p&gt;Then I got to thinking some more about this.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 4. Request/Reply protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reqreply.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Imagine you have two computers talking to each other, and one computer (the
client) makes a request of the second (the server/FPGA).  If the request gets
dropped, how shall the first computer (the client) know it was dropped except
if it doesn’t get any response?  Worse, if the client doesn’t get any response,
does that mean 1) the server didn’t get the request, or 2) that the server did
get and process the request and the client just didn’t get the reply?  All the
client can do at this point is to just re-send and re-send its packet until
it eventually gets a reply.&lt;/p&gt;

&lt;p&gt;Voila, repeated packets.  We’ll need to handle these somehow.&lt;/p&gt;

&lt;p&gt;Now lets make matters even worse: some requests, such as commanding the
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;
device to erase a sector or to program a page, aren’t things you want to do
twice.  Any network based debugging protocol will therefore, of a necessity,
need to be able to properly handle duplicated packets.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-arrive-out-of-order&quot;&gt;Packets may arrive out of order&lt;/h3&gt;

&lt;p&gt;Just to make things worse, not only may packets get dropped or repeated, they
might also arrive out of order.&lt;/p&gt;

&lt;h3 id=&quot;udpip-is-a-fairly-simple-protocol&quot;&gt;UDP/IP is a fairly simple protocol&lt;/h3&gt;

&lt;p&gt;One of the easiest protocols to implement in an FPGA is
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;.  1) &lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L130-L136&quot;&gt;It’s easy
enough to program most computers to send UDP
packets&lt;/a&gt;,
and 2) &lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L156-L187&quot;&gt;receiving UDP packets is relatively easy as
well&lt;/a&gt;.
Even better, if implemented well, the &lt;em&gt;internet&lt;/em&gt;
(the &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; part) has some remarkable
capabilities to it: I might even be able to access this piece of underwater
hardware from the other side of the world if necessary.  On the FPGA side,
there are some challenges involved in implementing
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;,
but the result is still fairly easy to accomplish.  Some of these challenges
include:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The FPGA needs to know the Ethernet MAC address, IP address, and destination
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; port to send the
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; packet to.&lt;/p&gt;

    &lt;p&gt;These can often be copied from the source addresses found in the request,
so that’s not a big problem.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Both &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
and &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
headers need to know the length of the rest of the
packet–possibly even before the rest of the packet has been formed.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; header
and &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; payload
&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4_header_checksum&quot;&gt;checksums&lt;/a&gt; are
implemented, these are also placed &lt;em&gt;prior&lt;/em&gt; to the packet data.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This sort of necessitates that a packet be formed first and placed into
a temporary buffer, before being forwarded downstream.  Still, this is quite
doable.&lt;/p&gt;

&lt;p&gt;The problem with &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;,
however, is that it offers no protection against the problems listed above:
packets may still be dropped, duplicated, or arrive out of order.&lt;/p&gt;

&lt;h3 id=&quot;ip-packets-may-be-fragmented&quot;&gt;IP packets may be fragmented&lt;/h3&gt;

&lt;p&gt;If a packet is too big for some portion of the network, then whatever
intermediate node recognizes this is supposed to be able to split the packet
into multiple sub-packets (fragments).  These packets will then be reassembled
on the far end.&lt;/p&gt;

&lt;h3 id=&quot;tcpip-requires-memory&quot;&gt;TCP/IP requires memory&lt;/h3&gt;

&lt;p&gt;I’ve used &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
in the past.  In general, it’s always been one of my favorite
protocols to work with: it’s easy and reliable.  However, I’ve never had to
implement it before, neither have I ever tried to implement it on an FPGA.
When digging into what it would take to implement the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
within an FPGA, it doesn’t take long to learn that each connection will require
some amount of memory to work properly–perhaps as much as 64kB per connection.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The connection setup defines the maximum and required sizes of this window&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Packet data includes where in the stream the data comes from&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Acknowledgments include the latest received stream position&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Further, &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
removes packet boundaries in favor of transmitting stream positions.  In many
ways, though,
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
might be the ideal way of encapsulating what was once a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; stream.&lt;/p&gt;

&lt;p&gt;Others have made this protocol work on an FPGA, so I know it can be done.
In my review, however, I ended up balking at the idea of implementing my own
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
protocol handling stack within FPGA logic.  (I’ll probabbly still place an
implemention of the &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
stack within the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
software before I’m done …)&lt;/p&gt;

&lt;h3 id=&quot;gbe-is-fast&quot;&gt;GbE is fast&lt;/h3&gt;

&lt;p&gt;From my experience, and with the boards I have, a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
can typically achieve speeds somewhere between about 100kB/s (1MBaud) and
400kB/s (4MBaud).  Gigabit Ethernet, on the otherhand, can transfer data at
125MB/s.  That’s probably faster than I need for this part of the project.
The biggest impact this is likely to have, though, is that it might keep my
compression algorithm from working–since that algorithm only tries to
compress a response value as long as the return pipeline is stalled.  If the
link is so fast that it never stalls, then it might make sense to remove to
remove the &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
compression from this network re-implementation.&lt;/p&gt;

&lt;h3 id=&quot;the-goal&quot;&gt;The Goal&lt;/h3&gt;

&lt;p&gt;Just to make it clear, my goal is to be able to control the bus within an
FPGA design from a network interface.  This means I want to be able to read
from and write both peripheral registers as well as
&lt;a href=&quot;/zipcpu/2018/07/13/memories.html&quot;&gt;memory&lt;/a&gt; and
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;.
Using this capability, I want to be able to do things like:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Reading, erasing, programming, and verifying &lt;a href=&quot;https://en.wikipedia.org/wiki/Flash_memory&quot;&gt;flash
memory&lt;/a&gt; contents&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Issuing a warm boot request, so that the FPGA will reload itself from
a secondary location&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Configuring any application specific hardware from an external host.&lt;/p&gt;

    &lt;p&gt;As one example, I’m hoping to control an &lt;a href=&quot;https://www.analog.com/en/products/adau1761.html&quot;&gt;ADAU1761 audio
chip&lt;/a&gt;
on a &lt;a href=&quot;https://store.digilentinc.com/nexys-video-artix-7-fpga-trainer-board-for-multimedia-applications&quot;&gt;Nexys Video board&lt;/a&gt;.
The network bus should be able to turn this chip on, adjust which
channel(s) are selected, and any gain associated with the individual
channels.&lt;/p&gt;

    &lt;p&gt;I expect to use a separate protocol to handle the return audio from such
a controller.  For now, I just want a dependable network protocol I can use
to guarantee my ability to configure this controller across the network in
the first place.&lt;/p&gt;

    &lt;p&gt;This is a test-only capability, to allow an operator to “hear” any
internal signals while the device is still on the bench.  Once the device
is sealed up, similar circuitry within the device will be used to route
from among multiple potential signal sources and sinks to their ultimate
destinations.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Without access to JTAG, I won’t have any vendor tools available for internal
logic analysis in order to diagnose any faults.  Instead, I’ll be using my
own &lt;a href=&quot;/blog/2017/07/08/getting-started-with-wbscope.html&quot;&gt;Wishbone
scope&lt;/a&gt;
across this network protocol.&lt;/p&gt;

    &lt;p&gt;This also means that I’ll want to assume only a bare minimum of design
functionality here.  What happens, for example, if I need to debug the
DDR3 SDRAM protocol?  In that case, I would need to be able to operate
this bus without access to any but internal FPGA memory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;Rebooting, pausing, stepping, and stopping or starting the CPU within the
design&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;Examining CPU
registers&lt;/a&gt;
when the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
is halted, and perhaps adjusting their contents if necessary.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That’s my goal, and you now know the problems associated with working with the
network.  Now, knowing this information, what can we do in order to generate
some form of protocol that we can use?&lt;/p&gt;

&lt;h2 id=&quot;generating-a-protocol&quot;&gt;Generating a Protocol&lt;/h2&gt;

&lt;p&gt;Let’s take a moment to walk through the design of this new protocol, and the
various choices I chose along the way to deal with the problems listed above.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 5. Encapsulating the former serial port protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/netb-encapsulation.svg&quot; alt=&quot;&quot; width=&quot;240&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;My first draft of this protocol, the draft I’ll be discussing today, simply
involved packetizing the requests I would’ve sent over the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; in the
first place.  That means these debugging bus packets simply include an
additional header on top of the headers already existing, together with a
set of bytes which would’ve normally been sent across a &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial
port&lt;/a&gt;.  We’ll call this
the “NetBus header” and “serial port debugging bus payload” or just “payload”
for short.&lt;/p&gt;

&lt;p&gt;My second (rather arbitrary) choice was to insist that all protocol
interactions take place in two parts: 1) the support software sends a request,
and 2) the FPGA returns a reply.  Moreover, as I alluded to above, &lt;em&gt;every&lt;/em&gt;
request was to receive a reply.  Should a reply not be returned, that would
mean that either the FPGA either didn’t receive the request or that the
response hadn’t been received.  This also meant that the FPGA would never
initiate a transaction on its own, it would only ever respond to requests.&lt;/p&gt;

&lt;p&gt;Incidentally, this also solves the problems associated with out of order
packets: if only one request is ever outstanding at a time, then there will
never be two or more packets to get reversed.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 6. Eight GPIO bits&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/gpio.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;One of the neat features of my serial port protocol was that it had a special
means of communicating
&lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupts&lt;/a&gt; to the host
computer.  At one time I used this feature with my &lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;original flash
controller&lt;/a&gt;
to notify any programming software of the end of a write transaction.  This
was cool, but … perhaps we could expand upon it?  For example, it’d be nice
to get some status bits from the controller.  Such status bits might include
answers to questions like: Has the buffer within the controller ever suffered
from an overrun?  Has the controller received any bus error responses?  Is this
the first packet following a reset?  All of this together necessitated a set of
general purpose I/O bits that could be controlled via this protocol.  So far,
I’ve settled upon four of the eight bits shown in Fig. 6.  These would be
sticky bits when set, and only cleared upon a write from the external host.
Another four bits remain available for … whatever purpose.&lt;/p&gt;

&lt;p&gt;I created this capability with two parts: a mask and a value.  That way,
any GPIO bit could be updated whose mask bit was set to the value it was set
to, allowing independent control of each of these bits.  Further, by setting
the mask to zero, the FPGA would simply ignore these bits.  Indeed, this I/O
part of the protocol is very similar to &lt;a href=&quot;/zipcpu/2019/02/09/cpu-blinky.html&quot;&gt;one we’ve discussed
before&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My third choice was to place a stream packet ID number into the header of the
packet.  The FPGA can then use this ID to identify and handle repeated packets.
This way, should the FPGA ever detect a second request with the same frame
number, then it would simply repeat the response to the prior packet with
that frame number.&lt;/p&gt;

&lt;p&gt;One stream ID was designated as special: ID=0.  This indicated a “Sync” packet
in this protocol.  This would be the ID I would use when initiating a
communication with the device.  I could then use this packet to record and set
the Ethernet MAC, IP address, and UDP port of the source, as well as to
reset the state of the internal compression engine to something that could
be known within the client program.  This way, upon starting a client program,
the client could quickly synchronize the two compression engines.&lt;/p&gt;

&lt;p&gt;Further, the design should handle packets with an empty payload, as sort of a
“keep-alive” packet.&lt;/p&gt;

&lt;h3 id=&quot;request-packet-format&quot;&gt;Request Packet Format&lt;/h3&gt;

&lt;p&gt;These choices led me to the packet design for request packets shown in Fig. 7.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 7. Host to FPGA Packets&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/host-to-fpga.svg&quot; alt=&quot;&quot; width=&quot;760&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;In general, the host only added four bytes to any payload.  The first two were
the packet ID.  This ID could be anything, with zero having the special meaning
discussed above, and the second requirement being that ID’s shouldn’t be
repeated in succession.&lt;/p&gt;

&lt;h3 id=&quot;reply-packet-format&quot;&gt;Reply Packet Format&lt;/h3&gt;

&lt;p&gt;The reverse link is very similar, if not almost identical.  There are only
a couple of differences.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 8. FPGA to Host Reply Packets&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/fpga-to-host.svg&quot; alt=&quot;&quot; width=&quot;760&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For example, all replies will include the host packet’s ID number so the host
can know which request is being replied to.  This will allow the host to
remove duplicate packets from the return stream.&lt;/p&gt;

&lt;p&gt;Further, all replies will include sixteen general purpose I/O bits.  Eight of
these, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;i_gpio&lt;/code&gt;, are input bits collected from somewhere in the system–such as
the &lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt&lt;/a&gt;
bit.  Indeed, we discussed four of these bits above, while the other four
remain uncommitted.  The other eight bits, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;o_gpio&lt;/code&gt;, are a simply a
reflection of the current settings as generated by the last packet sent by the
host controller.&lt;/p&gt;

&lt;p&gt;The next word, however, is generated within the FPGA logic.  The first
16-bit field of this word is the prior packet ID from the previous packet.  This
was chosen so that, in high speed situations, I might send two packets to the
FPGA and then have some assurance the FPGA had received both in case the
first response was dropped.  The next sixteen bits are simply a one-up packet
counter from the FPGA.  This counter would be increased on any sends or
re-sends, allowing the host to identify where, if at all, packets get lost
in this system.  Is it between the host and the FPGA, or on the return trip
from the FPGA to the host?&lt;/p&gt;

&lt;h3 id=&quot;building-the-clients-state-machine&quot;&gt;Building the Client’s State Machine&lt;/h3&gt;

&lt;p&gt;Before concluding, let’s take a quick look at what the host control
software would look like for this.  We’ll base this look upon a
&lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L130-L136&quot;&gt;UDPSOCKET&lt;/a&gt;
implementation that encapsulates any issues of issuing packets to or receiving
packets from the O/S.&lt;/p&gt;

&lt;p&gt;A couple of other fields will allow us to keep a copy of the last
received packet, or the packet we are getting ready to send.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt;	&lt;span class=&quot;nc&quot;&gt;NETBUS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RDBUFLN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TXBUFLEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;UDPSOCKET&lt;/span&gt;	&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The first step, therefore, in communicating with this new FPGA protocol is
to establish a connection.  This is done by sending a sync packet.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// Make up to MAXTRIES attempts to synchronize&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAXTRIES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Try sending a sync packet&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Clear the 4-byte header, then send a packet of 4bytes only&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Turn this into a UDP packet and send it&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;m_udp-&amp;gt;write&lt;/code&gt; will call the system to actually send this across a UDP
port we’ve connected ourselves to.&lt;/p&gt;

&lt;p&gt;The purpose of the for loop is so that, in the case that we don’t get any
response, we can try sending up to MAXTRIES of these packets.&lt;/p&gt;

&lt;p&gt;The next step is to look for the return packet.  We’ll wait &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PKT_TIMEOUT&lt;/code&gt;
milliseconds for this return–using the poll() system call to implement this
timeout.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;		&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RDBUFLN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PKT_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Now that we have a return packet, let’s look for and assemble the packet ID.
If this ID is not zero, then this isn’t a response to our sync request.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;		&lt;span class=&quot;n&quot;&gt;rxframe&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rxframe&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// This is a return from another request&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// Ignore it.&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If after &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MAXTRIES&lt;/code&gt; attempts we still don’t get a response, we’ll throw a
bus error so that the system can deal with this further up in the chain.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BUSERR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Otherwise, if we do have a good packet, we can look through the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;i_gpio&lt;/code&gt; values
and record or process them as necessary.  For example, this is where we’d
mark that we’d received an interrupt of some type.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Mark how long the packet is that's in our buffer&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;handle_gpio_returns&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Sending data to the device is very similar.  First, you’d generate a packet
header.  Here we choose to use a pseudorandom number algorithm, although you
can use roughly any algorithm you want–as long as it doesn’t generate a
zero packet ID.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;begin&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BUSW&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Last packet was a sync packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Following a sync, the first ID == 1&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RANDOMIZER_COEFFICIENTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Following the header, we’ll encode the address of the subsequent transaction.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;c1&quot;&gt;// Return a pointer to the packet following the&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// address&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;At this point, we can fill our packet with data to be written to the device.&lt;/p&gt;

&lt;p&gt;Once done, we’ll try writing this data to the device &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MAXTRIES&lt;/code&gt; times, or
until we get a response.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAXTRIES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Send the request packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pktlen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Try reading a packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;readpkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PKT_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// We were successful!&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Otherwise we repeat&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BUSERR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// Search the returned packet for evidence of a bus error.  If we&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// get a bus error, we'll throw an exception as above.&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’ll then repeat this process until all of the data we need sent has been
sent.&lt;/p&gt;

&lt;p&gt;As you can see, the protocol is pretty simple from a software standpoint to
get working reliably.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;It works.&lt;/p&gt;

&lt;p&gt;That’s all that matters, right?&lt;/p&gt;

&lt;p&gt;Well, not quite.  In reality, this is just my first draft of a packet protocol
of this type.  For example, I haven’t implemented IP defragmentation.  (Nor
am I really planning on doing so in the FPGA hardware.)  Neither have I
implemented &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; support beyond version 4,
or impemented any header option support.  Similarly, I haven’t implemented any
support for zero length packets beyond the original sync packets.&lt;/p&gt;

&lt;p&gt;You can see a list of potential improvements I’ve been considering in Fig. 9.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 9. Potential upgrades to this protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/upgrades.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For perspective, I rewrote my original &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;serial port bus
protocol&lt;/a&gt; about
three times before finally I arrived at something I liked.  Each version was
then better than the previous one.  Indeed, even now I have a fourth version of
that &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;serial port protocol&lt;/a&gt;
that I’m slowly testing.  However, since this fourth version can only get
about a 10% speed improvement over the current version for the same baud
speed, it hasn’t gotten a lot of priority.  Put simply, the speed of the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
isn’t really slowing me down significantly.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 10. Learning and rebuilding is to be expected&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reproofs.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;That in itself is a lesson in any endeavor, and one I learned when working on
my Ph.D.  I like to sum it up with this advice to students, “Fail early. Fail
often. Plan for failure.”  Or, alternatively, “Success is measured by the
number of failures that it takes to achieve it.”  (These quotes are my own …)
Given that the best design is never the first one, you should plan on
rebuilding any design once or twice before it will become the best design
that you want to use and reuse over and over again.&lt;/p&gt;

&lt;p&gt;From a more business perspective, I might argue the advice would be to put
lots of energy into &lt;a href=&quot;/blog/2020/01/13/reuse.html&quot;&gt;anything you intend to use more than
once&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From all these perspectives, this is only a first design and draft of such
a protocol.  I expect it to get better over time.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Can two walk together, except they be agreed? Amos 3:3&lt;/em&gt;</description>
        <pubDate>Wed, 24 Aug 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/08/24/protocol-design.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/08/24/protocol-design.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>Quiz #21: Verifying all configurations of a design</title>
        <description>&lt;!-- answer: &quot;2022/07/16/fv-answer20.html&quot; --&gt;

&lt;p&gt;Many of my designs have multiple configurations.  For example:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU supports both pipelined and non-pipelined implementations.
How shall the CPU be verified?  Against a pipelined implementation or a
non-pipelined one?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU supports a compressed instruction set.  This costs area.
Although the area cost is minimal, what if I don’t want to support it?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU can be built either with or without a user mode.  Many micro
controller environments don’t need the user mode together with the headaches
associated with using it.  How shall I make sure this supervisor-only mode
remains supported, even if I don’t use it very often?&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This quiz gets to the answer to these questions.&lt;/p&gt;
</description>
        <pubDate>Sat, 16 Jul 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/quiz/2022/07/16/quiz21.html</link>
        <guid isPermaLink="true">https://zipcpu.com/quiz/2022/07/16/quiz21.html</guid>
        
        
        <category>quiz</category>
        
      </item>
    
      <item>
        <title>ZipCPU Lesson: If it's not tested, it doesn't work.</title>
        <description>&lt;p&gt;The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; &lt;del&gt;has&lt;/del&gt; &lt;em&gt;had&lt;/em&gt; a problem.
It’s kind of fundamental to digital design, so let’s chat about it.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 1, The &quot;No testy--no worky&quot; principle&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/no-testy-no-worky.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;It begins with the goal of the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.
The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is designed to be low logic,
and that’s where the problem begins.  The problem is simply that low logic
means different things to different people.  Low logic means one thing on an
iCE40 with only 8k 4-LUTs.  Low logic means something else on a Spartan 6, and
something else entirely on a 20k 6-LUT Artix-7.  It means one thing when
driving a &lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone
bus&lt;/a&gt;, and another thing
when &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;driving an AXI
bus&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The natural consequence of trying to support multiple design requirements and
different targets is that the CPU is highly parameterized.  In general, this
is a good thing.&lt;/p&gt;

&lt;p&gt;We’ve discussed how to handle &lt;a href=&quot;/zipcpu/2018/12/20/sby-makefile.html&quot;&gt;formally verifying parameterized
designs&lt;/a&gt;.
That’s not all that hard to do, although &lt;a href=&quot;/zipcpu/2018/12/20/sby-makefile.html&quot;&gt;the
article&lt;/a&gt; needs a bit
of updating.  Specifically, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chparam&lt;/code&gt; in Yosys should only be used as an
argument to a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hierarchy&lt;/code&gt; command, but that aside handling multiple parameters
is still quite easy to accomplish formally.&lt;/p&gt;

&lt;p&gt;My problem is that my formal proofs don’t quite capture &lt;em&gt;everything&lt;/em&gt;.
Yes, those things they do capture they do so exhaustively, but I still keep
finding a bug every now and again at integration time when two things don’t
work together like they should.&lt;/p&gt;

&lt;p&gt;Frankly, I need a simulation solution that can test the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; in each and every one of its
many potential configurations.  That’s what I’d like to discuss today.&lt;/p&gt;

&lt;h2 id=&quot;first-approach-the-zbasic-system&quot;&gt;First approach: The ZBasic System&lt;/h2&gt;

&lt;p&gt;My previous approach at testing the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was the separate
&lt;a href=&quot;/zipcpu/2018/02/12/zbasic-intro.html&quot;&gt;ZBasic&lt;/a&gt; repository.
This is simply a demonstration system connecting the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; to a variety of other
components.  Most notable among these other components are the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/memdev.v&quot;&gt;block RAM
memory&lt;/a&gt;, the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/wbuart/wbuart.v&quot;&gt;serial
port&lt;/a&gt;, and the
&lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;debugging bus&lt;/a&gt;.
Other less notable components include the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/sdspi/sdspi.v&quot;&gt;SPI based SD card protocol
controller&lt;/a&gt; and
the &lt;a href=&quot;/zipcpu/2019/02/09/cpu-blinky.html&quot;&gt;GPIO controller&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That makes the &lt;a href=&quot;/zipcpu/2018/02/12/zbasic-intro.html&quot;&gt;ZBasic&lt;/a&gt;
system into a pretty complete great demonstration system–for simulating a
single configuration.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;It offers as much &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/memdev.v&quot;&gt;block
RAM&lt;/a&gt;
as your simulation environment will allow&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/wbuart/wbuart.v&quot;&gt;serial
port&lt;/a&gt;
has both transmit and receive functionalities, so you can interact with
the CPU.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When using &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;,
the &lt;a href=&quot;/blog/2020/04/01/design-flow.html&quot;&gt;SD card can be treated as a full SD card of whatever
size is necessary&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is all great, but it’s hardly ideal for testing the &lt;em&gt;CPU&lt;/em&gt;–even though
that’s what I’ve used it for.&lt;/p&gt;

&lt;p&gt;To that end, I built several CPU tests that I have kept in the
&lt;a href=&quot;https://github.com/ZipCPU/zbasic&quot;&gt;ZBasic repository&lt;/a&gt; to help me know if the
CPU is working.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://github.com/ZipCPU/zbasic/blob/master/sw/board/cputest.c&quot;&gt;There’s the standard CPU
test&lt;/a&gt;, which
is designed to check the performance of (almost) every instruction in
isolation.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s a &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/hello.c&quot;&gt;Hello World
test&lt;/a&gt;, which
I’ve included in order to flesh out any obvious problems with the C-Library.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s another &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/hellostep.c&quot;&gt;Hello World
test&lt;/a&gt;
that works by stepping through the &lt;a href=&quot;https://en.wikipedia.org/wiki/%22Hello,_World!%22_program&quot;&gt;classic Hello World
program&lt;/a&gt; one
instruction at a time: a supervisor mode task sets up the program in user
mode, and then steps through it.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, there’s a &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/lockcheck.c&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction checking
program&lt;/a&gt;.
This one generates three (or four) concurrent tasks all attempting to get
access to the same MUTEX and then verify that they have said MUTEX.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These programs are what actually tests the CPU–which was the original purpose
of the &lt;a href=&quot;https://github.com/ZipCPU/zbasic&quot;&gt;ZBasic repository&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The most obvious problem I’ve alluded to so far is that this repository only
tests a single configuration.  That configuration tends to be a full pipeline,
cache enabled, Wishbone design.  The next big problem is that the test is
dependent on many other (non-CPU) components for success.&lt;/p&gt;

&lt;p&gt;The result of all of this is that I’ve often published changes to the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; repository that … broke one
part or another of the CPU and then never realized it.&lt;/p&gt;

&lt;p&gt;Frankly, I needed a better testing environment.&lt;/p&gt;

&lt;h2 id=&quot;envisioning-a-better-simulation-test&quot;&gt;Envisioning a better simulation test&lt;/h2&gt;

&lt;p&gt;When thinking over what I needed, I decided upon three goals for a new
simulation environment.  Obviously, it needed to test multiple configurations.
That was my first goal.  But that also lead to my second goal, which was that
I wanted my simulation environment to test both the
&lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone&lt;/a&gt;
and &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;AXI front ends&lt;/a&gt;.
Finally, I also wanted this new simulation environment to be all Verilog.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 2, Supported base ZipCPU configuration groups&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/zip-configs.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The first step was to identify a series of “supported” configurations.
I chose to define 22 such configurations, of which I’m (currently) only testing
the 14 I’ve ever used in practice.  The 22 configurations fall into six basic
groups:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;ASM&lt;/strong&gt;: The Assembly only configuration is the lowest logic configuration of
the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  It doesn’t have full
instruction support, neither does it support user mode.  Missing instructions
include shifts by more than one bit, multiplies, and divides.  Worse,
without user mode, there’s no way to trap on one of these instructions being
illegal.  As a result, you can’t really use this configuration with GCC.
GCC will often attempt to implement one (or more) of these instructions, and
without the ability to trap on them there’s no real way to rescue a program
so generated for this configuration.&lt;/p&gt;

    &lt;p&gt;While this configuration is defined, there are no tests assigned to it.
Yet.  (Technically, that makes this configuration unusable.  Remember,
if it’s not tested then it doesn’t really work.)&lt;/p&gt;

    &lt;p&gt;What I really like about this configuration is that this represents the
lowest logic configuration of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;: requiring only 584 Xilinx
7-Series 6-LUTs.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;TRAP&lt;/strong&gt;: This configuration now supports shifts, user mode, and the lock
instruction.  Since it supports user mode, it also supports traps, and so
the CPU can now support the divide and multiply instructions from user
mode–assuming I ever build the trap software to handle such instructions
properly.&lt;/p&gt;

    &lt;p&gt;Without the software to support this TRAP configuration, or for that matter
without a GCC flag implemented to replace divide and multiply instructions
with soft equivalents, there are no tests of this configuration yet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;MIN&lt;/strong&gt;: This is the minimum CPU configuration supported by a generic ZipCPU
backend for GCC.  It includes support for multiplies, divides, shifts, lock
instructions, user mode, and the compressed instruction set.  This
configuration uses the most basic instruction fetch and memory controllers.
This also the only configuration where the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is not running its
full pipeline.  Finally, this configuration is the first of several that
allows the CPU to be externally configured: the CPU may be reset, halted, or
stepped externally and registers within the CPU may be now read and written
externally,&lt;/p&gt;

    &lt;p&gt;This is the minimum configuration that I can currently test automatically.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;PIPE&lt;/strong&gt;: This is the minimum pipelined configuration.  Yes, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is
pipelined by design, but that can require too much logic for some hardware
to handle.  Therefore, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
supports both pipelined and non-pipelined configurations.  This configuration
is the first of the pipelined configurations.  It also uses (naturally) the
piped fetch and memory controllers–allowing multiple bus requests to be
outstanding at any given time.  As an extra bonus with pipelining, this is
the first configuration supporting early branching.&lt;/p&gt;

    &lt;p&gt;In this case, early branching is defined by any branch recognized by the
instruction decoder, which can be forwarded to the instruction fetch
prior to the associated instruction making its way through the rest of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s pipeline.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;CACHE&lt;/strong&gt;: Here’s where we get to a more traditional CPU configuration.  In
this configuration, both instructions and data are kept in a (nominally 4kB)
cache.  Because this configuration is cached, this is also the first one that
has a chance of keeping the CPU’s pipeline fully loaded.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Low Power&lt;/strong&gt;: The final configuration has been optimized for low power.  This
configuration is the same as the CACHE configuration above, save for two
changes.  First, unused signals have been zero’d out to prevent any
unnecessary toggling.  Since this costs extra logic to do, it’s not the
primary or default configuration by any means.  Second, this configuration
enables the &lt;a href=&quot;/blog/2021/10/26/clkgate.html&quot;&gt;clock gating feature that we’ve discussed
before&lt;/a&gt;.  As a result,
whenever the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is sleeping
(i.e. waiting for an interrupt), the CPU’s clock will be turned off when
using this configuration.&lt;/p&gt;

    &lt;p&gt;No, it’s not likely I’ll be able to use this in any FPGA projects, but I
do use it from time to time on simulation projects and so it’s
nice to know it can be done.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That’s six basic configurations, of which I have tests defined for only
four at present.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 3, All 22 ZipCPU test configurations&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/all-configs.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Then, for each of these four configurations, I want to
test the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; in one of four
environments:
using a basic Wishbone wrapper I call the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;,
a second Wishbone wrapper with an attached peripheral set
(&lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timers&lt;/a&gt;,
&lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt controller&lt;/a&gt;s,
some performance counters, a
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/wbdmac.v&quot;&gt;DMA&lt;/a&gt;,
etc.)
called the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;,
an &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;AXI-Lite&lt;/a&gt;
wrapper called
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;ZipAXIL&lt;/a&gt;,
or finally a &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;Full AXI
wrapper&lt;/a&gt; I call
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt;.
You can see these configurations enumerated in Fig. 3.  It’s not quite 24 total
configurations, simply because it hasn’t (yet) made any sense to build an
AXI-Lite cache.  Therefore, the cache and low–power configurations only test
the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;&lt;em&gt;AXI&lt;/em&gt; wrapper to the
ZipCPU&lt;/a&gt;,
not the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;AXI-Lite
wrapper&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This sort of comes with a rather derived requirement: I’ll need a simulation
environment that can be uniform enough to support all (or most) of these
configurations.  This is just to minimize the amount of rework necessary
to go from a test of one configuration to another.  However, since the
AXI environment is so different from the Wishbone one, I eventually settled
on two top level simulation drivers: &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;one for
AXI&lt;/a&gt;,
and &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;one for
Wishbone&lt;/a&gt;.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 4, All Verilog test bench&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/all-verilog.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;My last requirement was that this simulation environment be all Verilog.
This is sort of a new requirement to me, since &lt;a href=&quot;/blog/2020/04/01/design-flow.html&quot;&gt;I normally use Verilator for
my simulations&lt;/a&gt;.
Five reasons drive this requirement:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Sometime back, &lt;a href=&quot;/zipcpu/2021/07/23/cpusim.html&quot;&gt;I needed to build a simulation with a CPU for a bus
driver&lt;/a&gt; and the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; fit that role nicely&lt;/p&gt;

    &lt;p&gt;Some of my recent &lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;
projects have required driving a bus from Verilog.
While an all Verilog model of an ARM might have worked here, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
fits this role nicely in its absence.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;X propagation.&lt;/p&gt;

    &lt;p&gt;I’ve now been burned, more than once, by a model that works just fine in
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
that then failed to work in a simulator that supports ‘X propagation.  This
has bit me in two ways:&lt;/p&gt;

    &lt;ol&gt;
      &lt;li&gt;
        &lt;p&gt;&lt;a href=&quot;/blog/2020/08/22/oddr.html&quot;&gt;My ODDR design&lt;/a&gt; failed
miserably here.  Where I struggled was with a design that just needed to
create a register that simply toggles within it.  That register didn’t
need to be reset, it just needed to toggle with every clock.  However, if
you include this design in an
&lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;
environment, where initial statements
aren’t allowed, then you either need to add a reset or the ‘X propagation
will kill you–even if the design would’ve worked.&lt;/p&gt;

        &lt;p&gt;My first “solution” to this problem was to replace things like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;==&lt;/code&gt; with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;===&lt;/code&gt; and so forth.  That worked great until the post place and route
simulation.  So … I bit the bullet and added a reset to that design.
(Who cares, right?  It’s an
&lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;!  Logic is
cheap in &lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;s.)&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;I’ve often found myself using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(*)&lt;/code&gt; blocks to set something to a
constant.  This works great when using either
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
or synthesis tools, because you get the value you want.  Unfortunately,
this is not Verilog language compliant.  With a true Verilog compliant
simulator, any registers set within such a block will be set to ‘X
(undefined) since nothing ever triggers such an always block.&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ol&gt;

    &lt;p&gt;Frankly, if I want to deliver “working” IP to any customers, then that IP
really needs to work on their simulator as well.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;External device models require assignment delays, and often encrypted IP.&lt;/p&gt;

    &lt;p&gt;I’ve also recently needed to run simulations against external device models
that include assignment delays within them, and I’ve wanted to drive
these simulations with the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;Sometimes these models are of my own creation.  In this case, &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt;
has handled the problem quite nicely.  At other times, these simulations
are proprietary, encrypted, models provided by various device vendors.  This
necessitates being able to use proprietary simulation tools.&lt;/p&gt;

    &lt;p&gt;So far I’ve tried three proprietary tools:&lt;/p&gt;
    &lt;ol&gt;
      &lt;li&gt;NC Verilog (which doesn’t like my use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localparam&lt;/code&gt;s)&lt;/li&gt;
      &lt;li&gt;XCellium, which can currently (for me) handle all but Xilinx’s
proprietary IP.  (I must be missing something–Xilinx says it is
supported …)&lt;/li&gt;
      &lt;li&gt;Xilinx’s Vivado, which SegFaulted on the first project I tried it on.
Since then, I’ve now gotten it to the point where I can run batch
simulations on it–just like with XCellium–so both simulators are quite
usable for me.&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY, or Mutation Coverage with Yosys&lt;/a&gt;,
works nicely with an all Verilog simulation model to start from.&lt;/p&gt;

    &lt;p&gt;In case you are not familiar with &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;,
&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; is a means of testing the test
bench.  Want to know what bugs your test bench will catch?  Mutate the design
(i.e. break it), and see if the test bench can find the mutation.  A good
test bench should be able to find any mutation, or at least a high percentage
of them.&lt;/p&gt;

    &lt;p&gt;Sadly, although &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; can be used with
formal methods, it doesn’t integrate well with them.  (i.e., you need to be
careful that you don’t mutate any formal properties.)  This has really slowed
my adoption of &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Post place-and-route timing simulations&lt;/p&gt;

    &lt;p&gt;Simulating internal timing requires an all RTL model–ideally one that
achieves a high level of coverage.  So, any test script that passes an
&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; check should (ideally) be able to
exercise all of the paths within a design even after place and route.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, several of the customers I’ve worked with have asked for all
Verilog test benches.
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt; C++
models were simply unacceptable to them.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Bottom line is, if I want to work with others in the IP community, then I’ll
need a Verilog–only test bench.&lt;/p&gt;

&lt;h2 id=&quot;building-the-simulation-environment&quot;&gt;Building the simulation environment&lt;/h2&gt;

&lt;p&gt;The first step was to build a simulation environment that would meet these
needs.&lt;/p&gt;

&lt;p&gt;My first problem was the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s 
configuration.  Prior to defining a common configuration set, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was completely configured via
an &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v&quot;&gt;external Verilog “header” file that defined a set of macros used to
configure the CPU&lt;/a&gt;.
These macros controlled &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v#209&quot;&gt;whether or not the CPU was
pipelined&lt;/a&gt;,
which fetch or memory controller was used, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v#64-78&quot;&gt;which multiply
implementation&lt;/a&gt;
was used, which portions of the instruction set were implemented and more.&lt;/p&gt;

&lt;p&gt;My problem with this external configuration file was that it was hard to
automatically override the definitions within it.  The easy way to override
things is with parameters (Generics, when using VHDL).  So my first step was
to &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/tree/2ffbf68b450948dee56f36bbd113e80866a9362a&quot;&gt;rewrite the ZipCPU&lt;/a&gt;
to get rid of any and all “ifdef”s and to replace them with configuration
parameters.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 5, Minimum CPU Testbench Requirements&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/min-cpu.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I then needed a top level simulation environment.  A minimum CPU needs
memory and a console.  My &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;favorite CPU test
program&lt;/a&gt;
also requires a &lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timer&lt;/a&gt;,
and my &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;clock gating test software&lt;/a&gt;
requires interrupts from an automatically &lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;reloading
timer&lt;/a&gt;.  I also threw a
&lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;CPU logic analyzer in there for good
measure&lt;/a&gt; although I
don’t yet have a test that uses it.&lt;/p&gt;

&lt;p&gt;This leads to a test environment looking like Fig. 6.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 6, ZipCPU simulation test bench components&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/zip_tb.svg&quot; alt=&quot;&quot; width=&quot;560&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;It’s not just a single test environment either.  I built two near–identical
test environments: &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/commit/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;one for
AXI&lt;/a&gt;,
and &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/commit/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;another for Wishbone&lt;/a&gt;.
Further, since I wanted to test the same executable logic in each environment,
I made sure that the address space controlled by each test environment was the
same between both
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;AXI&lt;/a&gt; and
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;Wishbone&lt;/a&gt;
test benches.&lt;/p&gt;

&lt;p&gt;As a side note, I never would’ve considered a test setup this complex early on
in my own personal development.  A
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbar&lt;/a&gt; just to test a
CPU?  That’s a project in and of itself!  Or how about the bus resizing
elements, which are required to test the CPU on a non–32bit bus?  All of
these extra parts and pieces were never things that I had considered to be
necessary components of a &lt;em&gt;CPU&lt;/em&gt; repository, yet the C library won’t run without
the console, and so the testing the design necessitates having a
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbar&lt;/a&gt; on hand.
Similarly, either I need to build a bus width agile console port, or
alternatively I just need to suck up the reality of crossing bus widths.&lt;/p&gt;

&lt;p&gt;I then ran into a problem when trying to figure out how to support both the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
CPU wrapper, the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
wrapper, as well as the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt;
wrapper from a common addressing space.  For background, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/core/zipcore.v&quot;&gt;the
core&lt;/a&gt;
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is just that: a CPU.  It doesn’t
come with many of the peripherals necessary for most CPU environments.  For
this reason, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; initially
came with two wrappers.  (There are now four.)  You could either use the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
wrapper or the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;.
The difference between these two is that the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
contained a locally mapped set of peripherals:
&lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timers&lt;/a&gt;, counters, one or
two &lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt controller&lt;/a&gt;s,
and a &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/wbdmac.v&quot;&gt;DMA&lt;/a&gt;.  The
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
wrapper had none of these, so it might be lighter in logic area.  Then, when I
later built the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;AXI-Lite wrapper&lt;/a&gt;
and later the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;AXI (full) wrapper&lt;/a&gt;,
I left these near-peripherals out.&lt;/p&gt;

&lt;p&gt;How, then, should I guarantee that the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s software can interact
with these external peripherals regardless of the wrapper used?&lt;/p&gt;

&lt;p&gt;The obvious answer is to guarantee within the test bench that each of these
wrappers can see the same set of necessary peripherals–regardless of whether
or not they come pre–packaged within the CPU wrapper or not.  Hence, I included
an &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/axilperiphs.v&quot;&gt;AXI-Lite CPU peripheral
set&lt;/a&gt;
into the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;AXI testbench
top&lt;/a&gt;, and several
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
peripherals directly into the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;Wishbone top&lt;/a&gt; for the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt; system to interact with.
All that remained was to make sure these peripherals all mapped to the same
addresses.&lt;/p&gt;

&lt;p&gt;This wasn’t (yet) enough.&lt;/p&gt;

&lt;p&gt;One of the recent drivers of this work has been my desire to operate the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
in environments with non–32bit wide buses.  One project I’m working on
requires a 64-bit bus.  A second project, based on &lt;a href=&quot;https://www.enclustra.com/en/products/fpga-modules/mercury-kx2/&quot;&gt;Enclustra’s Mercury+ KX7
board&lt;/a&gt;,
will require a 512-bit bus if I only want to be able to keep up with the
memory bandwidth that board is capable of.
This meant that my simulation test bench environments needed to be
bus–width agnostic as well.  This then turned into
a requirement that my test bench include a bus downsizer,
in addition to requiring one more parameter to define the simulation
environment.  Thankfully, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wbdown.v&quot;&gt;bus
downsizer&lt;/a&gt;
can be included even if the bus doesn’t need downsizing–in that case, it just
becomes a simple
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wbdown.v#L77-L99&quot;&gt;pass-through&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Then, after using these simulation environments for a while, I ended up
retrofitting each of them with a Verilog &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v#L962-L980&quot;&gt;watchdog
timer&lt;/a&gt;.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;localparam&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1_000_00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// 1ms&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;reg&lt;/span&gt;	&lt;span class=&quot;p&quot;&gt;[$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;clog2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// if (i_reset)&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	Resets aren't strictly necessary in&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	simulation only environments ...&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	watchdog_counter &amp;lt;= 0;&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// else&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cpu_stb&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cpu_stall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Clear the watchdog if the CPU ever makes a&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// (successful) bus request&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ERROR: Watchdog timeout!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;finish&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This timer will count the number of clock cycles it’s been since the CPU has
attempted to access the bus.  It’s sort of a proxy for whether or not the
CPU has ever locked up.  (Hint: This means the CPU &lt;em&gt;was&lt;/em&gt; locking up.  In
this case, the lock-up was caused by the clock gating logic found in the
Wishbone drivers.)  The way it works is, if the CPU’s bus inputs ever become
idle for some parameterized number of clock cycles, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/code&gt;,
then the simulation halts with an ERROR.  This helped to keep failing
simulations from hanging the entire simulation setup.  (We’ll get to the
setup in the next section.)&lt;/p&gt;

&lt;p&gt;The final critical component of the simulation environment was the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; software executable itself.  By
parameterizing the simulation software load using the name of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; executable,
I now had complete control over what simulations would run and how.&lt;/p&gt;

&lt;h2 id=&quot;configuring-the-test-cases&quot;&gt;Configuring the test cases&lt;/h2&gt;

&lt;p&gt;The last critical piece in this setup, prior to the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation
script&lt;/a&gt;,
was the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definition
file&lt;/a&gt;.
The &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;Perl
script&lt;/a&gt;
reads the various test configurations from this &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definition
file&lt;/a&gt;,
and then commands a run of that test.  All output from the test then gets
logged to a file for later viewing.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 7, Defining a simulation&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/test-defn.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;To show how this is done, let’s back up a moment and start with the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;simulation configuration file&lt;/a&gt;.
I chose to define a given simulation run via five space delimited fields.
These are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The name of the test.  This also becomes the name of the executable &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt; builds, as well as being transformed
into the name of the output log file.  For these reasons, the test name needs
to be unique.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The CPU configuration.  Given that there were 15 separate parameters I
wanted to control via the configuration, it helped to have named
configuration rather than writing all of these parameters out on each
configuration line.  The &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation drive
script&lt;/a&gt;
could then easily look up a configuration by name, and set everything.
For example, here’s what the generic &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L64-L78&quot;&gt;pipeline
configuration&lt;/a&gt;
looks like from Perl:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;    &lt;span class=&quot;k&quot;&gt;my&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pipeconfig&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_PIPELINED=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LGDCACHE=2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LGICACHE=2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_MPY=6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DIV=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_SHIFTS=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LOCK=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_EARLY_BRANCHING=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LOWPOWER=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DISTRIBUTED_REGS=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_USERMODE=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_CLKGATE=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DBGPORT=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_TRACE_PORT=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_CIS=1 &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This is just the first step in the configuration, though.  This would then
need to be coupled with a top level entity, a simulation file set, and
one more parameter indicating which wrapper was being used: either one of the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt; wrappers (for
&lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone&lt;/a&gt;),
or the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;ZipAXIL&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt; wrappers.
I’ll get to these details in the next section, though.&lt;/p&gt;

&lt;ol start=&quot;3&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Now that the design has a named configuration to use, the next step was to
select a test.  For this, the third element in each line was the name of a
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format&quot;&gt;ELF&lt;/a&gt;
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/verilator/mkhex.cpp&quot;&gt;executable turned hex file&lt;/a&gt;.
This file would then be included into the simulation via
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/memsim.v#L81&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$readmemh()&lt;/code&gt;&lt;/a&gt;
for the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; to execute.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;To know, later on, if the test passed successfully, I also kept track of
the output of the CPU’s console.  This is the fourth component of a test
configuration line: the name of a file to write this console output into.&lt;/p&gt;

    &lt;p&gt;The reason for this configuration parameter was to help guarantee that all
intermediate and output files had unique names.  This would allow me to run
the script multiple times, for different tests, on multiple different
processors concurrently.&lt;/p&gt;

    &lt;p&gt;In hindsight, I could’ve just created a file name from the name of the
test.  Perhaps I might’ve called it &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$tstname-out.txt&lt;/code&gt; or some such.
Still, this works, so I have no need to change it at present.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 8, Reconfigurability is a test requirement&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/reconfigurable.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol start=&quot;3&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;The final part of the command line was really key to the success of this
format as a whole.  The final piece is an (optional) white-space separated
list of parameter overrides.  Frankly, if I ever do this again, this will
be a guaranteed part of any future approach.&lt;/p&gt;

    &lt;p&gt;Why?  Because it keeps me from modifying the files under test just to test
a new configuration.&lt;/p&gt;

    &lt;p&gt;Why?  Because in one customer project, I created an &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt; script file for each test, and I then
kept needing to change one (or more) of those files to turn on (or off)
&lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt;
generation.  (Yes, &lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt;
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v#L945-L956&quot;&gt;generation in the Verilog test benches is completely
parameterized&lt;/a&gt;).
It then became a hassle to recognize whether or not the changes to the
file needed to be committed to the repository or not, since git only ever
flagged that the file was changed.  (It didn’t help that the change was
a single character on a very long &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;
command line.) This way, I can control the current test configuration
separate from the other files under version control, and I can also see
at a glance whether configuration changes were substantial or not.&lt;/p&gt;

    &lt;p&gt;How have I used this?  I’ve now used it for more than just turning on and off
&lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt; (or other trace file)
generation.  I’ve also used it to adjust the default bus width, or to turn on
&lt;a href=&quot;/blog/2021/10/26/clkgate.html&quot;&gt;clock gating&lt;/a&gt;
for configurations that don’t have it enabled by default.  Want to create
an ad-hoc test to check a 512bit bus?  Not a problem!  In another project,
one with fewer configuration parameters, I use this parameter list field to
set all of the key parameters (and macros!)–such as whether an analog PHY
is present, or whether or not Xilinx SERDES I/O elements should be used and
tested.&lt;/p&gt;

    &lt;p&gt;Even better, when required, I can use this optional field to implement
Verilog macros as well.  So there are a lot of opportunities here.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That’s the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;configuration file&lt;/a&gt;.
As you can see, it really captures all of the potential ways the simulation
can be reconfigured to support one test or another.&lt;/p&gt;

&lt;h2 id=&quot;the-simulation-driver&quot;&gt;The simulation driver&lt;/h2&gt;

&lt;p&gt;Now let’s turn our attention over to some of the key components of this
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L64-L78&quot;&gt;simulation perl script driver&lt;/a&gt;.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 9, Steps to a scripted simulation&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/script-ops.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The script starts off by &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9-L162&quot;&gt;defining a massive number of configuration default
values&lt;/a&gt;.
I’ll skip &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9-L162&quot;&gt;this section&lt;/a&gt;
for brevity, but you are more than welcome to look through it.  These define
both the basic &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; configurations,
such as we listed above, as well as &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L138-L162&quot;&gt;which wrapper is to be used for each
configuration&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From there, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L164-L178&quot;&gt;script starts looking over the command line
arguments&lt;/a&gt;.  In this
case, we insist on at least one argument &lt;em&gt;or die!&lt;/em&gt;.  Sorry, couldn’t help it.
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;or die&lt;/code&gt; is common Perlese for exiting the script with an error.  Otherwise,
if the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L170-L174&quot;&gt;first command line argument is the single word
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;all&lt;/code&gt;&lt;/a&gt;,
then we’ll ignore any other arguments and run every test case found in the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;configuration file&lt;/a&gt;.
Finally, if neither case applies, then &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L175-L176&quot;&gt;the argument list is interpreted as a
set of test names&lt;/a&gt;
that we’ll then &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L450-L471&quot;&gt;look
up&lt;/a&gt;
in our &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definitions
file&lt;/a&gt;.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;No test cases given&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Running all tests:&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;--------------------&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;## Run any named tests found in the definitions file&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;@array&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;@ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’re going to want to place our results in a directory that isn’t under
version control.  Let’s call this directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;test/&lt;/code&gt;, and make sure it exists.
If not, we’ll create it next.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;test/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The next step is found at the bottom of the file.  Here we either look
up a test configuration by name, via the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gettest()&lt;/code&gt; function (&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L450-L471&quot;&gt;also
implemented within this perl script&lt;/a&gt;, or read
every line from the configuration file.  Every line is then passed to the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;simline()&lt;/code&gt; function for both parsing and to run the actual simulation.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$simd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/sim_testcases.txt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^\s*#/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;# print &quot;TEST LINE: $line&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;simline&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;----&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Test run complete&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$akey&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;@array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gettest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$akey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/FAIL/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;# print &quot;TEST LINE: $line&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;simline&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Incidentally, it’s this &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;simline()&lt;/code&gt; function where all the work takes
place, so let’s break this function up into pieces and walk through it, since
this is the function that actually runs the simulator for a given test
configuration.&lt;/p&gt;

&lt;p&gt;The key to this function is Perl’s pattern matching ability.&lt;/p&gt;

&lt;p&gt;We’ll start by removing any end of line comments.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^(.*)#.*/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’ll then apply a pattern match to the line to separate out the various
components of the line.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^\s*(\S+)\s*(\S+)\s*(\S+)\s*(\S+)\s(.*)\s*$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$memfil&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$confil&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$params&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The pattern above depends upon the existence of four (or more) white space
delineated fields, as we described them above, where the last field containing
the (optional) parameter list may be left blank.  If this pattern doesn’t
match, then … this isn’t a properly configured test line, and we’ll generate
an error and then skip it.&lt;/p&gt;

&lt;p&gt;For now, let’s assume the pattern matches and we’ll continue.&lt;/p&gt;

&lt;p&gt;It’s important for me to know &lt;em&gt;when&lt;/em&gt; things happen.  This helps me know
how long a test takes, as well as how deep into a test I am at any given
time.  When I’m not producing any console output, this is also the first
indication I have of any (potential) errors.  So, I’ll take this time to
grab a time stamp to describe the beginning of the simulation call.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
				&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Incidentally, if you look through this &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation driver Perl
script&lt;/a&gt;, you’ll find
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L214-L279&quot;&gt;the script works for&lt;/a&gt;
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
as well as &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;–it’s just that
the &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
support &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9&quot;&gt;isn’t (currently) configured either by
default&lt;/a&gt; or by the command line.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$verilator_flag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Configure for Verilator ...&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Configure for IVerilog ...&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Now that we have our configuration test parameters, the next step is to put
the &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iverilog&lt;/code&gt; command line&lt;/a&gt; together.&lt;/p&gt;

&lt;p&gt;We’ll start with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-g2012&lt;/code&gt;.  I personally use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-g2012&lt;/code&gt; option for all my
work.  I need it to support my liberal use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localparam&lt;/code&gt;s, but I’m sure
there are other goodies that come with this as well.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;iverilog -g2012&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Let’s look up the parameters associated with our named configuration next.
To do this, however, we’ll need to know the top level module name, whether
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wb_tb&lt;/code&gt;&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;axi_tb&lt;/code&gt;&lt;/a&gt;.
We’re going to need that, so let’s grab that off of the configuration file
string.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/-s\s+(\S+)\s/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/-s\s+(\S+)$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## This should probably be an error.&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;no_tb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We can now look up our configuration string.  This is the string with all of
our parameters defined in it.  In my case, I prefixed each parameter with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-P&lt;/code&gt;.  This, however, isn’t sufficient.  Parameters need to be prefixed with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-P&lt;/code&gt; &lt;em&gt;and&lt;/em&gt; the name of the top level–so we’ll do a simple substitution here to
get that right.  While we’re at it, we’ll add a shell escape for our quotation
marks–so the shell won’t play with them unduly.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfghash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;ne&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Must include sim file list and top level&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## as well as any parameters&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfghash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;s/-P/-P$toplevel./g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;s/\&quot;/\\\&quot;/g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Two more parameters come from the test configuration line itself.
These are the name of the memory file, containing the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;ZipCPU test
program&lt;/a&gt;
memory image, and the name of the console file output.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.MEM_FILE=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;zipsw/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$memfil&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.CONSOLE_FILE=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$confil&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;With that, it’s now time to look at our parameter list.  This list comes in the
form of a set of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt; pairs, where the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A&lt;/code&gt; is the parameter name and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;B&lt;/code&gt;
is it’s value.&lt;/p&gt;

&lt;p&gt;The first step is to try to match the remaining portion of the line to
both an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt; pair and an everything else in the line.  I’ve chosen to
name this “everything else” as the &lt;a href=&quot;https://en.wikipedia.org/wiki/CAR_and_CDR&quot;&gt;CDR after the use of this term in
LISP&lt;/a&gt;.  Once the design
has been separated into these three pieces, I can then use the first
two, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;B&lt;/code&gt; of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt;, to generate a command line parameter
setting.  Since this will follow all other parameter settings on the command
line, this one should override any previous parameters set by the same name.
Don’t forget to escape any string quotations!&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/\s*(\S+)=(\S+)(.*)$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/\&quot;(.*)\&quot;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$str&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$p&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$str&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$p&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Our last step will be to append the name of our file list to the command
line, and then specify that &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;
should produce an output file in our
test directory having the same name as our test’s configuration name.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;ne&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -o &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This should be unique enough to work with.&lt;/p&gt;

&lt;p&gt;For those not familiar with &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus Verilog&lt;/a&gt;,
this is &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;’s way of doing business.
Simulation takes place in two parts.  The first part is to build a simulation
executable, and the second part is to build the simulation itself.&lt;br /&gt;
(Vivado isn’t all that different.)  Now that we have a command line built up
to build the executable, therefore, we go ahead and run
&lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt; to build our simulation executable.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;unlink&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; |&amp;amp; tee -a &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$cmd&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;bash -c &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$cmd&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$errB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If all goes well, we should now have a simulation executable–assuming
&lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt; didn’t find some error while building
our design.&lt;/p&gt;

&lt;p&gt;So … let’s run our simulation!&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Grab a timestamp&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
				&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -- Starting simulation&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; | tee -a &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;## Then run the simulation&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;## Finish the log with another timestamp&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
					&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once we get to this point, the simulation has now completed.  This may take
many hours, depending upon the configuration and the test.  For example,
running the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; check on the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
MIN configuration takes about 12hrs on my computer.  On the other hand, when
using &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;,
&lt;em&gt;all&lt;/em&gt; of the tests for all of the configurations can complete in less than one
hour–but … that’s another story.  (It’s also one of the reasons why I love
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt; so
much!)&lt;/p&gt;

&lt;p&gt;Now that everything has completed, let’s go dig through the log file to
see if we’ve been successful.&lt;/p&gt;

&lt;p&gt;If we find &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ERROR&lt;/code&gt; in the log file, or any reference to an assertion failure,
then we have not been successful.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'ERROR&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; | sort -u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -q &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'ERROR&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -iq &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'assert.*fail&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -iq &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'fail&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We can now take these results and write them into a report file, to track
all of our simulation results.  We’ll assume here that if we haven’t found
any errors, then the test has been successful.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%s IVerilog  -- %s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$errA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$errF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## ERRORs found&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ERRORS    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ERRORS    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;PASSED    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;PASSED    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This isn’t really an ideal test, but it’s worked for me so far.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;ideal&lt;/em&gt; would be for the test to end with some form of SUCCESS message.
My test setup still needs some work, though, before I will have a dependable
SUCCESS message to work from.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Put together, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;this script&lt;/a&gt; allows me to test a rough 67 test
cases.  Why so many?  Simply because each test checks something different.
Sadly, I’ve learned from experience that it’s possible to have 66 test cases
pass and one fail.&lt;/p&gt;

&lt;p&gt;Ideally, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;initial CPU test&lt;/a&gt;
should catch any and all bugs.  Sadly, it doesn’t.  Or rather, it hasn’t.  For
example, the original &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;CPU
test&lt;/a&gt;
never caught the bugs associated with stepping the CPU, one instruction at a
time.  Specifically, stepping through a divide instruction would void the
divide instruction, and leave you forever stepping through the same
instruction.  While I’ve now fixed the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;CPU test
program&lt;/a&gt;
so it checks for that bug, I’m reasonably confident that nothing other than my
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/lockcheck.c&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; checking program&lt;/a&gt;
will truly check for whether or not &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction works.  Further, the
bus width tests have found bugs the other tests haven’t as well.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 10, Does testing need to go multicore?&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/multicore.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;While the test set is reasonably complete, I am also painfully aware of some
significant holes remaining in it–thanks to both
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;’s
coverage checking capability and &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;.
For example, while I exercise the exclusive access capabilities of
both AXI and Wishbone buses, I only do so from a single CPU.  Worse, the
CPU will not allow a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction sequence to be interrupted or stepped
through–it’s either all one instruction or none by design.  In many ways,
that’s a good thing … except that it means there will never be any true
&lt;em&gt;bus&lt;/em&gt; contention to test whether or not the memory modules handle locking
properly.  Another glaring fault in this test setup is that nothing is
(currently) testing the CPU’s debug port.  Hence, I may choose to fix both
of these by adding additional CPU’s to my simulation, in such a way that one
master CPU controls and starts all others.&lt;/p&gt;

&lt;p&gt;For now, let me note that I’ve enjoyed this approach so much that I’ve
started using something similar on my commercial projects, and I’ve even
ported a similar script to Vivado.&lt;/p&gt;

&lt;p&gt;Bottom line: the approach works nicely, and I’m likely to use it again.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Judge me, O LORD; for I have walked in mine integrity: I have trusted also in the LORD; therefore I shall not slide.  Examine me, O LORD, and prove me; try my reins and my heart. (Ps 26:1-2)&lt;/em&gt;</description>
        <pubDate>Mon, 04 Jul 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/zipcpu/2022/07/04/zipsim.html</link>
        <guid isPermaLink="true">https://zipcpu.com/zipcpu/2022/07/04/zipsim.html</guid>
        
        
        <category>zipcpu</category>
        
      </item>
    
      <item>
        <title>A Coming Economic Downturn?  or Worse?</title>
        <description>&lt;p&gt;I’ll try to keep this short.&lt;/p&gt;

&lt;p&gt;Some time ago, I came across this verse:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
stone, a tried stone, a precious corner stone, a sure foundation: he that
believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Isaiah 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;At the time, I was trying to understand the New Testament references to
cornerstones, and this was &lt;a href=&quot;https://www.blueletterbible.org/kjv/1pe/2/6&quot;&gt;one of those
references&lt;/a&gt;.  The other major
reference being to &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/118/22/&quot;&gt;Ps 118:22&lt;/a&gt;.
Unlike &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/118/22/&quot;&gt;Ps 118:22&lt;/a&gt;,
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;this Isaiah verse&lt;/a&gt;
had a context that quite captured my attention.  For example, if you back up
by just one verse, you read:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Because ye have said, We have made a covenant with death, and with hell
are we at agreement; when the overflowing scourge shall pass through, it
shall not come unto us: for we have made lies our refuge, and under
falsehood have we hid ourselves:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/15/&quot;&gt;Isaiah 28:15&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;That’s not just pretty poetic language, its powerful language and … it has
my attention.  Specifically, why does
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;verse 16&lt;/a&gt;
begin with the word “Therefore”?
The two verses seem to be completely unrelated.  Or at least, they seemed
unrelated to me until I understood how and why God had put them together.
Once you put them together, they then speak very loudly to today’s day and age.&lt;/p&gt;

&lt;p&gt;So, let’s back up further.  I’ll back up all the way to verse 9.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Whom shall he teach knowledge? and whom shall he make to understand
  doctrine? them that are weaned from the milk, and drawn from the breasts.
For precept must be upon precept, precept upon precept; line upon line,
  line upon line; here a little, and there a little:
For with stammering lips and another tongue will he speak to this people.
To whom he said, This is the rest wherewith ye may cause the weary to rest;
  and this is the refreshing: yet they would not hear.
But the word of the LORD was unto them precept upon precept, precept upon
  precept; line upon line, line upon line; here a little, and there a
  little; that they might go, and fall backward, and be broken, and snared,
  and taken.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/9-13/&quot;&gt;Is 28:9-13&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Let me pause for a moment and expand upon the language a little bit here.&lt;/p&gt;

&lt;p&gt;First, since studying Biblical Greek (yes, I know this is from Hebrew), I’ve
had a different definition and understanding of the word “doctrine”.  I would
define this word as “the substance of what is taught.”  This isn’t all that
different from today’s &lt;a href=&quot;https://en.wikipedia.org/wiki/Doctrine&quot;&gt;Wikipedia
definition&lt;/a&gt;, “a codification of
beliefs or a body of teachings or instructions, taught principles or
positions, as the essence of teachings in a given branch of knowledge or in a
belief system,” save that I don’t connect doctrine with a “belief system” by
nature.  The word is more neutral than that.  It’s simple the substance of
what is taught.  It’s the text book if you will, the “codification” of a
“body of teachings or instructions.”  There is a doctrine of mathematics, for
example–it’s not about beliefs, it’s just the codification of the lesson
material.&lt;/p&gt;

&lt;p&gt;God wants to teach us “knowledge” and “doctrine”.  This sounds like a good
thing.  I’m interested.  I’d sign up for that class.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;For precept must be upon precept, precept upon precept; line upon line,
  line upon line; here a little, and there a little:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/10/&quot;&gt;Is 28:10&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This we all know and agree upon.  You can’t teach a child how to multiply
unless they first know how to add.  You can’t teach reading unless you first
teach letters.  Teaching is built upon a foundation, and that foundation
needs to be laid a little bit at a time.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;To whom he said, This is the rest wherewith ye may cause the weary to rest;
  and this is the refreshing: yet they would not hear.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/12/&quot;&gt;Is 28:12&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This part starts with a promise, and one I like–&lt;a href=&quot;https://www.blueletterbible.org/kjv/heb/4/9&quot;&gt;a promise of
rest&lt;/a&gt; and refreshing.  I like
promises, especially promises of good from those who are able to keep them.&lt;/p&gt;

&lt;p&gt;But it continues with, “yet they would not hear.”&lt;/p&gt;

&lt;p&gt;God, therefore, is offering to man a wonderful promise and getting rebellion
in response.  This forms the backdrop of what takes place next.&lt;/p&gt;

&lt;p&gt;Indeed, the next part is where it starts to get interesting.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;But the word of the LORD was unto them precept upon precept, precept upon
  precept; line upon line, line upon line; here a little, and there a
  little; that they might go, and fall backward, and be broken, and snared,&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/13/&quot;&gt;Is 28:13&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Here’s God’s point: if you don’t learn the lessons of truth, about how the
reality of the world works, the truth doesn’t change.  Instead, the realities
of life will break you.  As one preacher once said, men don’t break God’s laws,
God’s laws break them.  Sure, you can jump off a building an defy gravity
for a fleeting moment, but you can’t avoid the sudden stop at the bottom.&lt;/p&gt;

&lt;p&gt;It’s not just that two plus two equals four and not five independent of the
family you were born into, but it’s also the simple basics of life: only hens
lay eggs, only cows provide milk, and only women can give birth.  You aren’t
going to get eggs from a cock (a farmer’s term for a male chicken, since
technically all chickens roost and are therefore roosters), and I’m going to
laugh at the individual who tries to milk the bull.  Frankly, there are some
parts of this world that man cannot change, and those who try will “fall
backward, and be broken, and snared.”  Put simply, it’s not going to end well.&lt;/p&gt;

&lt;p&gt;But this is only the part of where God describes what is currently taking
place.  It’s in the next verse where He begins His pronouncement of judgment.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Wherefore hear the word of the LORD, ye scornful men, that rule this people
  which is in Jerusalem.
Because ye have said, We have made a covenant with death, and with hell
  are we at agreement; when the overflowing scourge shall pass through, it
  shall not come unto us: for we have made lies our refuge, and under
  falsehood have we hid ourselves:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/14-15/&quot;&gt;Is 28:14-15&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Yes, I know that this particular judgment has long since passed.  The
individuals who ruled “this people which is in Jerusalem” did so over
a thousand years ago.  I’m just not willing to dismiss this passage that
quickly, especially since the nature of God which caused Him to send this
judgment hasn’t changed, neither have the simple truths of life which still
need to be taught today.&lt;/p&gt;

&lt;p&gt;Indeed, “We have made lies our refuge, and under falsehood have we hid
ourselves” describes the day we live in.  Yes, the government can get itself
out of the problem it has created by spending more than it has by printing
more money!  Yes, we can escape all responsibility by blaming our predecessor!
Yes, we can blame foreigners and aliens for the problems we’ve created in our
own back yards!  Yes, a man can win in women’s sports by declaring himself to
be a woman!  Yes, I can declare my engineering products as “working” even
before they are tested!  Reality doesn’t affect me!&lt;/p&gt;

&lt;p&gt;But what of the peace treaty with death?  God gets to that two verses down.
For now, in the midst of this pronouncement of judgment, the prophet
adds this verse about the cornerstone.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
  stone, a tried stone, a precious corner stone, a sure foundation: he that
  believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Is 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Again, like I said at the beginning, at the first read this feels out of place.
The verse following seems to skip it.  It’s almost as if, if you only removed
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;verse 16&lt;/a&gt;,
the passage would make more sense.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Judgment also will I lay to the line, and righteousness to the plummet: and
  the hail shall sweep away the refuge of lies, and the waters shall overflow
  the hiding place.
And your covenant with death shall be disannulled, and your agreement with
  hell shall not stand; when the overflowing scourge shall pass through,
  then ye shall be trodden down by it.
From the time that it goeth forth it shall take you: for morning by morning
  shall it pass over, by day and by night: and it shall be a vexation only
  to understand the report.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/17-19/&quot;&gt;Is 28:17-19&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/17/&quot;&gt;Verse 17&lt;/a&gt;,
referencing a line and a plummet, is a clear reference to the
restoration of truth in a society.  We build using lines.  A taught cord
can be used as a straight line when setting a wall.  Indeed, masons use such
cords often and for that specific purpose.  Straight lines are important.  So
is the &lt;a href=&quot;https://www.lowes.com/pd/Swanson-Tool-Company-16-oz-Solid-Brass-Plumb-Bob/1006465&quot;&gt;plummet–a basic weight on a cord&lt;/a&gt;.  The plummet is used to
determine which way is down and, as a consequence, which is up.  Both are
references to basic truths which cannot be ignored or broken.  This,
therefore, is a reference to God bringing His creation back to reality.
This judgment will be a true “Come to Jesus” moment, if ever there was one.&lt;/p&gt;

&lt;p&gt;What of the peace treaty with death?  It will be disannulled.  There was no
basis for it.  The judge will neither recognize it, nor honour it, nor compel
its enforcement.  The agreement with hell?  Same thing.  It will not stand.
The overflowing scourge?&lt;/p&gt;

&lt;p&gt;Ahh, now that’s where we meet what’s coming next.&lt;/p&gt;

&lt;p&gt;What form will this overflowing scourge take?&lt;/p&gt;

&lt;p&gt;Will it be an economic recession?  Perhaps.  A depression?  Could be.  An
interruption in the food supply?  We’ve already seen some of that.  An
interruption in power?  That’s already in the forecast.  War?  Another world
war even?  We know from prophecy that another one is coming if not two.  The
destruction of the current world order?  &lt;a href=&quot;https://www.blueletterbible.org/kjv/dan/2/42-45&quot;&gt;That’s also been
prophesied&lt;/a&gt;.
It’s just a matter of when.&lt;/p&gt;

&lt;p&gt;Frankly, I don’t know what’s coming next.  Sure, &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/119/105&quot;&gt;God’s word is a lamp unto
my feet&lt;/a&gt;–just not my
horizon.  What I do know is this, &lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/24/32&quot;&gt;the signs are all around
us&lt;/a&gt;,
and “It shall be a vexation only to understand the report.”&lt;/p&gt;

&lt;p&gt;When God steps in, there will be shock and awe.&lt;/p&gt;

&lt;p&gt;Okay, so let’s now go back to that corner stone verse.  How does that apply
here?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
stone, a tried stone, a precious corner stone, a sure foundation: he that
believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Is 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The application is now straight-forward.  The storm is coming.  Many shall be
destroyed by it.  God has declared it, and there’s nothing that can be done
to stop it.  All we can hope to do is to ride through it.  For this reason,
God provides a “sure foundation”, so that those standing upon it will not get
swept away with the judgment of the unbelievers.&lt;/p&gt;

&lt;p&gt;It’s against this backdrop that Jesus teaches,&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore whosoever heareth these sayings of mine, and doeth them, I will
  liken him unto a wise man, which built his house upon a rock:
And the rain descended, and the floods came, and the winds blew, and beat
  upon that house; and it fell not: for it was founded upon a rock.
And every one that heareth these sayings of mine, and doeth them not, shall
  be likened unto a foolish man, which built his house upon the sand:
And the rain descended, and the floods came, and the winds blew, and beat
  upon that house; and it fell: and great was the fall of it.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/7/24-27&quot;&gt;Matt 7:24-27&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You will hear many individuals telling you how to prepare for whatever they
believe the coming catastrophe will be.  I’ve heard some telling me to buy
&lt;a href=&quot;https://www.birchgold.com&quot;&gt;gold&lt;/a&gt; or silver.  Some say that I should purchase
&lt;a href=&quot;https://mypatriotsupply.com&quot;&gt;packaged food&lt;/a&gt; for long term storage.  Others
have said to buy bonds.  Still others say that inflationary times are the
best times to borrow money.&lt;/p&gt;

&lt;p&gt;While these individuals may be well intentioned, the only advice that will
help you avoid God’s judgment of sinful men is the advice God offers.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/7/24&quot;&gt;Therefore whosoever heareth these sayings of mine, and doeth
them&lt;/a&gt;, …&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a stone, a tried stone, a precious corner stone, a sure foundation: he that believeth shall not make haste.  (Is 28:16)&lt;/em&gt;</description>
        <pubDate>Tue, 21 Jun 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/06/21/cornerstone.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/06/21/cornerstone.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>Quiz #20: Using $stable in a multiclock environment</title>
        <description>&lt;p&gt;This is a really good question for understanding how &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$stable()&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$past()&lt;/code&gt;
work in a multiclock environment.&lt;/p&gt;

&lt;p&gt;Remember, though: I like to play trick questions.  Beware of the easy and
(possibly) obvious answer.&lt;/p&gt;
</description>
        <pubDate>Mon, 16 May 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/quiz/2022/05/16/quiz20.html</link>
        <guid isPermaLink="true">https://zipcpu.com/quiz/2022/05/16/quiz20.html</guid>
        
        
        <category>quiz</category>
        
      </item>
    
      <item>
        <title>Learning AXI: Where to start?</title>
        <description>&lt;p&gt;Someone &lt;a href=&quot;https://www.reddit.com/r/FPGA/comments/shw219/advice_for_studying_the_axi_specification/&quot;&gt;once asked on Reddit, how should one go about learning the AXI
protocol&lt;/a&gt;?
The following summarizes my basic answer.&lt;/p&gt;

&lt;p&gt;First off, don’t start with Xilinx’s example designs.  Sorry, but their
examples are horribly broken.  Even their demo &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI Stream master is
broken&lt;/a&gt;.  It’s a shame
that they’ve neither fixed these designs, nor updated their training materials
to acknowledge that their basic designs are broken.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 1, Basic Roadmap for Learning AXI&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/roadmap.svg&quot; alt=&quot;&quot; width=&quot;280&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Others have suggested that the best place to start is by learning handshaking,
and most of the AXI stream protocol is just that: handshaking.  I would agree.
Therefore, I would recommend that anyone starting out begin by learning
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI’s handshaking rules&lt;/a&gt;.
As &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;that article&lt;/a&gt; will
explain, the AXI stream protocol is little more than simple handshaking, and
you can (mostly) ignore the TID, TSTRB, TKEEP, and TDEST signals.  This
is also where you’ll discover how Xilinx got their example AXI stream master
messed up, and where you’ll learn how easy it would be to fix it.&lt;/p&gt;

&lt;p&gt;Once you understand &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI
handshaking&lt;/a&gt;, I’d then
recommend learning about
&lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;. Without
them, you’ll never get better than 50% throughput without violating the
AXI specification.&lt;/p&gt;

&lt;p&gt;The next place I’d go would be to  &lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;look into
AXI-lite&lt;/a&gt;. Beware of
backpressure! It has caused Xilinx (and others unnamed) no end of headaches,
and forms the backdrop for many of the bugs in their example designs. If you
want a working example design to start from, check out &lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;this example
design&lt;/a&gt; that I
often use myself when working with AXI-lite.  You might also wish to look over
&lt;a href=&quot;/blog/2021/05/22/vhdlaxil.html&quot;&gt;this post, describing how to fix Xilinx’s (broken) AXI-lite VHDL
example&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;For most use cases, you can stop there.  AXI-lite will get you just about
everywhere you need to go.  For most of the things you might need the
full AXI specification for, you can already find example open source or vendor
designs that’ll work.
(&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;s,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;MM2S&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;S2MM&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;virtual FIFO&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;video frame buffer reading&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;video frame buffer writing&lt;/a&gt;, etc.)&lt;/p&gt;

&lt;p&gt;If you are interested in moving past AXI-lite, then it’s time to understand &lt;a href=&quot;/blog/2019/04/27/axi-addr.html&quot;&gt;AXI
addressing&lt;/a&gt;,
and the various FIX, WRAP, and INCR addressing modes and how the AxSIZE field
impacts them.  This is important.  Xilinx &lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;didn’t even try to get this right
in their example&lt;/a&gt;, and I’ve
seen plenty of ASIC designs that even get this addressing messed up.  You will
need to understand this before diving into building your first full AXI slave.
Indeed, I’ve used the &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi_addr.v&quot;&gt;next AXI address
module&lt;/a&gt; built
and presented in that article in many of my own designs.&lt;/p&gt;

&lt;p&gt;Once you understand addressing, or at least once you’ve simplified it enough
that you can work with it, then the next step would be to build a &lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;fully
capable AXI slave&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What will you gain by writing an AXI slave over an AXI-Lite slave?  Not much.
Seriously.  There’s not a lot of performance gain to be had by building an
AXI (full) slave over that already gained by building an AXI-Lite slave–at
least, not much gain to be had for most uses.  What performance difference might
you see?  Well, following &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi2axilite.v&quot;&gt;a good AXI to AXI-lite
bridge&lt;/a&gt;, you
might find yourself
loosing about 2 clocks of &lt;em&gt;latency&lt;/em&gt; per transaction.  That’s it.  Following a
poor AXI to AXI-lite bridge?  In that case, you might lose 4-8 clocks of
&lt;em&gt;throughput&lt;/em&gt; per transaction.  Of course, you could always switch back to a
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi2axilite.v&quot;&gt;better bridge&lt;/a&gt;
to recover this lost throughput–so there’s really not a lot to
be gained by switching from an AXI-lite slave to an AXI (full) one.&lt;/p&gt;

&lt;p&gt;When it comes to AXI masters, however, that’s a different story.  Still, I
would similarly recommend you start with an &lt;a href=&quot;/blog/2020/03/23/wbm2axisp.html&quot;&gt;AXI-Lite
master&lt;/a&gt;. Technically, such
a master should be able to be just as fast as an AXI full master.  Practically
and sadly, many designs cripple their AXI-lite implementations. (Hello, Xilinx?)&lt;/p&gt;

&lt;p&gt;A full discussion of &lt;a href=&quot;/blog/2020/06/16/axiaddr-limits.html&quot;&gt;AXI masters gets
difficult&lt;/a&gt;.
It’s hard enough that I haven’t (yet) figured out how to simplify the material
enough to write a post on how to build a general purpose AXI master–the
addressing is just that hard to get right in general. (It usually takes me
a couple of days to get right–even when building my own.) However, you are
welcome to examine &lt;a href=&quot;/blog/2021/06/28/master-examples.html&quot;&gt;some of the AXI masters I’ve written and
posted&lt;/a&gt; if you’d like.&lt;/p&gt;

&lt;p&gt;Among those &lt;a href=&quot;/blog/2021/06/28/master-examples.html&quot;&gt;AXI master
examples&lt;/a&gt; are
two worth mentioning here since I’ve written articles about them.  The first
discusses how to build a &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;memory controller for the ZipCPU using the AXI-Lite
protocol&lt;/a&gt;, whereas the
second discusses the &lt;a href=&quot;/zipcpu/2021/09/30/axiops.html&quot;&gt;modifications necessary to upgrade that memory controller
to AXI (full)&lt;/a&gt;.  This &lt;a href=&quot;/zipcpu/2021/09/30/axiops.html&quot;&gt;second
article&lt;/a&gt; goes over the
AXI Exclusive Access protocol (AxLOCK, and EXOKAY), and then how to go about
building a master that uses it–although I only really know of CPU use cases
for such a protocol.  It also discusses some of the challenging interactions
between AxADDR and AxSIZE.&lt;/p&gt;

&lt;p&gt;If you are really going to dive deeply into the AXI protocol, then it will
quickly become important to know &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;how to measure AXI
performance&lt;/a&gt;.
Just what kind of performance are you achieving, what is possible, and what
can you expect are all good questions you’ll want to know how to answer.&lt;/p&gt;

&lt;p&gt;The above will get you most of the way. However, it will also leave you with
questions about what AxCACHE, AxPROT, and AxQOS are for, or when you should
use the AxID field.  Indeed, you may leave wondering about AxSIZE as well, and
why it’s an important part of the protocol.  For a discussion of these, let me
point you to a reddit question of my own from some time ago: &lt;a href=&quot;https://www.reddit.com/r/FPGA/comments/egkrce/is_axi_too_complicated/&quot;&gt;is AXI too
complicated&lt;/a&gt;?&lt;/p&gt;

&lt;h2 id=&quot;formally-verifying-axi&quot;&gt;Formally Verifying AXI&lt;/h2&gt;

&lt;p&gt;Not that long ago, I was asked about the possibility of writing a course on how
to formally verify AXI components.  At the time, I sketched out the following
outline for such a course–an outline that primarily matches most of the
progression above.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The course would start with a &lt;a href=&quot;/blog/2017/10/19/formal-intro.html&quot;&gt;quick review of formal
methods&lt;/a&gt;: what
are assertions and assumptions, and what are some of the &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;unique challenges
associated with
induction&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 2, Lessons that might compose a course in formally verifying AXI components&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/courseware.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Indeed, when you get to AXI full,
   &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;
   becomes a necessity.  AXI is sufficiently complicated to limit a bounded
   model check to somewhere between 20-40 cycles.  As a result, no bounded model
   check will be sufficient to verify one or more 256-beat bursts.  A complete
   proof, therefore, &lt;em&gt;requires&lt;/em&gt;
   &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;.
   It’s important here to understand how it works, and what challenges you
   might expect when working with it.&lt;/p&gt;

&lt;ol start=&quot;2&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;As above, the next step would be to look into AXI Stream, and in
particular how to handle
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;Handshaking&lt;/a&gt;
and &lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;.
Specifically, I’d go over the assertions necessary to describe an
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI handshake&lt;/a&gt;, and the
need for &lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;.
The lesson would end with a
&lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffer&lt;/a&gt;
exercise of some type–perhaps simply requiring a student to build their own.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The next step would be
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt;.  The big
difference between
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt; and the
bare &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;handshaking&lt;/a&gt;
discussion is that you need to count outstanding read and write requests when
using &lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt;.  Every
read request requires one (and only one) response.  Write requests
are similar and also require a single response, however a write request is
not complete until there’s been a request on both write address and write
data channels.  In general, though, the only thing we’re adding above and
beyond the basic
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;handshaking&lt;/a&gt;
are some simple counters as well as some assertions tied to those counters.&lt;/p&gt;

    &lt;p&gt;An exercise for this portion of the course might involve verifying a given
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt; module.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;While AXI-lite is a great protocol for register handling, it’s also
important to know your design handles registers properly.  Therefore, I’d
dedicate a lesson to discussing &lt;a href=&quot;/blog/2020/12/19/axil-register-checking.html&quot;&gt;how to verify that registers are read or
written correctly&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;A good exercise here would be to modify the exercise from the AXI-lite
lesson, so that it verifies the register within.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We can now discuss &lt;a href=&quot;/blog/2019/04/27/axi-addr.html&quot;&gt;AXI
  addressing&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It would then be time to dive into AXI full.  This topic is so large,
however, that it really needs to be broken up.  Therefore, I’d start with
how to verify handling a single read burst.  The basics of single read
burst counting are pretty simple: you need to count the number of bursts
that are outstanding, and the number of remaining outstanding items in
each burst.&lt;/p&gt;

    &lt;p&gt;This might be where I’d introduce the exercise of verifying an &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/demofull.v&quot;&gt;AXI full
slave&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;This is also where the easy part ends.  How, for example, shall you verify
that the number of beats returned for a given burst read request is correct?
That’s a touch harder–especially when you need to start tracking multiple
outstanding bursts.&lt;/p&gt;

    &lt;p&gt;From there, I’d move on to discuss how to verify out-of-order returns, and
how to handle verifying packet ID’s.&lt;/p&gt;

    &lt;p&gt;This leads to the task of verifying an AXI full slave that requires multiple
beats to process requests given to it.  A simple example might be an AXI
SRAM controller, where the SRAM requires one (or more) clocks from
request to response and where the read command can only be issued once.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Write handling is more challenging than read handling.  Specifically, AXI
write requests split the write address and data into two channels, and
formally verifying both channels can require a bit of synchronization within
the formal properties.  Once the channels are synchronized, however,
verification returns to being as easy as counting bursts and beats again.&lt;/p&gt;

    &lt;p&gt;Yes, there are a couple new requirements, although once the channels are
synchronized these are minimal.  Primarily, the extra requirements deal
with those packets for which AWSIZE is less than a full word, or for which
the initial AWADDR isn’t word aligned.  In these cases, there’s the
additional requirement that write beats only contain strobes for the
correct bytes.  For example, if AWADDR is odd, then the WSTRB[0] of the
first beat must be zero.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Exclusive Access.  Exclusive access is AXI’s method of handling atomic
requests.  These really aren’t all that hard to understand or model.
Indeed, they are easier to deal with than read or write bursts.  Still,
I would place exclusive access handling late in the course, not because
of how easy or difficult it is, but more because of how few things actually
need it.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 3, It can be a real challenge to verify a design containing a FIFO&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/fifo-challenge.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol start=&quot;10&quot;&gt;
  &lt;li&gt;That brings us to the FIFO Challenge.  FIFOs are fairly easy to verify on
   their own.  Sadly, they become much harder to verify when they are used
   within something.  AXI, however, is very much built around the concept
   of FIFOs.  How to verify something that has a FIFO within it is something
   we’d need to discuss here.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once you get past the FIFO challenge, it then becomes possible to build AXI
   components that can handle any number of multiple bursts at a time.  When
   would you need something like this?  When building an AXI
   &lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt; or
   a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;
   of some type.  Both would make good examples of components that might
   need this technology.&lt;/p&gt;

&lt;p&gt;At least, these are my current thoughts on what lessons I might teach were I
to create a course in formally verifying AXI components.  Given that every
piece of commercial IP I’ve ever built has required some form of AXI interface,
I wouldn’t be surprised to find such a course to be an in-demand topic.
I would just need to find a way to clear enough time out of my schedule to
create it.&lt;/p&gt;

&lt;h2 id=&quot;axi-design-exercises&quot;&gt;AXI Design Exercises&lt;/h2&gt;

&lt;p&gt;When learning any new topic, its important to exercise your new knowledge
as you learn it.  Here’s a list, therefore, containing a progression of
exercises with increasing difficulty that you might find valuable when
learning AXI.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 4, Practice exercises, for use in learning AXI&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/exercises.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Build and verify an AXI Stream component.  A good example of this might
be either a DSP component or perhaps a FIFO of some type.  Perhaps the
simplest example I might come up with would be a frequency shifter based
upon an internal &lt;a href=&quot;/dsp/2017/08/30/cordic.html&quot;&gt;CORDIC&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;Other examples include stream processing network packets–such as a
stream component that might recognize, encrypt or decrypt a UDP packet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Build and verify an AXI-lite bus slave&lt;/p&gt;

    &lt;p&gt;This project is actually pretty easy.  I’d have you start with the
&lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;EasyAXIL design&lt;/a&gt;, and
then modify it for some purpose.  Perhaps that might be to create a
GPIO or UART controller from it, or to turn it into a basic timer
peripheral of some type.  Any of these exercises would be fairly simple,
since the &lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;EasyAXIL
design&lt;/a&gt; is just
that easy to work with and from.  Even better, it comes with all the details
you need to formally verify how well it handles bus transactions.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The simplest bus master to build is a basic, scripted, one request at a time
bus master using AXI-lite.  &lt;a href=&quot;/blog/2021/12/30/dbgaxil.html&quot;&gt;This
article&lt;/a&gt; presents both
such a bus master, and a usage description of why you might wish to build
one.  The master is easy enough to verify, and so might make a good practice
start at building your first AXI-lite bus master.&lt;/p&gt;

    &lt;p&gt;Indeed, a scripted AXI-lite bus master is not really all that much more
complex than a basic &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;AXI-Lite CPU memory
unit&lt;/a&gt;, so
building such a memory unit might also fit nicely here.  From an exercise
standpoint, however, the &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;CPU memory
unit&lt;/a&gt; has to deal with
two protocols, both that of the CPU and that of AXI-lite, meaning that the
&lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;CPU memory unit&lt;/a&gt; might be
more complex than this exercise would require.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A more complicated AXI-lite bus master, and certainly one with more interest,
might be to &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.html&quot;&gt;add a small FIFO to a CPU instruction fetch
unit&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;This exercise is only slightly more complex than the scripted memory
controller of the last exercise.  Specifically, what should the fetch unit
do when, mid fetch, the CPU tells it that it no longer wants the values
currently being fetched but instead wants to start over from a new address?&lt;/p&gt;

    &lt;p&gt;Before leaving this example, let me quickly outline the number of uses I’ve
found for such a FIFO based AXI-lite bus controller.  The most basic use
is in scripting a scatter-gather DMA.  I’ve also found it useful for
scripting I2C or SPI transactions from a script in memory somewhere.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That would roughly exhaust the exercises needed to learn how to work with
both &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI handshaking&lt;/a&gt; and
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-lite&lt;/a&gt;.  From here, it
would be time to move on to the full AXI bus protocol.&lt;/p&gt;

&lt;ol start=&quot;5&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;The first (and simplest) exercise would be to build (and verify) an AXI
(full) slave.  A specific performance goal would be that this slave should
be able to handle a throughput of one beat per clock–even when crossing
the boundaries between multiple burst requests.&lt;/p&gt;

    &lt;p&gt;A classic design example which might work well here would be a single
port SRAM controller.  Such a controller would require an internal
arbiter to select which of the read or write channel would be allowed
access to the SRAM.&lt;/p&gt;

    &lt;p&gt;A bonus exercise might be to make that slave able to handle exclusive
access requests, but this would need to be bonus.  Not all AXI slaves
need or want exclusive access.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A good exercise for building an AXI master might be to build an AXI based
cache of some type.  At this point, however, there’s no real way around
the two protocols required: you’d need to support both a cache-to-CPU
protocol as well as the AXI protocol.&lt;/p&gt;

    &lt;p&gt;The cache would be the first type of component requiring burst access.
It can be kept simple enough as to only require a single burst at a time.
Bonus points would include using WRAP addressing, or exclusive access
(data cache only).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When you want good bus performance, however, you need to be able to build 
a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;.
The skills involved in building (and verifying) a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;memory to memory
DMA controller&lt;/a&gt;
should be the last AXI skills you will need to learn.&lt;/p&gt;

    &lt;p&gt;The key new feature learned when building a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA
controller&lt;/a&gt;,
not present in any of the prior AXI components, is the simple reality that
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;a DMA&lt;/a&gt;
needs to be able to blast as much information across the bus as possible in
as few beats as possible.  This means you’d need to be able to verify that
your design can issue and track multiple outstanding burst requests at any
given time.&lt;/p&gt;

    &lt;p&gt;To simplify this project to something that might still be accomplished
within a class, I might suggest limiting this DMA to aligned words only.
Obviously, &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;a DMA which can handle both unaligned addresses and unaligned
lengths&lt;/a&gt; is
more useful, but the challenge involved in verfiying
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;such a DMA&lt;/a&gt;
might be too much for an introductory course in AXI design.&lt;/p&gt;

    &lt;p&gt;The neat part of this exercise however, is that once you can build a
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;basic AXI DMA&lt;/a&gt;,
you can then build all kinds of specialized data movers, such as:
stream or packet to memory DMA’s, or the reverse memory to packet or stream
DMA, video DMAs, virtual FIFOs, and more.  None of these items are really
all that much more complex than the
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;basic AXI DMA&lt;/a&gt;
is in the first place.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;While these example design exercises start simple, they do end up quite
complex–as they should.  This isn’t quite as complex as AXI gets, however.
More complicated AXI designs might include bus upsizers, downsizers, or even
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbars&lt;/a&gt;.  While such
components are more complex, they aren’t really required for &lt;em&gt;learning&lt;/em&gt; AXI.
If you can handle the prior exercises, then you should then know enough to
build any of these more complex components.&lt;/p&gt;

&lt;p&gt;The big problem I have with these exercises, however, is that they get fairly
challenging by the end.  I’m not sure how I would go about fitting the
verification of a DMA into an AXI formal verification course of only a couple
days–especially since it took me a couple of weeks to verify &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;my own
DMA&lt;/a&gt;.
So … I’ll continue to keep my eyes open for better (simpler) examples to
work with and from.  Until then, this is still a really good list of exercises
for any student to work with in order to learn the basic AXI concepts on his or
her own.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I’m not sure I’ve seen a lot of good AXI training material on-line.  Most
of what I’ve seen, so far, has been Xilinx’s materials–and those materials
would have you start with and modify a
&lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;broken design&lt;/a&gt;.
Further, there aren’t a lot of materials discussing how to &lt;em&gt;formally&lt;/em&gt; verify
AXI designs, and it’s that formal part that was required in order to find some
really fundamental
bugs in Xilinx’s AXI designs.&lt;/p&gt;

&lt;p&gt;In the meantime, I offer the roadmap above for learning AXI.  Not everyone
will need all of the lessons or exercises above.  However, the lessons and
exercises outlined above should be thorough enough for anyone to fully learn
the topic.&lt;/p&gt;

&lt;p&gt;Finally, if a course in formally verifying AXI bus components is something you
would be interested in, then let me invite you to correspond with me and
express your interest.  Let me also invite anyone interested to suggest how
either the exercises might be simplified, or how the course might be
structured so as to make sure everyone has the time and ability to accomplish
each of the exercises.  Without such exercises, I fear that lecture alone would
leave students just as confused as they are or were when they entered
the course.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;If thou hast run with the footmen, and they have wearied thee, then how canst thou contend with horses? and if in the land of peace, wherein thou trustedst, they wearied thee, then how wilt thou do in the swelling of Jordan? (Jer 12:5)&lt;/em&gt;</description>
        <pubDate>Sat, 07 May 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/05/07/learning-axi.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/05/07/learning-axi.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
  </channel>
</rss>
