<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>The ZipCPU by Gisselquist Technology</title>
    <description>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstream FPGA design courses such as how to debug an FPGA design.
</description>
    <link>https://zipcpu.com/</link>
    <atom:link href="https://zipcpu.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 30 Aug 2022 21:51:23 -0400</pubDate>
    <lastBuildDate>Tue, 30 Aug 2022 21:51:23 -0400</lastBuildDate>
    <generator>Jekyll v4.2.0</generator>
    <image>
      <url>https://zipcpu.com/img/gt-rss.png</url>
      <title></title>
      <link></link>
    </image>
    
      <item>
        <title>It's not my fault!  Your code is broken.</title>
        <description>&lt;p&gt;I’ve  always commented that the way to get an interface working is to lock
the engineers responsible for each side of the interface together in a room
until it works.  I like to say it in jest, but in many ways there’s a lot of
truth to it.&lt;/p&gt;

&lt;p&gt;One of the challenges of working with Open Source anything really is debugging.
To be successful, an open source engineer needs to commit their time to
supporting their design–no matter how it is used.  As an illustration, what
happens when one engineer uses an open source design, uses it inappropriately,
and then declares that it doesn’t work?  It can reflect poorly on the quality
of the design–even if the design was and remains fully functional.&lt;/p&gt;

&lt;p&gt;As an example, someone recently attempted to use &lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;my digital
PLL&lt;/a&gt;.  They commented
that &lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
worked great, as long as they didn’t attempt any frequency
tracking.  Was
&lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
broken?  Not at all.  Was the frequency tracking broken?
No, not that either.  In this case, the user wanted to track a 2kHz clock
using a 250MHz sample frequency.  The problem was twofold: first, they didn’t
adjust the gain coefficient appropriately.  As a result, the first time
&lt;a href=&quot;/dsp/2017/12/14/logic-pll.html&quot;&gt;the PLL&lt;/a&gt;
noticed that the two clocks weren’t aligned, it attempted to adjust the
frequency by such a large extent that there was no way it would ever come into
alignment.  The second problem was that they didn’t give the design enough
phase bits to track such a low frequency.&lt;/p&gt;

&lt;p&gt;Finding these bugs required a test case from the user sufficient to trigger
the bug, and a couple of hours running simulations.   Thankfully, I knew where
to look since I’d worked with
&lt;a href=&quot;https://github.com/ZipCPU/dpll/master/blob/rtl/sdpll.v&quot;&gt;the design&lt;/a&gt;
before, and knew it was sensitive to how you set the tracking
coefficient–something anyone who had worked with PLLs before would know.&lt;/p&gt;

&lt;p&gt;In another example, I watched a user complain that Xilinx’s FFT wasn’t
working.  However, when he presented his logic it wasn’t too hard to
discover that his &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI stream logic was
broken&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Today’s story, however, regards the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;cheap-hardware-for-compressing-weather-data&quot;&gt;Cheap Hardware for Compressing Weather Data&lt;/h2&gt;

&lt;p&gt;Early on in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s
development, I met a kind gentleman who was interested in using cheap hardware
to compress massive amounts of weather data.  Let’s call him Pi, to allow him
to remain anonymous.  His goal, further, was to be able to accomplish this
compression on the cheapest commodity hardware he could find.  He was
interested in the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
back then specifically because the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
promised to be low logic and he wanted a CPU to help him do his work.&lt;/p&gt;

&lt;p&gt;We’ve since interacted with each other off and on for, well, I suppose it’s
been about five years.  He has been very supportive of my efforts, and has
always volunteered to help me test and verify any new distribution I put
together.&lt;/p&gt;

&lt;p&gt;Let’s come back to Pi again in a moment.  For now, let me share some of the
lessons I’ve since learned about verification from working with the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

&lt;!-- Need to lead up to the discussion of whether or not the memory is working
&quot;If memory is brok how does the lifting step work in catzip in hw and sim
produces same results as test-zipcore?  The pport rtl files from icozip dev
break pptest speechpp in hw.&quot;
--&gt;

&lt;h2 id=&quot;lessons-and-stories-from-zipcpu-verification&quot;&gt;Lessons and Stories from ZipCPU verification&lt;/h2&gt;

&lt;p&gt;When I first built the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;,
I needed some way of testing it.  So I built
a small assembly based test script to test each instruction.  While my goal
was to test each instruction in isolation, nothing ever really works out that
way.  In reality, every instruction under test required that two instruction
sequences needed to be tested.&lt;/p&gt;

&lt;p&gt;Well, let’s be honest, that first test was built in machine code.  A &lt;a href=&quot;https://github.com/ZipCPU/blob/master/sw/zasm/optest.cpp&quot;&gt;small C++
program&lt;/a&gt; helped me
generate this code, but the instructions were written in C++, not as an input
file.  I then &lt;a href=&quot;https://github.com/ZipCPU/blob/master/bench/asm/simtest.s&quot;&gt;converted the test to
assembly&lt;/a&gt;, and built
&lt;a href=&quot;https://github.com/ZipCPU/blob/master/sw/zasm.y&quot;&gt;my own assembler&lt;/a&gt; to turn it
into machine code.  Eventually, the test was compiled using
the GNU assembler from binutils, and then turned into a
&lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/cputest.c&quot;&gt;C program&lt;/a&gt; that
I now run on every updated design.&lt;/p&gt;

&lt;p&gt;Once I knew that every instruction worked, I then declared the CPU operational.&lt;/p&gt;

&lt;p&gt;Over the next several years, I was surprised to find further bugs in my
“operational” CPU.  The list below is just a small subset of some of those bugs.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was originally a
32-bit byte machine.  Back in the day, it couldn’t handle 8-bit bytes.
Neither could I compile the C-library for the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  So, it needed to change.&lt;/p&gt;

    &lt;p&gt;When I first converted the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
to using 8-bit bytes, I came across an ugly printf bug.  This was due to
the fact that the data structure used by the
&lt;a href=&quot;https://sourceware.org/newlib&quot;&gt;newlib&lt;/a&gt; stdio library is a packed structure.
My initial data tests only tested reading and writing 32-bit words–not
bytes within a greater structure.&lt;/p&gt;

    &lt;p&gt;The broken design failed to pass &lt;a href=&quot;https://en.wikipedia.org/wiki/&amp;quot;Hello_World!&amp;quot;_program&quot;&gt;&lt;em&gt;Hello
World&lt;/em&gt;&lt;/a&gt;, so
&lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/hello.c&quot;&gt;Hello World&lt;/a&gt; is
now one of my standard tests.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When it came time to give the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
an instruction cache, I built one I called
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/master/rtl/core/pfcache.v&quot;&gt;pfcache&lt;/a&gt;.
I built a test bench for it, and verified that it did everything right when
running the test bench.&lt;/p&gt;

    &lt;p&gt;I was then convinced the prefetch worked.  Indeed, &lt;em&gt;everything&lt;/em&gt; worked well:
the bench test, the CPU test, etc. until I first placed this design into
hardware.  Once I placed things into hardware, the &lt;a href=&quot;/zipcpu/2017/12/18/ugliest-bug.html&quot;&gt;CPU broke and I was
looking everywhere else but the instruction cache for the
bug&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I have continued using the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
for some time after that, and indeed still use it today.  However, when
it came time to learn formal verification, there was a time when it became
time to &lt;a href=&quot;/blog/2018/04/02/formal-cpu-bugs.html&quot;&gt;formally verify the
ZipCPU&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;At this point, again, it passed all my test benches.  It ran many programs
successfully.  I had used it in hardware successfully for many programs.
I “knew” it worked, and had a lot of confidence in it.  I just wanted to
formally verify it.&lt;/p&gt;

    &lt;p&gt;Much to my surprise, &lt;a href=&quot;/blog/2018/04/02/formal-cpu-bugs.html&quot;&gt;there were many bugs in the
CPU&lt;/a&gt; that none
of my simulation test benches ever caught.  Many of these depended on
specific instruction sequences that I didn’t have the vision to anticipate,
and which weren’t triggered by my &lt;a href=&quot;https://github.com/ZipCPU/blob/zipcore/sim/zipsw/cputest.c&quot;&gt;C test
program&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When I first added GCC support, I ran up against a difficult problem: the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; only had instruction space
to support eight conditions.  GCC wanted support for many more conditions.
How should the missing conditions be generated?&lt;/p&gt;

    &lt;p&gt;Specifically, I had an unsigned less than comparison, but no greater than
or equal unsigned comparison.  For example, to tell if the unsigned value
Rx was less than another unsigned value Ry, and then branch if it was, one
might write:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP Rx,Ry		# Is (unsigned)Rx &amp;lt; (unsigned)Ry?
     BC  target		# Branch to target if the carry bit is set&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;To handle greater than, I could reverse the comparison.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP Ry,Rx		# Is (Unsigned)Rx &amp;gt; (unsigned)Ry?
     BC  target		# Branch to target if the carry bit is set&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;But how should I check for less than or equal?&lt;/p&gt;

&lt;p&gt;My approach for this was to add one to the comparison, so that the
   comparison became,&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;     CMP -1+Rx,Ry	# Is (Unsigned)Rx-1 &amp;lt; (unsigned)Ry?&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Again, this passed all my tests.&lt;/p&gt;

&lt;p&gt;Look closely at this solution, though.  What would happen if Rx were
   zero?  If you subtracted one from Rx it would become the greatest possible
   unsigned integer.  If you then checked the comparison, it would fail.&lt;/p&gt;

&lt;p&gt;It wasn’t until some time after I had GCC support “working” that I came
   across this bug.  Sure enough, I didn’t expect to find it in my GCC
   back end.&lt;/p&gt;

&lt;p&gt;Eventually, I solved this problem by adjusting the instruction set
   so as to get rid of the greater than comparison and to replace it with a
   no-carry check.  The solution is only so good, and sometimes breaks down
   to the point where I need to issue two branch instructions to cover
   the desired condition–but that’s really a topic for another day.&lt;/p&gt;

&lt;p&gt;My point here is simply that, when debugging one part of my design, I found
   I needed to look somewhere else entirely to trace down this bug.&lt;/p&gt;

&lt;ol start=&quot;5&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;After using the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; for many 
projects, &lt;a href=&quot;/zipcpu/2019/02/04/debugging-that-cpu.html&quot;&gt;I ran into trouble in one that was using a GbE network
controller&lt;/a&gt;.
For some strange reason, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
appeared to be randomly hanging.  I struggled to figure out why.  I mean,
it worked in my test bench, no?&lt;/p&gt;

    &lt;p&gt;When I finally traced the problem down, it was due to a race condition
in the interrupt logic.  If an interrupt happened between two halves of a
compressed instruction, the CPU would lock up.&lt;/p&gt;

    &lt;p&gt;At the time, I didn’t have any good test scripts for triggering interrupts
on the CPU.  Unfortunately, I still don’t–although I now have more formal
properties to catch bugs like this.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;At one time, the HALT instruction wasn’t working.  Sure, it would issue,
but never actually halt.&lt;/p&gt;

    &lt;p&gt;The problem was another instruction sequence thing, combined with
handling the HALT instruction with a Verilator C++ test script.
In this bug, a particular instruction sequence might keep the CPU
from halting following a HALT instruction.&lt;/p&gt;

    &lt;p&gt;Does the test bench check the HALT instruction?  Well, yes, but … only
once.  (Fixing this is on my to-do list …)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The LOCK bug: Sometimes it’s just that you haven’t thought through all of
the complex interactions between your logic.  For example, how should the
CPU step through a user instruction sequence that attempts to perform an
atomic access instruction, and yet do this from supervisor mode?&lt;/p&gt;

    &lt;p&gt;In the case of this bug, the CPU faithfully allowed the supervisor to
step through each of the sub-instructions associated with a LOCK instruction
sequence:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;   LDI  atomic_value,Ra		# Get the address of a semaphore
   LOCK				# Acquire a bus lock
   LW     (Ra),Rd		# Load the semaphore
   SUB    1,Rd			# Attempt to decrement it by one
   SW.GE  Rd			# If the updated semaphore is &amp;gt;= 0, write it back
   # The bus lock is then released, after the store instruction is issued.&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The problem with doing this, though, is that stepping through a LOCK
   sequence destroys the LOCK operation on the bus.  All four instructions
   following the LOCK instruction must complete or fail together–you can’t
   step through them or interrupt them.&lt;/p&gt;

&lt;p&gt;Lesson learned.&lt;/p&gt;

&lt;p&gt;My point in going through this list is simple: in each case, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; passed all of its simulation
test cases.  In each case, I was convinced the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; worked before placing it into
either a larger simulation environment or hardware itself.  In each case,
debugging then became harder because the bug had escaped bench testing.&lt;/p&gt;

&lt;p&gt;Yes, I now have tests that will catch most or even all of these bugs should
they ever occur again.  Am I convinced that the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is now free of all bugs?
Convinced enough to use it.  Beyond that, only time will tell.&lt;/p&gt;

&lt;h2 id=&quot;sdram-problem&quot;&gt;SDRAM Problem&lt;/h2&gt;

&lt;p&gt;I bring all this up to begin another story.&lt;/p&gt;

&lt;p&gt;Let’s go back to the story of the kind gentleman I mentioned above, Pi.
Pi wanted to build a &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; design for
some hardware he had purchased.  I didn’t have a copy of his hardware, but
sure, go ahead, copy one of my designs and place it onto your hardware.  God
bless, and have an adventure!&lt;/p&gt;

&lt;p&gt;His hardware required an SDRAM controller.  I suggested &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;one of my
own&lt;/a&gt;,
but cautioned him: not all SDRAM chips and protocols are the same.  The
required timing can change from one chip to another.  Memory size can change,
etc.&lt;/p&gt;

&lt;p&gt;I’m not sure how he did it, but he did manage to get it to work.&lt;/p&gt;

&lt;p&gt;Later on, I made some updates to the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  These changes included bug
fixes, and so it was worth upgrading his design for the new
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  The problem was that, when
he upgraded his design, it stopped working.  Your CPU, he said, was the problem.&lt;/p&gt;

&lt;p&gt;Well, if the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; has a bug in
it, then I want to fix it.&lt;/p&gt;

&lt;p&gt;That said, this left me with a bit of a dilemma: this is a kind, retired,
gentleman.  He has no significant money to hire an engineer.  My time fixing
his bug would never be paid for, and I had demanding jobs on my plate at the
time.  On the other hand, a bug in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
would reflect poorly on my work, and I try to keep my github repositories
working and debugged.&lt;/p&gt;

&lt;p&gt;So, I invested a Saturday into debugging his problem.&lt;/p&gt;

&lt;p&gt;Sure enough, it wasn’t a bug in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  Yes, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; test case was
no longer running on his hardware, but the problem wasn’t in the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  His problem was due to a
misconfiguration of the SDRAM controller he had copied, and then changed to
match his chip.  That was a copy and change done with little (if any)
understanding of how the SDRAM worked in the first place.&lt;/p&gt;

&lt;p&gt;This was voodoo engineering at its best:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Voodoo Engineering, Defn:&lt;/strong&gt; &lt;em&gt;To change what isn’t broken, in an attemp to fix
what is.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;To make matters worse, the &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;SDRAM
RTL&lt;/a&gt;
was modified one way, and the &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/sim/verilated/sdramsim.cpp&quot;&gt;SDRAM simulation
model&lt;/a&gt;
no longer matched.&lt;/p&gt;

&lt;p&gt;So, as a kind teacher, I tried to point out that he had no business trying to
run or debug his design on hardware if it didn’t work in simulation.&lt;/p&gt;

&lt;p&gt;Indeed, I went further: I pointed out that he had a bug in the SDRAM
portion of his design.&lt;/p&gt;

&lt;p&gt;However, this was no longer a controller I felt responsible for.  Yes, it was
originally my controller, but Pi had since changed and significantly modified
it.  Sure, I could debug it for him, but who would then pay for my time?  It
wasn’t a bug in &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/rtl/arrowzip/wbsdram.v&quot;&gt;my SDRAM
controller&lt;/a&gt;,
nor in &lt;a href=&quot;https://github.com/ZipCPU/arrowzip/blob/master/sim/verilated/sdramsim.cpp&quot;&gt;my C++ SDRAM
model&lt;/a&gt;,
nor in the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  It was a bug in
Pi’s changes.&lt;/p&gt;

&lt;p&gt;Needless to say, Pi was quite frustrated.  To my knowledge, he remains stuck in
&lt;a href=&quot;/blog/2017/05/19/fpga-hell.html&quot;&gt;FPGA Hell&lt;/a&gt; to this day.
Worse, he seems to have given up on RTL design, and he has certainly stopped
trying to get the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; working on
his board.&lt;/p&gt;

&lt;p&gt;Was his problem that hard?  Not really, but you really have to know the basics,
to include how to properly debug a simulation and trace a problem down from
the bug (the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; CPU test not
working) through to the problem (the SDRAM mis-configured).  That’s a lot of
design that needs to be traced through to find a bug.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;What conclusions might we draw from these stories?  Hardware is hard?  Maybe,
but that’s not really the conclusion I am going to draw today.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Do not place a design into hardware if the design doesn’t first work
in simulation.&lt;/p&gt;

    &lt;p&gt;This should go without saying.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If you change the RTL controller, the simulation model should need to be
changed to match.&lt;/p&gt;

    &lt;p&gt;If not, then was your simulation model really good enough in the first
place?&lt;/p&gt;

    &lt;p&gt;In Pi’s case, I’m not sure he remembered that he had changed the simulation
model …&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;While I’d like to say that debugging hardware is hard, debugging a
simulation really isn’t any harder than debugging anything in software.
In fact, simulations &lt;em&gt;are&lt;/em&gt; (technically) software.  Unlike hardware, you
have every signal available to you to analyze when running a simulation!&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;Debug by printf works in simulation&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;When using VCD/trace files, you can get even more information about
what’s going on within a design than gdb will ever give you!&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Getting a single module working is easy–especially when it is one you’ve
written yourself.&lt;/p&gt;

    &lt;p&gt;Getting 5-6 modules to work together, and to interact with external hardware?
That’s harder.  Not only do you need to know enough of how those 5-6 modules
work, and how the external module is supposed to work, but you have to know
those parts and pieces well enough that you can debug them.  You have to know
them well enough that you can find the one condition within module 3 (or
whichever one it is) that was set improperly.  It doesn’t help if those
modules were written by someone else either–this just makes the task
of an integration engineer that much more challenging.&lt;/p&gt;

    &lt;p&gt;I’ve often found hardware debugging sessions to bounce around from place
to place, as I try to chase a bug from where it manifests to its cause.
The process is time consuming and painful.  It’s also why those whose work
involves jobs like this can demand big bucks.  (At least I think they’re
big …)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If the design is complicated enough, and a different engineer has written
each of the models that need to be made to work together, then it may be
time to force all of the various engineers into the same room to get the
design to work.&lt;/p&gt;

    &lt;p&gt;In business, where you have the $$ or control to make this happen, this is
generally the most successful approach to solving integration bugs.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The bug you are looking for is rarely in the place you are looking.&lt;/p&gt;

    &lt;p&gt;I seem to have written about this often enough that it seems to be a
recurring theme on this blog.  I’ve already linked to several examples of
this above.  Not only do I experience this problem within my own work, I also
come across it when participating in online forums.  This also took place
when I was working customer support for Yosys.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;Customer: Your design doesn’t work!&lt;/p&gt;

      &lt;p&gt;Me: Well, okay, let’s do some joint debugging …&lt;/p&gt;

      &lt;p&gt;(After a lot of work …)&lt;/p&gt;

      &lt;p&gt;Me: No, actually, it’s your own design that’s at fault.&lt;/p&gt;
    &lt;/blockquote&gt;

    &lt;p&gt;Of course, to get to this point, you have to have enough confidence in how
the customer’s design works (or doesn’t) to be able to state with confidence
that it is their problem.&lt;/p&gt;

    &lt;p&gt;As a professional engineer, this interaction tends to be rather frustrating:
who do I bill for this time?  Do I bill the project the complaint was lodged
against?  That project worked.  Realistically, the bill should be given to
the customer, but that’s just not how the open source world works.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Let me know if you want to help Pi out.  I’m sure he’d like some help getting
his design working again.&lt;/p&gt;

&lt;h2 id=&quot;one-final-gem&quot;&gt;One final gem&lt;/h2&gt;

&lt;p&gt;As one final gem: some of the most challenging problems I’ve had to deal with
have involved debugging memory.  The CPU might read a value from memory and
do something inappropriate with it.  When you then try to debug the CPU,
it can be very difficult to tell where the problematic value got written to
memory in the first place.&lt;/p&gt;

&lt;p&gt;If you ever find yourself stuck dealing with this problem, try the following.&lt;/p&gt;

&lt;p&gt;First, let’s assume for discussion purposes that your memory model logic
looks something like:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i_write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Here’s the trick: check for everytime the value at this memory location
changes, and print something out anytime it does.  In Verilog, this
check could easily look like:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;localparam&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ADDRESS_WIDTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Whatever ...;&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;reg&lt;/span&gt;	&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;assign&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;track_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mem[0x%08x] &amp;lt;= %08x at time %t&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;BUGGY_ADDRESS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;track_valu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Of course, this logic won’t &lt;em&gt;synthesize&lt;/em&gt;, so you’ll want to remove it as
soon as you are done debugging, but it should be enough to get you to the
next step.&lt;/p&gt;

&lt;p&gt;The next step is to look at the output of your simulation to find where in
the trace the wrong value got written to memory.  Now go look up that time
in the trace, and you’ll be able to continue your work backwards through the
logic until you can find the source of your bug.&lt;/p&gt;

&lt;p&gt;Oh, and yes, you can use this basic technique when using a Verilator C++ model
as well, it’s just that the code for it will look a bit different.
Indeed, this technique would’ve sent Pi directly to his problem.  Perhaps
he’ll even read this article and manage to find his bug, since he &lt;em&gt;is&lt;/em&gt; an avid
reader of this blog.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Many will say to me in that day, Lord, Lord, have we not prophesied in thy name? and in thy name have cast out devils? and in thy name done many wonderful works?  And then will I profess unto them, I never knew you: depart from me, ye that work iniquity. (Matt 7:22-23)&lt;/em&gt;</description>
        <pubDate>Tue, 30 Aug 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/zipcpu/2022/08/30/not-my-fault.html</link>
        <guid isPermaLink="true">https://zipcpu.com/zipcpu/2022/08/30/not-my-fault.html</guid>
        
        
        <category>zipcpu</category>
        
      </item>
    
      <item>
        <title>Protocol Design for Network Debugging</title>
        <description>&lt;p&gt;What do you do when you need
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;,
but don’t have it?&lt;/p&gt;

&lt;p&gt;Let me back up and set the stage a bit more.  I’m working with what will be
an underwater design, as shown in Fig. 1.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig 1. Controlling an Underwater FPGA&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/sysdesign.svg&quot; alt=&quot;&quot; width=&quot;780&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For those who haven’t figured it out, this will (eventually) form the basis of
a SONAR device.&lt;/p&gt;

&lt;p&gt;At first, this problem seems simple enough: there will be an FPGA device
controlled via a network port.  Easy, got it.  Better yet, what’s the easiest
network protocol to use?
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;.  Open
Source &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;,
software stacks aren’t all that hard to write, and I know there are several
open source stacks that are easy enough to use.  (No, I’ve never written one
myself …)&lt;/p&gt;

&lt;p&gt;But, let’s dig a little deeper: I want to be able to control and debug the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
via the same network port.  That means I’ll want to be able to &lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;stop the CPU,
read its registers, adjust the contents in RAM, and then restart it
again&lt;/a&gt; all
over the network.  Put another way, if the CPU software won’t be running at
all times, then I can’t implement
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;
in software and still debug the CPU using the same
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;
stack.  Worse, what if the FPGA firmware can’t be trusted?
Now things are getting a bit more challenging.  How shall a piece of broken
FPGA firmware be updated without using software on the FPGA board?&lt;/p&gt;

&lt;p&gt;This, then, is where this problem starts.&lt;/p&gt;

&lt;p&gt;At the most basic level, any FPGA design can be halted and updated via the JTAG
port.  Most vendor designs will allow for that.  However, in this design, that
JTAG port will be quite literally underwater.  The only way to access it will
be to bring the entire unit back out of the water, to dry off the chassis the
FPGA board sits within, and then to uncap the JTAG port and access it.  This
is the insurance policy for the project–guaranteeing that the chassis the
hardware sits within will not need to be opened except in extreme circumstances.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 2. Reconfiguring a running FPGA&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reconfig-plan.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;That’s not, however, going to be the normal mode of operation.  Normally, upon
application of power, this design will need to automatically start up and then
do something to allow itself to be updated.  This can be done via an
Internal Configuration and Access Port (ICAP) found within the FPGA itself.
If a second design configuration can be written to the
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;,
the ICAP port can then be told to tell the FPGA to reconfigure itself from
this second configuration location.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 3. Basic outline of a UART protocol to control a Wishbone Bus&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/wb-uart-ovw.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Normally, I handle this sort of problem within my designs using a &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial
port&lt;/a&gt;
together with what I call a “debugging bus”: a protocol, running over
that &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;,
that allows me to read from or write to any address on the bus within the FPGA.
&lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;We’ve discussed this protocol
before&lt;/a&gt;, and for
reference you can see the basic components of this protocol in Fig. 3 on the
left: Commands are grouped into words, decompressed, placed into a FIFO, and
then those commands are used to control the bus.  Bus returns then come back.
Reset acknowledgments and interrupts get added to the return stream, which is
then compressed and split back into bytes before being returned across the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;.
In general, this works great, and I’ve used this approach for years.
Even better, having full bus access makes it really easy to debug the FPGA–as
long as you can guarantee that neither the debugging bus protocol nor the bus
itself will fail on you.&lt;/p&gt;

&lt;p&gt;That’s great for a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; protocol,
where character’s aren’t (generally) lost and where messages don’t
accidentally get repeated.&lt;/p&gt;

&lt;p&gt;But what about a network protocol?&lt;/p&gt;

&lt;p&gt;Today’s discussion, then, will discuss a network protocol which can be used
to do this same thing, but with an interface simple enough that it can be
implemented in an FPGA.&lt;/p&gt;

&lt;h2 id=&quot;understanding-the-problem&quot;&gt;Understanding the Problem&lt;/h2&gt;

&lt;p&gt;Let’s back up, therefore, and take a moment to understand the goal and purpose
of this protocol together with some of what makes the networking environment
unique.  This will lead us to an understanding of some of the problems
involved that will need to be handled by this protocol.&lt;/p&gt;

&lt;h3 id=&quot;all-network-traffic-takes-place-in-packets&quot;&gt;All network traffic takes place in packets&lt;/h3&gt;

&lt;p&gt;The first rule of networks is that all communication takes place in packets.
Even better, since we’ll be using Ethernet, &lt;a href=&quot;https://en.wikipedia.org/wiki/Ethernet_frame&quot;&gt;every Ethernet
packet&lt;/a&gt;
ends in a four byte &lt;a href=&quot;https://en.wikipedia.org/wiki/Frame_check_sequence&quot;&gt;Frame Check
Sequence&lt;/a&gt;
based upon a &lt;a href=&quot;https://en.wikipedia.org/wiki/Cyclic_redundancy_check&quot;&gt;Cyclic Redundancy Check
(CRC)&lt;/a&gt;.  These four
bytes are produced by a function applied to the contents of the packet.  Then,
on reception, the receiving end can also calculate the same function.  If the
result matches the four-byte frame check sequence found in the packet, then
you can have some strong assurance that the packet was received across the
interface without error.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-be-lost&quot;&gt;Packets may be lost&lt;/h3&gt;

&lt;p&gt;Here’s our first problem: if something goes wrong on the network–perhaps
there’s too much congestion somewhere, perhaps the FPGA is still responding to
some other packet, then a packet may be dropped.  Indeed, &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;we discussed this
sort of idea&lt;/a&gt; quite
recently.  In network implementations, dropped packets are considered a
“normal” phenomena, and any protocol working across the network needs to be
able to recover from a lost packet.&lt;/p&gt;

&lt;p&gt;Think this through a bit, since this can be a real problem.  What happens if
the bus within the FPGA locks up because some peripheral isn’t responding?
In the worst case, all following packets will be lost–to include any
packets telling the FPGA to reset itself.  This is a real possibility that
we’ll need to consider as things go on.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-be-repeated&quot;&gt;Packets may be repeated&lt;/h3&gt;

&lt;p&gt;The next problem is that packets may be repeated.&lt;/p&gt;

&lt;p&gt;At first, I simply poo-pood this idea.  This would never happen in any of &lt;em&gt;my&lt;/em&gt;
implementations, I told myself, because nothing in the network stack will ever
repeat a packet.&lt;/p&gt;

&lt;p&gt;Then I got to thinking some more about this.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 4. Request/Reply protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reqreply.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Imagine you have two computers talking to each other, and one computer (the
client) makes a request of the second (the server/FPGA).  If the request gets
dropped, how shall the first computer (the client) know it was dropped except
if it doesn’t get any response?  Worse, if the client doesn’t get any response,
does that mean 1) the server didn’t get the request, or 2) that the server did
get and process the request and the client just didn’t get the reply?  All the
client can do at this point is to just re-send and re-send its packet until
it eventually gets a reply.&lt;/p&gt;

&lt;p&gt;Voila, repeated packets.  We’ll need to handle these somehow.&lt;/p&gt;

&lt;p&gt;Now lets make matters even worse: some requests, such as commanding the
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;
device to erase a sector or to program a page, aren’t things you want to do
twice.  Any network based debugging protocol will therefore, of a necessity,
need to be able to properly handle duplicated packets.&lt;/p&gt;

&lt;h3 id=&quot;packets-may-arrive-out-of-order&quot;&gt;Packets may arrive out of order&lt;/h3&gt;

&lt;p&gt;Just to make things worse, not only may packets get dropped or repeated, they
might also arrive out of order.&lt;/p&gt;

&lt;h3 id=&quot;udpip-is-a-fairly-simple-protocol&quot;&gt;UDP/IP is a fairly simple protocol&lt;/h3&gt;

&lt;p&gt;One of the easiest protocols to implement in an FPGA is
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;.  1) &lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L130-L136&quot;&gt;It’s easy
enough to program most computers to send UDP
packets&lt;/a&gt;,
and 2) &lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L156-L187&quot;&gt;receiving UDP packets is relatively easy as
well&lt;/a&gt;.
Even better, if implemented well, the &lt;em&gt;internet&lt;/em&gt;
(the &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; part) has some remarkable
capabilities to it: I might even be able to access this piece of underwater
hardware from the other side of the world if necessary.  On the FPGA side,
there are some challenges involved in implementing
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;,
but the result is still fairly easy to accomplish.  Some of these challenges
include:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The FPGA needs to know the Ethernet MAC address, IP address, and destination
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; port to send the
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; packet to.&lt;/p&gt;

    &lt;p&gt;These can often be copied from the source addresses found in the request,
so that’s not a big problem.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Both &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
and &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
headers need to know the length of the rest of the
packet–possibly even before the rest of the packet has been formed.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; header
and &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; payload
&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4_header_checksum&quot;&gt;checksums&lt;/a&gt; are
implemented, these are also placed &lt;em&gt;prior&lt;/em&gt; to the packet data.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This sort of necessitates that a packet be formed first and placed into
a temporary buffer, before being forwarded downstream.  Still, this is quite
doable.&lt;/p&gt;

&lt;p&gt;The problem with &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;,
however, is that it offers no protection against the problems listed above:
packets may still be dropped, duplicated, or arrive out of order.&lt;/p&gt;

&lt;h3 id=&quot;ip-packets-may-be-fragmented&quot;&gt;IP packets may be fragmented&lt;/h3&gt;

&lt;p&gt;If a packet is too big for some portion of the network, then whatever
intermediate node recognizes this is supposed to be able to split the packet
into multiple sub-packets (fragments).  These packets will then be reassembled
on the far end.&lt;/p&gt;

&lt;h3 id=&quot;tcpip-requires-memory&quot;&gt;TCP/IP requires memory&lt;/h3&gt;

&lt;p&gt;I’ve used &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
in the past.  In general, it’s always been one of my favorite
protocols to work with: it’s easy and reliable.  However, I’ve never had to
implement it before, neither have I ever tried to implement it on an FPGA.
When digging into what it would take to implement the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
within an FPGA, it doesn’t take long to learn that each connection will require
some amount of memory to work properly–perhaps as much as 64kB per connection.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The connection setup defines the maximum and required sizes of this window&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Packet data includes where in the stream the data comes from&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Acknowledgments include the latest received stream position&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Further, &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
removes packet boundaries in favor of transmitting stream positions.  In many
ways, though,
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
might be the ideal way of encapsulating what was once a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; stream.&lt;/p&gt;

&lt;p&gt;Others have made this protocol work on an FPGA, so I know it can be done.
In my review, however, I ended up balking at the idea of implementing my own
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
protocol handling stack within FPGA logic.  (I’ll probabbly still place an
implemention of the &lt;a href=&quot;https://en.wikipedia.org/wiki/Transmission_Control_Protocol&quot;&gt;TCP&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
stack within the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
software before I’m done …)&lt;/p&gt;

&lt;h3 id=&quot;gbe-is-fast&quot;&gt;GbE is fast&lt;/h3&gt;

&lt;p&gt;From my experience, and with the boards I have, a
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
can typically achieve speeds somewhere between about 100kB/s (1MBaud) and
400kB/s (4MBaud).  Gigabit Ethernet, on the otherhand, can transfer data at
125MB/s.  That’s probably faster than I need for this part of the project.
The biggest impact this is likely to have, though, is that it might keep my
compression algorithm from working–since that algorithm only tries to
compress a response value as long as the return pipeline is stalled.  If the
link is so fast that it never stalls, then it might make sense to remove to
remove the &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
compression from this network re-implementation.&lt;/p&gt;

&lt;h3 id=&quot;the-goal&quot;&gt;The Goal&lt;/h3&gt;

&lt;p&gt;Just to make it clear, my goal is to be able to control the bus within an
FPGA design from a network interface.  This means I want to be able to read
from and write both peripheral registers as well as
&lt;a href=&quot;/zipcpu/2018/07/13/memories.html&quot;&gt;memory&lt;/a&gt; and
&lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;flash&lt;/a&gt;.
Using this capability, I want to be able to do things like:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Reading, erasing, programming, and verifying &lt;a href=&quot;https://en.wikipedia.org/wiki/Flash_memory&quot;&gt;flash
memory&lt;/a&gt; contents&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Issuing a warm boot request, so that the FPGA will reload itself from
a secondary location&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Configuring any application specific hardware from an external host.&lt;/p&gt;

    &lt;p&gt;As one example, I’m hoping to control an &lt;a href=&quot;https://www.analog.com/en/products/adau1761.html&quot;&gt;ADAU1761 audio
chip&lt;/a&gt;
on a &lt;a href=&quot;https://store.digilentinc.com/nexys-video-artix-7-fpga-trainer-board-for-multimedia-applications&quot;&gt;Nexys Video board&lt;/a&gt;.
The network bus should be able to turn this chip on, adjust which
channel(s) are selected, and any gain associated with the individual
channels.&lt;/p&gt;

    &lt;p&gt;I expect to use a separate protocol to handle the return audio from such
a controller.  For now, I just want a dependable network protocol I can use
to guarantee my ability to configure this controller across the network in
the first place.&lt;/p&gt;

    &lt;p&gt;This is a test-only capability, to allow an operator to “hear” any
internal signals while the device is still on the bench.  Once the device
is sealed up, similar circuitry within the device will be used to route
from among multiple potential signal sources and sinks to their ultimate
destinations.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Without access to JTAG, I won’t have any vendor tools available for internal
logic analysis in order to diagnose any faults.  Instead, I’ll be using my
own &lt;a href=&quot;/blog/2017/07/08/getting-started-with-wbscope.html&quot;&gt;Wishbone
scope&lt;/a&gt;
across this network protocol.&lt;/p&gt;

    &lt;p&gt;This also means that I’ll want to assume only a bare minimum of design
functionality here.  What happens, for example, if I need to debug the
DDR3 SDRAM protocol?  In that case, I would need to be able to operate
this bus without access to any but internal FPGA memory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;Rebooting, pausing, stepping, and stopping or starting the CPU within the
design&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;Examining CPU
registers&lt;/a&gt;
when the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;
is halted, and perhaps adjusting their contents if necessary.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That’s my goal, and you now know the problems associated with working with the
network.  Now, knowing this information, what can we do in order to generate
some form of protocol that we can use?&lt;/p&gt;

&lt;h2 id=&quot;generating-a-protocol&quot;&gt;Generating a Protocol&lt;/h2&gt;

&lt;p&gt;Let’s take a moment to walk through the design of this new protocol, and the
various choices I chose along the way to deal with the problems listed above.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 5. Encapsulating the former serial port protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/netb-encapsulation.svg&quot; alt=&quot;&quot; width=&quot;240&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;My first draft of this protocol, the draft I’ll be discussing today, simply
involved packetizing the requests I would’ve sent over the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt; in the
first place.  That means these debugging bus packets simply include an
additional header on top of the headers already existing, together with a
set of bytes which would’ve normally been sent across a &lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial
port&lt;/a&gt;.  We’ll call this
the “NetBus header” and “serial port debugging bus payload” or just “payload”
for short.&lt;/p&gt;

&lt;p&gt;My second (rather arbitrary) choice was to insist that all protocol
interactions take place in two parts: 1) the support software sends a request,
and 2) the FPGA returns a reply.  Moreover, as I alluded to above, &lt;em&gt;every&lt;/em&gt;
request was to receive a reply.  Should a reply not be returned, that would
mean that either the FPGA either didn’t receive the request or that the
response hadn’t been received.  This also meant that the FPGA would never
initiate a transaction on its own, it would only ever respond to requests.&lt;/p&gt;

&lt;p&gt;Incidentally, this also solves the problems associated with out of order
packets: if only one request is ever outstanding at a time, then there will
never be two or more packets to get reversed.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 6. Eight GPIO bits&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/gpio.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;One of the neat features of my serial port protocol was that it had a special
means of communicating
&lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupts&lt;/a&gt; to the host
computer.  At one time I used this feature with my &lt;a href=&quot;/blog/2019/03/27/qflexpress.html&quot;&gt;original flash
controller&lt;/a&gt;
to notify any programming software of the end of a write transaction.  This
was cool, but … perhaps we could expand upon it?  For example, it’d be nice
to get some status bits from the controller.  Such status bits might include
answers to questions like: Has the buffer within the controller ever suffered
from an overrun?  Has the controller received any bus error responses?  Is this
the first packet following a reset?  All of this together necessitated a set of
general purpose I/O bits that could be controlled via this protocol.  So far,
I’ve settled upon four of the eight bits shown in Fig. 6.  These would be
sticky bits when set, and only cleared upon a write from the external host.
Another four bits remain available for … whatever purpose.&lt;/p&gt;

&lt;p&gt;I created this capability with two parts: a mask and a value.  That way,
any GPIO bit could be updated whose mask bit was set to the value it was set
to, allowing independent control of each of these bits.  Further, by setting
the mask to zero, the FPGA would simply ignore these bits.  Indeed, this I/O
part of the protocol is very similar to &lt;a href=&quot;/zipcpu/2019/02/09/cpu-blinky.html&quot;&gt;one we’ve discussed
before&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My third choice was to place a stream packet ID number into the header of the
packet.  The FPGA can then use this ID to identify and handle repeated packets.
This way, should the FPGA ever detect a second request with the same frame
number, then it would simply repeat the response to the prior packet with
that frame number.&lt;/p&gt;

&lt;p&gt;One stream ID was designated as special: ID=0.  This indicated a “Sync” packet
in this protocol.  This would be the ID I would use when initiating a
communication with the device.  I could then use this packet to record and set
the Ethernet MAC, IP address, and UDP port of the source, as well as to
reset the state of the internal compression engine to something that could
be known within the client program.  This way, upon starting a client program,
the client could quickly synchronize the two compression engines.&lt;/p&gt;

&lt;p&gt;Further, the design should handle packets with an empty payload, as sort of a
“keep-alive” packet.&lt;/p&gt;

&lt;h3 id=&quot;request-packet-format&quot;&gt;Request Packet Format&lt;/h3&gt;

&lt;p&gt;These choices led me to the packet design for request packets shown in Fig. 7.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig 7. Host to FPGA Packets&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/host-to-fpga.svg&quot; alt=&quot;&quot; width=&quot;760&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;In general, the host only added four bytes to any payload.  The first two were
the packet ID.  This ID could be anything, with zero having the special meaning
discussed above, and the second requirement being that ID’s shouldn’t be
repeated in succession.&lt;/p&gt;

&lt;h3 id=&quot;reply-packet-format&quot;&gt;Reply Packet Format&lt;/h3&gt;

&lt;p&gt;The reverse link is very similar, if not almost identical.  There are only
a couple of differences.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 8. FPGA to Host Reply Packets&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/fpga-to-host.svg&quot; alt=&quot;&quot; width=&quot;760&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For example, all replies will include the host packet’s ID number so the host
can know which request is being replied to.  This will allow the host to
remove duplicate packets from the return stream.&lt;/p&gt;

&lt;p&gt;Further, all replies will include sixteen general purpose I/O bits.  Eight of
these, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;i_gpio&lt;/code&gt;, are input bits collected from somewhere in the system–such as
the &lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt&lt;/a&gt;
bit.  Indeed, we discussed four of these bits above, while the other four
remain uncommitted.  The other eight bits, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;o_gpio&lt;/code&gt;, are a simply a
reflection of the current settings as generated by the last packet sent by the
host controller.&lt;/p&gt;

&lt;p&gt;The next word, however, is generated within the FPGA logic.  The first
16-bit field of this word is the prior packet ID from the previous packet.  This
was chosen so that, in high speed situations, I might send two packets to the
FPGA and then have some assurance the FPGA had received both in case the
first response was dropped.  The next sixteen bits are simply a one-up packet
counter from the FPGA.  This counter would be increased on any sends or
re-sends, allowing the host to identify where, if at all, packets get lost
in this system.  Is it between the host and the FPGA, or on the return trip
from the FPGA to the host?&lt;/p&gt;

&lt;h3 id=&quot;building-the-clients-state-machine&quot;&gt;Building the Client’s State Machine&lt;/h3&gt;

&lt;p&gt;Before concluding, let’s take a quick look at what the host control
software would look like for this.  We’ll base this look upon a
&lt;a href=&quot;https://github.com/ZipCPU/zipversa/blob/6828a9e4ebe9032dbea6a51f1223b30a0fb980d7/sw/host/udpsocket.cpp#L130-L136&quot;&gt;UDPSOCKET&lt;/a&gt;
implementation that encapsulates any issues of issuing packets to or receiving
packets from the O/S.&lt;/p&gt;

&lt;p&gt;A couple of other fields will allow us to keep a copy of the last
received packet, or the packet we are getting ready to send.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt;	&lt;span class=&quot;nc&quot;&gt;NETBUS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RDBUFLN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TXBUFLEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;UDPSOCKET&lt;/span&gt;	&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The first step, therefore, in communicating with this new FPGA protocol is
to establish a connection.  This is done by sending a sync packet.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// Make up to MAXTRIES attempts to synchronize&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAXTRIES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Try sending a sync packet&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Clear the 4-byte header, then send a packet of 4bytes only&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Turn this into a UDP packet and send it&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;m_udp-&amp;gt;write&lt;/code&gt; will call the system to actually send this across a UDP
port we’ve connected ourselves to.&lt;/p&gt;

&lt;p&gt;The purpose of the for loop is so that, in the case that we don’t get any
response, we can try sending up to MAXTRIES of these packets.&lt;/p&gt;

&lt;p&gt;The next step is to look for the return packet.  We’ll wait &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PKT_TIMEOUT&lt;/code&gt;
milliseconds for this return–using the poll() system call to implement this
timeout.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;		&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RDBUFLN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PKT_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Now that we have a return packet, let’s look for and assemble the packet ID.
If this ID is not zero, then this isn’t a response to our sync request.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;		&lt;span class=&quot;n&quot;&gt;rxframe&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rdbuf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rxframe&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// This is a return from another request&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// Ignore it.&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If after &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MAXTRIES&lt;/code&gt; attempts we still don’t get a response, we’ll throw a
bus error so that the system can deal with this further up in the chain.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BUSERR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Otherwise, if we do have a good packet, we can look through the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;i_gpio&lt;/code&gt; values
and record or process them as necessary.  For example, this is where we’d
mark that we’d received an interrupt of some type.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nrd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Mark how long the packet is that's in our buffer&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;handle_gpio_returns&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Sending data to the device is very similar.  First, you’d generate a packet
header.  Here we choose to use a pseudorandom number algorithm, although you
can use roughly any algorithm you want–as long as it doesn’t generate a
zero packet ID.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;begin&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NETBUS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BUSW&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Last packet was a sync packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// Following a sync, the first ID == 1&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RANDOMIZER_COEFFICIENTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_frameid&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x0ff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Following the header, we’ll encode the address of the subsequent transaction.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;c1&quot;&gt;// Return a pointer to the packet following the&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// address&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode_address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;At this point, we can fill our packet with data to be written to the device.&lt;/p&gt;

&lt;p&gt;Once done, we’ll try writing this data to the device &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MAXTRIES&lt;/code&gt; times, or
until we get a response.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c--&quot; data-lang=&quot;c++&quot;&gt;	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAXTRIES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tries&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Send the request packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m_udp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pktlen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m_pkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Try reading a packet&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;readpkt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PKT_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// We were successful!&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// Otherwise we repeat&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m_rxlen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BUSERR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

	&lt;span class=&quot;c1&quot;&gt;// Search the returned packet for evidence of a bus error.  If we&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// get a bus error, we'll throw an exception as above.&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’ll then repeat this process until all of the data we need sent has been
sent.&lt;/p&gt;

&lt;p&gt;As you can see, the protocol is pretty simple from a software standpoint to
get working reliably.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;It works.&lt;/p&gt;

&lt;p&gt;That’s all that matters, right?&lt;/p&gt;

&lt;p&gt;Well, not quite.  In reality, this is just my first draft of a packet protocol
of this type.  For example, I haven’t implemented IP defragmentation.  (Nor
am I really planning on doing so in the FPGA hardware.)  Neither have I
implemented &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; support beyond version 4,
or impemented any header option support.  Similarly, I haven’t implemented any
support for zero length packets beyond the original sync packets.&lt;/p&gt;

&lt;p&gt;You can see a list of potential improvements I’ve been considering in Fig. 9.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig 9. Potential upgrades to this protocol&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/upgrades.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For perspective, I rewrote my original &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;serial port bus
protocol&lt;/a&gt; about
three times before finally I arrived at something I liked.  Each version was
then better than the previous one.  Indeed, even now I have a fourth version of
that &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;serial port protocol&lt;/a&gt;
that I’m slowly testing.  However, since this fourth version can only get
about a 10% speed improvement over the current version for the same baud
speed, it hasn’t gotten a lot of priority.  Put simply, the speed of the
&lt;a href=&quot;/formal/2019/02/21/txuart.html&quot;&gt;serial port&lt;/a&gt;
isn’t really slowing me down significantly.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig 10. Learning and rebuilding is to be expected&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/reproofs.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;That in itself is a lesson in any endeavor, and one I learned when working on
my Ph.D.  I like to sum it up with this advice to students, “Fail early. Fail
often. Plan for failure.”  Or, alternatively, “Success is measured by the
number of failures that it takes to achieve it.”  (These quotes are my own …)
Given that the best design is never the first one, you should plan on
rebuilding any design once or twice before it will become the best design
that you want to use and reuse over and over again.&lt;/p&gt;

&lt;p&gt;From a more business perspective, I might argue the advice would be to put
lots of energy into &lt;a href=&quot;/blog/2020/01/13/reuse.html&quot;&gt;anything you intend to use more than
once&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From all these perspectives, this is only a first design and draft of such
a protocol.  I expect it to get better over time.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Can two walk together, except they be agreed? Amos 3:3&lt;/em&gt;</description>
        <pubDate>Wed, 24 Aug 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/08/24/protocol-design.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/08/24/protocol-design.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>Quiz #21: Verifying all configurations of a design</title>
        <description>&lt;!-- answer: &quot;2022/07/16/fv-answer20.html&quot; --&gt;

&lt;p&gt;Many of my designs have multiple configurations.  For example:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU supports both pipelined and non-pipelined implementations.
How shall the CPU be verified?  Against a pipelined implementation or a
non-pipelined one?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU supports a compressed instruction set.  This costs area.
Although the area cost is minimal, what if I don’t want to support it?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The ZipCPU can be built either with or without a user mode.  Many micro
controller environments don’t need the user mode together with the headaches
associated with using it.  How shall I make sure this supervisor-only mode
remains supported, even if I don’t use it very often?&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This quiz gets to the answer to these questions.&lt;/p&gt;
</description>
        <pubDate>Sat, 16 Jul 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/quiz/2022/07/16/quiz21.html</link>
        <guid isPermaLink="true">https://zipcpu.com/quiz/2022/07/16/quiz21.html</guid>
        
        
        <category>quiz</category>
        
      </item>
    
      <item>
        <title>ZipCPU Lesson: If it's not tested, it doesn't work.</title>
        <description>&lt;p&gt;The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; &lt;del&gt;has&lt;/del&gt; &lt;em&gt;had&lt;/em&gt; a problem.
It’s kind of fundamental to digital design, so let’s chat about it.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 1, The &quot;No testy--no worky&quot; principle&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/no-testy-no-worky.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;It begins with the goal of the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.
The &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is designed to be low logic,
and that’s where the problem begins.  The problem is simply that low logic
means different things to different people.  Low logic means one thing on an
iCE40 with only 8k 4-LUTs.  Low logic means something else on a Spartan 6, and
something else entirely on a 20k 6-LUT Artix-7.  It means one thing when
driving a &lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone
bus&lt;/a&gt;, and another thing
when &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;driving an AXI
bus&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The natural consequence of trying to support multiple design requirements and
different targets is that the CPU is highly parameterized.  In general, this
is a good thing.&lt;/p&gt;

&lt;p&gt;We’ve discussed how to handle &lt;a href=&quot;/zipcpu/2018/12/20/sby-makefile.html&quot;&gt;formally verifying parameterized
designs&lt;/a&gt;.
That’s not all that hard to do, although &lt;a href=&quot;/zipcpu/2018/12/20/sby-makefile.html&quot;&gt;the
article&lt;/a&gt; needs a bit
of updating.  Specifically, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chparam&lt;/code&gt; in Yosys should only be used as an
argument to a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hierarchy&lt;/code&gt; command, but that aside handling multiple parameters
is still quite easy to accomplish formally.&lt;/p&gt;

&lt;p&gt;My problem is that my formal proofs don’t quite capture &lt;em&gt;everything&lt;/em&gt;.
Yes, those things they do capture they do so exhaustively, but I still keep
finding a bug every now and again at integration time when two things don’t
work together like they should.&lt;/p&gt;

&lt;p&gt;Frankly, I need a simulation solution that can test the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; in each and every one of its
many potential configurations.  That’s what I’d like to discuss today.&lt;/p&gt;

&lt;h2 id=&quot;first-approach-the-zbasic-system&quot;&gt;First approach: The ZBasic System&lt;/h2&gt;

&lt;p&gt;My previous approach at testing the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was the separate
&lt;a href=&quot;/zipcpu/2018/02/12/zbasic-intro.html&quot;&gt;ZBasic&lt;/a&gt; repository.
This is simply a demonstration system connecting the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; to a variety of other
components.  Most notable among these other components are the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/memdev.v&quot;&gt;block RAM
memory&lt;/a&gt;, the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/wbuart/wbuart.v&quot;&gt;serial
port&lt;/a&gt;, and the
&lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;debugging bus&lt;/a&gt;.
Other less notable components include the &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/sdspi/sdspi.v&quot;&gt;SPI based SD card protocol
controller&lt;/a&gt; and
the &lt;a href=&quot;/zipcpu/2019/02/09/cpu-blinky.html&quot;&gt;GPIO controller&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That makes the &lt;a href=&quot;/zipcpu/2018/02/12/zbasic-intro.html&quot;&gt;ZBasic&lt;/a&gt;
system into a pretty complete great demonstration system–for simulating a
single configuration.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;It offers as much &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/memdev.v&quot;&gt;block
RAM&lt;/a&gt;
as your simulation environment will allow&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/rtl/wbuart/wbuart.v&quot;&gt;serial
port&lt;/a&gt;
has both transmit and receive functionalities, so you can interact with
the CPU.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When using &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;,
the &lt;a href=&quot;/blog/2020/04/01/design-flow.html&quot;&gt;SD card can be treated as a full SD card of whatever
size is necessary&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is all great, but it’s hardly ideal for testing the &lt;em&gt;CPU&lt;/em&gt;–even though
that’s what I’ve used it for.&lt;/p&gt;

&lt;p&gt;To that end, I built several CPU tests that I have kept in the
&lt;a href=&quot;https://github.com/ZipCPU/zbasic&quot;&gt;ZBasic repository&lt;/a&gt; to help me know if the
CPU is working.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://github.com/ZipCPU/zbasic/blob/master/sw/board/cputest.c&quot;&gt;There’s the standard CPU
test&lt;/a&gt;, which
is designed to check the performance of (almost) every instruction in
isolation.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s a &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/hello.c&quot;&gt;Hello World
test&lt;/a&gt;, which
I’ve included in order to flesh out any obvious problems with the C-Library.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s another &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/hellostep.c&quot;&gt;Hello World
test&lt;/a&gt;
that works by stepping through the &lt;a href=&quot;https://en.wikipedia.org/wiki/%22Hello,_World!%22_program&quot;&gt;classic Hello World
program&lt;/a&gt; one
instruction at a time: a supervisor mode task sets up the program in user
mode, and then steps through it.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, there’s a &lt;a href=&quot;https://github.com/ZipCPU/zbasic/blob/master/sw/board/lockcheck.c&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction checking
program&lt;/a&gt;.
This one generates three (or four) concurrent tasks all attempting to get
access to the same MUTEX and then verify that they have said MUTEX.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These programs are what actually tests the CPU–which was the original purpose
of the &lt;a href=&quot;https://github.com/ZipCPU/zbasic&quot;&gt;ZBasic repository&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The most obvious problem I’ve alluded to so far is that this repository only
tests a single configuration.  That configuration tends to be a full pipeline,
cache enabled, Wishbone design.  The next big problem is that the test is
dependent on many other (non-CPU) components for success.&lt;/p&gt;

&lt;p&gt;The result of all of this is that I’ve often published changes to the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; repository that … broke one
part or another of the CPU and then never realized it.&lt;/p&gt;

&lt;p&gt;Frankly, I needed a better testing environment.&lt;/p&gt;

&lt;h2 id=&quot;envisioning-a-better-simulation-test&quot;&gt;Envisioning a better simulation test&lt;/h2&gt;

&lt;p&gt;When thinking over what I needed, I decided upon three goals for a new
simulation environment.  Obviously, it needed to test multiple configurations.
That was my first goal.  But that also lead to my second goal, which was that
I wanted my simulation environment to test both the
&lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone&lt;/a&gt;
and &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;AXI front ends&lt;/a&gt;.
Finally, I also wanted this new simulation environment to be all Verilog.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 2, Supported base ZipCPU configuration groups&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/zip-configs.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The first step was to identify a series of “supported” configurations.
I chose to define 22 such configurations, of which I’m (currently) only testing
the 14 I’ve ever used in practice.  The 22 configurations fall into six basic
groups:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;ASM&lt;/strong&gt;: The Assembly only configuration is the lowest logic configuration of
the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.  It doesn’t have full
instruction support, neither does it support user mode.  Missing instructions
include shifts by more than one bit, multiplies, and divides.  Worse,
without user mode, there’s no way to trap on one of these instructions being
illegal.  As a result, you can’t really use this configuration with GCC.
GCC will often attempt to implement one (or more) of these instructions, and
without the ability to trap on them there’s no real way to rescue a program
so generated for this configuration.&lt;/p&gt;

    &lt;p&gt;While this configuration is defined, there are no tests assigned to it.
Yet.  (Technically, that makes this configuration unusable.  Remember,
if it’s not tested then it doesn’t really work.)&lt;/p&gt;

    &lt;p&gt;What I really like about this configuration is that this represents the
lowest logic configuration of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;: requiring only 584 Xilinx
7-Series 6-LUTs.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;TRAP&lt;/strong&gt;: This configuration now supports shifts, user mode, and the lock
instruction.  Since it supports user mode, it also supports traps, and so
the CPU can now support the divide and multiply instructions from user
mode–assuming I ever build the trap software to handle such instructions
properly.&lt;/p&gt;

    &lt;p&gt;Without the software to support this TRAP configuration, or for that matter
without a GCC flag implemented to replace divide and multiply instructions
with soft equivalents, there are no tests of this configuration yet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;MIN&lt;/strong&gt;: This is the minimum CPU configuration supported by a generic ZipCPU
backend for GCC.  It includes support for multiplies, divides, shifts, lock
instructions, user mode, and the compressed instruction set.  This
configuration uses the most basic instruction fetch and memory controllers.
This also the only configuration where the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is not running its
full pipeline.  Finally, this configuration is the first of several that
allows the CPU to be externally configured: the CPU may be reset, halted, or
stepped externally and registers within the CPU may be now read and written
externally,&lt;/p&gt;

    &lt;p&gt;This is the minimum configuration that I can currently test automatically.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;PIPE&lt;/strong&gt;: This is the minimum pipelined configuration.  Yes, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is
pipelined by design, but that can require too much logic for some hardware
to handle.  Therefore, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
supports both pipelined and non-pipelined configurations.  This configuration
is the first of the pipelined configurations.  It also uses (naturally) the
piped fetch and memory controllers–allowing multiple bus requests to be
outstanding at any given time.  As an extra bonus with pipelining, this is
the first configuration supporting early branching.&lt;/p&gt;

    &lt;p&gt;In this case, early branching is defined by any branch recognized by the
instruction decoder, which can be forwarded to the instruction fetch
prior to the associated instruction making its way through the rest of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s pipeline.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;CACHE&lt;/strong&gt;: Here’s where we get to a more traditional CPU configuration.  In
this configuration, both instructions and data are kept in a (nominally 4kB)
cache.  Because this configuration is cached, this is also the first one that
has a chance of keeping the CPU’s pipeline fully loaded.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Low Power&lt;/strong&gt;: The final configuration has been optimized for low power.  This
configuration is the same as the CACHE configuration above, save for two
changes.  First, unused signals have been zero’d out to prevent any
unnecessary toggling.  Since this costs extra logic to do, it’s not the
primary or default configuration by any means.  Second, this configuration
enables the &lt;a href=&quot;/blog/2021/10/26/clkgate.html&quot;&gt;clock gating feature that we’ve discussed
before&lt;/a&gt;.  As a result,
whenever the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is sleeping
(i.e. waiting for an interrupt), the CPU’s clock will be turned off when
using this configuration.&lt;/p&gt;

    &lt;p&gt;No, it’s not likely I’ll be able to use this in any FPGA projects, but I
do use it from time to time on simulation projects and so it’s
nice to know it can be done.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That’s six basic configurations, of which I have tests defined for only
four at present.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 3, All 22 ZipCPU test configurations&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/all-configs.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Then, for each of these four configurations, I want to
test the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; in one of four
environments:
using a basic Wishbone wrapper I call the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;,
a second Wishbone wrapper with an attached peripheral set
(&lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timers&lt;/a&gt;,
&lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt controller&lt;/a&gt;s,
some performance counters, a
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/wbdmac.v&quot;&gt;DMA&lt;/a&gt;,
etc.)
called the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;,
an &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;AXI-Lite&lt;/a&gt;
wrapper called
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;ZipAXIL&lt;/a&gt;,
or finally a &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;Full AXI
wrapper&lt;/a&gt; I call
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt;.
You can see these configurations enumerated in Fig. 3.  It’s not quite 24 total
configurations, simply because it hasn’t (yet) made any sense to build an
AXI-Lite cache.  Therefore, the cache and low–power configurations only test
the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;&lt;em&gt;AXI&lt;/em&gt; wrapper to the
ZipCPU&lt;/a&gt;,
not the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;AXI-Lite
wrapper&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This sort of comes with a rather derived requirement: I’ll need a simulation
environment that can be uniform enough to support all (or most) of these
configurations.  This is just to minimize the amount of rework necessary
to go from a test of one configuration to another.  However, since the
AXI environment is so different from the Wishbone one, I eventually settled
on two top level simulation drivers: &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;one for
AXI&lt;/a&gt;,
and &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob//2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;one for
Wishbone&lt;/a&gt;.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 4, All Verilog test bench&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/all-verilog.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;My last requirement was that this simulation environment be all Verilog.
This is sort of a new requirement to me, since &lt;a href=&quot;/blog/2020/04/01/design-flow.html&quot;&gt;I normally use Verilator for
my simulations&lt;/a&gt;.
Five reasons drive this requirement:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Sometime back, &lt;a href=&quot;/zipcpu/2021/07/23/cpusim.html&quot;&gt;I needed to build a simulation with a CPU for a bus
driver&lt;/a&gt; and the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; fit that role nicely&lt;/p&gt;

    &lt;p&gt;Some of my recent &lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;
projects have required driving a bus from Verilog.
While an all Verilog model of an ARM might have worked here, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
fits this role nicely in its absence.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;X propagation.&lt;/p&gt;

    &lt;p&gt;I’ve now been burned, more than once, by a model that works just fine in
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
that then failed to work in a simulator that supports ‘X propagation.  This
has bit me in two ways:&lt;/p&gt;

    &lt;ol&gt;
      &lt;li&gt;
        &lt;p&gt;&lt;a href=&quot;/blog/2020/08/22/oddr.html&quot;&gt;My ODDR design&lt;/a&gt; failed
miserably here.  Where I struggled was with a design that just needed to
create a register that simply toggles within it.  That register didn’t
need to be reset, it just needed to toggle with every clock.  However, if
you include this design in an
&lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;
environment, where initial statements
aren’t allowed, then you either need to add a reset or the ‘X propagation
will kill you–even if the design would’ve worked.&lt;/p&gt;

        &lt;p&gt;My first “solution” to this problem was to replace things like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;==&lt;/code&gt; with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;===&lt;/code&gt; and so forth.  That worked great until the post place and route
simulation.  So … I bit the bullet and added a reset to that design.
(Who cares, right?  It’s an
&lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;!  Logic is
cheap in &lt;a href=&quot;/blog/2017/10/13/fpga-v-asic.html&quot;&gt;ASIC&lt;/a&gt;s.)&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;I’ve often found myself using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;always @(*)&lt;/code&gt; blocks to set something to a
constant.  This works great when using either
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
or synthesis tools, because you get the value you want.  Unfortunately,
this is not Verilog language compliant.  With a true Verilog compliant
simulator, any registers set within such a block will be set to ‘X
(undefined) since nothing ever triggers such an always block.&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ol&gt;

    &lt;p&gt;Frankly, if I want to deliver “working” IP to any customers, then that IP
really needs to work on their simulator as well.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;External device models require assignment delays, and often encrypted IP.&lt;/p&gt;

    &lt;p&gt;I’ve also recently needed to run simulations against external device models
that include assignment delays within them, and I’ve wanted to drive
these simulations with the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;Sometimes these models are of my own creation.  In this case, &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt;
has handled the problem quite nicely.  At other times, these simulations
are proprietary, encrypted, models provided by various device vendors.  This
necessitates being able to use proprietary simulation tools.&lt;/p&gt;

    &lt;p&gt;So far I’ve tried three proprietary tools:&lt;/p&gt;
    &lt;ol&gt;
      &lt;li&gt;NC Verilog (which doesn’t like my use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localparam&lt;/code&gt;s)&lt;/li&gt;
      &lt;li&gt;XCellium, which can currently (for me) handle all but Xilinx’s
proprietary IP.  (I must be missing something–Xilinx says it is
supported …)&lt;/li&gt;
      &lt;li&gt;Xilinx’s Vivado, which SegFaulted on the first project I tried it on.
Since then, I’ve now gotten it to the point where I can run batch
simulations on it–just like with XCellium–so both simulators are quite
usable for me.&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY, or Mutation Coverage with Yosys&lt;/a&gt;,
works nicely with an all Verilog simulation model to start from.&lt;/p&gt;

    &lt;p&gt;In case you are not familiar with &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;,
&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; is a means of testing the test
bench.  Want to know what bugs your test bench will catch?  Mutate the design
(i.e. break it), and see if the test bench can find the mutation.  A good
test bench should be able to find any mutation, or at least a high percentage
of them.&lt;/p&gt;

    &lt;p&gt;Sadly, although &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; can be used with
formal methods, it doesn’t integrate well with them.  (i.e., you need to be
careful that you don’t mutate any formal properties.)  This has really slowed
my adoption of &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Post place-and-route timing simulations&lt;/p&gt;

    &lt;p&gt;Simulating internal timing requires an all RTL model–ideally one that
achieves a high level of coverage.  So, any test script that passes an
&lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt; check should (ideally) be able to
exercise all of the paths within a design even after place and route.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, several of the customers I’ve worked with have asked for all
Verilog test benches.
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt; C++
models were simply unacceptable to them.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Bottom line is, if I want to work with others in the IP community, then I’ll
need a Verilog–only test bench.&lt;/p&gt;

&lt;h2 id=&quot;building-the-simulation-environment&quot;&gt;Building the simulation environment&lt;/h2&gt;

&lt;p&gt;The first step was to build a simulation environment that would meet these
needs.&lt;/p&gt;

&lt;p&gt;My first problem was the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s 
configuration.  Prior to defining a common configuration set, the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; was completely configured via
an &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v&quot;&gt;external Verilog “header” file that defined a set of macros used to
configure the CPU&lt;/a&gt;.
These macros controlled &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v#209&quot;&gt;whether or not the CPU was
pipelined&lt;/a&gt;,
which fetch or memory controller was used, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/43a0cdbbb549d360aa05b606305667d3c24bad7c/rtl/cpudefs.v#64-78&quot;&gt;which multiply
implementation&lt;/a&gt;
was used, which portions of the instruction set were implemented and more.&lt;/p&gt;

&lt;p&gt;My problem with this external configuration file was that it was hard to
automatically override the definitions within it.  The easy way to override
things is with parameters (Generics, when using VHDL).  So my first step was
to &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/tree/2ffbf68b450948dee56f36bbd113e80866a9362a&quot;&gt;rewrite the ZipCPU&lt;/a&gt;
to get rid of any and all “ifdef”s and to replace them with configuration
parameters.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 5, Minimum CPU Testbench Requirements&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/min-cpu.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I then needed a top level simulation environment.  A minimum CPU needs
memory and a console.  My &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;favorite CPU test
program&lt;/a&gt;
also requires a &lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timer&lt;/a&gt;,
and my &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;clock gating test software&lt;/a&gt;
requires interrupts from an automatically &lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;reloading
timer&lt;/a&gt;.  I also threw a
&lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;CPU logic analyzer in there for good
measure&lt;/a&gt; although I
don’t yet have a test that uses it.&lt;/p&gt;

&lt;p&gt;This leads to a test environment looking like Fig. 6.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 6, ZipCPU simulation test bench components&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/zip_tb.svg&quot; alt=&quot;&quot; width=&quot;560&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;It’s not just a single test environment either.  I built two near–identical
test environments: &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/commit/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;one for
AXI&lt;/a&gt;,
and &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/commit/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;another for Wishbone&lt;/a&gt;.
Further, since I wanted to test the same executable logic in each environment,
I made sure that the address space controlled by each test environment was the
same between both
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;AXI&lt;/a&gt; and
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;Wishbone&lt;/a&gt;
test benches.&lt;/p&gt;

&lt;p&gt;As a side note, I never would’ve considered a test setup this complex early on
in my own personal development.  A
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbar&lt;/a&gt; just to test a
CPU?  That’s a project in and of itself!  Or how about the bus resizing
elements, which are required to test the CPU on a non–32bit bus?  All of
these extra parts and pieces were never things that I had considered to be
necessary components of a &lt;em&gt;CPU&lt;/em&gt; repository, yet the C library won’t run without
the console, and so the testing the design necessitates having a
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbar&lt;/a&gt; on hand.
Similarly, either I need to build a bus width agile console port, or
alternatively I just need to suck up the reality of crossing bus widths.&lt;/p&gt;

&lt;p&gt;I then ran into a problem when trying to figure out how to support both the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
CPU wrapper, the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
wrapper, as well as the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt;
wrapper from a common addressing space.  For background, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/core/zipcore.v&quot;&gt;the
core&lt;/a&gt;
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; is just that: a CPU.  It doesn’t
come with many of the peripherals necessary for most CPU environments.  For
this reason, the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; initially
came with two wrappers.  (There are now four.)  You could either use the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
wrapper or the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;.
The difference between these two is that the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
contained a locally mapped set of peripherals:
&lt;a href=&quot;/zipcpu/2018/04/17/ziptimer.html&quot;&gt;timers&lt;/a&gt;, counters, one or
two &lt;a href=&quot;/zipcpu/2019/04/02/icontrol.html&quot;&gt;interrupt controller&lt;/a&gt;s,
and a &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/wbdmac.v&quot;&gt;DMA&lt;/a&gt;.  The
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
wrapper had none of these, so it might be lighter in logic area.  Then, when I
later built the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;AXI-Lite wrapper&lt;/a&gt;
and later the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;AXI (full) wrapper&lt;/a&gt;,
I left these near-peripherals out.&lt;/p&gt;

&lt;p&gt;How, then, should I guarantee that the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;’s software can interact
with these external peripherals regardless of the wrapper used?&lt;/p&gt;

&lt;p&gt;The obvious answer is to guarantee within the test bench that each of these
wrappers can see the same set of necessary peripherals–regardless of whether
or not they come pre–packaged within the CPU wrapper or not.  Hence, I included
an &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/peripherals/axilperiphs.v&quot;&gt;AXI-Lite CPU peripheral
set&lt;/a&gt;
into the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;AXI testbench
top&lt;/a&gt;, and several
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt;
peripherals directly into the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;Wishbone top&lt;/a&gt; for the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt; system to interact with.
All that remained was to make sure these peripherals all mapped to the same
addresses.&lt;/p&gt;

&lt;p&gt;This wasn’t (yet) enough.&lt;/p&gt;

&lt;p&gt;One of the recent drivers of this work has been my desire to operate the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
in environments with non–32bit wide buses.  One project I’m working on
requires a 64-bit bus.  A second project, based on &lt;a href=&quot;https://www.enclustra.com/en/products/fpga-modules/mercury-kx2/&quot;&gt;Enclustra’s Mercury+ KX7
board&lt;/a&gt;,
will require a 512-bit bus if I only want to be able to keep up with the
memory bandwidth that board is capable of.
This meant that my simulation test bench environments needed to be
bus–width agnostic as well.  This then turned into
a requirement that my test bench include a bus downsizer,
in addition to requiring one more parameter to define the simulation
environment.  Thankfully, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wbdown.v&quot;&gt;bus
downsizer&lt;/a&gt;
can be included even if the bus doesn’t need downsizing–in that case, it just
becomes a simple
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wbdown.v#L77-L99&quot;&gt;pass-through&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Then, after using these simulation environments for a while, I ended up
retrofitting each of them with a Verilog &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v#L962-L980&quot;&gt;watchdog
timer&lt;/a&gt;.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;localparam&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1_000_00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// 1ms&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;reg&lt;/span&gt;	&lt;span class=&quot;p&quot;&gt;[$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;clog2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// if (i_reset)&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	Resets aren't strictly necessary in&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	simulation only environments ...&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;//	watchdog_counter &amp;lt;= 0;&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// else&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cpu_stb&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cpu_stall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// Clear the watchdog if the CPU ever makes a&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// (successful) bus request&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;watchdog_counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ERROR: Watchdog timeout!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;finish&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This timer will count the number of clock cycles it’s been since the CPU has
attempted to access the bus.  It’s sort of a proxy for whether or not the
CPU has ever locked up.  (Hint: This means the CPU &lt;em&gt;was&lt;/em&gt; locking up.  In
this case, the lock-up was caused by the clock gating logic found in the
Wishbone drivers.)  The way it works is, if the CPU’s bus inputs ever become
idle for some parameterized number of clock cycles, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TB_WATCHDOG_TIMEOUT&lt;/code&gt;,
then the simulation halts with an ERROR.  This helped to keep failing
simulations from hanging the entire simulation setup.  (We’ll get to the
setup in the next section.)&lt;/p&gt;

&lt;p&gt;The final critical component of the simulation environment was the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; software executable itself.  By
parameterizing the simulation software load using the name of the
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; executable,
I now had complete control over what simulations would run and how.&lt;/p&gt;

&lt;h2 id=&quot;configuring-the-test-cases&quot;&gt;Configuring the test cases&lt;/h2&gt;

&lt;p&gt;The last critical piece in this setup, prior to the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation
script&lt;/a&gt;,
was the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definition
file&lt;/a&gt;.
The &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;Perl
script&lt;/a&gt;
reads the various test configurations from this &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definition
file&lt;/a&gt;,
and then commands a run of that test.  All output from the test then gets
logged to a file for later viewing.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 7, Defining a simulation&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/test-defn.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;To show how this is done, let’s back up a moment and start with the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;simulation configuration file&lt;/a&gt;.
I chose to define a given simulation run via five space delimited fields.
These are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The name of the test.  This also becomes the name of the executable &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt; builds, as well as being transformed
into the name of the output log file.  For these reasons, the test name needs
to be unique.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The CPU configuration.  Given that there were 15 separate parameters I
wanted to control via the configuration, it helped to have named
configuration rather than writing all of these parameters out on each
configuration line.  The &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation drive
script&lt;/a&gt;
could then easily look up a configuration by name, and set everything.
For example, here’s what the generic &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L64-L78&quot;&gt;pipeline
configuration&lt;/a&gt;
looks like from Perl:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;    &lt;span class=&quot;k&quot;&gt;my&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pipeconfig&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_PIPELINED=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LGDCACHE=2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LGICACHE=2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_MPY=6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DIV=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_SHIFTS=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LOCK=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_EARLY_BRANCHING=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_LOWPOWER=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DISTRIBUTED_REGS=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_USERMODE=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_CLKGATE=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_DBGPORT=1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_TRACE_PORT=0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -POPT_CIS=1 &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This is just the first step in the configuration, though.  This would then
need to be coupled with a top level entity, a simulation file set, and
one more parameter indicating which wrapper was being used: either one of the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipsystem.v&quot;&gt;ZipSystem&lt;/a&gt; wrappers (for
&lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone&lt;/a&gt;),
or the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxil.v&quot;&gt;ZipAXIL&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipaxi.v&quot;&gt;ZipAXI&lt;/a&gt; wrappers.
I’ll get to these details in the next section, though.&lt;/p&gt;

&lt;ol start=&quot;3&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Now that the design has a named configuration to use, the next step was to
select a test.  For this, the third element in each line was the name of a
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format&quot;&gt;ELF&lt;/a&gt;
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/verilator/mkhex.cpp&quot;&gt;executable turned hex file&lt;/a&gt;.
This file would then be included into the simulation via
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/memsim.v#L81&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$readmemh()&lt;/code&gt;&lt;/a&gt;
for the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; to execute.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;To know, later on, if the test passed successfully, I also kept track of
the output of the CPU’s console.  This is the fourth component of a test
configuration line: the name of a file to write this console output into.&lt;/p&gt;

    &lt;p&gt;The reason for this configuration parameter was to help guarantee that all
intermediate and output files had unique names.  This would allow me to run
the script multiple times, for different tests, on multiple different
processors concurrently.&lt;/p&gt;

    &lt;p&gt;In hindsight, I could’ve just created a file name from the name of the
test.  Perhaps I might’ve called it &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$tstname-out.txt&lt;/code&gt; or some such.
Still, this works, so I have no need to change it at present.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 8, Reconfigurability is a test requirement&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/reconfigurable.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol start=&quot;3&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;The final part of the command line was really key to the success of this
format as a whole.  The final piece is an (optional) white-space separated
list of parameter overrides.  Frankly, if I ever do this again, this will
be a guaranteed part of any future approach.&lt;/p&gt;

    &lt;p&gt;Why?  Because it keeps me from modifying the files under test just to test
a new configuration.&lt;/p&gt;

    &lt;p&gt;Why?  Because in one customer project, I created an &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus
Verilog&lt;/a&gt; script file for each test, and I then
kept needing to change one (or more) of those files to turn on (or off)
&lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt;
generation.  (Yes, &lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt;
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v#L945-L956&quot;&gt;generation in the Verilog test benches is completely
parameterized&lt;/a&gt;).
It then became a hassle to recognize whether or not the changes to the
file needed to be committed to the repository or not, since git only ever
flagged that the file was changed.  (It didn’t help that the change was
a single character on a very long &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;
command line.) This way, I can control the current test configuration
separate from the other files under version control, and I can also see
at a glance whether configuration changes were substantial or not.&lt;/p&gt;

    &lt;p&gt;How have I used this?  I’ve now used it for more than just turning on and off
&lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt; (or other trace file)
generation.  I’ve also used it to adjust the default bus width, or to turn on
&lt;a href=&quot;/blog/2021/10/26/clkgate.html&quot;&gt;clock gating&lt;/a&gt;
for configurations that don’t have it enabled by default.  Want to create
an ad-hoc test to check a 512bit bus?  Not a problem!  In another project,
one with fewer configuration parameters, I use this parameter list field to
set all of the key parameters (and macros!)–such as whether an analog PHY
is present, or whether or not Xilinx SERDES I/O elements should be used and
tested.&lt;/p&gt;

    &lt;p&gt;Even better, when required, I can use this optional field to implement
Verilog macros as well.  So there are a lot of opportunities here.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That’s the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;configuration file&lt;/a&gt;.
As you can see, it really captures all of the potential ways the simulation
can be reconfigured to support one test or another.&lt;/p&gt;

&lt;h2 id=&quot;the-simulation-driver&quot;&gt;The simulation driver&lt;/h2&gt;

&lt;p&gt;Now let’s turn our attention over to some of the key components of this
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L64-L78&quot;&gt;simulation perl script driver&lt;/a&gt;.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 9, Steps to a scripted simulation&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/script-ops.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The script starts off by &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9-L162&quot;&gt;defining a massive number of configuration default
values&lt;/a&gt;.
I’ll skip &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9-L162&quot;&gt;this section&lt;/a&gt;
for brevity, but you are more than welcome to look through it.  These define
both the basic &lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt; configurations,
such as we listed above, as well as &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L138-L162&quot;&gt;which wrapper is to be used for each
configuration&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From there, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L164-L178&quot;&gt;script starts looking over the command line
arguments&lt;/a&gt;.  In this
case, we insist on at least one argument &lt;em&gt;or die!&lt;/em&gt;.  Sorry, couldn’t help it.
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;or die&lt;/code&gt; is common Perlese for exiting the script with an error.  Otherwise,
if the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L170-L174&quot;&gt;first command line argument is the single word
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;all&lt;/code&gt;&lt;/a&gt;,
then we’ll ignore any other arguments and run every test case found in the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;configuration file&lt;/a&gt;.
Finally, if neither case applies, then &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L175-L176&quot;&gt;the argument list is interpreted as a
set of test names&lt;/a&gt;
that we’ll then &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L450-L471&quot;&gt;look
up&lt;/a&gt;
in our &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/sim_testcases.txt&quot;&gt;test definitions
file&lt;/a&gt;.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;No test cases given&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Running all tests:&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;--------------------&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;## Run any named tests found in the definitions file&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;@array&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;@ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’re going to want to place our results in a directory that isn’t under
version control.  Let’s call this directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;test/&lt;/code&gt;, and make sure it exists.
If not, we’ll create it next.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;test/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The next step is found at the bottom of the file.  Here we either look
up a test configuration by name, via the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gettest()&lt;/code&gt; function (&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L450-L471&quot;&gt;also
implemented within this perl script&lt;/a&gt;, or read
every line from the configuration file.  Every line is then passed to the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;simline()&lt;/code&gt; function for both parsing and to run the actual simulation.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$all_run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$simd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/sim_testcases.txt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^\s*#/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;# print &quot;TEST LINE: $line&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;simline&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;----&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Test run complete&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$akey&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;@array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gettest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$akey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/FAIL/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;# print &quot;TEST LINE: $line&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;simline&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Incidentally, it’s this &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;simline()&lt;/code&gt; function where all the work takes
place, so let’s break this function up into pieces and walk through it, since
this is the function that actually runs the simulator for a given test
configuration.&lt;/p&gt;

&lt;p&gt;The key to this function is Perl’s pattern matching ability.&lt;/p&gt;

&lt;p&gt;We’ll start by removing any end of line comments.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^(.*)#.*/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’ll then apply a pattern match to the line to separate out the various
components of the line.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/^\s*(\S+)\s*(\S+)\s*(\S+)\s*(\S+)\s(.*)\s*$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$memfil&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$confil&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$params&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The pattern above depends upon the existence of four (or more) white space
delineated fields, as we described them above, where the last field containing
the (optional) parameter list may be left blank.  If this pattern doesn’t
match, then … this isn’t a properly configured test line, and we’ll generate
an error and then skip it.&lt;/p&gt;

&lt;p&gt;For now, let’s assume the pattern matches and we’ll continue.&lt;/p&gt;

&lt;p&gt;It’s important for me to know &lt;em&gt;when&lt;/em&gt; things happen.  This helps me know
how long a test takes, as well as how deep into a test I am at any given
time.  When I’m not producing any console output, this is also the first
indication I have of any (potential) errors.  So, I’ll take this time to
grab a time stamp to describe the beginning of the simulation call.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
				&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Incidentally, if you look through this &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;simulation driver Perl
script&lt;/a&gt;, you’ll find
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L214-L279&quot;&gt;the script works for&lt;/a&gt;
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
as well as &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;–it’s just that
the &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
support &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl#L9&quot;&gt;isn’t (currently) configured either by
default&lt;/a&gt; or by the command line.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$verilator_flag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Configure for Verilator ...&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Configure for IVerilog ...&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Now that we have our configuration test parameters, the next step is to put
the &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iverilog&lt;/code&gt; command line&lt;/a&gt; together.&lt;/p&gt;

&lt;p&gt;We’ll start with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-g2012&lt;/code&gt;.  I personally use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-g2012&lt;/code&gt; option for all my
work.  I need it to support my liberal use of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localparam&lt;/code&gt;s, but I’m sure
there are other goodies that come with this as well.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;iverilog -g2012&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Let’s look up the parameters associated with our named configuration next.
To do this, however, we’ll need to know the top level module name, whether
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/wb_tb.v&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wb_tb&lt;/code&gt;&lt;/a&gt; or
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/rtl/axi_tb.v&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;axi_tb&lt;/code&gt;&lt;/a&gt;.
We’re going to need that, so let’s grab that off of the configuration file
string.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/-s\s+(\S+)\s/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/-s\s+(\S+)$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## This should probably be an error.&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$toplevel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;no_tb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We can now look up our configuration string.  This is the string with all of
our parameters defined in it.  In my case, I prefixed each parameter with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-P&lt;/code&gt;.  This, however, isn’t sufficient.  Parameters need to be prefixed with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-P&lt;/code&gt; &lt;em&gt;and&lt;/em&gt; the name of the top level–so we’ll do a simple substitution here to
get that right.  While we’re at it, we’ll add a shell escape for our quotation
marks–so the shell won’t play with them unduly.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfghash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;ne&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Must include sim file list and top level&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## as well as any parameters&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfghash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;s/-P/-P$toplevel./g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;s/\&quot;/\\\&quot;/g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfgstr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Two more parameters come from the test configuration line itself.
These are the name of the memory file, containing the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;ZipCPU test
program&lt;/a&gt;
memory image, and the name of the console file output.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.MEM_FILE=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;zipsw/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$memfil&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.CONSOLE_FILE=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$confil&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;With that, it’s now time to look at our parameter list.  This list comes in the
form of a set of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt; pairs, where the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A&lt;/code&gt; is the parameter name and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;B&lt;/code&gt;
is it’s value.&lt;/p&gt;

&lt;p&gt;The first step is to try to match the remaining portion of the line to
both an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt; pair and an everything else in the line.  I’ve chosen to
name this “everything else” as the &lt;a href=&quot;https://en.wikipedia.org/wiki/CAR_and_CDR&quot;&gt;CDR after the use of this term in
LISP&lt;/a&gt;.  Once the design
has been separated into these three pieces, I can then use the first
two, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;B&lt;/code&gt; of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A=B&lt;/code&gt;, to generate a command line parameter
setting.  Since this will follow all other parameter settings on the command
line, this one should override any previous parameters set by the same name.
Don’t forget to escape any string quotations!&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/\s*(\S+)=(\S+)(.*)$/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cdr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/\&quot;(.*)\&quot;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$str&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$p&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$str&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\\&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -P&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$toplevel&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$p&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Our last step will be to append the name of our file list to the command
line, and then specify that &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;
should produce an output file in our
test directory having the same name as our test’s configuration name.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;ne&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cfgfiles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -o &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This should be unique enough to work with.&lt;/p&gt;

&lt;p&gt;For those not familiar with &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus Verilog&lt;/a&gt;,
this is &lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt;’s way of doing business.
Simulation takes place in two parts.  The first part is to build a simulation
executable, and the second part is to build the simulation itself.&lt;br /&gt;
(Vivado isn’t all that different.)  Now that we have a command line built up
to build the executable, therefore, we go ahead and run
&lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt; to build our simulation executable.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;unlink&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; |&amp;amp; tee -a &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$cmd&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;bash -c &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$cmd&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$errB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If all goes well, we should now have a simulation executable–assuming
&lt;a href=&quot;http://iverilog.icarus.com&quot;&gt;Icarus&lt;/a&gt; didn’t find some error while building
our design.&lt;/p&gt;

&lt;p&gt;So … let’s run our simulation!&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errB&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## Grab a timestamp&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
				&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -- Starting simulation&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; | tee -a &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;## Then run the simulation&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$testd&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;## Finish the log with another timestamp&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isdst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1900&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%04d/%02d/%02d %02d:%02d:%02d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt;
					&lt;span class=&quot;nv&quot;&gt;$yr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$mn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;echo &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Once we get to this point, the simulation has now completed.  This may take
many hours, depending upon the configuration and the test.  For example,
running the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; check on the
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/rtl/zipbones.v&quot;&gt;ZipBones&lt;/a&gt;
MIN configuration takes about 12hrs on my computer.  On the other hand, when
using &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;,
&lt;em&gt;all&lt;/em&gt; of the tests for all of the configurations can complete in less than one
hour–but … that’s another story.  (It’s also one of the reasons why I love
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt; so
much!)&lt;/p&gt;

&lt;p&gt;Now that everything has completed, let’s go dig through the log file to
see if we’ve been successful.&lt;/p&gt;

&lt;p&gt;If we find &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ERROR&lt;/code&gt; in the log file, or any reference to an assertion failure,
then we have not been successful.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'ERROR&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; | sort -u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -q &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'ERROR&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -iq &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'assert.*fail&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;grep -iq &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;'fail&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;' &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$sim_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;nv&quot;&gt;$errF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vg&quot;&gt;$?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We can now take these results and write them into a report file, to track
all of our simulation results.  We’ll assume here that if we haven’t found
any errors, then the test has been successful.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-perl&quot; data-lang=&quot;perl&quot;&gt;	&lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;gt;&amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;);&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%s IVerilog  -- %s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tstamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$errA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$errF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;## ERRORs found&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ERRORS    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ERRORS    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;PASSED    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;PASSED    &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$msg&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&quot;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This isn’t really an ideal test, but it’s worked for me so far.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;ideal&lt;/em&gt; would be for the test to end with some form of SUCCESS message.
My test setup still needs some work, though, before I will have a dependable
SUCCESS message to work from.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Put together, &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/sim_run.pl&quot;&gt;this script&lt;/a&gt; allows me to test a rough 67 test
cases.  Why so many?  Simply because each test checks something different.
Sadly, I’ve learned from experience that it’s possible to have 66 test cases
pass and one fail.&lt;/p&gt;

&lt;p&gt;Ideally, the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;initial CPU test&lt;/a&gt;
should catch any and all bugs.  Sadly, it doesn’t.  Or rather, it hasn’t.  For
example, the original &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;CPU
test&lt;/a&gt;
never caught the bugs associated with stepping the CPU, one instruction at a
time.  Specifically, stepping through a divide instruction would void the
divide instruction, and leave you forever stepping through the same
instruction.  While I’ve now fixed the &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/cputest.c&quot;&gt;CPU test
program&lt;/a&gt;
so it checks for that bug, I’m reasonably confident that nothing other than my
&lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/2ffbf68b450948dee56f36bbd113e80866a9362a/sim/zipsw/lockcheck.c&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; checking program&lt;/a&gt;
will truly check for whether or not &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction works.  Further, the
bus width tests have found bugs the other tests haven’t as well.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 10, Does testing need to go multicore?&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/zipsim/multicore.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;While the test set is reasonably complete, I am also painfully aware of some
significant holes remaining in it–thanks to both
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;’s
coverage checking capability and &lt;a href=&quot;https://github.com/YosysHQ/mcy&quot;&gt;MCY&lt;/a&gt;.
For example, while I exercise the exclusive access capabilities of
both AXI and Wishbone buses, I only do so from a single CPU.  Worse, the
CPU will not allow a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOCK&lt;/code&gt; instruction sequence to be interrupted or stepped
through–it’s either all one instruction or none by design.  In many ways,
that’s a good thing … except that it means there will never be any true
&lt;em&gt;bus&lt;/em&gt; contention to test whether or not the memory modules handle locking
properly.  Another glaring fault in this test setup is that nothing is
(currently) testing the CPU’s debug port.  Hence, I may choose to fix both
of these by adding additional CPU’s to my simulation, in such a way that one
master CPU controls and starts all others.&lt;/p&gt;

&lt;p&gt;For now, let me note that I’ve enjoyed this approach so much that I’ve
started using something similar on my commercial projects, and I’ve even
ported a similar script to Vivado.&lt;/p&gt;

&lt;p&gt;Bottom line: the approach works nicely, and I’m likely to use it again.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Judge me, O LORD; for I have walked in mine integrity: I have trusted also in the LORD; therefore I shall not slide.  Examine me, O LORD, and prove me; try my reins and my heart. (Ps 26:1-2)&lt;/em&gt;</description>
        <pubDate>Mon, 04 Jul 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/zipcpu/2022/07/04/zipsim.html</link>
        <guid isPermaLink="true">https://zipcpu.com/zipcpu/2022/07/04/zipsim.html</guid>
        
        
        <category>zipcpu</category>
        
      </item>
    
      <item>
        <title>A Coming Economic Downturn?  or Worse?</title>
        <description>&lt;p&gt;I’ll try to keep this short.&lt;/p&gt;

&lt;p&gt;Some time ago, I came across this verse:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
stone, a tried stone, a precious corner stone, a sure foundation: he that
believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Isaiah 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;At the time, I was trying to understand the New Testament references to
cornerstones, and this was &lt;a href=&quot;https://www.blueletterbible.org/kjv/1pe/2/6&quot;&gt;one of those
references&lt;/a&gt;.  The other major
reference being to &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/118/22/&quot;&gt;Ps 118:22&lt;/a&gt;.
Unlike &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/118/22/&quot;&gt;Ps 118:22&lt;/a&gt;,
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;this Isaiah verse&lt;/a&gt;
had a context that quite captured my attention.  For example, if you back up
by just one verse, you read:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Because ye have said, We have made a covenant with death, and with hell
are we at agreement; when the overflowing scourge shall pass through, it
shall not come unto us: for we have made lies our refuge, and under
falsehood have we hid ourselves:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/15/&quot;&gt;Isaiah 28:15&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;That’s not just pretty poetic language, its powerful language and … it has
my attention.  Specifically, why does
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;verse 16&lt;/a&gt;
begin with the word “Therefore”?
The two verses seem to be completely unrelated.  Or at least, they seemed
unrelated to me until I understood how and why God had put them together.
Once you put them together, they then speak very loudly to today’s day and age.&lt;/p&gt;

&lt;p&gt;So, let’s back up further.  I’ll back up all the way to verse 9.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Whom shall he teach knowledge? and whom shall he make to understand
  doctrine? them that are weaned from the milk, and drawn from the breasts.
For precept must be upon precept, precept upon precept; line upon line,
  line upon line; here a little, and there a little:
For with stammering lips and another tongue will he speak to this people.
To whom he said, This is the rest wherewith ye may cause the weary to rest;
  and this is the refreshing: yet they would not hear.
But the word of the LORD was unto them precept upon precept, precept upon
  precept; line upon line, line upon line; here a little, and there a
  little; that they might go, and fall backward, and be broken, and snared,
  and taken.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/9-13/&quot;&gt;Is 28:9-13&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Let me pause for a moment and expand upon the language a little bit here.&lt;/p&gt;

&lt;p&gt;First, since studying Biblical Greek (yes, I know this is from Hebrew), I’ve
had a different definition and understanding of the word “doctrine”.  I would
define this word as “the substance of what is taught.”  This isn’t all that
different from today’s &lt;a href=&quot;https://en.wikipedia.org/wiki/Doctrine&quot;&gt;Wikipedia
definition&lt;/a&gt;, “a codification of
beliefs or a body of teachings or instructions, taught principles or
positions, as the essence of teachings in a given branch of knowledge or in a
belief system,” save that I don’t connect doctrine with a “belief system” by
nature.  The word is more neutral than that.  It’s simple the substance of
what is taught.  It’s the text book if you will, the “codification” of a
“body of teachings or instructions.”  There is a doctrine of mathematics, for
example–it’s not about beliefs, it’s just the codification of the lesson
material.&lt;/p&gt;

&lt;p&gt;God wants to teach us “knowledge” and “doctrine”.  This sounds like a good
thing.  I’m interested.  I’d sign up for that class.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;For precept must be upon precept, precept upon precept; line upon line,
  line upon line; here a little, and there a little:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/10/&quot;&gt;Is 28:10&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This we all know and agree upon.  You can’t teach a child how to multiply
unless they first know how to add.  You can’t teach reading unless you first
teach letters.  Teaching is built upon a foundation, and that foundation
needs to be laid a little bit at a time.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;To whom he said, This is the rest wherewith ye may cause the weary to rest;
  and this is the refreshing: yet they would not hear.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/12/&quot;&gt;Is 28:12&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This part starts with a promise, and one I like–&lt;a href=&quot;https://www.blueletterbible.org/kjv/heb/4/9&quot;&gt;a promise of
rest&lt;/a&gt; and refreshing.  I like
promises, especially promises of good from those who are able to keep them.&lt;/p&gt;

&lt;p&gt;But it continues with, “yet they would not hear.”&lt;/p&gt;

&lt;p&gt;God, therefore, is offering to man a wonderful promise and getting rebellion
in response.  This forms the backdrop of what takes place next.&lt;/p&gt;

&lt;p&gt;Indeed, the next part is where it starts to get interesting.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;But the word of the LORD was unto them precept upon precept, precept upon
  precept; line upon line, line upon line; here a little, and there a
  little; that they might go, and fall backward, and be broken, and snared,&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/13/&quot;&gt;Is 28:13&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Here’s God’s point: if you don’t learn the lessons of truth, about how the
reality of the world works, the truth doesn’t change.  Instead, the realities
of life will break you.  As one preacher once said, men don’t break God’s laws,
God’s laws break them.  Sure, you can jump off a building an defy gravity
for a fleeting moment, but you can’t avoid the sudden stop at the bottom.&lt;/p&gt;

&lt;p&gt;It’s not just that two plus two equals four and not five independent of the
family you were born into, but it’s also the simple basics of life: only hens
lay eggs, only cows provide milk, and only women can give birth.  You aren’t
going to get eggs from a cock (a farmer’s term for a male chicken, since
technically all chickens roost and are therefore roosters), and I’m going to
laugh at the individual who tries to milk the bull.  Frankly, there are some
parts of this world that man cannot change, and those who try will “fall
backward, and be broken, and snared.”  Put simply, it’s not going to end well.&lt;/p&gt;

&lt;p&gt;But this is only the part of where God describes what is currently taking
place.  It’s in the next verse where He begins His pronouncement of judgment.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Wherefore hear the word of the LORD, ye scornful men, that rule this people
  which is in Jerusalem.
Because ye have said, We have made a covenant with death, and with hell
  are we at agreement; when the overflowing scourge shall pass through, it
  shall not come unto us: for we have made lies our refuge, and under
  falsehood have we hid ourselves:&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/14-15/&quot;&gt;Is 28:14-15&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Yes, I know that this particular judgment has long since passed.  The
individuals who ruled “this people which is in Jerusalem” did so over
a thousand years ago.  I’m just not willing to dismiss this passage that
quickly, especially since the nature of God which caused Him to send this
judgment hasn’t changed, neither have the simple truths of life which still
need to be taught today.&lt;/p&gt;

&lt;p&gt;Indeed, “We have made lies our refuge, and under falsehood have we hid
ourselves” describes the day we live in.  Yes, the government can get itself
out of the problem it has created by spending more than it has by printing
more money!  Yes, we can escape all responsibility by blaming our predecessor!
Yes, we can blame foreigners and aliens for the problems we’ve created in our
own back yards!  Yes, a man can win in women’s sports by declaring himself to
be a woman!  Yes, I can declare my engineering products as “working” even
before they are tested!  Reality doesn’t affect me!&lt;/p&gt;

&lt;p&gt;But what of the peace treaty with death?  God gets to that two verses down.
For now, in the midst of this pronouncement of judgment, the prophet
adds this verse about the cornerstone.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
  stone, a tried stone, a precious corner stone, a sure foundation: he that
  believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Is 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Again, like I said at the beginning, at the first read this feels out of place.
The verse following seems to skip it.  It’s almost as if, if you only removed
&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;verse 16&lt;/a&gt;,
the passage would make more sense.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Judgment also will I lay to the line, and righteousness to the plummet: and
  the hail shall sweep away the refuge of lies, and the waters shall overflow
  the hiding place.
And your covenant with death shall be disannulled, and your agreement with
  hell shall not stand; when the overflowing scourge shall pass through,
  then ye shall be trodden down by it.
From the time that it goeth forth it shall take you: for morning by morning
  shall it pass over, by day and by night: and it shall be a vexation only
  to understand the report.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/17-19/&quot;&gt;Is 28:17-19&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/17/&quot;&gt;Verse 17&lt;/a&gt;,
referencing a line and a plummet, is a clear reference to the
restoration of truth in a society.  We build using lines.  A taught cord
can be used as a straight line when setting a wall.  Indeed, masons use such
cords often and for that specific purpose.  Straight lines are important.  So
is the &lt;a href=&quot;https://www.lowes.com/pd/Swanson-Tool-Company-16-oz-Solid-Brass-Plumb-Bob/1006465&quot;&gt;plummet–a basic weight on a cord&lt;/a&gt;.  The plummet is used to
determine which way is down and, as a consequence, which is up.  Both are
references to basic truths which cannot be ignored or broken.  This,
therefore, is a reference to God bringing His creation back to reality.
This judgment will be a true “Come to Jesus” moment, if ever there was one.&lt;/p&gt;

&lt;p&gt;What of the peace treaty with death?  It will be disannulled.  There was no
basis for it.  The judge will neither recognize it, nor honour it, nor compel
its enforcement.  The agreement with hell?  Same thing.  It will not stand.
The overflowing scourge?&lt;/p&gt;

&lt;p&gt;Ahh, now that’s where we meet what’s coming next.&lt;/p&gt;

&lt;p&gt;What form will this overflowing scourge take?&lt;/p&gt;

&lt;p&gt;Will it be an economic recession?  Perhaps.  A depression?  Could be.  An
interruption in the food supply?  We’ve already seen some of that.  An
interruption in power?  That’s already in the forecast.  War?  Another world
war even?  We know from prophecy that another one is coming if not two.  The
destruction of the current world order?  &lt;a href=&quot;https://www.blueletterbible.org/kjv/dan/2/42-45&quot;&gt;That’s also been
prophesied&lt;/a&gt;.
It’s just a matter of when.&lt;/p&gt;

&lt;p&gt;Frankly, I don’t know what’s coming next.  Sure, &lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/119/105&quot;&gt;God’s word is a lamp unto
my feet&lt;/a&gt;–just not my
horizon.  What I do know is this, &lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/24/32&quot;&gt;the signs are all around
us&lt;/a&gt;,
and “It shall be a vexation only to understand the report.”&lt;/p&gt;

&lt;p&gt;When God steps in, there will be shock and awe.&lt;/p&gt;

&lt;p&gt;Okay, so let’s now go back to that corner stone verse.  How does that apply
here?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a
stone, a tried stone, a precious corner stone, a sure foundation: he that
believeth shall not make haste.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/isa/28/16/&quot;&gt;Is 28:16&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The application is now straight-forward.  The storm is coming.  Many shall be
destroyed by it.  God has declared it, and there’s nothing that can be done
to stop it.  All we can hope to do is to ride through it.  For this reason,
God provides a “sure foundation”, so that those standing upon it will not get
swept away with the judgment of the unbelievers.&lt;/p&gt;

&lt;p&gt;It’s against this backdrop that Jesus teaches,&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Therefore whosoever heareth these sayings of mine, and doeth them, I will
  liken him unto a wise man, which built his house upon a rock:
And the rain descended, and the floods came, and the winds blew, and beat
  upon that house; and it fell not: for it was founded upon a rock.
And every one that heareth these sayings of mine, and doeth them not, shall
  be likened unto a foolish man, which built his house upon the sand:
And the rain descended, and the floods came, and the winds blew, and beat
  upon that house; and it fell: and great was the fall of it.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/7/24-27&quot;&gt;Matt 7:24-27&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You will hear many individuals telling you how to prepare for whatever they
believe the coming catastrophe will be.  I’ve heard some telling me to buy
&lt;a href=&quot;https://www.birchgold.com&quot;&gt;gold&lt;/a&gt; or silver.  Some say that I should purchase
&lt;a href=&quot;https://mypatriotsupply.com&quot;&gt;packaged food&lt;/a&gt; for long term storage.  Others
have said to buy bonds.  Still others say that inflationary times are the
best times to borrow money.&lt;/p&gt;

&lt;p&gt;While these individuals may be well intentioned, the only advice that will
help you avoid God’s judgment of sinful men is the advice God offers.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/mat/7/24&quot;&gt;Therefore whosoever heareth these sayings of mine, and doeth
them&lt;/a&gt;, …&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;&lt;p&gt;&lt;em&gt;Therefore thus saith the Lord GOD, Behold, I lay in Zion for a foundation a stone, a tried stone, a precious corner stone, a sure foundation: he that believeth shall not make haste.  (Is 28:16)&lt;/em&gt;</description>
        <pubDate>Tue, 21 Jun 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/06/21/cornerstone.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/06/21/cornerstone.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>Quiz #20: Using $stable in a multiclock environment</title>
        <description>&lt;p&gt;This is a really good question for understanding how &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$stable()&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$past()&lt;/code&gt;
work in a multiclock environment.&lt;/p&gt;

&lt;p&gt;Remember, though: I like to play trick questions.  Beware of the easy and
(possibly) obvious answer.&lt;/p&gt;
</description>
        <pubDate>Mon, 16 May 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/quiz/2022/05/16/quiz20.html</link>
        <guid isPermaLink="true">https://zipcpu.com/quiz/2022/05/16/quiz20.html</guid>
        
        
        <category>quiz</category>
        
      </item>
    
      <item>
        <title>Learning AXI: Where to start?</title>
        <description>&lt;p&gt;Someone &lt;a href=&quot;https://www.reddit.com/r/FPGA/comments/shw219/advice_for_studying_the_axi_specification/&quot;&gt;once asked on Reddit, how should one go about learning the AXI
protocol&lt;/a&gt;?
The following summarizes my basic answer.&lt;/p&gt;

&lt;p&gt;First off, don’t start with Xilinx’s example designs.  Sorry, but their
examples are horribly broken.  Even their demo &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI Stream master is
broken&lt;/a&gt;.  It’s a shame
that they’ve neither fixed these designs, nor updated their training materials
to acknowledge that their basic designs are broken.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 1, Basic Roadmap for Learning AXI&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/roadmap.svg&quot; alt=&quot;&quot; width=&quot;280&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Others have suggested that the best place to start is by learning handshaking,
and most of the AXI stream protocol is just that: handshaking.  I would agree.
Therefore, I would recommend that anyone starting out begin by learning
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI’s handshaking rules&lt;/a&gt;.
As &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;that article&lt;/a&gt; will
explain, the AXI stream protocol is little more than simple handshaking, and
you can (mostly) ignore the TID, TSTRB, TKEEP, and TDEST signals.  This
is also where you’ll discover how Xilinx got their example AXI stream master
messed up, and where you’ll learn how easy it would be to fix it.&lt;/p&gt;

&lt;p&gt;Once you understand &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI
handshaking&lt;/a&gt;, I’d then
recommend learning about
&lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;. Without
them, you’ll never get better than 50% throughput without violating the
AXI specification.&lt;/p&gt;

&lt;p&gt;The next place I’d go would be to  &lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;look into
AXI-lite&lt;/a&gt;. Beware of
backpressure! It has caused Xilinx (and others unnamed) no end of headaches,
and forms the backdrop for many of the bugs in their example designs. If you
want a working example design to start from, check out &lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;this example
design&lt;/a&gt; that I
often use myself when working with AXI-lite.  You might also wish to look over
&lt;a href=&quot;/blog/2021/05/22/vhdlaxil.html&quot;&gt;this post, describing how to fix Xilinx’s (broken) AXI-lite VHDL
example&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;For most use cases, you can stop there.  AXI-lite will get you just about
everywhere you need to go.  For most of the things you might need the
full AXI specification for, you can already find example open source or vendor
designs that’ll work.
(&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;s,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;MM2S&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;S2MM&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;virtual FIFO&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;video frame buffer reading&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;video frame buffer writing&lt;/a&gt;, etc.)&lt;/p&gt;

&lt;p&gt;If you are interested in moving past AXI-lite, then it’s time to understand &lt;a href=&quot;/blog/2019/04/27/axi-addr.html&quot;&gt;AXI
addressing&lt;/a&gt;,
and the various FIX, WRAP, and INCR addressing modes and how the AxSIZE field
impacts them.  This is important.  Xilinx &lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;didn’t even try to get this right
in their example&lt;/a&gt;, and I’ve
seen plenty of ASIC designs that even get this addressing messed up.  You will
need to understand this before diving into building your first full AXI slave.
Indeed, I’ve used the &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi_addr.v&quot;&gt;next AXI address
module&lt;/a&gt; built
and presented in that article in many of my own designs.&lt;/p&gt;

&lt;p&gt;Once you understand addressing, or at least once you’ve simplified it enough
that you can work with it, then the next step would be to build a &lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;fully
capable AXI slave&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What will you gain by writing an AXI slave over an AXI-Lite slave?  Not much.
Seriously.  There’s not a lot of performance gain to be had by building an
AXI (full) slave over that already gained by building an AXI-Lite slave–at
least, not much gain to be had for most uses.  What performance difference might
you see?  Well, following &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi2axilite.v&quot;&gt;a good AXI to AXI-lite
bridge&lt;/a&gt;, you
might find yourself
loosing about 2 clocks of &lt;em&gt;latency&lt;/em&gt; per transaction.  That’s it.  Following a
poor AXI to AXI-lite bridge?  In that case, you might lose 4-8 clocks of
&lt;em&gt;throughput&lt;/em&gt; per transaction.  Of course, you could always switch back to a
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axi2axilite.v&quot;&gt;better bridge&lt;/a&gt;
to recover this lost throughput–so there’s really not a lot to
be gained by switching from an AXI-lite slave to an AXI (full) one.&lt;/p&gt;

&lt;p&gt;When it comes to AXI masters, however, that’s a different story.  Still, I
would similarly recommend you start with an &lt;a href=&quot;/blog/2020/03/23/wbm2axisp.html&quot;&gt;AXI-Lite
master&lt;/a&gt;. Technically, such
a master should be able to be just as fast as an AXI full master.  Practically
and sadly, many designs cripple their AXI-lite implementations. (Hello, Xilinx?)&lt;/p&gt;

&lt;p&gt;A full discussion of &lt;a href=&quot;/blog/2020/06/16/axiaddr-limits.html&quot;&gt;AXI masters gets
difficult&lt;/a&gt;.
It’s hard enough that I haven’t (yet) figured out how to simplify the material
enough to write a post on how to build a general purpose AXI master–the
addressing is just that hard to get right in general. (It usually takes me
a couple of days to get right–even when building my own.) However, you are
welcome to examine &lt;a href=&quot;/blog/2021/06/28/master-examples.html&quot;&gt;some of the AXI masters I’ve written and
posted&lt;/a&gt; if you’d like.&lt;/p&gt;

&lt;p&gt;Among those &lt;a href=&quot;/blog/2021/06/28/master-examples.html&quot;&gt;AXI master
examples&lt;/a&gt; are
two worth mentioning here since I’ve written articles about them.  The first
discusses how to build a &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;memory controller for the ZipCPU using the AXI-Lite
protocol&lt;/a&gt;, whereas the
second discusses the &lt;a href=&quot;/zipcpu/2021/09/30/axiops.html&quot;&gt;modifications necessary to upgrade that memory controller
to AXI (full)&lt;/a&gt;.  This &lt;a href=&quot;/zipcpu/2021/09/30/axiops.html&quot;&gt;second
article&lt;/a&gt; goes over the
AXI Exclusive Access protocol (AxLOCK, and EXOKAY), and then how to go about
building a master that uses it–although I only really know of CPU use cases
for such a protocol.  It also discusses some of the challenging interactions
between AxADDR and AxSIZE.&lt;/p&gt;

&lt;p&gt;If you are really going to dive deeply into the AXI protocol, then it will
quickly become important to know &lt;a href=&quot;/blog/2021/08/14/axiperf.html&quot;&gt;how to measure AXI
performance&lt;/a&gt;.
Just what kind of performance are you achieving, what is possible, and what
can you expect are all good questions you’ll want to know how to answer.&lt;/p&gt;

&lt;p&gt;The above will get you most of the way. However, it will also leave you with
questions about what AxCACHE, AxPROT, and AxQOS are for, or when you should
use the AxID field.  Indeed, you may leave wondering about AxSIZE as well, and
why it’s an important part of the protocol.  For a discussion of these, let me
point you to a reddit question of my own from some time ago: &lt;a href=&quot;https://www.reddit.com/r/FPGA/comments/egkrce/is_axi_too_complicated/&quot;&gt;is AXI too
complicated&lt;/a&gt;?&lt;/p&gt;

&lt;h2 id=&quot;formally-verifying-axi&quot;&gt;Formally Verifying AXI&lt;/h2&gt;

&lt;p&gt;Not that long ago, I was asked about the possibility of writing a course on how
to formally verify AXI components.  At the time, I sketched out the following
outline for such a course–an outline that primarily matches most of the
progression above.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The course would start with a &lt;a href=&quot;/blog/2017/10/19/formal-intro.html&quot;&gt;quick review of formal
methods&lt;/a&gt;: what
are assertions and assumptions, and what are some of the &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;unique challenges
associated with
induction&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 2, Lessons that might compose a course in formally verifying AXI components&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/courseware.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Indeed, when you get to AXI full,
   &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;
   becomes a necessity.  AXI is sufficiently complicated to limit a bounded
   model check to somewhere between 20-40 cycles.  As a result, no bounded model
   check will be sufficient to verify one or more 256-beat bursts.  A complete
   proof, therefore, &lt;em&gt;requires&lt;/em&gt;
   &lt;a href=&quot;/blog/2018/03/10/induction-exercise.html&quot;&gt;induction&lt;/a&gt;.
   It’s important here to understand how it works, and what challenges you
   might expect when working with it.&lt;/p&gt;

&lt;ol start=&quot;2&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;As above, the next step would be to look into AXI Stream, and in
particular how to handle
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;Handshaking&lt;/a&gt;
and &lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;.
Specifically, I’d go over the assertions necessary to describe an
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI handshake&lt;/a&gt;, and the
need for &lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffers&lt;/a&gt;.
The lesson would end with a
&lt;a href=&quot;/blog/2019/05/22/skidbuffer.html&quot;&gt;skidbuffer&lt;/a&gt;
exercise of some type–perhaps simply requiring a student to build their own.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The next step would be
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt;.  The big
difference between
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt; and the
bare &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;handshaking&lt;/a&gt;
discussion is that you need to count outstanding read and write requests when
using &lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt;.  Every
read request requires one (and only one) response.  Write requests
are similar and also require a single response, however a write request is
not complete until there’s been a request on both write address and write
data channels.  In general, though, the only thing we’re adding above and
beyond the basic
&lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;handshaking&lt;/a&gt;
are some simple counters as well as some assertions tied to those counters.&lt;/p&gt;

    &lt;p&gt;An exercise for this portion of the course might involve verifying a given
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-Lite&lt;/a&gt; module.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;While AXI-lite is a great protocol for register handling, it’s also
important to know your design handles registers properly.  Therefore, I’d
dedicate a lesson to discussing &lt;a href=&quot;/blog/2020/12/19/axil-register-checking.html&quot;&gt;how to verify that registers are read or
written correctly&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;A good exercise here would be to modify the exercise from the AXI-lite
lesson, so that it verifies the register within.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We can now discuss &lt;a href=&quot;/blog/2019/04/27/axi-addr.html&quot;&gt;AXI
  addressing&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It would then be time to dive into AXI full.  This topic is so large,
however, that it really needs to be broken up.  Therefore, I’d start with
how to verify handling a single read burst.  The basics of single read
burst counting are pretty simple: you need to count the number of bursts
that are outstanding, and the number of remaining outstanding items in
each burst.&lt;/p&gt;

    &lt;p&gt;This might be where I’d introduce the exercise of verifying an &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/demofull.v&quot;&gt;AXI full
slave&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;This is also where the easy part ends.  How, for example, shall you verify
that the number of beats returned for a given burst read request is correct?
That’s a touch harder–especially when you need to start tracking multiple
outstanding bursts.&lt;/p&gt;

    &lt;p&gt;From there, I’d move on to discuss how to verify out-of-order returns, and
how to handle verifying packet ID’s.&lt;/p&gt;

    &lt;p&gt;This leads to the task of verifying an AXI full slave that requires multiple
beats to process requests given to it.  A simple example might be an AXI
SRAM controller, where the SRAM requires one (or more) clocks from
request to response and where the read command can only be issued once.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Write handling is more challenging than read handling.  Specifically, AXI
write requests split the write address and data into two channels, and
formally verifying both channels can require a bit of synchronization within
the formal properties.  Once the channels are synchronized, however,
verification returns to being as easy as counting bursts and beats again.&lt;/p&gt;

    &lt;p&gt;Yes, there are a couple new requirements, although once the channels are
synchronized these are minimal.  Primarily, the extra requirements deal
with those packets for which AWSIZE is less than a full word, or for which
the initial AWADDR isn’t word aligned.  In these cases, there’s the
additional requirement that write beats only contain strobes for the
correct bytes.  For example, if AWADDR is odd, then the WSTRB[0] of the
first beat must be zero.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Exclusive Access.  Exclusive access is AXI’s method of handling atomic
requests.  These really aren’t all that hard to understand or model.
Indeed, they are easier to deal with than read or write bursts.  Still,
I would place exclusive access handling late in the course, not because
of how easy or difficult it is, but more because of how few things actually
need it.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 3, It can be a real challenge to verify a design containing a FIFO&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/fifo-challenge.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol start=&quot;10&quot;&gt;
  &lt;li&gt;That brings us to the FIFO Challenge.  FIFOs are fairly easy to verify on
   their own.  Sadly, they become much harder to verify when they are used
   within something.  AXI, however, is very much built around the concept
   of FIFOs.  How to verify something that has a FIFO within it is something
   we’d need to discuss here.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once you get past the FIFO challenge, it then becomes possible to build AXI
   components that can handle any number of multiple bursts at a time.  When
   would you need something like this?  When building an AXI
   &lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt; or
   a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;
   of some type.  Both would make good examples of components that might
   need this technology.&lt;/p&gt;

&lt;p&gt;At least, these are my current thoughts on what lessons I might teach were I
to create a course in formally verifying AXI components.  Given that every
piece of commercial IP I’ve ever built has required some form of AXI interface,
I wouldn’t be surprised to find such a course to be an in-demand topic.
I would just need to find a way to clear enough time out of my schedule to
create it.&lt;/p&gt;

&lt;h2 id=&quot;axi-design-exercises&quot;&gt;AXI Design Exercises&lt;/h2&gt;

&lt;p&gt;When learning any new topic, its important to exercise your new knowledge
as you learn it.  Here’s a list, therefore, containing a progression of
exercises with increasing difficulty that you might find valuable when
learning AXI.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 4, Practice exercises, for use in learning AXI&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/learning-axi/exercises.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Build and verify an AXI Stream component.  A good example of this might
be either a DSP component or perhaps a FIFO of some type.  Perhaps the
simplest example I might come up with would be a frequency shifter based
upon an internal &lt;a href=&quot;/dsp/2017/08/30/cordic.html&quot;&gt;CORDIC&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;Other examples include stream processing network packets–such as a
stream component that might recognize, encrypt or decrypt a UDP packet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Build and verify an AXI-lite bus slave&lt;/p&gt;

    &lt;p&gt;This project is actually pretty easy.  I’d have you start with the
&lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;EasyAXIL design&lt;/a&gt;, and
then modify it for some purpose.  Perhaps that might be to create a
GPIO or UART controller from it, or to turn it into a basic timer
peripheral of some type.  Any of these exercises would be fairly simple,
since the &lt;a href=&quot;/blog/2020/03/08/easyaxil.html&quot;&gt;EasyAXIL
design&lt;/a&gt; is just
that easy to work with and from.  Even better, it comes with all the details
you need to formally verify how well it handles bus transactions.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The simplest bus master to build is a basic, scripted, one request at a time
bus master using AXI-lite.  &lt;a href=&quot;/blog/2021/12/30/dbgaxil.html&quot;&gt;This
article&lt;/a&gt; presents both
such a bus master, and a usage description of why you might wish to build
one.  The master is easy enough to verify, and so might make a good practice
start at building your first AXI-lite bus master.&lt;/p&gt;

    &lt;p&gt;Indeed, a scripted AXI-lite bus master is not really all that much more
complex than a basic &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;AXI-Lite CPU memory
unit&lt;/a&gt;, so
building such a memory unit might also fit nicely here.  From an exercise
standpoint, however, the &lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;CPU memory
unit&lt;/a&gt; has to deal with
two protocols, both that of the CPU and that of AXI-lite, meaning that the
&lt;a href=&quot;/zipcpu/2021/04/17/axilops.html&quot;&gt;CPU memory unit&lt;/a&gt; might be
more complex than this exercise would require.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A more complicated AXI-lite bus master, and certainly one with more interest,
might be to &lt;a href=&quot;https://github.com/ZipCPU/zipcpu/blob/zipcore/rtl/core/axilfetch.html&quot;&gt;add a small FIFO to a CPU instruction fetch
unit&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;This exercise is only slightly more complex than the scripted memory
controller of the last exercise.  Specifically, what should the fetch unit
do when, mid fetch, the CPU tells it that it no longer wants the values
currently being fetched but instead wants to start over from a new address?&lt;/p&gt;

    &lt;p&gt;Before leaving this example, let me quickly outline the number of uses I’ve
found for such a FIFO based AXI-lite bus controller.  The most basic use
is in scripting a scatter-gather DMA.  I’ve also found it useful for
scripting I2C or SPI transactions from a script in memory somewhere.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That would roughly exhaust the exercises needed to learn how to work with
both &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;AXI handshaking&lt;/a&gt; and
&lt;a href=&quot;/formal/2018/12/28/axilite.html&quot;&gt;AXI-lite&lt;/a&gt;.  From here, it
would be time to move on to the full AXI bus protocol.&lt;/p&gt;

&lt;ol start=&quot;5&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;The first (and simplest) exercise would be to build (and verify) an AXI
(full) slave.  A specific performance goal would be that this slave should
be able to handle a throughput of one beat per clock–even when crossing
the boundaries between multiple burst requests.&lt;/p&gt;

    &lt;p&gt;A classic design example which might work well here would be a single
port SRAM controller.  Such a controller would require an internal
arbiter to select which of the read or write channel would be allowed
access to the SRAM.&lt;/p&gt;

    &lt;p&gt;A bonus exercise might be to make that slave able to handle exclusive
access requests, but this would need to be bonus.  Not all AXI slaves
need or want exclusive access.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A good exercise for building an AXI master might be to build an AXI based
cache of some type.  At this point, however, there’s no real way around
the two protocols required: you’d need to support both a cache-to-CPU
protocol as well as the AXI protocol.&lt;/p&gt;

    &lt;p&gt;The cache would be the first type of component requiring burst access.
It can be kept simple enough as to only require a single burst at a time.
Bonus points would include using WRAP addressing, or exclusive access
(data cache only).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When you want good bus performance, however, you need to be able to build 
a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA&lt;/a&gt;.
The skills involved in building (and verifying) a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;memory to memory
DMA controller&lt;/a&gt;
should be the last AXI skills you will need to learn.&lt;/p&gt;

    &lt;p&gt;The key new feature learned when building a &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;DMA
controller&lt;/a&gt;,
not present in any of the prior AXI components, is the simple reality that
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;a DMA&lt;/a&gt;
needs to be able to blast as much information across the bus as possible in
as few beats as possible.  This means you’d need to be able to verify that
your design can issue and track multiple outstanding burst requests at any
given time.&lt;/p&gt;

    &lt;p&gt;To simplify this project to something that might still be accomplished
within a class, I might suggest limiting this DMA to aligned words only.
Obviously, &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;a DMA which can handle both unaligned addresses and unaligned
lengths&lt;/a&gt; is
more useful, but the challenge involved in verfiying
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;such a DMA&lt;/a&gt;
might be too much for an introductory course in AXI design.&lt;/p&gt;

    &lt;p&gt;The neat part of this exercise however, is that once you can build a
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;basic AXI DMA&lt;/a&gt;,
you can then build all kinds of specialized data movers, such as:
stream or packet to memory DMA’s, or the reverse memory to packet or stream
DMA, video DMAs, virtual FIFOs, and more.  None of these items are really
all that much more complex than the
&lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;basic AXI DMA&lt;/a&gt;
is in the first place.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;While these example design exercises start simple, they do end up quite
complex–as they should.  This isn’t quite as complex as AXI gets, however.
More complicated AXI designs might include bus upsizers, downsizers, or even
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;crossbars&lt;/a&gt;.  While such
components are more complex, they aren’t really required for &lt;em&gt;learning&lt;/em&gt; AXI.
If you can handle the prior exercises, then you should then know enough to
build any of these more complex components.&lt;/p&gt;

&lt;p&gt;The big problem I have with these exercises, however, is that they get fairly
challenging by the end.  I’m not sure how I would go about fitting the
verification of a DMA into an AXI formal verification course of only a couple
days–especially since it took me a couple of weeks to verify &lt;a href=&quot;https://github.com/ZipCPU/wb2axip/blob/master/rtl/axidma.v&quot;&gt;my own
DMA&lt;/a&gt;.
So … I’ll continue to keep my eyes open for better (simpler) examples to
work with and from.  Until then, this is still a really good list of exercises
for any student to work with in order to learn the basic AXI concepts on his or
her own.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I’m not sure I’ve seen a lot of good AXI training material on-line.  Most
of what I’ve seen, so far, has been Xilinx’s materials–and those materials
would have you start with and modify a
&lt;a href=&quot;/formal/2019/05/13/axifull.html&quot;&gt;broken design&lt;/a&gt;.
Further, there aren’t a lot of materials discussing how to &lt;em&gt;formally&lt;/em&gt; verify
AXI designs, and it’s that formal part that was required in order to find some
really fundamental
bugs in Xilinx’s AXI designs.&lt;/p&gt;

&lt;p&gt;In the meantime, I offer the roadmap above for learning AXI.  Not everyone
will need all of the lessons or exercises above.  However, the lessons and
exercises outlined above should be thorough enough for anyone to fully learn
the topic.&lt;/p&gt;

&lt;p&gt;Finally, if a course in formally verifying AXI bus components is something you
would be interested in, then let me invite you to correspond with me and
express your interest.  Let me also invite anyone interested to suggest how
either the exercises might be simplified, or how the course might be
structured so as to make sure everyone has the time and ability to accomplish
each of the exercises.  Without such exercises, I fear that lecture alone would
leave students just as confused as they are or were when they entered
the course.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;If thou hast run with the footmen, and they have wearied thee, then how canst thou contend with horses? and if in the land of peace, wherein thou trustedst, they wearied thee, then how wilt thou do in the swelling of Jordan? (Jer 12:5)&lt;/em&gt;</description>
        <pubDate>Sat, 07 May 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/05/07/learning-axi.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/05/07/learning-axi.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>Bringing up a new piece of hardware -- what can go wrong?</title>
        <description>&lt;p&gt;For those who wonder what a “day in the life of” a digital design engineer
might be like, let me offer the following account of “bringup week.”
This is the week the team assembled, with all of their various parts and
pieces, to put a hardware design together for the first time.&lt;/p&gt;

&lt;p&gt;I’m getting ahead of myself, though, so let me back up a bit.&lt;/p&gt;

&lt;p&gt;As background, I’ve had the wonderful fortune and opportunity to help build a
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
system.  Since I’m just a one-man shop, I’m only working on a portion of this
system.  My portion is simply the FPGA portion with some demonstration software
thrown in for good effect.  Others had developed and assembled the circuit
boards, someone else had developed the actual
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; circuitry, and another team had
designed and built the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transducer&quot;&gt;transducers&lt;/a&gt;
which would go in the water and couple the physical pressure waves with
electrical signals.  The digital board used to control this initial bringup
effort was &lt;a href=&quot;https://digilent.com/shop/nexys-video-artix-7-fpga-trainer-board-for-multimedia-applications/&quot;&gt;Digilent’s Nexys Video
board&lt;/a&gt;–a
very capable board for many reasons.&lt;/p&gt;

&lt;p&gt;My job in this design was primarily two-fold: 1) command the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; transmitter, and 2) capture
and save &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
samples from the receiver.  That was, and still is, the primary task.&lt;/p&gt;

&lt;p&gt;As with any hardware project, there are several steps towards a working piece
of hardware.  The first couple of steps take place on paper.  Then there’s
an initial prototype design, where the parts and pieces get assembled together
in order to test the concepts first placed on paper.  Just before this
step, I had picked up a &lt;a href=&quot;https://digilent.com/shop/nexys-video-artix-7-fpga-trainer-board-for-multimedia-applications/&quot;&gt;Nexys Video
board&lt;/a&gt;
to test partial designs on.  This is where I’ll pick up the story today–with
the testing of this prototype design.  Later, we’ll actually turn the component
designs that formed this prototype into design components for a fully
functioning &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; system, with all of
the ultimate functionality we are going to give it.  But for now, we’re just
testing our concepts with a basic prototype board.&lt;/p&gt;

&lt;p&gt;Thankfully, most of the critical digital work was already done.  I’d been
working on the transmitter for over a year, and I was confident it would work.
How could it not?  I mean, the transmitter design logic was really simple.  All
I needed to do was to generate various tones,
&lt;a href=&quot;https://en.wikipedia.org/wiki/Chirp&quot;&gt;chirps&lt;/a&gt;,
&lt;a href=&quot;https://en.wikipedia.org/wiki/Phase-shift_keying#Binary_phase-shift_keying_(BPSK)&quot;&gt;BPSK&lt;/a&gt;
and/or &lt;a href=&quot;https://en.wikipedia.org/wiki/Frequency-shift_keying&quot;&gt;BFSK&lt;/a&gt;
waveforms.  It was all very basic stuff.  I say I was working on it for a year,
but the original design was done in a day or two and I’ve only been tweaking
it since then.  As for the receiver, I was just planning on porting a receiver
design from another project where it had already demonstrated the ability to
work quite well.&lt;/p&gt;

&lt;p&gt;Sounds pretty low key, right?  I mean, all the stuff this project required was
either really simple or had already worked before on another project.  No
problem!&lt;/p&gt;

&lt;p&gt;Unfortunately, there were a couple big secondary tasks that didn’t come from
other projects–not all of them explicitly written down.  Worse, some of these
were added into the requirements at a late stage of the game.  Let’s go over
a quick list of what new digital pieces were part of this design:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Gigabit Ethernet&lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 1, This system is going to get wet&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/netbus/sysdesign.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Here’s the reality: we’re building a
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; device.  It’s going
   to get wet.  That’s just the nature of this business.  To make sure things
   can work in water, our plan is to seal all of the electronics into an
   air-tight can.  Sealing that can will require a special technician, so
   … once sealed it’s not likely that I’ll see my FPGA board
   again.  At that point, I’ll have only one interface available to my
   FPGA–and indeed to the entire device: a Gigabit Ethernet (GbE).&lt;/p&gt;

&lt;p&gt;That’s it.&lt;/p&gt;

&lt;p&gt;Think about this for a moment.  There will be no JTAG port access to plug
   Vivado in to.  There will be no serial port for debugging.  There will only
   be GbE.&lt;/p&gt;

&lt;p&gt;That means that any design problems, updates, or upgrades, must all be
   handled via GbE.  Might you need an &lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;internal logic
   analyzer&lt;/a&gt;?  You’ll need
   to configure it, read from it, and process it over GbE.  Want to update the
   design?  You’ll need to write a new design to flash and then command the
   FPGA to reconfigure itself all over GbE.&lt;/p&gt;

&lt;p&gt;This sort of thing is often and typically handled via a
   &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;.  What happens,
   however, when you need to update that CPU’s software?  Similarly, what
   happens when the CPU software fails and needs to be debugged?  All of that
   will need to be handled over the network.&lt;/p&gt;

&lt;p&gt;For these reasons, I chose to handle several networking protocols in
   digital logic apart from the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;–so
   I could have some confidence that they would continue to work even while
   the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt; was halted or being debugged.
   These protocols included the &lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;Address Resolution Protocol
   (ARP)&lt;/a&gt; and the
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol&quot;&gt;Internet Control Message Protocol (ICMP, or
   “ping”)&lt;/a&gt;,
   as well as the data packet protocol sending out the
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; data and a debug protocol I
   built specifically for the purpose of being able to read and write
   addresses in the design across GbE without needing
   the &lt;a href=&quot;/about/zipcpu.html&quot;&gt;CPU&lt;/a&gt;.  That way, the network can
   be used to &lt;a href=&quot;/zipcpu/2017/07/14/cpu-debugging-needs.html&quot;&gt;halt the CPU, read its registers, update its software, and
   more&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The good news is that I’d done projects with GbE before.  The bad news is
   that this project will likely push the GbE to over 50% capacity.  My
   previous approach to GbE was crippingly slow, and could never handle such
   rates.  As a result, I rewrote much of it to handle AXI stream inputs and
   outputs so the hardware could do most of the network work automatically.&lt;/p&gt;

&lt;p&gt;Hence, while the &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; transmit
   and receive logic might be reused, the network logic contained a massive
   rewrite and a lot of new logic.  The one good news to this new portion of the
   requirement is that we were only bringing up a prototype.  The prototype
   wasn’t going to be sealed in a bottle, and so I &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;still had the serial port
   and more available to
   me&lt;/a&gt;–with the
   understanding that future versions would remove this and any other excess
   interfaces.&lt;/p&gt;

&lt;ol start=&quot;2&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Time Synchronization&lt;/p&gt;

    &lt;p&gt;Eventually, we’ll need to coordinate multiple of these
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; devices together.  That means
they’ll all need to send their transmit pulses at the same time, and they’ll
all need to sample the return waveforms at the same time.&lt;/p&gt;

    &lt;p&gt;Oh, and did I mention that any synchronization would need to take place over
GbE?&lt;/p&gt;

    &lt;p&gt;As a bonus, I’m trying to figure out how I might synchronize these devices
to GPS, but … I’m not there yet.  Of course, there’s no GPS in the water,
so the synchronization would have to come from above.  The big difference
would be that GPS allows you to do absolute time synchronization, vs the
simpler relative time synchronization task of running multiple co-located
devices.&lt;/p&gt;

    &lt;p&gt;Oh, and just to add into the mix: there’s no room in the one control cable
containing the GbE connection to add specialized timing signals or even
a common clock.  It’s all GbE.&lt;/p&gt;

    &lt;p&gt;This logic is also new.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Audio&lt;/p&gt;

    &lt;p&gt;Somewhere along here, I must’ve decided that my task was too easy, and
so I pointed out to other members of the team that the FPGA development
board we were using for the prototype bringup had audio ports on it and
asked if we could use them.&lt;/p&gt;

    &lt;p&gt;Well, okay, the story is a bit longer.  The challenge with any test is that
you need test equipment.  How shall we know, for example, how much power
the device is putting in the water if we can’t measure it?  Measuring
something like that requires a calibrated measurement device and I
volunteered the FPGA as a way of reading from this calibrated device.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 2, Knowing how much power is in the water requires an independent, calibrated measurement&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/microphone.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I mean, why not use the I2S controller I’d built years earlier (and never
   tested) to listen to this calibrated device?  The controller was already
   on board, it just needed to be read.  Even better, if the FPGA read from
   the calibrated device, then we could have common time stamps between our
   transmitter and the calibrated receiver.&lt;/p&gt;

&lt;p&gt;The other half of this measurement is the question of, how can you tell how
   good your receiver is?  This requires having a known source that can
   transmit a known waveform, which can then be heard using the
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; device under test.
   Basically, you need to be able to broadcast a waveform at a known volume
   and then receive at the same time.  You can then take that received waveform,
   correlate it with the transmitted waveform, and get a measure of how much
   power you were able to receive.  If you know how much power was actually
   in the water, you should then be able to estimate how much of that power
   you were able to successfully capture.&lt;/p&gt;

&lt;p&gt;While we’re at it, why not just grab “sounds” from locations within the
   device to allow your “ear” to do some debugging?&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 3, Audio Feedback Sources&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/audio-out.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;This is all well and good.  My problem was that none of this was part of my
   original assignment.&lt;/p&gt;

&lt;p&gt;An ugly corollary to the above problem statement is that I set up the audio
   device for 96k samples per second.  The
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;,
   however, was sampling at a much higher frequency.  How than shall I take the
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;,
   sampling rate and downsample it to the audio rate?  Several of these
   audio sources needed resamplers, as shown in Fig. 3 above.  Those also
   needed to be designed and tested.&lt;/p&gt;

&lt;ol start=&quot;4&quot;&gt;
  &lt;li&gt;
    &lt;p&gt;Video&lt;/p&gt;

    &lt;p&gt;One of the hassles of our setup was that viewing the data was a challenge.
By design, the prototype &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
device would digitize sound waves from the
water, assemble them into packets, and then blast those packets over the
network.  I then needed to write software to capture these packets and to
write them to a file.  The plan was then to read this file into
&lt;a href=&quot;https://www.gnu.org/software/octave&quot;&gt;Octave&lt;/a&gt; for analysis.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 4, A Simulated Falling Raster&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/gfx-raster.png&quot; alt=&quot;&quot; width=&quot;401&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The problem with this setup is that you don’t get any immediate feedback
   regarding what’s in the water.  It takes time to capture packets, more time
   to read them into &lt;a href=&quot;https://www.gnu.org/software/octave&quot;&gt;Octave&lt;/a&gt;, and even
   more time to then display these packets.  Was there something that could
   be done in real time?&lt;/p&gt;

&lt;p&gt;Well, yes.  The &lt;a href=&quot;https://digilent.com/shop/nexys-video-artix-7-fpga-trainer-board-for-multimedia-applications/&quot;&gt;Nexys Video development board&lt;/a&gt;
   we were using for this prototype also has an HDMI video output port.  Why
   not use that to generate some canned displays?  As it turns out, simple
   &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_histogram.v&quot;&gt;histograms&lt;/a&gt;,
   &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_histogram.v&quot;&gt;plots&lt;/a&gt;,
   and even &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_waterfall.v&quot;&gt;falling
   rasters&lt;/a&gt;
   aren’t all that hard to build.  Why not add these to the mix?&lt;/p&gt;

&lt;p&gt;Fig. 4, for example, shows a falling raster.  Recent time is at the top,
   and it scrolls down from above.  Frequency goes from left to right, and the
   energy at any particular frequency is shown coming out of the page.  (I.e.
   black has no energy, white has the most.)&lt;/p&gt;

&lt;p&gt;In this case, the signal shown is a test signal for which I manually
   varied the frequency during a
   &lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulated&lt;/a&gt;
   test-run.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 5, A simulated split window, containing a spectrogram and a falling raster&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/gfx-split-trace.png&quot; alt=&quot;&quot; width=&quot;401&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Fig. 5 is very similar, save that we’ve now split the screen in half using
   a &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_empty.v&quot;&gt;blank video
   generator&lt;/a&gt;,
   plus two &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/axisvoverlay.v&quot;&gt;AXI video stream
   overlays&lt;/a&gt;
   in order to generate a split video.  The top half shows a
   &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_trace.v&quot;&gt;trace&lt;/a&gt; of
   the &lt;a href=&quot;/dsp/2018/10/02/fft.html&quot;&gt;Fourier transform&lt;/a&gt;
   of the input signal, whereas the bottom half shows a &lt;a href=&quot;https://github.com/ZipCPU/vgasim/blob/dev/rtl/gfx/vid_waterfall.v&quot;&gt;falling
   raster&lt;/a&gt;
   again.  Where the two meet, you can see the current
   &lt;a href=&quot;/dsp/2018/10/02/fft.html&quot;&gt;Fourier transform&lt;/a&gt;
   and a horizontal line showing that
   &lt;a href=&quot;https://en.wikipedia.org/wiki/Spectrogram&quot;&gt;spectrogram&lt;/a&gt;
   coming out of the screen.&lt;/p&gt;

&lt;p&gt;So far, all this capability sounds wonderful!&lt;/p&gt;

&lt;p&gt;That is, until it has to be made to work.&lt;/p&gt;

&lt;p&gt;Remember, the most expensive part of digital logic (FPGA) design is not
the design itself, but rather the verification of that design.  Not only that,
I had now permitted some major scope creep into the project.  Neither audio
nor video were ever &lt;em&gt;required&lt;/em&gt; portions of the project.  While I had done HDMI
video before, I hadn’t done I2S audio nor had I ever configured the I2S chip
I had using I2C before.  (Remember &lt;a href=&quot;/blog/2021/11/15/ultimate-i2c.html&quot;&gt;my proposal for an ultimate I2C
controller&lt;/a&gt;?
This would be the first test of &lt;a href=&quot;https://github.com/ZipCPU/wbi2c/blob/master/rtl/wbi2ccpu.v&quot;&gt;that
controller&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;All this meant that there needed to be just that much more testing prior to
bringup.&lt;/p&gt;

&lt;h2 id=&quot;programmatics&quot;&gt;Programmatics&lt;/h2&gt;

&lt;p&gt;Just to add to the stress of the entire project, let me point out a very
simple reality:  It takes time to coordinate team activities.  Put another
way, if you want a design to work across the boundaries of multiple engineering
teams, then you really need to get the engineers responsible for each portion
of the design together into the same room and lock them in there until it works.
That means there needs to be a time and date on a schedule for the meeting.
Travel arrangements need to be made.  This all needs to be done in advance,
and .. it takes a lot of work to rearrange things if need be.  No one wants
to be the one individual responsible for telling the rest of the team that
they have some problem or other and every one else will need to reschedule.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 6, Test Readiness Review&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/trr.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;On a larger project, we might have coordinated a “Test Readiness Review”, so
that everyone would be on the record stating that their portion of the project
was sufficiently working that the project was now ready for test.  In our
case, the analog engineer didn’t feel like he could debug his side of the board
until he had access to a working digital design–forcing us to come together
perhaps earlier than we might have otherwise.&lt;/p&gt;

&lt;p&gt;Either way, once we put this bringup week on the calendar, it was then
going to happen whether I was ready for it or not.&lt;/p&gt;

&lt;p&gt;In my case, I felt like I was ready: I could
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulate&lt;/a&gt;
the device and see the critical portions of the design working nicely through
all of the
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulated&lt;/a&gt;
digital hoops I had laid out for it.&lt;/p&gt;

&lt;p&gt;Still, there was always the worst case scenario: What if my
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulations&lt;/a&gt;
were insufficient, or some hardware piece didn’t work like I had expected?  What
if I arrived at the test site and my stuff didn’t work?  The last thing I
wanted was to sit in a room full of engineers with everyone staring at me
and asking me why my portion of the design, the digital logic, wasn’t working.&lt;/p&gt;

&lt;h2 id=&quot;preparation&quot;&gt;Preparation&lt;/h2&gt;

&lt;p&gt;Let’s just remember, though, I figured this task would be relatively simple: I
already had the transmitter and receiver built, and the receiver had been used
in another project.  So … I allocated myself about two weeks to do my final
preparations.&lt;/p&gt;

&lt;p&gt;I suppose it’s not quite so bad as that.  That’s just what it felt like towards
the end.  Looking over my git logs, I had the major portions of the design built
and verified two months before bringup.  They all built.  They were all lint
clean via &lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My big problem, however, is that I didn’t have a large
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
infrastructure.  I had a long list of things that should’ve been tested in
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;,
but for which I didn’t really have a good model for.  For example, &lt;a href=&quot;https://github.com/ZipCPU/wbi2c/bench/cpp/i2csim.cpp&quot;&gt;my I2C
model&lt;/a&gt; didn’t match
that of the Audio chip I was going to control.  Neither did I have a network
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
model (at first).  I certainly didn’t have a model for the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; transmitter, and no method other
than formal methods to verify it.&lt;/p&gt;

&lt;p&gt;Still, I was confident things would work–perhaps naively so.&lt;/p&gt;

&lt;p&gt;However, when I started building my design with Vivado I was quickly reminded
of some of the limitations of
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;’s
lint capabilities.  Sure, they’ve gotten &lt;em&gt;a lot better&lt;/em&gt; since &lt;a href=&quot;/blog/2017/07/17/debugging-dbgbus.html&quot;&gt;I last grumped
about them&lt;/a&gt;, but
Vivado still catches more wires that should be registers and registers that
should be wires than
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt;
does.  (I know,
&lt;a href=&quot;/blog/2017/06/21/looking-at-verilator.html&quot;&gt;Verilator&lt;/a&gt; is
an &lt;em&gt;open source&lt;/em&gt; project–I should submit a patch to fix these issues.
I’ll just be honest and say that I haven’t done so–yet.)&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 7, Clocks in the design&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/clocks.svg&quot; alt=&quot;&quot; width=&quot;240&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Then there was timing.  Sadly, this design has way too many clocks in it.
The SPI based A/D runs off of a 200MHz clock.  The network runs off of two
separate 125MHz clocks–one for transmit and one for receive.  I would combine
these two clocks, but there’s always the possibility that the network might not
come up in GbE mode.  In that case, the receive clock will run at either 2.5MHz
(10T) or 25MHz (100T), whereas the transmit clock will remain at 125MHz.  The
audio runs off of a 24.5MHz clock.  The rest of the design runs off of the
100MHz clock used by the DDR3 memory and exported by the MIG.  That meant
that, just to get the design to synthesize, I needed to write a lot of timing
exceptions everywhere something
&lt;a href=&quot;/blog/2017/10/20/cdc.html&quot;&gt;crossed clock domains&lt;/a&gt;.
Although tedious, the good news is that I found some places where I didn’t
realize I was &lt;a href=&quot;/blog/2017/10/20/cdc.html&quot;&gt;crossed clock
domains&lt;/a&gt;, and all of those needed
to be fixed.&lt;/p&gt;

&lt;p&gt;One problem I had early on in when trying to implement my design centered
around how to delay the network clock by 90 degrees from the data.  My plan
was to, and indeed &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/7e86624a623c38a2fd36fdffc6ec56c693c2ec37/rtl/toplevel.v#L351-L356&quot;&gt;my previous implementations of this interface
did&lt;/a&gt;, &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/7e86624a623c38a2fd36fdffc6ec56c693c2ec37/rtl/toplevel.v#L356&quot;&gt;output a clock using a hardware
ODDR element&lt;/a&gt;, and to drive that element with &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/7e86624a623c38a2fd36fdffc6ec56c693c2ec37/rtl/toplevel.v#L567&quot;&gt;a clock
that was 90 degrees delayed from my data
clock&lt;/a&gt;.
As long as the two logic levels leading into this ODDR element were constant
this shouldn’t be a problem, right?&lt;/p&gt;

&lt;p&gt;Well, not quite.&lt;/p&gt;

&lt;p&gt;There was always the possibility that the transmitter might need to run at
a lower network speed than GbE, and then these values would need to toggle
to generate a slower speed clock.  But, my patience was thin, I just wanted
it to work–not necessarily to work right.  Unfortunately, Vivado gave me
no end of grief trying to get timing closure using this method.  In the end, I
tore up that approach and simply output both clock and data using a 4x OSERDES.
That way I could guarantee the phase relationship and clock crossings myself,
and also guarantee that the network interface was done “right”.  (Incidentally,
I’ve also now verified–by accident–that the slower speed transmit mode works
as designed.)&lt;/p&gt;

&lt;p&gt;I was now ready to place the design on the board.&lt;/p&gt;

&lt;p&gt;The first test?
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt; and
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol&quot;&gt;ICMP (ping)&lt;/a&gt;.
Why?  Because if I ever need to debug a network connection, the first thing I
always try is to &lt;a href=&quot;https://en.wikipedia.org/wiki/Ping_(networking_utility)&quot;&gt;ping&lt;/a&gt;
the device on the other end.  When you run
&lt;a href=&quot;https://en.wikipedia.org/wiki/Ping_(networking_utility)&quot;&gt;ping&lt;/a&gt;
on your local network, the first thing your computer will do is to broadcast an
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt;
request.  Once it gets the response,
and only then, will the actual
&lt;a href=&quot;https://en.wikipedia.org/wiki/Ping_(networking_utility)&quot;&gt;ping&lt;/a&gt;
packet get sent.&lt;/p&gt;

&lt;p&gt;Neither worked.&lt;/p&gt;

&lt;p&gt;I still remember that cold, depressed feeling as I stared at the board and
wondered to myself, now what?&lt;/p&gt;

&lt;p&gt;Unfortunately, I hadn’t put any debugging infrastructure into any of the new
components of the design.  I just … never thought things wouldn’t work.
(You’d think I’d know better by now …)  So my first step was to instrument
as much of the network design as I could with &lt;a href=&quot;/blog/2017/07/08/getting-started-with-wbscope.html&quot;&gt;Wishbone
scopes&lt;/a&gt;.
I started with the end points, and then worked my way towards the packet
processors in the middle.  Every step got a scope.  It got to the point where
I could touch any point in the packet processing chain to see what was going on.&lt;/p&gt;

&lt;p&gt;Shall we look over some of the errors I found?  Here was one: my packet miss
counter wasn’t counting up the number of missed packets.  See the bug?&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_wb_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;o_net_reset_n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;	&lt;span class=&quot;c1&quot;&gt;// See the bug?&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;counter_rx_miss&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;32'h0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rx_miss_stb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;counter_rx_miss&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counter_rx_miss&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If you missed it, just remember that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_n&lt;/code&gt; is the suffix I use for negative
logic.  The counter should be cleared on reset, and the test for that should’ve
been for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;!o_net_reset_n&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This wasn’t the only place where I got reset polarities mixed up.  In
a design filled with “working” and “formally verified” modules, you’d expect
some bugs due to integration.  Here was one of those bugs:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;n&quot;&gt;pkt2stream&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;icmp_stream&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S_AXI_ACLK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i_net_rx_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S_AXI_ARESETN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rx_reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//Same bug&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Incidentally, this was the exact same bug.  &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rx_reset&lt;/code&gt; was active high, whereas
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;S_AXI_ARESETN&lt;/code&gt; is active low.  Not only that, I found this same bug in a
couple of submodules of the same network control module.&lt;/p&gt;

&lt;p&gt;Here’s another bug I found.  Again, this is the sort of bug you might expect
when integrating various “working” components together.  In this case, I
was using &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abortable AXI
Streams&lt;/a&gt;, and needed a way
to convert these streams to normal AXI streams that couldn’t be aborted and
that could be written to memory if desired.  (There’d be no room for TLAST in
memory …)  My method of handling this was to start each “packet” with a
length word, followed by the packet payload.  The bug?  Well, the
converter to AXI Stream calculated the length word based upon the length
of the packet itself, whereas the bridge from a regular AXI Stream to an
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abortable AXI stream&lt;/a&gt;
included the four bytes of the length word in its length count.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 7, Converting between AXI Stream types&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/pktlength.svg&quot; alt=&quot;&quot; width=&quot;760&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Apparently, there was enough time separating when I wrote these two components
that I forgot which format I was using.  Then, to add insult to injury,
neither of the two components using this format described the format properly
in their comments.  Had they done so, the issue would’ve been easier to debug.&lt;/p&gt;

&lt;p&gt;Lesson learned: Document all interface formats.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 20px&quot;&gt;&lt;caption&gt;Fig. 8, Selecting from among many packet sources&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/txmux.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I also found a &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;basic AXI
handshaking&lt;/a&gt; bug in the
packet merge utility.  This utility, shown in Fig. 8, is responsible for
granting channel access to one (and only one) packet source when that source
wishes to send a packet.  In my case, there were several possible packet
sources: the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt; processor, the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol&quot;&gt;ICMP&lt;/a&gt;
processor, the debug protocol handler, and the receive data processor.
(Eventually, the list will include the network time handler and CPU packet
handling as well.)  In this case, the bug involved moving a data item forward
in an AXI Stream when the slave was valid, rather than waiting for the slave
to be valid &lt;em&gt;and&lt;/em&gt; ready.  The result was an extra word at the beginning of
every packet.&lt;/p&gt;

&lt;p&gt;Incidentally, this is one of those places where formal verification is no
more complex than a counter: You count the number of stream words from a given
stream’s packet input going into the mux, and you count the number of words
coming out.  Verify that the same number of words going in matches the number
of words coming out.  If you want to get fancy, you can even declare that
word #XYZ (let the solver pick this) must have some solver chosen value,
and then verify the same on the output.  Still, the formal proof is quite easy
to do.  … You just have to do it.&lt;/p&gt;

&lt;p&gt;During this whole process, I used &lt;a href=&quot;https://www.wireshark.org&quot;&gt;Wireshark&lt;/a&gt;
heavily to debug any errors.
&lt;a href=&quot;https://www.wireshark.org&quot;&gt;Wireshark&lt;/a&gt; could tell me, for example, if an
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt;
request was getting a response or not, or if that response had the correct
format, or if not what part of the packet was in error.
(&lt;a href=&quot;https://www.wireshark.org&quot;&gt;Wireshark&lt;/a&gt; was
also telling me that I was blasting packets of what looked like random data
across the network–but we’ll get to that nasty bug soon enough.)  If you
ever find yourself doing network debugging, I highly recommend having
&lt;a href=&quot;https://www.wireshark.org&quot;&gt;Wireshark&lt;/a&gt; running during your debug sessions.  The
information it provides is just that valuable.&lt;/p&gt;

&lt;p&gt;Once I had
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt; and
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol&quot;&gt;ICMP&lt;/a&gt;
working, as well as seeing my receive data packets
properly transmitted, I figured my task was done.  I took a break and rested
for the weekend.  It wasn’t until the next week when I tried looking at the
output of my &lt;a href=&quot;https://en.wikipedia.org/wiki/Ping_(networking_utility)&quot;&gt;ping&lt;/a&gt;
command, and thus discovering that
[ping](https://en.wikipedia.org/wiki/Ping_(networking_utility) didn’t
think it was getting a response, that I dug even further down to discover that
my &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksums&lt;/a&gt;
were all wrong.&lt;/p&gt;

&lt;p&gt;Lesson learned: &lt;a href=&quot;https://www.wireshark.org&quot;&gt;Wireshark&lt;/a&gt; doesn’t automatically
check &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; or
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksums&lt;/a&gt;.
That functionality needs to be enabled.&lt;/p&gt;

&lt;p&gt;Oops.&lt;/p&gt;

&lt;p&gt;As it turns out, I had built my &lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;IP
checksum&lt;/a&gt; logic based upon my
memory of how the &lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksum&lt;/a&gt;
was supposed to work from the last time I had built
&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; packets.  Apparently, I had forgotten
that the &lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksum&lt;/a&gt;
needs to be inverted before use.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 9, Packet Checks in the Network Simulator&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/netsim-checks.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;By this point, I had also finally bit the bullet: I now had a GbE network
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt; model.
This model would send random
&lt;a href=&quot;https://en.wikipedia.org/wiki/Address_Resolution_Protocol&quot;&gt;ARP&lt;/a&gt; and
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol&quot;&gt;ICMP&lt;/a&gt;
requests, and validate their responses.  It checked
&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; and
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksums&lt;/a&gt;.  It would also
validate &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
packets.  Even better, I could send requests to my design via
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
on the local host, and the network model would then forward those requests
into the design and then forward any responses back.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 10, Network Packet Simulator&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/netsim.svg&quot; alt=&quot;&quot; width=&quot;420&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;This &lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
capability was very helpful, and I’m not sure I would’ve found
any of my remaining bugs without it.&lt;/p&gt;

&lt;p&gt;Another ugly bug I wasn’t expecting was associated with adding packet
headers and so forth to the design.  In this design, the network engine
accepts an AXI stream packet.  That packet starts with the Ethernet destination
and an EtherType (skipping the Ethernet source MAC), followed by any ethernet
payload.  Incidentally, this format helps keep all the AXI stream words
formatted nicely on 32-bit boundaries–but that’s another story.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 11, Network Core processing steps&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/netcore.svg&quot; alt=&quot;&quot; width=&quot;320&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;It then &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/enet/rtl/ethernet/addemac.v&quot;&gt;fills out the rest of the Ethernet
header&lt;/a&gt;,
&lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/enet/rtl/ethernet/addepad.v&quot;&gt;expands the packet to the minimum
size&lt;/a&gt;
(64 bytes), and &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/enet/rtl/ethernet/addecrc.v&quot;&gt;adds a
CRC&lt;/a&gt;.
All of this extra “adding” process, however, takes cycles, and I wasn’t
insisting on any dead time between packets to make sure these cycles were
available.  Rather, I had set the TREADY value associated with the incoming
network packet stream to be a constant one.&lt;/p&gt;

&lt;p&gt;Frankly, I never saw that one coming.  Because I unconditionally set
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TREADY=1&lt;/code&gt;, the network processing modules weren’t getting properly reset
between packets and so independent packets were getting merged together.
This wasn’t a problem with the previous design from which this one was drawn,
since the previous design used a different handshake to start packet
transmission.&lt;/p&gt;

&lt;p&gt;Still, I figured I was at least close to ready.&lt;/p&gt;

&lt;p&gt;I even had the network debugging port up and running.  This port was a
modified version of my &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;serial port “debugging
bus”&lt;/a&gt;, save that
it had been modified to run “reliably” over
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;.
Using this port, I could send commands to the device to read or write to any
address found within my FPGA design.
The basic protocol was that the external computer would send a packet to the
FPGA requesting a bus transaction, and then wait for the FPGA’s response.  Every
packet was given a response.  If there was ever no response, the request would
timeout and then get repeated.  As a result, no more than one request would
ever be in flight at any given time–although there might be multiple copies of
that one request and its response in flight.  To handle that, if the FPGA
received duplicate packets, it would only run the bus requests once for the
first packet request, and then simply repeat the response it had generated
for that request on any subsequent requests.  No, the protocol wasn’t very
efficient networkwise, but it was &lt;em&gt;MUCH&lt;/em&gt; faster than the serial port it was
replacing.&lt;/p&gt;

&lt;p&gt;Now that I had all of this working, it was time to start staging for the trip.&lt;/p&gt;

&lt;h2 id=&quot;staging&quot;&gt;Staging&lt;/h2&gt;

&lt;p&gt;“Staging” is my word for separating all of the hardware that will be traveling
with me from my fixed development environment.  My desktop would not be
traveling with me, so I needed to bring a laptop–and a newly purchased one
at that.  That laptop would be a special project laptop.  It needed to have
Linux installed, Vivado, Verilator, GtkWave, Icarus Verilog, zip-gcc and
… all my favorite development toys.  Once I had all these installed, I
cleared off a table and started setting up my traveling equipment.&lt;/p&gt;

&lt;p&gt;Of course, once I put it all together, nothing worked.&lt;/p&gt;

&lt;p&gt;Sound familiar?&lt;/p&gt;

&lt;p&gt;This time, it took me almost a whole day to chase down the problem.  (I hadn’t
allocated time for this extra day …)  Apparently, that brand new laptop I had
just bought for this trip and this project came with a bad Ethernet port.
(Or had I broken it somehow?  I’ll never know …)&lt;/p&gt;

&lt;p&gt;The problem with this was, I had assumed everyone else’s hardware “just
worked.” Had I suspected the laptop might have a bad Ethernet port, I
might’ve saved myself a half day or more by trying my USB to Ethernet
dongle earlier.&lt;/p&gt;

&lt;p&gt;Instead, I turned to my &lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/dev/rtl/enetctrl.v&quot;&gt;(working) MDIO
controller&lt;/a&gt;
for the first time only to discover … it wasn’t working.  I couldn’t figure
out what had happened.  I knew the design worked before the last time I used
it, but somehow it wasn’t working today.  In particular, the bits returned
were off by one, and the last bit wasn’t trustworthy.  In hindsight, looking
over the design with &lt;a href=&quot;https://www.atlassian.com/git/tutorials/gitk&quot;&gt;gitk&lt;/a&gt;, it
looks like I had tweaked this design since copying it from the
&lt;a href=&quot;https://github.com/ZipCPU/videozip/blob/enet/rtl/enetctrl.v&quot;&gt;“working” project&lt;/a&gt;
and … not validated it since.  Those “tweaks” were what wasn’t working.&lt;/p&gt;

&lt;p&gt;At this point, though, I was less than a two days out.  It was now Wednesday,
the &lt;a href=&quot;https://www.amtrak.com/auto-train&quot;&gt;train&lt;/a&gt; left on Friday, and I had only
just gotten my tests running again in this staging area.  Then, when I went to
double check everything again, I discovered that … the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
data packets weren’t getting through anymore.&lt;/p&gt;

&lt;p&gt;At this point, I was out of time.  I had a critical capability that wasn’t
working, but it was now time to pack up all my hardware for the train.
(I swear it was working earlier!  What happened?)&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: right&quot;&gt;&lt;caption&gt;Fig. 12, Amtrak's Auto Train&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/auto-train.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h2 id=&quot;the-train&quot;&gt;The Train&lt;/h2&gt;

&lt;p&gt;Let me set the stage a bit more for what happened next.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt; data processing in this
system takes place in several steps:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;All of the digitizers for the various sensors sample their data from an
SPI based A/D concurrently.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;That data is then serialized, and organized into blocks of 24 samples,
with 24-bits per sample.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Each block is then examined to calculate an appropriate block exponent.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The samples are then compressed into 16, 20, 24, or 32-bits per sample.&lt;/p&gt;

    &lt;p&gt;Okay, so stuffing 24-bits into 32-bits isn’t much of a compression, but it
does make it easier to examine what’s going on when staring at a hex dump
of the packet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, the samples and exponents are assembled together into packets of
32-bit words.  The packets contain configuration information, the time
stamp of the first sample, possibly some non-acoustic data, and then
transmit information is appended to the end of the packet.&lt;/p&gt;

    &lt;p&gt;This takes place in a module I called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rx_genpkt&lt;/code&gt;.  By the time I got on
the train, this module had just recently been formally verified (we’ll
discuss that with Fig. 13 below), and no longer showed any signs of being
broken in either
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
or hardware.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Ethernet, &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IPv4&lt;/a&gt;, and
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; headers are
then added to the sample packet, containing the length of the packet,
&lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4&quot;&gt;IP&lt;/a&gt; and
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Internet_checksum&quot;&gt;checksums&lt;/a&gt;,
and so forth.&lt;/p&gt;

    &lt;p&gt;This takes place in a module I called &lt;em&gt;pkt2udp&lt;/em&gt;, the one module I knew
was broken when I got on the train.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The packet then gets multiplexed between the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
sensor data source and a second (microphone) data source–following Fig. 2
shown above.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It then crosses from the 100MHz to the 125MHz clock domain.&lt;/p&gt;

    &lt;p&gt;This clock domain crossing component is really nothing more than a
&lt;a href=&quot;/blog/2018/07/06/afifo.html&quot;&gt;traditional asynchronous
FIFO&lt;/a&gt;.
The “packet” getting placed into this FIFO consisted of a 4-byte header
containing the packet’s length, followed by a payload containing as many
words as were required to capture the rest of the number of bytes requested
in the header.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Once in the 125MHz domain, the length word is stripped from the packet,
and the packet payload is then broken down from 32-bit words to 8-bit
octets.&lt;/p&gt;

    &lt;p&gt;The 32-bit word size turns out to be convenient for both assembling the
packet, as well as making sure that packet generated using a 100MHz clock
can keep the network busy on every clock cycle of a 125MHz clock.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, the packet goes through an arbiter that selects one packet request
   at a time, from among several potential packet sources, to forward to the
   network core.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The network core then adds a MAC address.  (See Fig. 11)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The network core then pads the packet to a minimum of 64 bytes&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A CRC is then added to the end of the packet, and&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A preamble is added to the beginning of the packet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The packet then travels the network.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;In general, there’s one module for each of these steps, and most of these
modules have been formally verified.  There were two notable exceptions to this
rule.&lt;/p&gt;

&lt;p&gt;The first exception was that the initial packet assembly, where we added
configuration information and timestamps.  Just before I left, I had narrowed
down a bug to this logic, as shown in Fig. 13 below.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 13, Chasing bugs in hardware&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/bugchasing.svg&quot; alt=&quot;&quot; width=&quot;780&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;At the time, this packet assembly logic wasn’t located in a separate module but
rather in a module containing other modules.  As such, it hadn’t been formally
verified.  Just before leaving, I had traced a nasty bug to this module,
as shown in Fig. 13 above.  That was enough to split the remaining processing
logic into a separate module for formal verification.  Once separated, this
processing module then became easy to verify.&lt;/p&gt;

&lt;p&gt;Unfortunately, the bugs in the RxCHAIN weren’t the last bugs in the system.
Another bug appeared in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkt2udp&lt;/code&gt;.  Once I had formally verified (and fixed)
the receive chain, this &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkt2udp&lt;/code&gt; module was the only one left in the chain
that hadn’t been formally verified.&lt;/p&gt;

&lt;p&gt;What did &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkt2udp&lt;/code&gt; do?  This was the component responsible for turning a
sensor data packet into a
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; packet.&lt;/p&gt;

&lt;p&gt;Frankly, I didn’t trust this module at all.  It felt like I kept tracing bugs
into the module, but could never find their cause.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 14, The Circular Buffer&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/linked-list.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;For some more background, understand that this component’s operation centered
around the circular buffer, shown in Fig. 14 above.  (A ping-pong buffer pair
would’ve been easier to verify.)  Within this buffer, the first 32-bit word of
every packet in the buffer was to contain the length of the packet that would
follow.&lt;/p&gt;

&lt;p&gt;Writing to this buffer meant:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Clearing the packet length field.  This was usually done as part of
writing the previous packet to memory, but on reset it might need to
be cleared manually.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Write data into the buffer, counting how much data gets inserted&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;Abort (drop)&lt;/a&gt;
the packet if 1) the source
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;aborts&lt;/a&gt;
aborts, or 2) if the one packet uses (or will use) the entire memory buffer.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Once the packet is complete, write a zero to the field following.  This
will become the length field of the next packet.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Then go back and write the finished packet length into the buffer&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, move the write-packet boundary forward in the buffer.  Our packet
has now been committed to the output stream.  It now has a reserved location
in RAM.  It won’t be dropped from this point forward.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The key to all this processing is the length field.  A zero length means there
is no packet present.  Once a packet was committed, the length of that
(now committed) packet would be updated in memory once we guaranteed that the
next packet’s length field was set to zero.&lt;/p&gt;

&lt;p&gt;If at any time during this process there wasn’t enough room in the buffer for
the packet, the packet needed to be
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;dropped&lt;/a&gt;.  There were two
parts to this.  First, if the packet filled the entire memory and there still
wasn’t enough memory to finish the packet, then the packet would be
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;dropped&lt;/a&gt; internally.
The source would never be the wiser.  This keeps the routine from locking up
on an over-long packet.  Second, the incoming packet would stall if the
writer ever ran out of memory between the write and read pointers.  If it
stalled for too long, the packet source might also &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort the
packet&lt;/a&gt;–once it couldn’t
stall any longer.  (Remember, data is coming in at a constant rate.  It must
either go somewhere, or get dropped if the system can’t handle it.  You cannot
stall indefinitely, neither can we allow partially completed packets to move
forward.)&lt;/p&gt;

&lt;p&gt;The read side of this process was simple enough as well: You’d read from the
first word where the last packet left off.  While that word read zero,
the reader would stay put and just keep reading that length word.  Once the
length word became non-zero, the reader would start reading the packet out,
by reading and then forwarding the packet’s data.&lt;/p&gt;

&lt;p&gt;I’m sure most of you will recognize this structure as a basic
&lt;a href=&quot;https://en.wikipedia.org/wiki/Linked_list&quot;&gt;linked list&lt;/a&gt;.  The
biggest differences between this
&lt;a href=&quot;https://en.wikipedia.org/wiki/Linked_list&quot;&gt;linked list&lt;/a&gt;
and the ones you find more often in software are 1) the wrapping memory, and
the fact that the “pointers” in this case were lengths, rather than true
pointers, and 2) in hardware, you have to deal with timing and timing cycles.
These are minor differences, though: it’s still a basic
&lt;a href=&quot;https://en.wikipedia.org/wiki/Linked_list&quot;&gt;linked list&lt;/a&gt;:
the first word in a packet gives the packet’s length, and therefore points
to the first word, the length word, in the next packet.&lt;/p&gt;

&lt;p&gt;Indeed, the operation of this IP is all quite straight-forward, but I had
no end of trouble with this design.  It got so bad at one point that I even
(gasp!) built a Verilog
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
to bench test it.  That bench test was
&lt;em&gt;really&lt;/em&gt; hard to get right, too.  I spent a half day toggling between
assuming that the reader would accept packets out at full speed, or that it
would accept them at quarter speed, only able to get one of the two speeds
working depending on how I set the &lt;em&gt;M_AXIN_READY&lt;/em&gt; input.  While I eventually
found that bug, it wasn’t really enough.&lt;/p&gt;

&lt;p&gt;What the design needed was to be formally verified.&lt;/p&gt;

&lt;p&gt;Why wasn’t it formally verified?  How was it that I had gone so long without
formally verifying this critical component?&lt;/p&gt;

&lt;p&gt;The simple answer is that I couldn’t figure out how to go about formally
verifying a
&lt;a href=&quot;https://en.wikipedia.org/wiki/Linked_list&quot;&gt;linked list&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As a result, I was now on an &lt;a href=&quot;https://www.amtrak.com/auto-train&quot;&gt;Amtrak train&lt;/a&gt;
headed for hardware bringup with a known bug in my digital logic design.  Using
my own &lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;internal logic
analyzer&lt;/a&gt;,
I had caught this bug in hardware just before leaving.  What I discovered 
is illustrated in Fig. 15 below.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: none&quot;&gt;&lt;caption&gt;Fig. 15, The linked list, now corrupted&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/broken-links.svg&quot; alt=&quot;&quot; width=&quot;480&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;I should point out that I only discovered this via &lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;the internal
logic analyzer&lt;/a&gt;.  I’m
not sure I would’ve known where to look without it.  While the &lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;internal logic
analyzer&lt;/a&gt; told me where
the design was stuck, however, it didn’t tell me how it got stuck in the first
place.&lt;/p&gt;

&lt;p&gt;Here at least I knew that, due
to some unknown condition, the read pointer would be reading a zero
length packet somewhere in memory (meaning that there was no packet present),
all while the write half of the module was working on a packet elsewhere.
The design would be locked up, never to go again.  However, while I could
discover this much using &lt;a href=&quot;/blog/2017/07/08/getting-started-with-wbscope.html&quot;&gt;my
scope&lt;/a&gt;,
I couldn’t figure out &lt;em&gt;how&lt;/em&gt; the design ever got into this configuration.
&lt;em&gt;This wasn’t supposed to happen!&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Therefore, on the train, I decided to try the following approach to formally
verifying this linked list chain:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;I would allow the formal tool to select two arbitrary memory locations.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I would start tracking these two locations as soon as the first location
pointed to the second one.  If it never pointed at the second location,
I’d never track what happened next.&lt;/p&gt;

    &lt;p&gt;A formal-only state machine’s state register would note that I was
tracking a packet existing between these two pointer addresses.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I then tracked these two addresses, and their values, until the read
pointer pointed at the first of these two locations, so that it would
start reading out the packet.  Frankly, I didn’t need to go farther: I
had the read tracking logic working in my formal proof already.  I just
needed to get to this point where I could guarantee that the read pointer
would be given the right data.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I also formally verified particular properties of these two locations:
1) The first address, plus the length contained at that address, had to point
at the second address.  2) The writer could be active starting at the second
address, but never between the two.  2) The packet length was at least a
minimum packet length, and always less than the full memory size, and so on.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;For all other linked list pointer-pairs within the design that the formal
tool might encounter, I &lt;em&gt;assumed&lt;/em&gt; these properties.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once I had this plan in mind, I was then able to formally verify the packet to
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
module.  What I discovered was a strange corner case: If
the source &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;aborted&lt;/a&gt;
the packet just at the exact same clock cycle that the
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
packet assembler completed it, a zero length word would be written to the
packet’s length word, and the writer would move on to the next packet.&lt;/p&gt;

&lt;p&gt;Just to see what’s going on, here’s what the original packet assembly
logic looked like:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// ... assemble the parts and pieces of the packet together&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;endcase&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// On either an external or internal abort ...&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S_AXIN_ABORT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;abort_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// Write the null pointer back to the first address&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// of memory&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem_wr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;1'b1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Write to memory&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem_waddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next_start_of_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;mem_wdata&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

			&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S_IDLE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S_AXI_RESETN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// Reset stuffs&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The problem here is, what happens if the packet is already fully assembled
when the &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort&lt;/a&gt;
signal is received?  We were then going to write the length
of this packet and set the packet start address to the next start of packet
address.  The &lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort&lt;/a&gt;
condition would override that write, causing us to write
a null pointer which would then cause the reader to freeze waiting.&lt;/p&gt;

&lt;p&gt;And here’s the corrected condition:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c1&quot;&gt;// ... assemble the parts and pieces of the packet together&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;endcase&lt;/span&gt;

		&lt;span class=&quot;c1&quot;&gt;// On either an external or internal abort ...&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S_AXIN_ABORT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S_PAYLOAD&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;abort_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt;
			&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Notice how, this time, the packet is only
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;aborted&lt;/a&gt;
if it hasn’t been completed.  That is, we don’t
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort&lt;/a&gt;
after we’ve received the full &lt;em&gt;payload&lt;/em&gt; of the packet.  Once the payload has
been completed, we do nothing more with the
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort&lt;/a&gt; logic.&lt;/p&gt;

&lt;p&gt;In the end, it only took between 4-6 hrs on the train to fully verify this
packet to &lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
bridge.  That’s 4-6 hrs compared to the last several weeks where
I was dealing with this bug on and off depending on the conditions within the
design, depending on when the hardware switched from 10Mb mode to 1GbE mode,
and so forth.  Worse, during those weeks, I could never quite pin the bug
down to one module, so it really required formally verifying everything else
to get to the point where I could isolate this bug to this module.&lt;/p&gt;

&lt;p&gt;Now, at least, I had found the bug.  Even better, I now had confidence that
this last unverified portion of my design would work as intended.  I just had
nowhere to assemble the hardware to test it until the team was assembled
on Monday morning.&lt;/p&gt;

&lt;h2 id=&quot;bringup-bugs-found&quot;&gt;Bringup Bugs Found&lt;/h2&gt;

&lt;p&gt;So, once Monday morning came around, I joined the team at the test site.
I plugged in the hardware and my newly verified packet to
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt;
converter “just worked” like a champ.&lt;/p&gt;

&lt;p&gt;Instead, I had two other bugs to deal with.  (These weren’t the first bugs
of the day, either–those were in the circuitry elsewhere and not my digital
logic.)&lt;/p&gt;

&lt;p&gt;The first was associated with a weird corner case.  The network hardware is
designed to start up in 10Mb Ethernet mode.  It then senses whether or not the
cable is capable of 100Mb or 1Gb Ethernet.  Once that sensing is complete, the
network hardware will switch modes.  My design, however, only checks and
changes speed between packets.&lt;/p&gt;

&lt;p&gt;What happens, then, when the &lt;a href=&quot;https://en.wikipedia.org/wiki/Sonar&quot;&gt;SONAR&lt;/a&gt;
receiver starts assembling data into packets
and then attempts to blast so much data across the network that there’s never
a rest between packets for the network controller to use to change speed in?&lt;/p&gt;

&lt;p&gt;What happens is that the network controller gets so stuck that the debugging
packets can’t get through.  Without the debugging packets, it was impossible
to send (via the network debugging port) a command to halt the packet
generation.  It’s a classic chicken-and-egg problem.&lt;/p&gt;

&lt;p&gt;For the time being, I could get around this bug easily enough by turning the
receive data handling off (via
&lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;UART&lt;/a&gt;),
letting the network adjust, and then
turning it back on again.  By the Tuesday morning (Day #2) I had a more
permanent fix for this in place, whereby the data packet generation wouldn’t
start until the network was in high speed 1Gb/s mode.  Indeed, after the
second morning, I never needed the &lt;a href=&quot;/blog/2017/06/05/wb-bridge-overview.html&quot;&gt;UART debug bus backup
port&lt;/a&gt;
again–it was all network control after that.&lt;/p&gt;

&lt;p&gt;It was the second problem that was more of a hassle that first day.&lt;/p&gt;

&lt;p&gt;For background, remember that this is the first time my FPGA logic was
connected to hardware on this project.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 16, SPI Controller Self-Test Setup&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/miso.svg&quot; alt=&quot;&quot; width=&quot;360&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;When the receive processing logic was first checked out years ago,
I had two potential test sources, as shown in Fig. 16.&lt;/p&gt;

&lt;p&gt;The first was an emulated A/D inside my design, which I could use as a source
if I needed one and had no hardware.  This emulated A/D consisted of a series of
&lt;a href=&quot;/dsp/2017/08/30/cordic.html&quot;&gt;CORDICs&lt;/a&gt;, each generating
a sine wave at a different frequency and amplitude, but all of them phase
aligned.  The result was then
encoded appropriately to match what the A/D output would be–it became the
“MISO” input from an emulated A/D.  As a result, if you ever plotted the
receive waveform from this artificial test source, you’d see some easily
recognizable signals.&lt;/p&gt;

&lt;p&gt;For this project, however, I had decided that the emulated source was probably
overkill.&lt;/p&gt;

&lt;p&gt;Instead, I used the second test source configuration in the A/D controller.
This test source would replace whatever was actually read by the A/D with a
counter and the channel number.  I could then follow this incrementing counter
through my processing chain to make certain that no data was ever dropped.
This project now marked the second time I’d used this counter approach.  The
first time, on the original receiver project, I &lt;em&gt;automatically&lt;/em&gt; verified that
there were never any breaks in the counter when the results were finally
received by the software processor.  This time, however, I just looked at a
couple of packets in hex, by eye, to verify there were no packet breaks.&lt;/p&gt;

&lt;p&gt;So, now, with the whole team assembled, we connected a signal generator to the
A/D input.  The &lt;a href=&quot;/dsp/2019/12/21/histogram.html&quot;&gt;histogram&lt;/a&gt;
of the output looked wonderful, so I figured everything was good–up until we
all looked at the waveform.  Instead of a sine wave, we got something like
Fig. 17.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 17, Corrupted Sinewave&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/corrupted-sinewav.png&quot; alt=&quot;&quot; width=&quot;640&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;In this figure, you’ll notice discontinuities in the sine wave.  As a
hypothesis test, I’ve placed vertical bars every 18 samples.  You’ll notice
that these vertical bars land right on those discontinuities–every 18 samples.&lt;/p&gt;

&lt;p&gt;At one point, we tried increasing the amplitude.  We got something worse,
as shown in Fig. 18.&lt;/p&gt;

&lt;table align=&quot;center&quot; style=&quot;float: left; padding: 25px&quot;&gt;&lt;caption&gt;Fig. 18, The corruption only gets worse as the volume goes up&lt;/caption&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;/img/proto-bringup/corrupted-capture.png&quot; alt=&quot;&quot; width=&quot;640&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Let’s start with what we know.  Sudden breaks in what should be a smooth
waveform sound like samples that are getting dropped somewhere.
So, I checked for lost samples.  I turned on the counter injection at the
source, as shown in Fig. 16, and then had my packet software dump the data in
hex so I could check for lost samples.&lt;/p&gt;

&lt;p&gt;There were no lost samples.&lt;/p&gt;

&lt;p&gt;I was confused.  That first day of testing ended in frustration.&lt;/p&gt;

&lt;p&gt;On my way out the door, however, another teammate suggested based upon the
frequency we were measuring that I was dropping exactly 6 of every 24 samples.
As it turned out, that was just the help I needed to find the bug.&lt;/p&gt;

&lt;p&gt;Surprise!  The dropped samples bug wasn’t in my hardware at all.&lt;/p&gt;

&lt;p&gt;The network packets were arriving at their destination without error, and
without any dropped packets.  I had verified by eye that nothing was getting
dropped.  That wasn’t the bug.&lt;/p&gt;

&lt;p&gt;No, the bug was in my latest rewrite of the packet handling &lt;em&gt;software&lt;/em&gt;, the
same software that both collected packets and converted them to a text file
so that &lt;a href=&quot;https://www.gnu.org/software/octave&quot;&gt;Octave&lt;/a&gt;
could ingest them.  As of the latest &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rx_genpkt&lt;/code&gt; rewrite, I had run out of
meta-data room to stuff the number of samples per packet in the header.
Instead, the software would simply know this value as a shared
constant.  My problem was, when re-writing this software, I looked up the
packet size from a &lt;a href=&quot;/blog/2017/07/31/vcd.html&quot;&gt;VCD&lt;/a&gt;
trace, shown in &lt;a href=&quot;https://gtkwave.sourceforge.net&quot;&gt;GTKWave&lt;/a&gt;, and generated via
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
just to be sure I got it right.  I read
that there were 0x18 samples per packet, and then wrote the software to read
out 18 samples per packet–dropping six samples from every data packet in the
process.  (Did you notice the accidental hexadecimal to decimal unit change?)&lt;/p&gt;

&lt;p&gt;That fixed the discontinuities in Fig. 17.  What about the additional
discontinuities in Fig. 18?
Those discontinuities came because, surprise, surprise, I was now using Xilinx
hardware instead of ~ALtera~ Intel hardware.  I had also changed the front end.
The receive wavefoms were running though some IDDR elements and there was an
additional delay in when the MISO were returned to my controller.  As a
result, I was sampling the bits from the A/D on the wrong clock cycle.  This
was easily found (and fixed) using my &lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;internal
logic analyzer&lt;/a&gt;.
I’m not sure how I would’ve found this delay otherwise.&lt;/p&gt;

&lt;p&gt;Needless to say, by Tuesday morning I had a parameter in the design allowing
me to adjust the capture delay by eye, and I was able to adjust it so
that it now captured in the center of the bit.&lt;/p&gt;

&lt;p&gt;Fig’s 17 and 18 show one more bug in them, most obvious in Fig. 17: the
sine wave wasn’t uniformly smooth between its positive and negative half
sides.  This one wasn’t my fault.  Instead, we traced it to a mis-configuration
in the function generator we were using to generate the sinewave in the first
place.  We had it set to clip the negative half of the waveform–although
this was more obvious when we ran a triangle wave through the system (not shown
above).&lt;/p&gt;

&lt;p&gt;These three bugs ended up being my last show stopping bug for the week.  The
rest of the week everything I had written “just worked” like I wanted.
(Don’t worry, we’re not superhumans, we still had other bugs to chase down …
there just weren’t any more of them in the digital logic.  Or, to be more
exact, there weren’t any more bugs in the digital logic &lt;em&gt;that any one else
noticed&lt;/em&gt;.)&lt;/p&gt;

&lt;h2 id=&quot;sudden-new-capabilities&quot;&gt;Sudden New Capabilities&lt;/h2&gt;

&lt;p&gt;There’s one more story worth telling from this week.&lt;/p&gt;

&lt;p&gt;As I’m sure you can imagine, this being the first time the team was assembled,
things didn’t go as smoothly as everyone had planned.  I wasn’t the only
engineer in the team with faults that needed to be chased down.  In particular,
we were chasing down some hardware faults in the transmitter on Thursday.
Things weren’t working, and we weren’t certain why.&lt;/p&gt;

&lt;p&gt;The team then asked me if it would be possible to transmit from only one of
the transmitters on this device.&lt;/p&gt;

&lt;p&gt;That wasn’t a request I was expecting.  Nowhere in the requirements did it
say that I needed to be able to transmit onto a selectable subset of the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Transducer&quot;&gt;transducers&lt;/a&gt;
controlled by the device.&lt;/p&gt;

&lt;p&gt;In general, adding a capability like this sounds pretty easy.  All you need
to do is to take the output data and mask it with a register telling you
which transmitters are “on” and which ones are not.  The fix, in Verilog,
was just about as simple as inserting the following lines of logic.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;generate&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NUM_SONAR_ELEMENTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;begin&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ADD_ENABLES&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;initial&lt;/span&gt;	&lt;span class=&quot;n&quot;&gt;o_tx_control&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// This is an FPGA, initial works&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;posedge&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i_clk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tx_enabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;o_tx_control&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;o_tx_control&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int_tx_control&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;endgenerate&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;That was the easy part.&lt;/p&gt;

&lt;p&gt;Now let’s put this problem into a broader context: This design has a
&lt;a href=&quot;/about/zipcpu.html&quot;&gt;ZipCPU&lt;/a&gt;, memory,
many controllers,
&lt;a href=&quot;/blog/2017/06/08/simple-scope.html&quot;&gt;scopes&lt;/a&gt;,
etc.  Every peripheral within the design has its own &lt;a href=&quot;/zipcpu/2019/09/03/address-assignment.html&quot;&gt;address
assignments&lt;/a&gt;.
There’s also an
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt;, the
responsible for routing requests from their sources to the peripherals being
referenced.  Putting something new like this together will require allocating
a new address for a new peripheral register.  That peripheral will then need
to be added to the
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt;, the
&lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt;,
will need to be reconfigured for the &lt;a href=&quot;/zipcpu/2019/09/03/address-assignment.html&quot;&gt;new address
map&lt;/a&gt;, and
then all the software will need to be adjusted for any addresses that had to
change during this process and so on.&lt;/p&gt;

&lt;p&gt;That’s a lot of work.&lt;/p&gt;

&lt;p&gt;Oh, and did I mention I wasn’t using Vivado’s IP integrator?  Nor was I using
their AXI &lt;a href=&quot;/blog/2019/07/17/crossbar.html&quot;&gt;interconnect&lt;/a&gt;?
(I was using &lt;a href=&quot;/zipcpu/2017/11/07/wb-formal.html&quot;&gt;Wishbone&lt;/a&gt;.
I could’ve used AXI, I just chose not to.)&lt;/p&gt;

&lt;p&gt;Using &lt;a href=&quot;https://github.com/ZipCPU/autofpga&quot;&gt;AutoFPGA&lt;/a&gt;, we had all this work
done in less than a half an hour.  When you consider that Vivado took about
half of that time for synthesis and implementation (I wasn’t counting at the
time), this may be even more impressive.&lt;/p&gt;

&lt;h2 id=&quot;audio-and-video&quot;&gt;Audio and Video&lt;/h2&gt;

&lt;p&gt;In the end, neither the brand new audio nor the video capabilities were tested
during this bringup week.  That’s kind of a shame, so I figured I’d at least
discuss some pictures of what the video might look like in
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Fig. 4, back in the beginning of the article, shows one such falling raster.
In this figure, frequency goes from left to right, and the displayed image
scrolls from the top down.  The source is an artificially
generated test tone, generated internal to the system.  At several points
during the
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;,
I adjusted the tone’s frequency, and you can see these adjustments in the image.&lt;/p&gt;

&lt;p&gt;Similarly, Fig. 5 shows a split screen, with a trace on top and the falling
raster below.  Note how the frequency axes are identical, so that the trace
sits nicely on top of the raster, with the raster showing how the trace had
adjusted over time.&lt;/p&gt;

&lt;p&gt;I suppose it’s a good thing the video outputs didn’t get tested.  They didn’t
work in
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;,
until the end of the week.  Below, for example, is a bug
that locked up the Video source selector.  (Remember, I had five video sources,
each generating video signals, and so I need a selector in the system somewhere
to select between which one would be displayed.)&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HLAST&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;VLAST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This was just a &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;basic AXI
bug&lt;/a&gt;.  The correct
condition should have read:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VALID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;READY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This is just a &lt;a href=&quot;/blog/2021/08/28/axi-rules.html&quot;&gt;basic AXI stream handling
rule&lt;/a&gt;.  I should’ve known
better, and so I’m kicking myself for having made it.  The good news, of
course, is that this bug was easily found with just a touch of formal methods.&lt;/p&gt;

&lt;p&gt;Perhaps I’ll have a chance to show off these (now working) video capabilities
during our next hardware test.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;So, what can we learn from the week and the preparation leading up to it?
Let’s see if we can draw some conclusions.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Expect failures–even in hardware.  Plan for them.  Give yourself time,
ahead of time, to find and fix failures.&lt;/p&gt;

    &lt;p&gt;While it sounds weird, I like to put it as, “Fail early, fail often.”&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;Simulate&lt;/a&gt; all
major interfaces!  I lost a lot of preparation time believing that my
network interfaces “just worked”, simply because I hadn’t bit the bullet and
built a proper network
&lt;a href=&quot;/blog/2018/08/22/what-is-simulation.html&quot;&gt;simulation&lt;/a&gt;
model first.  Once I had that model, debugging the network got easy, and
my bug-to-fix times got a lot faster.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;For all of my simulation work using the packet to
&lt;a href=&quot;https://en.wikipedia.org/wiki/User_Datagram_Protocol&quot;&gt;UDP&lt;/a&gt; converter,
nothing managed to catch the actual bugs I was encountering in hardware.
I would’ve had to trigger the 
&lt;a href=&quot;/blog/2022/02/23/axis-abort.html&quot;&gt;abort&lt;/a&gt; on just the
right input sample to trigger this, and I had no idea (before finding the
bug using formal methods) how I might’ve set up the simulation to stimulate
the bug.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It’s a lot easier to find bugs using formal methods than it is to &lt;a href=&quot;/blog/2017/06/02/design-process.html&quot;&gt;find
them in hardware&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Frankly, if it’s not been formally verified, I don’t trust it.  Remember
Fig. 13?  The last two items in that processing chain to get formally
verified were the last two items with bugs in them.  Of those two, the one
item that was the hardest to formally verify turned out to be the last item
in the design with a difficult bug to chase down.  Once formally verified,
however, it worked like a charm.&lt;/p&gt;

    &lt;p&gt;This isn’t to say that every formally verified module &lt;a href=&quot;/formal/2020/06/12/four-keys.html&quot;&gt;worked the first
time&lt;/a&gt;.  Rather, not
every formal proof I ran was sufficient to guarantee proper functionality
the first time.  The proofs got better the longer I worked with each of the
individual components of the design.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Yes, it is possible to formally verify a linked list.  I wish I had
formally verified the &lt;em&gt;pkt2udp&lt;/em&gt; module earlier–it would’ve saved me a lot
of head scratching during the weeks leading up to my travels.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Document your interfaces!&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The sooner you move to the “staging” area, the sooner you can debug your
chosen travel hardware.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Plan early on for how you will debug a design.  Adding the (unused) Audio
and Video capability into the design late in the game took a lot of my
time and – we never got to testing either of those interfaces.  (We
might’ve started testing with them sooner, if I arrived with more confidence
in their functionality–but that’s another story.)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;With a little focus, you can get a lot of work done on &lt;a href=&quot;https://www.amtrak.com/auto-train&quot;&gt;Amtrak’s auto
   train&lt;/a&gt;, while still bringing whatever
   hardware you might need.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;While I didn’t discuss this one above, here was another lesson learned: If
   you have a complicated condition, and two or more things depend upon it,
   create a common signal to capture that condition for both pieces of logic.
   In my case, I had a condition for when a received packet should be generated.
   That condition was repeated in two different locations of the same module.
   Among other things, it checked how much space was available in the buffer.
   I then updated the condition to help guarantee sufficient space was
   available, but only updated it in one location–not both.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This was the bug in Fig. 13, and one I found when I finally formally
   verified the data packet generator.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Looking over all the bugs I found, I seem to have traced several to the
   boundaries between formally verified components–at a place where things
   weren’t verified.  I’ll have to think about this some more.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Finally, while I can be critical of others making basic mistakes, I made
   plenty myself.  I think the worst one I found was checking for
   &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;!VALID || VALID&lt;/code&gt; when what I wanted to be checking for was
   &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;!VALID || READY&lt;/code&gt;.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Let me leave you with a final thought from the first verses of Psalm one,
a Psalm I’ve started to make a habit of reciting to myself on trips like
this one:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Blessed is the man that walketh not in the counsel of the ungodly, nor
  standeth in the way of sinners, nor sitteth in the seat of the scornful. 
But his delight is in the law of the LORD; and in his law doth he meditate
  day and night. 
And he shall be like a tree planted by the rivers of water, that bringeth
  forth his fruit in his season; his leaf also shall not wither; and
  whatsoever he doeth shall prosper.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;https://www.blueletterbible.org/kjv/psa/1&quot;&gt;Ps 1:1-3&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;May God bless you all.&lt;/p&gt;
&lt;hr /&gt;&lt;p&gt;&lt;em&gt;And unto Adam he said, Because thou hast hearkened unto the voice of thy wife, and hast eaten of the tree, of which I commanded thee, saying, Thou shalt not eat of it: cursed is the ground for thy sake; in sorrow shalt thou eat of it all the days of thy life (Gen 3:17)&lt;/em&gt;</description>
        <pubDate>Fri, 29 Apr 2022 00:00:00 -0400</pubDate>
        <link>https://zipcpu.com/blog/2022/04/29/proto-bringup.html</link>
        <guid isPermaLink="true">https://zipcpu.com/blog/2022/04/29/proto-bringup.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
  </channel>
</rss>
