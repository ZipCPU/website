<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>What does Formal Development look like in Practice?</title>
  <meta name="description" content="When I initially started working withformal verification,I used formal methodsto find bugs in my designs.  Now, I struggle to build a new design componentwit...">

  <link rel="shortcut icon" type="image/x-icon" href="/img/GT.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://zipcpu.com/formal/2018/07/14/dev-cycle.html">
  <link rel="alternate" type="application/rss+xml" title="The ZipCPU by Gisselquist Technology" href="https://zipcpu.com/feed.xml">
</head>


  <body>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102570964-1', 'auto');
  ga('send', 'pageview');

</script>

    <header class="site-header">
  <div id="banner">
  <a href="/"><picture>
    <img height=120 id="site-logo" src="/img/fullgqtech.png" alt="Gisselquist Technology, LLC">
  </picture></A>
  </div>

  <div class="site-nav">
<ul>

<li><a HREF="/">Main/Blog</a>


<li><a HREF="/about/">About Us</a>


<li><a HREF="/fpga-hell.html">FPGA Hell</a>


<li><a HREF="/projects.html">Projects</a>


<li><a HREF="/topics.html">Site Index</a>


<li><a href="https://twitter.com/zipcpu"><span class="icon--twitter"><svg viewBox="0 0 400 400"><path fill="#1da1f2" d="M153.62,301.59c94.34,0,145.94-78.16,145.94-145.94,0-2.22,0-4.43-.15-6.63A104.36,104.36,0,0,0,325,122.47a102.38,102.38,0,0,1-29.46,8.07,51.47,51.47,0,0,0,22.55-28.37,102.79,102.79,0,0,1-32.57,12.45,51.34,51.34,0,0,0-87.41,46.78A145.62,145.62,0,0,1,92.4,107.81a51.33,51.33,0,0,0,15.88,68.47A50.91,50.91,0,0,1,85,169.86c0,.21,0,.43,0,.65a51.31,51.31,0,0,0,41.15,50.28,51.21,51.21,0,0,1-23.16.88,51.35,51.35,0,0,0,47.92,35.62,102.92,102.92,0,0,1-63.7,22A104.41,104.41,0,0,1,75,278.55a145.21,145.21,0,0,0,78.62,23"/></svg>
</span><span class="username">@zipcpu</span></a>

<li><a HREF="https://www.patreon.com/ZipCPU"><IMG SRC="/img/patreon_logomark_color_on_white.png" WIDTH="25"> Support</a>
</ul>
</div>


</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="https://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">What does Formal Development look like in Practice?</h1>
    <p class="post-meta"><time datetime="2018-07-14T00:00:00-04:00" itemprop="datePublished">Jul 14, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When I initially started working with
<a href="/blog/2017/10/19/formal-intro.html">formal verification</a>,
I used <a href="/blog/2017/10/19/formal-intro.html">formal methods</a>
to find bugs in my designs.  Now, I struggle to build a new design component
without using
<a href="/blog/2017/10/19/formal-intro.html">formal methods</a>
along the way.</p>

<p>What does that look like?</p>

<p>Consider this: last night I set about to build a <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">new SPI flash
controller</a>.
This isn’t the first <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a> <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> controller that I’ve built.  You can find
my first one <a href="https://opencores.org/project/qspiflash">here</a>.  That one’s a
very general purpose controller, <a href="https://github.com/ZipCPU/zbasic/blob/master/sim/verilated/qspiflashsim.cpp">plus Verilator-based
simulator</a>.
Because it’s such a general purpose controller, it requires more
logic than I often have.  (Remember, I like working with really cheap, low
logic boards.)</p>

<p>This isn’t the first time I’ve had this problem.  The first time this
<a href="http://opencores.org/project/qspiflash">general purpose controller</a>
didn’t fit within a design was when I was working on the
<a href="https://store.digilentinc.com/cmod-s6-breadboardable-spartan-6-fpga-module">CMod-S6</a>, a “spartan” board containing a Spartan 6/LX4
<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">FPGA</a>
and only 2400 <a href="/blog/2017/06/12/minimizing-luts.html">LUTs</a>.  So I ripped out
the capabilities I didn’t really need: the ability to read the device ID, or to
erase and reprogram the <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>.  Yes, I cringed when removing these capabilities,
I really wanted to keep them.  However, if your hardware doesn’t have enough
logic, then you’ll need to find alternate and creative solutions for many
things.  The <a href="https://github.com/ZipCPU/s6soc/blob/master/rtl/qflashxpress.v">controller I eventually
built</a>
for <a href="https://github.com/ZipCPU/s6soc">that design</a> is fast, simple
and low logic.  However, it requires a six-wire Quad-SPI interface.</p>

<p>Why is that important?  In one example, when I first
started working with the <a href="https://tinyfpga.com">TinyFPGA BX</a>
it didn’t have all six Quad-SPI wires connected, only the four basic <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a> wires.
(Later versions now connect these last two wires.)  So I rewrote the Quad-SPI
interface from the <a href="https://github.com/ZipCPU/s6soc">CMod-S6 project</a>
to work in a dual-SPI mode.  Dual SPI aggregates the MISO and MOSI
wires from the <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a> together, so that both go in the same direction.  Hence,
the <a href="https://github.com/ZipCPU/tinyzip/blob/master/rtl/dualflexpress.v">Dual SPI controller</a>
should be about 2x as fast as a traditional <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a>
controller.  This is important when doing CPU work.  To handle erasing and
programming the <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>, I built a bit-banging interface through a control
register–something the <a href="https://github.com/ZipCPU/s6soc/blob/master/rtl/qflashxpress.v">CMod S6 Quad SPI flash controller
design</a>
didn’t have within it.</p>

<p>Sadly, even this won’t work on the
<a href="https://icoboard.org">ICO board</a>–another iCE40 based design.
Because the <a href="https://icoboard.org">ICO board</a> runs the wires for the <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>
through a MachXO2 chip, the wire directions are fixed.  Hence, the
<a href="https://icoboard.org">ICO board</a>
can only run a straight 4-wire <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a> <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> interface.
I also wanted a “faster” bit-banging interface than the <a href="https://github.com/ZipCPU/tinyzip/blob/master/rtl/dualflexpress.v">one I had just
written</a>
for the <a href="https://tinyfpga.com">TinyFPGA board</a> I have.</p>

<p>I say this all as background for why I was building a new
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>
controller–again.</p>

<p>The other reason why I share this background is so that you can place my next
claim into context: using
<a href="/blog/2017/10/19/formal-intro.html">formal methods</a>,
the controller only took about four hours to build–the time between dessert
and bed-time on a Friday night.
(No, don’t ask why I’m doing this on a Friday night … you don’t want to know.)</p>

<p>So, what did this development cycle look like?</p>

<h2 id="steps-in-a-formal-driven-development-cycle">Steps in a Formal Driven Development Cycle</h2>

<p>Since it’s fresh in my mind, and since a reader asked, let me walk you
through the steps of building <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">this brand new
SPI flash controller</a>.</p>

<ol>
  <li>
    <p>I started my design work at the kitchen table, where I tried to scribble out
some <a href="https://en.wikipedia.org/wiki/SystemVerilog">SystemVerilog</a> sequence
properties.  When most people think of <a href="/blog/2017/10/19/formal-intro.html">formal
verification</a>, they
think of these <a href="http://www.asic-world.com/systemverilog/assertions4.html">sequences</a>.  While I have used them a bit,
I’ve never used them enough to be comfortable with them.  However, I had just
removed the discussion of how to use
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>
to verify a <a href="https://en.wikipedia.org/wiki/Flash_memory">flash memory</a>
interaction from my <a href="/blog/2017/10/19/formal-intro.html">formal
verification</a>
courseware, since I had never used
them to verify a <a href="https://en.wikipedia.org/wiki/Flash_memory">flash memory</a>
interaction, it was complicated to examine, etc.  Was this really a good
choice?  I wasn’t certain.  (I still had other proven examples.)  So I’m
sure you can understand how I imagined that that actually building
<a href="/blog/2017/10/19/formal-intro.html">formal properties</a>
from <a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>
would help me teach this lesson later.</p>

    <p>It was a good intention.</p>

    <p>Instead, after I filled about a half sheet of paper with my chicken
scratches before realizing that the process wasn’t going anywhere fast.
Instead, I switched to the computer and typed my
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>
in, got annoyed with them, rearranged them, got annoyed again, and
rearranged them some more.  I quickly come to the realization that it
will be plain annoying to
<a href="/blog/2017/10/19/formal-intro.html">formally verify</a> these
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>,
since I’d need to move my files to a project directory on another computer
having the full commercial version of <a href="http://www.clifford.at/yosys">yosys</a>
on it.</p>

    <p>That’s what lead me to ultimately decide to build my design without
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>.</p>
  </li>
  <li>
    <p>So I switched from working on these (so far irrelevant) properties to
building the operational logic for my <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">basic
design</a>.
This took some time, as I worked with this design until it had enough
capability within it that I could do some amount of
<a href="/blog/2017/10/19/formal-intro.html">formal verification</a>
work next.</p>

    <p>When I say this took some time, I should point out that I couldn’t quite
decide how the controller over-ride mode was going to work.  (I needed this
to be able to erase and later program the
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> without complicating
the controller.) In the end, I decided that I wanted to have a special
control register, separate from the main
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> memory area, that this
register would control the <code class="highlighter-rouge">CS_n</code> pin of the
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>, and that writes to
this register would send eight bits and eight clocks to the device.</p>
  </li>
  <li>
    <p>Once I thought I was ready to move on, I ran
<a href="https://www.veripool.org/wiki/verilator">Verilator</a> on
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
to see if I had made any dumb mistakes.  Indeed I had: 64 will not
fit into a 6-bit register, among other problems
<a href="https://www.veripool.org/wiki/verilator">Verilator</a> found for me.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">% </span>verilator -Wall -cc spixpress.v</code></pre></figure>

<ol start="4">
  <li>I then moved to the <a href="/blog/2017/10/19/formal-intro.html">formal
property</a>
section of the design, making sure it was outlined properly by <code class="highlighter-rouge">ifdef</code>’s.
Since I had started with
<a href="https://en.wikipedia.org/wiki/SystemVerilog">SystemVerilog</a>
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequence properties</a>
that would only work with the commercial version of
<a href="https://www.clifford.at/yosys">yosys</a>,
I place these in a special <code class="highlighter-rouge">VERIFIC</code> section which I can come back to later.</li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">`ifdef	FORMAL
	// Properties will soon go here
`endif
`ifdef	VERIFIC
	// Commercial grade formal properties can go here
`endif</code></pre></figure>

<ol start="5">
  <li>My next step was to create an <code class="highlighter-rouge">f_past_valid</code> register for use with any
  <code class="highlighter-rouge">$past</code> properties I might have later.</li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	reg	f_past_valid;

	initial	f_past_valid = 1'b0;
	always @(posedge i_clk)
		f_past_valid &lt;= 1'b1;</code></pre></figure>

<ol start="6">
  <li>Once I had <code class="highlighter-rouge">f_past_valid</code>, the next step was to add in some properties to
describe the reset condition/state.  There were two parts to this process.
First, I worked my way back through my code, auditing which registers really
needed a reset capability and which did not.  The second part was to create
a basic reset property form I’ve found works in almost all of my designs.
This form has worked quite well for me in the past, tying both the initial
state and the reset state together and asserting that they are identical.</li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	always @(posedge i_clk)
	if ((!f_past_valid)||($past(i_reset)))
	begin
		assert(o_spi_cs_n == 1'b1);
		assert(o_spi_sck  == 1'b0);
		// etc.
		// Register states upon reset go here.
	end</code></pre></figure>

<ol start="7">
  <li>
    <p>The next step was to create a <code class="highlighter-rouge">bench/formal</code> directory, and then to copy
the <a href="https://github.com/ZipCPU/zipcpu/blob/dev/rtl/ex/fwb_slave.v"><code class="highlighter-rouge">fwb_slave</code>
properties</a>
from the
<a href="https://github.com/ZipCPU/zipcpu">ZipCPU project</a> to <a href="https://github.com/ZipCPU/icozip/tree/master/bench/formal">this new
directory</a>.  <a href="/zipcpu/2017/11/07/wb-formal.html">The
Wishbone properties</a>
will cause the <a href="/blog/2017/10/19/formal-intro.html">formal</a>
tools to assume that the external
<a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a> master
acts “appropriately”,
and assert that the responses of this module also act according to the
<a href="/zipcpu/2017/11/07/wb-formal.html">bus specification</a>.</p>

    <p>I spen5 a moment at this point trying to deciding what parameters needed
to be given to this <a href="https://github.com/ZipCPU/zipcpu/blob/dev/rtl/ex/fwb_slave.v">slave property
module</a>,
but ultimately end something like the following.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	localparam	F_LGDEPTH = 7;
	wire	[F_LGDEPTH-1:0]	f_nreqs, f_nacks, f_outstanding;

	fwb_slave #( .AW(23), .F_MAX_STALL(7'd70), .F_MAX_ACK_DELAY(7'd70),
			.F_LGDEPTH(F_LGDEPTH),
			.F_MAX_REQUESTS(1'b1),
			.F_OPT_MINCLOCK_DELAY(1'b1)
		) slavei(i_clk, i_reset,
		i_wb_cyc, i_wb_stb, i_wb_we, i_wb_addr, i_wb_data, 4'hf,
			o_wb_ack, o_wb_stall, o_wb_data, 1'b0,
			f_nreqs, f_nacks, f_outstanding);</code></pre></figure>

<ol start="8">
  <li>
    <p>Just to know this design will do something useful, I add a couple ad-hoc
safety properties as well.</p>

    <p>For example, my SCK output isn’t the true SCK for the interface.  That will
be created from a DDR I/O module at the top level–the only way to really
get a high speed SCK clock.  At this point, I wanted to make certain that
SCK is off (i.e. not toggling) any time <code class="highlighter-rouge">o_spi_cs_n</code> is not asserted.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	always @(*)
	if (o_spi_cs_n)
		assert(!o_spi_sck);</code></pre></figure>

<ol start="9">
  <li>I then returned to the <a href="https://github.com/ZipCPU/icozip/tree/master/bench/formal"><code class="highlighter-rouge">bench/formal</code>
directory</a>
and created a <a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>
<a href="https://github.com/ZipCPU/icozip/blob/master/bench/formal/spixpress.sby">configuration file</a>.  Since
I have no idea how well my code will or won’t work, I start it with a depth
longer than the
<a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a>
operation I’m interested in (about 64 cycles), and I also start it in <code class="highlighter-rouge">bmc</code>
mode only.</li>
</ol>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[options]
mode bmc
depth 70

[engines]
smtbmc

[script]
read_verilog -formal fwb_slave.v
read_verilog -formal spixpress.v
prep -top spixpress

[files]
fwb_slave.v
../../rtl/icozip/spixpress.v</code></pre></figure>

<ol start="10">
  <li>I now run <a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a> using
   this <a href="https://github.com/ZipCPU/icozip/blob/master/bench/formal/spixpress.sby">configuration file</a>.</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">% </span>sby -f spixpress.sby</code></pre></figure>

<ol start="11">
  <li>The design didn’t even get past the second clock.  I pull up the
   <a href="/blog/2017/07/31/vcd.html">VCD file</a>
   to examine it, and discover that my design has a problem with the <code class="highlighter-rouge">i_reset</code>
   signal.</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">% </span>gtkwave spixpress/engine_0/trace.vcd</code></pre></figure>

<ol start="12">
  <li>
    <p>My problem was specifically that I had wanted to create a design that
   would work with or without a reset signal, potentially using only the
   <code class="highlighter-rouge">initial</code> statements to get into the right state.  However, the
   <a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a>
   <a href="https://github.com/ZipCPU/zipcpu/blob/dev/rtl/ex/fwb_slave.v">property file</a>
   requires a reset anytime <code class="highlighter-rouge">f_past_valid</code> is false.  I grumble to myself and
   then grudgingly create this required reset.</p>
  </li>
  <li>
    <p>I then repeat this process: creating properties, running <a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>,
examining the trace, adjusting my code and repeating.</p>

    <p>Eventually I switch from <code class="highlighter-rouge">mode bmc</code> to <code class="highlighter-rouge">mode prove</code>.  This yields a whole
new set of
<a href="/formal/2018/03/10/induction-exercise.html">strangeness</a>
within the trace, but the process remains the same.</p>

    <p>Well, almost.  There are additional properties that your design will need
in order to to pass
<a href="/formal/2018/03/10/induction-exercise.html">induction</a>.
As is often the case, most of the problems I discover simply require more
<code class="highlighter-rouge">assert()</code> statements.</p>

    <p>The result of this exercise is usually a jumbled mess of assertions
at the bottom of an (eventually)
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">working design</a>.
I’ll often leave these properties just like that, in a jumbled mess,
until I come back later and blog about the design–if I ever do.</p>
  </li>
  <li>
    <p>After doing this for a while, my <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">design</a>
stopped failing.  Since the
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">design</a>
and its properties were at this point consistent,
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>
stopped generating any <a href="/blog/2017/07/31/vcd.html">trace
files</a> containing bugs
to look at.  When this happens it becomes harder to have any confidence
that the code is (still) working.  Sure, the tool says it’s working, but
is it?  Therefore, I added some cover properties to my design.</p>

    <p>Unlike a safety property, such as either <code class="highlighter-rouge">assume</code> or <code class="highlighter-rouge">assert</code>, a cover
property is used to prove that something <em>could</em> happen, or equivalently
that a particular state is possible.  A <code class="highlighter-rouge">cover</code> property will only succeed
if the solver can find a trace, any trace, that will make the expression
within it true.</p>

    <p>If you’ve never used <code class="highlighter-rouge">cover</code> before, usually you can cover a response from
the bus to get a large bang for your buck.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">always @(posedge i_clk)
	cover(o_wb_ack);</code></pre></figure>

<ol start="15">
  <li>Running in cover mode, however, required changing my
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>
<a href="https://github.com/ZipCPU/icozip/blob/master/bench/formal/spixpress.sby">configuration file</a>
to use <code class="highlighter-rouge">mode cover</code> instead of <code class="highlighter-rouge">mode prove</code>.  I then ran
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a> again, this
time focusing on the <code class="highlighter-rouge">cover</code> property.</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">% </span>sby -f spixpress.sby</code></pre></figure>

<ol start="16">
  <li>
    <p>For this particular design, covering a
<a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a>
acknowledgement just isn’t all that satisfying.  Perhaps I’ve been
spoiled by cache designs, MMU’s or other
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> controllers.  In this case, there’s a status register which will
respond almost instantly before the core does anything useful.</p>

    <p>Therefore, I needed to create some extra logic just so I could capture
just the acknowledgement I was looking for in a cover statement.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	reg	f_pending_bus_request; /// A read from the flash

	initial	f_pending_bus_request = 1'b0;
	always @(posedge i_clk)
	if ((i_reset)||(!i_wb_cyc))
		f_pending_bus_request &lt;= 1'b0;
	else if (bus_request)
		// bus_request is a wire set to (i_wb_stb)&amp;&amp;(!o_wb_stall)
		//	&amp;&amp;(!i_wb_we)&amp;&amp;( not the configuration register address)
		f_pending_bus_request &lt;= 1'b1;
	else if (o_wb_ack)
		f_pending_bus_request &lt;= 1'b0;

	always @(posedge i_clk)
		cover((o_wb_ack)&amp;&amp;(f_pending_bus_request));</code></pre></figure>

<ol start="17">
  <li>The design felt pretty good at this point, so I took a quick look
to see how big it was in terms of logic.  This meant firing up
<a href="https://www.clifford.at/yosys">yosys</a>,
and within a <a href="https://www.clifford.at/yosys">yosys</a> command line I typed:</li>
</ol>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&gt; read_verilog spixpress.v
&gt; synth_ice40
&gt; stat</code></pre></figure>

<ol start="18">
  <li><a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">The design</a>
only used about 150 elements.   150 elements would fit nicely on the
<a href="http://icoboard.org">ICO board</a>.  It is also cheaper than many of my
other designs.  The last benchmark I have is about 320 cells for the
<a href="https://github.com/ZipCPU/tinyzip/blob/master/rtl/dualflexpress.v">Dual SPI flash
controller</a>.</li>
</ol>

<ol start="19">
  <li>
    <p>Even though <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
had passed
<a href="/blog/2017/10/19/formal-intro.html">formal verification</a>,
it still really wasn’t complete.  In particular, it didn’t yet support
pipelined bus interactions.  Instead, it would read only one 32-bit value
from the <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> memory at any
given time.  Hence, any <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>
interaction would write the “read” command, <code class="highlighter-rouge">8'h03</code>, to the
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>, write the address,
and then read the data.  If you wanted to read the next data value, you
would have to start back at the beginning with a new command.</p>

    <p>Because of this ineffiiency, I like to create a pipeline capability in my
controllers.  Using this pipeline capaability, once you get near the end
of the data request,
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
will accept another
<a href="/zipcpu/2017/11/07/wb-formal.html">Wishbone</a>
request, but only for the next memory address.  That allows the controller
to require <code class="highlighter-rouge">64</code> clocks for the initial transfer, and <code class="highlighter-rouge">32</code> for any
subsequent transfer.</p>

    <p>To create this new capability, I added a one-bit parameter,
<code class="highlighter-rouge">OPT_PIPE</code>.  Pipeline logic requires that the
the <code class="highlighter-rouge">o_wb_stall</code> line be dropped before the end of the interaction, but
only if the next request from the bus is for the next word from <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>.
Pipeline logic also requires being able to tell if the next bus request
is for the next address in memory or not.  Hence, I added a generate block
to capture the last address logic.  This has the nice feature that it only
uses the additional logic any time <code class="highlighter-rouge">OPT_PIPE</code> is true.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-verilog" data-lang="verilog">	generate if (OPT_PIPE)
	begin
		reg	[21:0]	r_next_addr;
		always @(posedge i_clk)
		if ((i_wb_stb)&amp;&amp;(!o_wb_stall))
			r_next_addr &lt;= i_wb_addr[21:0] + 1'b1;

		assign	next_addr = r_next_addr;

	end else begin

		assign next_addr = 0;

	end endgenerate</code></pre></figure>

<ol start="19">
  <li>
    <p>Once accomplished, I had now adjusted my logic, so I now needed to go back
into my adjust my
<a href="/blog/2017/10/19/formal-intro.html">formal properties</a>,
run <a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>, and
view the <a href="/blog/2017/07/31/vcd.html">trace</a>
development cycle.</p>

    <p>I also added a property to make certain that, if <code class="highlighter-rouge">o_wb_stall</code> was ever
dropped during a transaction, it was only dropped if there was a read
request for the next data word.  Sure enough, this property failed the first
time around.</p>
  </li>
</ol>

<ol start="21">
  <li>
    <p>When <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
was at the point where it passed the
<a href="/formal/2018/03/10/induction-exercise.html">induction</a>
step again, I switched back to the cover mode.  Specifically, I wanted to
prove that <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the
design</a>
would be able to accept a request while the
<a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a>
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> operation is ongoing.</p>

    <p>This new cover property failed.</p>

    <p>This was really annoying, because a failed cover statement doesn’t yield a
<a href="/blog/2017/07/31/vcd.html">trace</a>.  A failed <code class="highlighter-rouge">assert</code>
will yield a
<a href="/blog/2017/07/31/vcd.html">trace</a>, showing you what’s
going wrong within your design.  Not so with a failed cover.  Instead, you
only get a <a href="/blog/2017/07/31/vcd.html">trace</a>
from a cover statement when (and if) the cover statement succeeds.
Therefore, I had to create a new cover statement one step prior to the
cover that failed to try to see where it failed.</p>
  </li>
</ol>

<ol start="22">
  <li>
    <p>Then the cycle repeated again, until I (eventually) found a careless
assumption I had made early
on in my design.  While this assumption had made it easier to get
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
off the ground, it was inappropriate for a final design.  Removing this
careless assumption fixed the problem, so
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
then passed the updated cover check.</p>
  </li>
  <li>
    <p>At this point it was now time to clean up a bit.
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">The design</a>
had at one time passed <a href="/blog/2017/10/19/formal-intro.html">formal
verification</a>
in a non-cover mode, but it had been some time since this
mode had been checked and there had been some changes.  Therefore, I
returned to the <a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>
<a href="https://github.com/ZipCPU/icozip/blob/master/bench/formal/spixpress.sby">configuration file</a>
and created a series of four tasks: Two of these tasks apply to
the non pipelined version, and two apply to the pipelined version.
Broken out another way, two of the tasks are
<a href="/formal/2018/03/10/induction-exercise.html">induction</a>
proofs and two are cover proofs.  The final
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a> <a href="https://github.com/ZipCPU/icozip/blob/master/bench/formal/spixpress.sby">configuration
file</a>
now looked like:</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[tasks]
safety		nopipe
safety_pipe	pipe
cover		nopipe
cover_pipe	pipe

[options]
safety:      mode prove
safety_pipe: mode prove
cover:       mode cover
cover_pipe:  mode cover
depth 70

[engines]
smtbmc

[script]
read_verilog -formal fwb_slave.v
read_verilog -formal spixpress.v
cover:      chparam -set F_OPT_COVER 1 spixpress
cover_pipe: chparam -set F_OPT_COVER 1 spixpress
nopipe:	chparam -set OPT_PIPE   0 spixpress
pipe:	chparam -set OPT_PIPE   1 spixpress
prep -top spixpress

[files]
fwb_slave.v
../../rtl/icozip/spixpress.v</code></pre></figure>

<ol start="24">
  <li>
    <p>Sadly, some of the functionality that had worked earlier had now broken, so
I went back through the cycle of updating the logic, the properties, running
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>, and looking
at <a href="/blog/2017/07/31/vcd.html">trace files</a>.</p>

    <p>This step gets difficult, though, since the
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a> will print its
result on the last line of processing any task, and then immediately move
on to the next task.  That means that if you want to know what task passed
and which didn’t, you’ll need to go back and examine the various result
directories.</p>

    <p>Hence, just to make certain I hadn’t missed anything, I listed all of the
<a href="https://symbiyosys.readthedocs.io/en/latest">SymbiYosys</a>
output directories.  Specifically, I was looking for an empty file named
<code class="highlighter-rouge">PASS</code> in all of the various output directories.  Other possibilities would
include <code class="highlighter-rouge">ERROR</code>, <code class="highlighter-rouge">FAIL</code>, and <code class="highlighter-rouge">UNKNOWN</code>.  Each of these would’ve indicated
a problem that I’d need to go back and revisit.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% ls spixpress*/
spixpress_cover/:
config.sby  engine_0  logfile.txt  model  PASS  spixpress_cover.xml  src

spixpress_cover_pipe/:
config.sby  engine_0  logfile.txt  model  PASS  spixpress_cover_pipe.xml  src

spixpress_safety/:
config.sby  engine_0  logfile.txt  model  PASS  spixpress_safety.xml  src

spixpress_safety_pipe/:
config.sby  engine_0  logfile.txt  model  PASS  spixpress_safety_pipe.xml  src
%</code></pre></figure>

<ol start="25">
  <li>As a final step, I re-ran
<a href="https://www.clifford.at/yosys">yosys</a> to measure the logic usage of
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>.
My goal was to reassure myself that, yes, I could
truly make a low logic design.  Much to my surprise, the amount of logic
used had jumped from <code class="highlighter-rouge">156</code> cells to <code class="highlighter-rouge">243</code>.  This number puzzled me, so
I returned to
<a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">the design</a>
and turn off the <code class="highlighter-rouge">OPT_PIPE</code> flag.  The logic usage level
returned to <code class="highlighter-rouge">156</code> cells again.  I wasn’t expecting this, but at that point
in the evening it was too late to chase down the cause of the difference.
My design passed <a href="/blog/2017/10/19/formal-intro.html">formal verification</a>,
and so I headed to bed.</li>
</ol>

<p>What about those <a href="https://en.wikipedia.org/wiki/SystemVerilog">SystemVerilog</a>
<a href="http://www.asic-world.com/systemverilog/assertsion4.html">sequences</a>
at the end of the file?  I still
haven’t tested them (yet), and at this point I’m not certain if I will.</p>

<p>This isn’t the end of this low-logic <a href="https://en.wikipedia.org/wiki/Serial_Perip-heral_Interface">SPI</a> <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> module with the
<a href="https://icoboard.org">ICO board</a>, but it is the end of last night’s
development.</p>

<h2 id="next-steps">Next Steps</h2>

<p>I do intend to come back to <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">this
design</a>
again later.  It’s not done.  It is however part of a longer term project
associated with getting the
<a href="/about/zipcpu.html">ZipCPU</a>
up and running on the
<a href="https://icoboard.org">ICO board</a>.  To support that project, I’ll want to build
a C++ <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> controller to allow
me to write programs to the
<a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>.  Sadly, this will need to
be a new <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a> controller,
since I just redesigned the interface necessary for erasing and then programming
the <a href="https://en.wikipedia.org/wiki/Flash_memory">flash</a>.</p>

<p>In general, I’ve been rather disappointed that the
<a href="/about/zipcpu.thml">ZipCPU</a>
that worked so nicely on several Xilinx boards has yet to work on the
<a href="https://icoboard.org">ICO board</a>.  I plan to discuss one of the really
annoying differences in an upcoming article.  However, to get to the point
where the <a href="/about/zipcpu.thml">ZipCPU</a> works on this board
I will need to integrate <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">this flash
controller</a>
into the overall design, and then finish building the <a href="/blog/2017/06/21/looking-at-verilator.html">Verilator
simulator</a>
using it.  Then, and only then, after <a href="https://github.com/ZipCPU/icozip/blob/master/rtl/icozip/spixpress.v">this new controller
design</a>
passes my tests in simulation, supported by a to-be-written C++ controller,
will I attempt to place it onto the actual <a href="https://icoboard.org">ICO board</a>
hardware.</p>

<p>Yes, I understand there are individuals who can build and verify things using
<a href="/blog/2017/10/19/formal-intro.html">formal methods</a> alone.
These individuals talk about “formal signoff”, or being able to certify that a
design is ready for tape-out using <a href="/blog/2017/10/19/formal-intro.html">formal
methods</a> alone.
I would love to be able to get there.  It’s one of my personal development
goals.  However, I’m not there yet.  Therefore, everything I do needs to
be both <a href="/blog/2017/10/19/formal-intro.html">formally
verified</a> (the easy part
to set up), and then it needs to pass simulation.</p>

  </div>


<div class "verse">
<HR align="center;" width="25%">
<P><em>And they took him, and brought him unto Areopagus, saying, May we know what this new doctrine, whereof thou speakest, is? (Acts 17:19)</em>


</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The ZipCPU by Gisselquist Technology</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <!-- <li></li> -->
          <li><a href="mailto:zipcpu@gmail.com">zipcpu@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="soc-medlist">
          
          <li>
            <a href="https://github.com/ZipCPU"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ZipCPU</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/zipcpu"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">@zipcpu</span></a>

          </li>
          
          
          <li><A href="https://www.patreon.com/ZipCPU"><img src="/img/become_a_patron_button.png"></a></li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The ZipCPU blog, featuring how to discussions of FPGA and soft-core CPU design.  This site will be focused on Verilog solutions, using exclusively OpenSource IP products for FPGA design.  Particular focus areas include topics often left out of more mainstreeam FPGA design courses such as how to debug an FPGA design.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
